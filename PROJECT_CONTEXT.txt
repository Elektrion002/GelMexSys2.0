============================================================
 GELMEXSYS 2.0 - REPORTE DE CONTEXTO T√âCNICO (PostgreSQL)
 FECHA: 2025-12-29 10:09:01
============================================================

------------------------------
ESTRUCTURA DE DIRECTORIOS:
[./]
    ARQUITECTURA_DATOS.md
    audit_system.py
    check_columns.py
    config.py
    HOJA_DE_METODO_INICIAL.md
    init_production_table.py
    intrucciones git.txt
    requirements.txt
    run.py
    seed_runner.py
    setup_db.py
    setup_structure.py
    update_db_real.py
    [app/]
        extensions.py
        forms.py
        __init__.py
        [blueprints/]
            api_test.py
            auth.py
            home.py
            inventory.py
            production.py
            reception.py
            sales.py
        [models/]
            catalogs.py
            clients.py
            infrastructure.py
            orders.py
            production.py
            products.py
            stock.py
            users.py
            __init__.py
        [static/]
            [css/]
                main.css
            [js/]
        [templates/]
            base.html
            [auth/]
                login.html
            [home/]
                index.html
            [inventory/]
                catalog_list.html
                form.html
                movements.html
            [production/]
                dashboard.html
                orders_list.html
            [reception/]
                reception_dock.html
            [sales/]
                console.html
    [db_seeds/]
        data_catalogs.py
        data_clients.py
        data_infrastructure.py
        data_products.py
        data_users.py
    [_historial_parches/]
        fix_catalog.py
        fix_column.py
        [tests/]
            test_inventory_flow.py
            __init__.py
------------------------------


========================= FILE: .\ARQUITECTURA_DATOS.md =========================
# ARQUITECTURA DE BASE DE DATOS - GELMEXSYS 2.0 (PostgreSQL)

**Motor:** PostgreSQL 15+
**ORM:** SQLAlchemy
**Estrategia:** Relacional Normalizada (3NF)

---

## 1. DICCIONARIO DE DATOS Y RELACIONES

### A. M√ìDULO DE CAT√ÅLOGOS SAT√âLITE (Din√°micos)
*El cliente exigi√≥ "No Hardcoding". Estas tablas permiten al admin crear nuevos tipos sin llamar al programador.*

1.  **`cat_plantas`**
    * `id` (PK), `descripcion`, `notas`.
2.  **`cat_areas`**
    * `id` (PK), `descripcion`, `notas`.
3.  **`cat_unidades_medida`**
    * `id` (PK), `nombre` (Litro, Pieza), `abreviatura` (Lt, Pza).
4.  **`cat_categorias_producto`**
    * `id` (PK), `nombre` (Bolis Leche, Paletas Agua), `descripcion`.
5.  **`cat_categorias_materia_prima`**
    * `id` (PK), `nombre` (L√°cteos, Saborizantes), `descripcion`.
6.  **`cat_tipos_almacen`**
    * `id` (PK), `nombre` (C√°mara Fr√≠a, Seco, Conservador).
7.  **`cat_puestos`**
    * `id` (PK), `nombre` (Vendedor, Heladero, Repartidor), `nivel_acceso` (1-5).
8.  **`cat_tipos_vehiculo`**
    * `id` (PK), `nombre` (Sedan, Pickup, Refrigerada).
9.  **`cat_modelos_vehiculo`**
    * `id` (PK), `marca`, `modelo`, `anio`.
10. **`cat_modelos_activo`** (Para refrigeradores/congeladores)
    * `id` (PK), `marca`, `modelo`, `capacidad_litros`.
11. **`cat_estados_fisicos`**
    * `id` (PK), `descripcion` (Bueno, Malo, √ìptimo, Nuevo, En Taller).

---

### B. M√ìDULO DE RECURSOS HUMANOS (Usuarios)

**Tabla: `usuarios`**
*Contiene la ficha completa del empleado.*
* `id` (PK)
* **Datos Personales:**
    * `nombres`, `apellido_paterno`, `apellido_materno`.
    * `fecha_nacimiento`, `estado_civil`, `profesion`.
    * `domicilio_calle`, `domicilio_num_ext`, `domicilio_num_int`, `domicilio_colonia`, `domicilio_cp`, `domicilio_ciudad`, `domicilio_estado`, `domicilio_pais`.
    * `telefono_casa`, `telefono_celular`.
* **Datos Laborales:**
    * `puesto_id` (FK -> `cat_puestos`).
    * `fecha_inicio_empresa`.
    * `calificacion_evaluacion` (1-5 Estrellas).
    * `notas_generales`.
* **Seguridad y Acceso:**
    * `email` (Login), `password_hash`, `pin_seguridad` (6 d√≠gitos).
    * `nivel_usuario` (Heredado de puesto o sobreescrito).
* **Emergencia:**
    * `contacto_emergencia_nombre`, `contacto_emergencia_telefono`.
* **Documentaci√≥n (Rutas de Archivos en `uploads/usuarios/`):**
    * `foto_perfil` (Uso interno).
    * `img_ine_frente`, `img_ine_reverso`.
    * `img_licencia_frente`, `img_licencia_reverso`, `fecha_validez_licencia`.

---

### C. M√ìDULO DE PRODUCTOS Y MATERIA PRIMA

**Tabla: `productos`**
* `id` (PK), `sku` (√önico).
* `descripcion`.
* `categoria_id` (FK -> `cat_categorias_producto`).
* `unidad_id` (FK -> `cat_unidades_medida`).
* **Costos y Precios:**
    * `precio_costo_actual`.
    * `precio_venta_general` (Base).
* **F√≠sico:**
    * `peso_gramos`, `caducidad_dias`.
    * `imagen_producto` (300x300 jpg, path).

**Tabla: `materia_prima`**
* `id` (PK), `sku`, `descripcion`.
* `categoria_id` (FK -> `cat_categorias_materia_prima`).
* `unidad_id` (FK -> `cat_unidades_medida`).
* `precio_costo_promedio`.
* `precio_venta_general` (Base).
* `peso_gramos`, `caducidad_dias`.
* `imagen_materia` (300x300 jpg, path).

---

### D. M√ìDULO DE INFRAESTRUCTURA E INVENTARIOS

**Tabla: `almacenes`**
* `id` (PK), `descripcion`.
* `tipo_id` (FK -> `cat_tipos_almacen`).
* `planta_id` (FK -> `cat_plantas`).
* `area_id` (FK -> `cat_areas`).
* `imagen_almacen` (300x300 jpg).

**Tabla: `ubicaciones_almacen`**
* `id` (PK), `codigo` (Ej: CFPA001B004).
* `almacen_id` (FK -> `almacenes`).
* `notas`.

**Tabla: `inventario_lotes` (El coraz√≥n del stock)**
* `id` (PK).
* **Qu√© es:**
    * `producto_id` (FK, Nullable).
    * `materia_prima_id` (FK, Nullable).
* **D√≥nde est√°:**
    * `ubicacion_id` (FK -> `ubicaciones_almacen`).
* **Cu√°nto hay:**
    * `cantidad_actual`.
    * `fecha_produccion` (Lote).
    * `fecha_ingreso_almacen`.
    * `stock_minimo`.
    * `stock_maximo`.
    * `stock_ideal`.
* **Sem√°foros (Definidos por producto, pero guardados aqu√≠ para snapshot o referenciados):**
    * (L√≥gica: Se compara `cantidad_actual` vs `Producto.stock_minimo` o `cantidad_actual` vs `Producto.stock_maximo`).

---

### E. M√ìDULO DE LOG√çSTICA Y ACTIVOS

**Tabla: `vehiculos`**
* `id` (PK), `placas`.
* `serie_vehiculo`.
* `tipo_id` (FK -> `cat_tipos_vehiculo`).
* `modelo_id` (FK -> `cat_modelos_vehiculo`).
* `estado_llantas_id` (FK -> `cat_estados_fisicos`).
* `estado_general_id` (FK -> `cat_estados_fisicos`).
* `kilometraje_ultimo_servicio`.
* `asignado` (Boolean).
* **Fechas Cr√≠ticas:**
    * `fecha_ultimo_servicio`, `fecha_proximo_servicio`.
    * `fecha_vencimiento_seguro`, `fecha_vencimiento_verificacion`.
* **Evidencia (600x400 jpg):**
    * `img_vehiculo`, `img_motor`, `img_odometro`.

**Tabla: `activos_frio` (Congeladores)**
* `id` (PK), `serie`, `descripcion`.
* `modelo_id` (FK -> `cat_modelos_activo`).
* `estado_id` (FK -> `cat_estados_fisicos`).
* `asignado` (Boolean).
* `img_activo` (300x300 jpg).
* `fecha_ultimo_mtto`, `fecha_proximo_mtto`.

**Tabla: `rutas_reparto`**
* `id` (PK), `descripcion`.
* `img_mapa` (600x400 jpg).
* `notas`.

---

### F. M√ìDULO DE VENTAS Y CLIENTES (Complejidad Alta)

**Tabla: `clientes`**
* `id` (PK).
* **Negocio:**
    * `nombre_negocio`, `tipo_negocio`.
    * `img_fachada` (300x300 jpg).
    * `calificacion` (1-5).
* **Encargado:**
    * `nombres_encargado`, `apellido_p_encargado`, `apellido_m_encargado`.
    * `img_ine_frente`, `img_ine_reverso`.
    * `domicilio_completo` (Desglosado igual que usuarios).
* **Financiero:**
    * `Vendedor_habitual_id` (FK -> `usuarios`, Nullable).
    * `limite_credito` (Cu√°nto le f√≠a GelMex).
    * `saldo_actual` (Deuda actual).
* **Log√≠stica:**
    * `ruta_id` (FK -> `rutas_reparto`).
    * `repartidor_habitual_id` (FK -> `usuarios`, Nullable).

**Tabla: `asignacion_activos_cliente`**
* `cliente_id` (FK).
* `activo_frio_id` (FK).
* `fecha_asignacion`.

**Tabla: `precios_especiales_cliente` (Regla de Negocio Cr√≠tica)**
* *Esta tabla permite que cada cliente tenga un precio diferente.*
* `id` (PK).
* `cliente_id` (FK).
* `producto_id` (FK).
* `tipo_descuento`: ('PORCENTAJE', 'MONTO_FIJO', 'PRECIO_FINAL').
* `valor_descuento`: (Ej. 10, 5.00, 15.50).
* *L√≥gica:* Al vender, el sistema busca aqu√≠ primero. Si no encuentra, usa `Producto.precio_venta_general`.

---

## 2. L√ìGICA DE PROCEDIMIENTOS Y VISTAS

### A. Vistas (Views) para Reportes R√°pidos
Estas vistas se crear√°n en la BD para facilitar el trabajo de los Dashboards.

1.  **`view_inventario_global`**:
    * Suma el stock de todas las ubicaciones agrupado por SKU.
    * Muestra: SKU, Descripci√≥n, Total Plantas, Total Rutas, Total General.

2.  **`view_estado_credito`**:
    * Lista clientes con `saldo_actual > 0`.
    * Calcula `credito_disponible` = `limite_credito` - `saldo_actual`.
    * Alerta si `saldo_actual` >= `limite_credito`.

### B. L√≥gica de Transacciones (Procedimientos "L√≥gicos")
No usaremos Stored Procedures de SQL (PL/pgSQL) para la l√≥gica de negocio, usaremos **Servicios en Python** (capa intermedia) para mantener el control de versiones, pero la l√≥gica ser√° transaccional (Atomicity).

1.  **Procedimiento `CrearPedido`:**
    * Input: Cliente, Lista de Items.
    * Validaci√≥n 1: ¬øEl cliente tiene cr√©dito suficiente? (Si es venta a cr√©dito).
    * C√°lculo: Iterar items -> Buscar si existe `precios_especiales_cliente` -> Calcular Subtotal.
    * Output: Orden en estado "BORRADOR" o "CONFIRMADO".

2.  **Procedimiento `ConfirmarProduccion` (Maestro Heladero):**
    * Input: Orden de Producci√≥n, Cantidad Real Producida.
    * Acci√≥n:
        * Restar Materia Prima (seg√∫n receta - *Futuro*).
        * Sumar Stock a "Ubicaci√≥n Temporal Producci√≥n".
        * Crear registro en `inventario_lotes`.

3.  **Procedimiento `CierreRuta` (Finanzas):**
    * Input: ID Ruta, Efectivo Entregado, Notas de Cr√©dito Firmadas.
    * Acci√≥n:
        * Actualizar `saldo_actual` de cada cliente (Resta abonos, suma nuevos pedidos a cr√©dito).
        * Conciliar Stock del cami√≥n (Lo que sali√≥ vs lo que volvi√≥ vs lo vendido).

---

## 3. ESTRATEGIA DE SEMILLAS (DB SEEDS)

Para el archivo `db_seeds.py`, seguiremos este orden estricto de llenado para evitar errores de Llaves For√°neas (FK):

1.  **Nivel 0 (Cat√°logos Duros):** Unidades de medida, Tipos de Almac√©n, Estados F√≠sicos.
2.  **Nivel 1 (Infraestructura):** Plantas, √Åreas, Rutas base.
3.  **Nivel 2 (Categor√≠as):** Categor√≠as de Productos y Materia Prima, Puestos.
4.  **Nivel 3 (Recursos):** Productos Base, Almacenes f√≠sicos, Veh√≠culos demo.
5.  **Nivel 4 (Usuarios):** Crear al "Super Admin" (Dios) y un Vendedor demo.

========================= FILE: .\audit_system.py =========================
import os
from app import create_app
from app.extensions import db
from sqlalchemy import text, inspect

# Configuraci√≥n de colores para la consola
class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'

def check_table_health(inspector, table_name, required_cols=None):
    """Verifica si la tabla existe y tiene columnas cr√≠ticas."""
    if not inspector.has_table(table_name):
        print(f"   {Colors.FAIL}[CR√çTICO] La tabla '{table_name}' NO EXISTE.{Colors.ENDC}")
        return False
    
    if required_cols:
        cols = [c['name'] for c in inspector.get_columns(table_name)]
        missing = [rc for rc in required_cols if rc not in cols]
        if missing:
            print(f"   {Colors.FAIL}[ERROR] Tabla '{table_name}' incompleta. Faltan columnas: {missing}{Colors.ENDC}")
            return False
        else:
            print(f"   [OK] Tabla '{table_name}' estructuralmente correcta.")
            # Imprimir columnas clave encontradas para validaci√≥n visual
            found_keys = [c for c in cols if c in required_cols]
            print(f"        -> Columnas validadas: {found_keys}")
    
    return True

def count_records(table_name):
    """Cuenta registros reales usando SQL directo."""
    try:
        sql = text(f"SELECT COUNT(*) FROM {table_name}")
        count = db.session.execute(sql).scalar()
        color = Colors.OKGREEN if count > 0 else Colors.WARNING
        print(f"   {color}Registros en '{table_name}': {count}{Colors.ENDC}")
        return count
    except Exception as e:
        print(f"   {Colors.FAIL}Error leyendo '{table_name}': {e}{Colors.ENDC}")
        return 0

def audit_database():
    app = create_app()
    with app.app_context():
        print(f"\n{Colors.HEADER}{'='*70}")
        print(f" AUDITOR√çA MCP (MODEL CONTEXT PROTOCOL) - GELMEXSYS 2.0")
        print(f"{'='*70}{Colors.ENDC}\n")

        inspector = inspect(db.engine)

        # ---------------------------------------------------------
        # FASE 1: INFRAESTRUCTURA DE ALMAC√âN (El terreno del Almacenista)
        # ---------------------------------------------------------
        print(f"{Colors.BOLD}FASE 1: PREPARACI√ìN DE ALMACENES (Infraestructura){Colors.ENDC}")
        
        # Validar si existen almacenes y, m√°s importante, UBICACIONES (Pasillos/Racks)
        # Sin ubicaciones, el almacenista no puede "ubicar" el producto.
        if check_table_health(inspector, 'almacenes') and check_table_health(inspector, 'ubicaciones_almacen', ['codigo', 'almacen_id']):
            cnt_alm = count_records('almacenes')
            cnt_ubi = count_records('ubicaciones_almacen')
            
            if cnt_alm > 0 and cnt_ubi == 0:
                print(f"   {Colors.FAIL}>>> ALERTA DE PROCESO: Tienes almacenes pero NO tienes ubicaciones.{Colors.ENDC}")
                print("       El Almacenista no podr√° guardar nada porque no hay 'Pasillos' definidos.")

        # ---------------------------------------------------------
        # FASE 2: MODELO DE INVENTARIO (La divergencia detectada)
        # ---------------------------------------------------------
        print(f"\n{Colors.BOLD}FASE 2: MODELO DE INVENTARIO (Validaci√≥n de Nombres){Colors.ENDC}")
        
        # Aqu√≠ validamos si postgres tiene 'cantidad_actual' o 'cantidad_fisica'
        inv_cols = [c['name'] for c in inspector.get_columns('inventario_productos')] if inspector.has_table('inventario_productos') else []
        
        print(f"   Columnas en DB Real: {inv_cols}")
        if 'cantidad_actual' in inv_cols:
            print(f"   {Colors.OKGREEN}‚úì PostgreSQL usa 'cantidad_actual'. (Aseg√∫rate que stock.py coincida){Colors.ENDC}")
        elif 'cantidad_fisica' in inv_cols:
            print(f"   {Colors.OKGREEN}‚úì PostgreSQL usa 'cantidad_fisica'. (Aseg√∫rate que stock.py coincida){Colors.ENDC}")
        else:
            print(f"   {Colors.FAIL}‚ùå NO SE ENCONTR√ì COLUMNA DE CANTIDAD. El sistema tronar√°.{Colors.ENDC}")

        # Revisamos si hay K√°rdex para auditor√≠a
        check_table_health(inspector, 'historial_movimientos', ['tipo_movimiento', 'cantidad', 'usuario_id', 'referencia'])

        # ---------------------------------------------------------
        # FASE 3: LOG√çSTICA (El terreno del Repartidor)
        # ---------------------------------------------------------
        print(f"\n{Colors.BOLD}FASE 3: LOG√çSTICA Y RUTAS (Preparaci√≥n para Entrega){Colors.ENDC}")
        
        # El proceso dice que el repartidor sube cajas seg√∫n su ruta. ¬øHay rutas?
        check_table_health(inspector, 'rutas_reparto', ['descripcion'])
        count_records('rutas_reparto')
        
        check_table_health(inspector, 'vehiculos', ['placas', 'asignado'])
        count_records('vehiculos')

        # ---------------------------------------------------------
        # FASE 4: SIMULACI√ìN DE FLUJO DE DATOS (Data Flow)
        # ---------------------------------------------------------
        print(f"\n{Colors.BOLD}FASE 4: DIAGN√ìSTICO DE FLUJO{Colors.ENDC}")
        
        # Revisamos estados de √≥rdenes para ver si el "Programador" tiene chamba
        try:
            sql = text("SELECT estado, COUNT(*) FROM ordenes_venta GROUP BY estado")
            res = db.session.execute(sql).fetchall()
            if res:
                print("   Estado de las √ìrdenes:")
                for r in res:
                    print(f"   - {r[0]}: {r[1]}")
            else:
                print(f"   {Colors.WARNING}No hay √≥rdenes activas.{Colors.ENDC}")
        except:
            pass

        print(f"\n{Colors.HEADER}CONCLUSI√ìN DEL PROTOCOLO:{Colors.ENDC}")
        print("Si FASE 1 tiene Almacenes pero 0 Ubicaciones -> Bloqueante para M√≥dulo Almac√©n.")
        print("Si FASE 2 muestra nombres distintos a tu c√≥digo Python -> Error 500 seguro.")
        print("Si FASE 3 tiene 0 Rutas -> El m√≥dulo de Ventas no podr√° asignar clientes correctamente.")

if __name__ == "__main__":
    audit_database()

========================= FILE: .\check_columns.py =========================
from app import create_app
from app.models.infrastructure import UbicacionAlmacen

app = create_app()

with app.app_context():
    print("-" * 30)
    print(f"TABLA REAL: {UbicacionAlmacen.__tablename__}")
    print("-" * 30)
    print("COLUMNAS EN EL MODELO:")
    # Esto nos dir√° exactamente qu√© atributos tiene la clase Python
    for column in UbicacionAlmacen.__table__.columns:
        print(f" >> {column.name}")
    print("-" * 30)

========================= FILE: .\config.py =========================
import os

class Config:
    # Llave de seguridad (luego la cambiamos por una real en producci√≥n)
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'clave-super-secreta-desarrollo'
    SQLALCHEMY_TRACK_MODIFICATIONS = False

class DevelopmentConfig(Config):
    DEBUG = True
    # Conexi√≥n a PostgreSQL Local
    # Formato: postgresql://usuario:password@localhost:puerto/nombre_db
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'postgresql://postgres:admin12345@localhost:5432/gelmex_db'

class ProductionConfig(Config):
    DEBUG = False
    # Aqu√≠ ir√≠a la conexi√≥n a PostgreSQL real
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')

# Diccionario para elegir f√°cil
config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}

========================= FILE: .\HOJA_DE_METODO_INICIAL.md =========================
# HOJA DE M√âTODO: DESPLIEGUE DE ENTORNO (GMX-OP-01)

| **PROYECTO** | **ID OPERACI√ìN** | **REVISI√ìN** | **RESPONSABLE** |
| :---              | :---              | :---         | :---                   |
| GelMexSys 2.0 ERP | OP-001-SETUP      | 1.1 (Fix)    | Ing. Mario E. Mart√≠nez |

## 1. OBJETIVO DE LA OPERACI√ìN
Estandarizar el procedimiento de "Rearme Inicial" y configuraci√≥n del entorno de desarrollo, asegurando la vinculaci√≥n expl√≠cita a la versi√≥n correcta de Python (3.12) y la gesti√≥n de dependencias sin conflictos.

## 2. ESPECIFICACIONES DE ENTRADA (SNAPSHOT)
El sistema ha sido validado bajo los siguientes par√°metros cr√≠ticos. **No proceder si no se cumplen.**

| Par√°metro     | Valor Especificado    | Criterio de Aceptaci√≥n      |
| :-------------| :-------------------- | :-------------------------- |
| **S.O.** | Windows 10/11 (x64)   | Sistema Host Operativo      |
| **Git Core** | **v2.52.0.windows.1** | Hash de versi√≥n coincidente |
| **Python** | **C:\Python312** | Ruta Absoluta del Binario   |
| **Framework** | Flask (Modular)       | Instalaci√≥n limpia          |


## 3. SECUENCIA DE OPERACIONES
### OP 10: Instalaci√≥n de Herramientas Base
**Descripci√≥n:** Preparaci√≥n del entorno host.
1. Descargar instalador certificado desde [git-scm.com](https://git-scm.com/).
2. Ejecutar instalaci√≥n est√°ndar (Default Settings).
3. **Punto de Control (Inspecci√≥n):** Ejecutar comando de validaci√≥n.
   powershell
   git --version
   # SALIDA ESPERADA: git version 2.52.0.windows.1

### OP 20: Configuraci√≥n de Identidad (Gafete Digital)
**Descripci√≥n:** Asignaci√≥n de trazabilidad al usuario.
1. Ejecutar en terminal:
powershell
git config --global user.name "edwared"
git config --global user.email "elektrion@gmail.com"

### OP 30: Inicializaci√≥n del Repositorio

**Descripci√≥n:** Activaci√≥n del control de cambios en el directorio de trabajo.

1. Iniciar rastreo:
powershell
git init


2. **Seguridad:** Crear archivo de bloqueo `.gitignore` con los siguientes filtros:
```text
venv/
__pycache__/
*.pyc
instance/
.env
*.db
app/static/uploads/

3. **L√≠nea Base:** Generar el primer punto de restauraci√≥n.
```powershell
git add .
git commit -m "Inicio: Estructura base y entorno virtual seg√∫n HOJA DE METODO OP-001"

### OP 40: Aprovisionamiento y Vinculaci√≥n de Entorno

**Descripci√≥n:** Creaci√≥n del contenedor aislado (VENV) forzando la ruta del ejecutable para evitar ambig√ºedad en Windows y carga de materiales.

1. **Creaci√≥n con Ruta Absoluta:**
Usar el operador de llamada `&` de PowerShell para invocar el ejecutable espec√≠fico y evitar errores de sintaxis.
powershell
& "C:\Python312\python.exe" -m venv venv

2. **Activaci√≥n (Punto Cr√≠tico):**
powershell
.\venv\Scripts\activate

*Verificaci√≥n Visual: Debe aparecer `(venv)` en verde al inicio de la terminal.*
3. **Validaci√≥n de Origen (Quality Gate):**
Asegurar que el sistema no est√° usando el Python de C:.
powershell
Get-Command python
# CRITERIO DE ACEPTACI√ìN: Source debe ser ".../GelMexSys2.0/venv/Scripts/python.exe"

4. **Definici√≥n de Lista de Materiales (BOM):**
Editar archivo `requirements.txt` con el siguiente contenido exacto para evitar conflictos de versiones:

Flask==3.0.0
python-dotenv==1.0.0
SQLAlchemy>=2.0.16
Flask-SQLAlchemy>=3.1.1


5. **Inyecci√≥n de Dependencias:**
powershell
pip install -r requirements.txt




## 4. DIAGRAMA DE ARQUITECTURA RESULTANTE

Al finalizar la operaci√≥n y ejecutar el script de estructura, el directorio debe coincidir con este patr√≥n:

GelMexSys2.0/
‚îú‚îÄ‚îÄ HOJA_DE_METODO_INICIAL.md  <-- Documento Maestro Actualizado
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ blueprints/            # L√≥gica (Controladores)
‚îÇ   ‚îú‚îÄ‚îÄ models/                # Datos (ORM)
‚îÇ   ‚îú‚îÄ‚îÄ static/                # Assets
‚îÇ   ‚îú‚îÄ‚îÄ templates/             # Vistas
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py            # App Factory
‚îú‚îÄ‚îÄ instance/                  # BD Local
‚îú‚îÄ‚îÄ run.py                     # Entry Point
‚îî‚îÄ‚îÄ requirements.txt           # BOM Certificado


# GU√çA T√âCNICA: DESPLIEGUE DE MOTOR DE BASE DE DATOS (GMX-DB-01)

### PASO 1: Descarga e Instalaci√≥n

1. Ve al sitio oficial: [https://www.postgresql.org/download/windows/](https://www.postgresql.org/download/windows/)
2. Dale clic en **"Download the installer"**.
3. Elige la versi√≥n **16.x** (es la m√°s estable ahorita) para Windows x86-64.
4. Ejecuta el instalador.

**Durante la instalaci√≥n (OJO AQU√ç):**

* **Componentes:** Aseg√∫rate de que est√©n marcados:
* [x] PostgreSQL Server
* [x] pgAdmin 4 (Este es el panel visual para administrar, indispensable).
* [x] Command Line Tools


* **Directorio:** D√©jalo por defecto.
* **Contrase√±a (CR√çTICO):** Te va a pedir una contrase√±a para el "Superusuario (postgres)".
* ‚ö†Ô∏è **Escr√≠bela:** Ponle `admin` o `123456` por ahora para desarrollo local. **No la olvides**, porque sin ella no podemos conectar Python.


* **Puerto:** D√©jalo en `5432` (Est√°ndar).
* **Locale:** D√©jalo por defecto (Default locale).

Dale "Siguiente" a todo hasta que termine.

---

### PASO 2: Crear la Base de Datos "gelmex_db"

Ya instalado, no vamos a usar consola negra, vamos a usar lo visual.

1. Presiona la tecla `Windows` y busca **pgAdmin 4**. √Åbrelo (es el icono del elefante).
2. Te va a pedir la contrase√±a que acabas de crear. P√≥nsela.
3. A la izquierda ver√°s `Servers` -> `PostgreSQL 16`. Dale doble clic para conectar.
4. Dale **clic derecho** sobre "Databases" -> **Create** -> **Database...**
5. En el nombre ponle: **`gelmex_db`** (Todo min√∫sculas).
6. Dale **Save**.

¬°Listo! Ya tienes el contenedor vac√≠o esperando los datos.

---

### PASO 3: Conectar Flask a PostgreSQL

Ahora hay que decirle a tu c√≥digo: "Oye, deja de usar SQLite y con√©ctate al Postgres que acabamos de instalar".

1. Abre tu archivo **`config.py`** en VS Code.
2. Busca la clase `DevelopmentConfig`.
3. Modifica la l√≠nea `SQLALCHEMY_DATABASE_URI`.

Debe quedar as√≠ (cambia `TU_CONTRASE√ëA` por la que pusiste en el instalador):

```python
class DevelopmentConfig(Config):
    DEBUG = True
    # Conexi√≥n a PostgreSQL Local
    # Formato: postgresql://usuario:password@localhost:puerto/nombre_db
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'postgresql://postgres:TU_CONTRASE√ëA@localhost:5432/gelmex_db'

```

*Nota: Si tu contrase√±a es `admin`, la l√≠nea queda: `'postgresql://postgres:admin@localhost:5432/gelmex_db'*`

---

### PASO 4: Instalar el Driver

Para que Python hable con Postgres, necesita un traductor. Ejecuta esto en tu terminal (con el `(venv)` activo):

```powershell
pip install psycopg2-binary

```

---

### PASO 5: Generar las Tablas (La Prueba de Fuego)

Ahora s√≠, ya con el motor instalado, la base creada y el c√≥digo conectado, vamos a crear las tablas.

Ejecuta tu archivo de arranque:

```powershell
python run.py

```

1. Si dice `Running on http://127.0.0.1:5000`, **EXITAZO**.
2. Para confirmar, ve a **pgAdmin 4**, ve a `gelmex_db` -> `Schemas` -> `public` -> `Tables`. Dale clic derecho y "Refresh".
3. Deber√≠as ver ah√≠ toda la lista: `almacenes`, `clientes`, `productos`, `usuarios`... ¬°Todas las tablas vac√≠as creadas por SQLAlchemy!


¬°Excelente iniciativa! Es el momento exacto para hacer un **Checkpoint (Commit)**. Acabamos de pasar de una "App Hola Mundo" a un **Sistema ERP con Arquitectura de Datos Enterprise conectada a PostgreSQL**.

Si algo se rompe ma√±ana, necesitamos poder volver a este punto exacto donde todo funciona (Tablas creadas + Conexi√≥n Exitosa).

Aqu√≠ tienes el procedimiento para ejecutar la **OP-50 (Control de Cambios)** siguiendo tu est√°ndar.

---

### OP 50: Aseguramiento de Versi√≥n (Git Commit)

**Descripci√≥n:** Consolidaci√≥n de la Arquitectura de Datos, Modelos ORM y conexi√≥n a motor de base de datos.

**1. Verificar el Estado (Reconocimiento)**
Primero, vamos a ver todo lo que Git detect√≥ que cambiamos (Modelos, Config, Seeds, etc.). Ejecuta en tu terminal:

```powershell
git status

```

*Deber√≠as ver en rojo (o verde si ya agregaste algo) archivos como `app/models/`, `db_seeds/`, `config.py`, `setup_db.py`, etc.*

**2. Preparar el Paquete (Staging)**
Vamos a subir todo al √°rea de preparaci√≥n.

```powershell
git add .

```

**3. Ejecutar el Commit (Guardado)**
Este es el comando clave. Copia y pega este mensaje para que quede profesional y descriptivo en el historial:

```powershell
git commit -m "Feat: Implementacion Arquitectura de Datos PostgreSQL y Modelos ORM

- Configuracion de conexion a PostgreSQL en config.py (GMX-DB-01).
- Creacion de Modelos Maestros: Catalogos, Usuarios, Productos, Clientes, Infraestructura.
- Integracion de script de sembrado de datos (seed_runner.py) y diccionarios de datos.
- Instalacion de driver psycopg2-binary.
- Validacion de creacion de tablas en pgAdmin 4."

```

---

### Actualizaci√≥n de tu Documentaci√≥n

Para mantener tu **HOJA DE M√âTODO (GMX-OP-01)** actualizada con lo que acabamos de hacer, aqu√≠ tienes el bloque que debes agregar al final de tu documento de texto para cerrar el ciclo de la "Revisi√≥n 1.1":

#### OP 60: Integraci√≥n de Motor de Datos (Post-Deployment)

**Descripci√≥n:** Vinculaci√≥n del entorno de aplicaci√≥n con el servidor de datos persistente.

1. **Instalaci√≥n de Driver:**
```powershell
pip install psycopg2-binary

```


2. **Configuraci√≥n de Enlace:**
Editar `config.py` para apuntar a `postgresql://postgres:***@localhost:5432/gelmex_db`.
3. **Despliegue de Esquema:**
Ejecutar script de diagn√≥stico y construcci√≥n:
```powershell
python setup_db.py

```


*Criterio de Aceptaci√≥n: Mensaje "‚úÖ ¬°√âXITO! TABLAS CREADAS CORRECTAMENTE." y visualizaci√≥n de 34 tablas en pgAdmin.*

---



========================= FILE: .\init_production_table.py =========================
from app import create_app, db
# Importamos el modelo para que SQLAlchemy sepa que existe
from app.models.production import OrdenProduccion 

app = create_app()

with app.app_context():
    print("üîß Verificando tablas faltantes...")
    # Esto crea SOLO las tablas que no existen (ordenes_produccion)
    db.create_all()
    print("‚úÖ Tabla 'ordenes_produccion' creada exitosamente en PostgreSQL.")

========================= FILE: .\intrucciones git.txt =========================
1. Revisa qu√© vas a meter al horno
powershell
git status
*Deber√≠as ver en rojo (o verde si ya le diste add) archivos como `HOJA_DE_METODO_INICIAL.md`, `generate_context.py` y `requirements.txt`.*

2. Prepara todo el paquete
powershell
git add .

3. Sella el compromiso (Commit)
Este mensaje describe que arreglamos el relajo del entorno y las herramientas:
powershell
git commit -m "Fix: Correcci√≥n de entorno venv y actualizaci√≥n de herramientas de contexto"

Y listo, wey. Con eso ya qued√≥ guardado este avance.

========================= FILE: .\requirements.txt =========================
Flask==3.0.0
python-dotenv==1.0.0
SQLAlchemy>=2.0.16
Flask-SQLAlchemy>=3.1.1

========================= FILE: .\run.py =========================
# run.py
import os
from app import create_app

config_name = os.getenv('FLASK_CONFIG') or 'default'
app = create_app(config_name)

if __name__ == '__main__':
    print(f"--> Arrancando GelMexSys en modo: {config_name}")
    print("--> ACCESO EXTERNO HABILITADO: Usa tu IP para entrar desde el cel.")
    
    # AGREGAMOS host='0.0.0.0'
    app.run(host='0.0.0.0', port=5000)

========================= FILE: .\seed_runner.py =========================
# seed_runner.py
from app import create_app
from app.extensions import db
from werkzeug.security import generate_password_hash

# --- IMPORTAR MODELOS ---
from app.models.catalogs import *
from app.models.users import Usuario
from app.models.infrastructure import Almacen, UbicacionAlmacen, RutaReparto
from app.models.products import Producto, MateriaPrima
from app.models.clients import Cliente, PrecioEspecialCliente

# --- IMPORTAR DATOS (Nombres Corregidos) ---
from db_seeds.data_catalogs import CATALOGOS
from db_seeds.data_infrastructure import ALMACENES, RUTAS
from db_seeds.data_products import PRODUCTOS, MATERIAS_PRIMAS
from db_seeds.data_users import USUARIOS
from db_seeds.data_clients import CLIENTES

app = create_app()

def run_seeds():
    with app.app_context():
        print("üå± INICIANDO SEMBRADO DE DATOS GELMEXSYS 2.0...")
        
        # 1. CAT√ÅLOGOS
        print("--> Sembrando Cat√°logos...")
        mapa_catalogos = {
            "cat_plantas": CatPlanta, "cat_areas": CatArea, "cat_ubicaciones": CatUbicacion,
            "cat_unidades_medida": CatUnidadMedida, "cat_categorias_producto": CatCategoriaProducto,
            "cat_categorias_materia_prima": CatCategoriaMateriaPrima, "cat_tipos_almacen": CatTipoAlmacen,
            "cat_tipos_movimiento_almacen": CatTipoMovimientoAlmacen, "cat_puestos": CatPuesto,
            "cat_tipos_vehiculo": CatTipoVehiculo, "cat_estados_fisicos": CatEstadoFisico,
            "cat_conceptos_finanzas": CatConceptoFinanzas, "cat_tipos_incidencia": CatTipoIncidencia,
            "cat_bancos_cajas": CatBancoCaja, "cat_tipos_descuento": CatTipoDescuento,
            "cat_tipos_pago_solicitado": CatTipoPagoSolicitado, "cat_estados_orden_venta": CatEstadoOrdenVenta,
            "cat_estados_plan_produccion": CatEstadoPlanProduccion, "cat_estados_orden_empaque": CatEstadoOrdenEmpaque,
            "cat_tipos_movimiento_finanzas": CatTipoMovimientoFinanzas, "cat_estados_deuda_empresa": CatEstadoDeudaEmpresa,
            "cat_tipos_flujo": CatTipoFlujo, "cat_origenes_flujo": CatOrigenFlujo, "cat_periodos": CatPeriodo
        }

        for tabla_key, modelo in mapa_catalogos.items():
            datos = CATALOGOS.get(tabla_key, [])
            for item in datos:
                # B√∫squeda flexible (por descripci√≥n o nombre)
                criterio = {}
                if hasattr(modelo, 'descripcion'): criterio['descripcion'] = item['descripcion']
                elif hasattr(modelo, 'nombre'): criterio['nombre'] = item['nombre']
                
                if not modelo.query.filter_by(**criterio).first():
                    db.session.add(modelo(**item))
        db.session.commit()

        # 2. INFRAESTRUCTURA
        print("--> Sembrando Infraestructura...")
        for r in RUTAS:
            if not RutaReparto.query.filter_by(descripcion=r['descripcion']).first():
                db.session.add(RutaReparto(**r))
        db.session.commit()

        for alm in ALMACENES:
            if not Almacen.query.filter_by(descripcion=alm['descripcion']).first():
                tipo = CatTipoAlmacen.query.filter_by(nombre=alm['tipo']).first()
                planta = CatPlanta.query.filter_by(descripcion=alm['planta']).first()
                # B√∫squeda parcial para √Årea
                area = CatArea.query.filter(CatArea.descripcion.ilike(f"%{alm['area']}%")).first()
                
                if tipo and planta and area:
                    nuevo = Almacen(descripcion=alm['descripcion'], tipo_id=tipo.id, planta_id=planta.id, area_id=area.id)
                    db.session.add(nuevo)
                    db.session.commit()
                    for ubi in alm['ubicaciones']:
                        db.session.add(UbicacionAlmacen(codigo=ubi['codigo'], notas=ubi['notas'], almacen_id=nuevo.id))
        db.session.commit()

        # 3. PRODUCTOS
        print("--> Sembrando Inventario Maestro...")
        for p in PRODUCTOS:
            if not Producto.query.filter_by(sku=p['sku']).first():
                cat = CatCategoriaProducto.query.filter_by(nombre=p['categoria']).first()
                uni = CatUnidadMedida.query.filter_by(nombre=p['unidad']).first()
                if cat and uni:
                    # Quitamos campos que no son columnas directas
                    data = {k: v for k, v in p.items() if k not in ['categoria', 'unidad', 'imagen']}
                    prod = Producto(**data)
                    prod.categoria_id, prod.unidad_id = cat.id, uni.id
                    prod.imagen_producto = p.get('imagen')
                    db.session.add(prod)
        
        for mp in MATERIAS_PRIMAS:
            if not MateriaPrima.query.filter_by(sku=mp['sku']).first():
                cat = CatCategoriaMateriaPrima.query.filter_by(nombre=mp['categoria']).first()
                uni = CatUnidadMedida.query.filter_by(nombre=mp['unidad']).first()
                if cat and uni:
                    data = {k: v for k, v in mp.items() if k not in ['categoria', 'unidad', 'imagen']}
                    mat = MateriaPrima(**data)
                    mat.categoria_id, mat.unidad_id = cat.id, uni.id
                    mat.imagen_materia = mp.get('imagen')
                    db.session.add(mat)
        db.session.commit()

        # 4. USUARIOS
        print("--> Sembrando Usuarios...")
        for u in USUARIOS:
            if not Usuario.query.filter_by(email_acceso=u['email']).first():
                puesto = CatPuesto.query.filter_by(nombre=u['puesto']).first()
                data = u.copy()
                del data['password_raw'], data['puesto'], data['email']
                
                user = Usuario(**data)
                user.email_acceso = u['email']
                user.password_hash = generate_password_hash(u['password_raw'])
                if puesto: user.puesto_id = puesto.id
                db.session.add(user)
        db.session.commit()

        # 5. CLIENTES
        print("--> Sembrando Clientes...")
        for c in CLIENTES:
            if not Cliente.query.filter_by(nombre_negocio=c['nombre_negocio']).first():
                ruta = RutaReparto.query.filter_by(descripcion=c['ruta_asignada']).first()
                data = c.copy()
                precios = data.pop('precios_especiales', [])
                del data['ruta_asignada']
                
                cte = Cliente(**data)
                if ruta: cte.ruta_id = ruta.id
                db.session.add(cte)
                db.session.commit()

                for pe in precios:
                    prod = Producto.query.filter_by(sku=pe['producto_sku']).first()
                    td = CatTipoDescuento.query.filter_by(descripcion=pe['tipo_descuento']).first()
                    if prod and td:
                        db.session.add(PrecioEspecialCliente(cliente_id=cte.id, producto_id=prod.id, tipo_descuento_id=td.id, valor_descuento=pe['valor']))
        db.session.commit()
        
        print("\n‚úÖ ¬°SEMBRADO COMPLETADO! La base de datos tiene vida.")

if __name__ == "__main__":
    try:
        run_seeds()
    except Exception as e:
        print(f"‚ùå ERROR: {e}")

========================= FILE: .\setup_db.py =========================
# setup_db.py
import sys
import os

# Agregamos el directorio actual al path para evitar errores de m√≥dulos
sys.path.append(os.getcwd())

from app import create_app
from app.extensions import db

def init_database():
    print("--> Inicializando aplicaci√≥n Flask...")
    # 1. Instanciamos la app AQU√ç ADENTRO para evitar el error de variable
    app = create_app()

    with app.app_context():
        print("üîß INICIANDO CONSTRUCCI√ìN DE BASE DE DATOS...")
        print(f"--> Destino: {app.config['SQLALCHEMY_DATABASE_URI']}")
        
        try:
            # 2. Importar Modelos (Esto fuerza a SQLAlchemy a reconocer las tablas)
            print("--> Leyendo planos (Modelos)...")
            # Importamos dentro del contexto para asegurar que db est√© listo
            from app.models import catalogs
            from app.models import users
            from app.models import infrastructure
            from app.models import products
            from app.models import clients
            print("    [OK] Modelos cargados en memoria.")

            # 3. Crear Tablas
            print("--> Ejecutando CREATE TABLE en PostgreSQL...")
            db.create_all()
            
            print("-" * 40)
            print("‚úÖ ¬°√âXITO! TABLAS CREADAS CORRECTAMENTE.")
            print("-" * 40)
            print("Instrucciones:")
            print("1. Ve a pgAdmin 4.")
            print("2. Dale clic derecho a 'Tables' -> Refresh.")
            print("3. Si ves la lista de tablas, ejecuta 'python seed_runner.py' para llenar los datos.")
            
        except Exception as e:
            print("\n‚ùå ERROR CR√çTICO AL CONECTAR CON LA BD:")
            print(f"{e}")
            print("\nPOSIBLES CAUSAS:")
            print("1. La contrase√±a en config.py est√° mal.")
            print("2. El servidor de PostgreSQL no est√° corriendo.")
            print("3. La base de datos 'gelmex_db' no existe (Cr√©ala en pgAdmin).")

if __name__ == "__main__":
    init_database()

========================= FILE: .\setup_structure.py =========================
import os
import pathlib

# --- CONFIGURACI√ìN DEL BLUEPRINT (ESPECIFICACI√ìN DE ARQUITECTURA) ---
# Definimos la estructura exacta aprobada en la Hoja de M√©todo
PROJECT_STRUCTURE = {
    "directories": [
        "app",
        "app/blueprints",   # Controladores
        "app/models",       # Base de Datos
        "app/static",       # Assets P√∫blicos
        "app/static/css",
        "app/static/js",
        "app/static/img",
        "app/templates",    # Vistas HTML
        "instance"          # DB Local (Protegida)
    ],
    "files": [
        "app/__init__.py",              # Inicializador del Core
        "app/blueprints/__init__.py",   # Inicializador de Paquete
        "app/models/__init__.py",       # Inicializador de Paquete
        "run.py",                       # Entry Point
        "config.py",                    # Variables de Entorno
        "requirements.txt"              # Lista de materiales (BOM)
    ]
}

def create_structure():
    print(f"[ INFO ] Iniciando despliegue de arquitectura GelMexSys 2.0...")
    
    # 1. Crear Directorios
    for directory in PROJECT_STRUCTURE["directories"]:
        path = pathlib.Path(directory)
        if not path.exists():
            os.makedirs(path)
            print(f"[ OK ] Directorio creado: {directory}/")
        else:
            print(f"[ SKIP ] El directorio ya existe: {directory}/")

    # 2. Crear Archivos Vac√≠os (Touch)
    for file in PROJECT_STRUCTURE["files"]:
        path = pathlib.Path(file)
        if not path.exists():
            # Crear archivo vac√≠o
            with open(path, 'w') as f:
                pass 
            print(f"[ OK ] Archivo base generado: {file}")
        else:
            print(f"[ SKIP ] El archivo ya existe: {file}")

    print("-" * 40)
    print(f"[ FIN ] Despliegue de estructura completado con √©xito.")

if __name__ == "__main__":
    create_structure()

========================= FILE: .\update_db_real.py =========================
from app import create_app, db
from sqlalchemy import text

app = create_app()

with app.app_context():
    print("üîß Actualizando tabla de √ìrdenes de Producci√≥n...")
    try:
        # 1. Columna para lo que REALMENTE sali√≥ de la m√°quina
        db.session.execute(text("ALTER TABLE ordenes_produccion ADD COLUMN cantidad_producida_real FLOAT DEFAULT 0;"))
        print("‚úÖ Columna 'cantidad_producida_real' agregada.")
    except Exception as e:
        print(f"‚ÑπÔ∏è Aviso: {e}")

    try:
        # 2. Columna para notas del Maestro (Excusas de por qu√© sali√≥ menos)
        db.session.execute(text("ALTER TABLE ordenes_produccion ADD COLUMN notas_produccion TEXT;"))
        print("‚úÖ Columna 'notas_produccion' agregada.")
    except Exception as e:
        print(f"‚ÑπÔ∏è Aviso: {e}")
        
    db.session.commit()
    print("üöÄ Base de datos lista para la Realidad Operativa.")

========================= FILE: .\app\extensions.py =========================
# app/extensions.py
from flask_sqlalchemy import SQLAlchemy

# Inicializamos el objeto db sin la app todav√≠a (Lazy Loading)
db = SQLAlchemy()

========================= FILE: .\app\forms.py =========================
# app/forms.py
from flask_wtf import FlaskForm
from wtforms import StringField, DecimalField, SelectField, FileField, SubmitField, IntegerField
from wtforms.validators import DataRequired, NumberRange, Length
from flask_wtf.file import FileAllowed

class ProductoForm(FlaskForm):
    sku = StringField('SKU / C√≥digo', validators=[DataRequired(), Length(max=50)])
    descripcion = StringField('Nombre del Producto', validators=[DataRequired(), Length(max=200)])
    
    # Los SelectField (Combos) se llenan din√°micamente en el controlador
    categoria_id = SelectField('Categor√≠a', coerce=int, validators=[DataRequired()])
    unidad_id = SelectField('Unidad de Medida', coerce=int, validators=[DataRequired()])
    
    precio_costo = DecimalField('Costo Producci√≥n ($)', places=2, validators=[NumberRange(min=0)])
    precio_venta = DecimalField('Precio Venta ($)', places=2, validators=[DataRequired(), NumberRange(min=0)])
    
    stock_minimo = IntegerField('Stock M√≠nimo (Alerta)', validators=[NumberRange(min=0)], default=10)
    
    imagen = FileField('Foto del Producto', validators=[
        FileAllowed(['jpg', 'png', 'jpeg'], 'Solo im√°genes JPG o PNG')
    ])
    
    submit = SubmitField('Guardar Producto')

========================= FILE: .\app\__init__.py =========================
# app/__init__.py
from flask import Flask
from config import config
from app.extensions import db
from flask_login import LoginManager # <--- 1. Importar

def create_app(config_name='default'):
    app = Flask(__name__)
    app.config.from_object(config[config_name])

    db.init_app(app)

    # --- CONFIGURACI√ìN DE LOGIN (NUEVO) ---
    login_manager = LoginManager()
    login_manager.login_view = 'auth.login' # A d√≥nde ir si no est√°s logueado
    login_manager.login_message = "Debes iniciar sesi√≥n para acceder a este sistema."
    login_manager.login_message_category = "warning"
    login_manager.init_app(app)

    # Funci√≥n para cargar usuario desde la Cookie
    from app.models.users import Usuario
    @login_manager.user_loader
    def load_user(user_id):
        return Usuario.query.get(int(user_id))
    # --------------------------------------

    with app.app_context():
        from app.models import catalogs, users, infrastructure, products, clients, stock, orders 
        db.create_all()

    # --- REGISTRO DE BLUEPRINTS ---
    from app.blueprints.api_test import api_bp
    app.register_blueprint(api_bp)

    from app.blueprints.home import home_bp
    app.register_blueprint(home_bp)

    from app.blueprints.auth import auth_bp
    app.register_blueprint(auth_bp)

    from app.blueprints.inventory import inventory_bp
    app.register_blueprint(inventory_bp)

    from app.blueprints.reception import reception_bp
    app.register_blueprint(reception_bp)

    from app.blueprints.sales import sales_bp
    app.register_blueprint(sales_bp)

    from app.blueprints.production import production_bp
    app.register_blueprint(production_bp)
   
    return app

========================= FILE: .\app\blueprints\api_test.py =========================
# app/blueprints/api_test.py
from flask import Blueprint, jsonify
from app.models.users import Usuario
from app.models.products import Producto
from app.models.clients import Cliente

# Definimos el "Mapa" de rutas para pruebas
api_bp = Blueprint('api_test', __name__, url_prefix='/api/v1')

@api_bp.route('/status', methods=['GET'])
def check_status():
    return jsonify({"status": "OK", "message": "GelMexSys 2.0 Backend Operativo", "db": "PostgreSQL"})

@api_bp.route('/usuarios', methods=['GET'])
def get_usuarios():
    # Consulta real a la Base de Datos
    users = Usuario.query.all()
    # Convertimos los objetos de Python a lista de diccionarios (JSON)
    data = [{
        "id": u.id, 
        "nombre": f"{u.nombres} {u.apellido_paterno}", 
        "email": u.email_acceso,
        "puesto": u.puesto.nombre if u.puesto else "Sin Asignar"
    } for u in users]
    return jsonify(data)

@api_bp.route('/productos', methods=['GET'])
def get_productos():
    prods = Producto.query.all()
    data = [{
        "sku": p.sku,
        "descripcion": p.descripcion,
        "precio_venta": float(p.precio_venta_general),
        "stock_actual": 0 # Ahorita est√° en 0 porque no hemos hecho entradas de almac√©n
    } for p in prods]
    return jsonify(data)

@api_bp.route('/clientes', methods=['GET'])
def get_clientes():
    clients = Cliente.query.all()
    data = []
    for c in clients:
        # Sacamos sus precios especiales
        precios = []
        for p_esp in c.precios_especiales:
            precios.append({
                "producto": p_esp.producto.descripcion,
                "descuento_tipo": p_esp.tipo_descuento.descripcion,
                "valor": float(p_esp.valor_descuento)
            })
            
        data.append({
            "negocio": c.nombre_negocio,
            "encargado": c.nombres_encargado,
            "precios_especiales": precios
        })
    return jsonify(data)

========================= FILE: .\app\blueprints\auth.py =========================
# app/blueprints/auth.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required, current_user
from app.models.users import Usuario

auth_bp = Blueprint('auth', __name__, url_prefix='/auth')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    # Si ya est√° logueado, lo mandamos directo al dashboard
    if current_user.is_authenticated:
        return redirect(url_for('home.dashboard'))

    if request.method == 'POST':
        email_form = request.form.get('email')
        password_form = request.form.get('password')
        
        # 1. Buscar usuario en DB
        usuario = Usuario.query.filter_by(email_acceso=email_form).first()
        
        # 2. Validar que exista y que la contrase√±a sea correcta
        if usuario and usuario.check_password(password_form):
            login_user(usuario) # Crear la sesi√≥n (Cookie)
            flash(f'¬°Bienvenido de nuevo, {usuario.nombres}!', 'success')
            
            # Redirigir a donde quer√≠a ir o al dashboard
            next_page = request.args.get('next')
            return redirect(next_page or url_for('home.dashboard'))
        else:
            flash('Correo o contrase√±a incorrectos. Intenta de nuevo.', 'danger')
        
    return render_template('auth/login.html')

@auth_bp.route('/logout')
@login_required # Solo si est√°s logueado puedes salir
def logout():
    logout_user()
    flash('Has cerrado sesi√≥n correctamente.', 'info')
    return redirect(url_for('auth.login'))

========================= FILE: .\app\blueprints\home.py =========================
# app/blueprints/home.py
from flask import Blueprint, render_template
from flask_login import login_required, current_user # <--- 1. IMPORTAR ESTO

home_bp = Blueprint('home', __name__)

@home_bp.route('/')
@home_bp.route('/dashboard')
@login_required # <--- 2. ESTE ES EL CANDADO (Si no hay login, no pasa)
def dashboard():
    # Pasamos el usuario actual a la plantilla (aunque Flask-Login ya lo hace globalmente)
    return render_template('home/index.html', user=current_user)

========================= FILE: .\app\blueprints\inventory.py =========================
import os
from flask import Blueprint, render_template, redirect, url_for, flash, current_app, request
from flask_login import login_required, current_user
from werkzeug.utils import secure_filename
from app.extensions import db
from datetime import datetime

# Importaci√≥n de Modelos
from app.models.products import Producto
from app.models.catalogs import CatCategoriaProducto, CatUnidadMedida, CatTipoMovimientoAlmacen
from app.models.stock import InventarioProducto, HistorialMovimiento
from app.models.infrastructure import Almacen, UbicacionAlmacen
from app.forms import ProductoForm 

inventory_bp = Blueprint('inventory', __name__, url_prefix='/inventario')

# --- RUTAS DE CAT√ÅLOGO (Index y Nuevo Producto) ---
@inventory_bp.route('/')
@inventory_bp.route('/lista')
@login_required
def index():
    productos = Producto.query.all()
    # CAMBIO AQU√ç: De 'list.html' a 'catalog_list.html'
    return render_template('inventory/catalog_list.html', productos=productos)

@inventory_bp.route('/nuevo', methods=['GET', 'POST'])
@login_required
def create():
    form = ProductoForm()
    form.categoria_id.choices = [(c.id, c.nombre) for c in CatCategoriaProducto.query.all()]
    form.unidad_id.choices = [(u.id, u.nombre) for u in CatUnidadMedida.query.all()]

    if form.validate_on_submit():
        sku = form.sku.data.upper()
        if Producto.query.filter_by(sku=sku).first():
            flash(f'Error: El SKU {sku} ya existe.', 'danger')
            return render_template('inventory/form.html', form=form, title="Nuevo Producto")

        filename = None
        if form.imagen.data:
            file = form.imagen.data
            filename = secure_filename(sku + "_" + file.filename)
            upload_path = os.path.join(current_app.root_path, 'static/uploads/productos')
            os.makedirs(upload_path, exist_ok=True)
            file.save(os.path.join(upload_path, filename))
            filename = f"uploads/productos/{filename}"

        nuevo_prod = Producto(
            sku=sku,
            descripcion=form.descripcion.data,
            categoria_id=form.categoria_id.data,
            unidad_id=form.unidad_id.data,
            precio_costo_actual=form.precio_costo.data,
            precio_venta_general=form.precio_venta.data,
            stock_minimo=form.stock_minimo.data,
            imagen_producto=filename
        )
        db.session.add(nuevo_prod)
        db.session.commit()
        flash(f'Producto "{nuevo_prod.descripcion}" creado.', 'success')
        return redirect(url_for('inventory.index'))

    return render_template('inventory/form.html', form=form, title="Nuevo Producto")

# --- CONSOLA DE MOVIMIENTOS (ALMACENISTA) ---
@inventory_bp.route('/movimientos', methods=['GET', 'POST'])
@login_required
def movimientos():
    # Cargas para los selectores
    productos = Producto.query.order_by(Producto.descripcion).all()
    almacenes = Almacen.query.all()
    ubicaciones = UbicacionAlmacen.query.all() # Necesario para el filtro de JS
    tipos_movimiento = CatTipoMovimientoAlmacen.query.all()
    
    if request.method == 'POST':
        try:
            # 1. Datos del Formulario
            producto_id = int(request.form.get('producto_id'))
            
            # Validaci√≥n de Ubicaci√≥n (Vital)
            ubicacion_id_raw = request.form.get('ubicacion_id')
            if not ubicacion_id_raw:
                flash('Error: Debes seleccionar una ubicaci√≥n exacta (Pasillo/Rack).', 'danger')
                return redirect(url_for('inventory.movimientos'))
            ubicacion_id = int(ubicacion_id_raw)

            cantidad = float(request.form.get('cantidad'))
            tipo_mov_id = int(request.form.get('tipo_movimiento_id'))
            notas = request.form.get('notas')

            # Obtenemos el objeto del cat√°logo para saber qu√© hacer
            tipo_obj = CatTipoMovimientoAlmacen.query.get(tipo_mov_id)
            desc_mov = tipo_obj.descripcion.upper()

            # 2. Buscar Inventario
            stock_record = InventarioProducto.query.filter_by(
                producto_id=producto_id,
                ubicacion_id=ubicacion_id
            ).first()

            saldo_anterior = stock_record.cantidad_actual if stock_record else 0
            
            # Si no existe registro, lo creamos en 0 para operar sobre √©l
            if not stock_record:
                stock_record = InventarioProducto(
                    producto_id=producto_id,
                    ubicacion_id=ubicacion_id,
                    cantidad_actual=0,
                    fecha_ingreso_almacen=datetime.now()
                )
                db.session.add(stock_record)

            # 3. L√≥gica de Negocio BLINDADA
            if "INICIAL" in desc_mov: 
                # MODO RESET: Ignora lo que hab√≠a, pone lo que dices.
                # ESTO CORRIGE TU SALDO NEGATIVO AUTOM√ÅTICAMENTE
                stock_record.cantidad_actual = cantidad 
                
            elif "ENTRADA" in desc_mov or "DEVOLUCION" in desc_mov or "PRODUCCION" in desc_mov:
                # MODO SUMA
                stock_record.cantidad_actual += cantidad
                
            elif "SALIDA" in desc_mov or "MERMA" in desc_mov or "AJUSTE" in desc_mov:
                # MODO RESTA (Con validaci√≥n)
                if stock_record.cantidad_actual < cantidad:
                    db.session.rollback()
                    flash(f'‚õî ERROR: No tienes suficiente stock. Tienes {stock_record.cantidad_actual} y quieres sacar {cantidad}.', 'danger')
                    return redirect(url_for('inventory.movimientos'))
                
                stock_record.cantidad_actual -= cantidad

            # 4. Evidencia en K√°rdex
            kardex = HistorialMovimiento(
                producto_id=producto_id,
                ubicacion_id=ubicacion_id,
                tipo_movimiento=desc_mov,
                cantidad=cantidad,
                usuario_id=current_user.id,
                fecha=datetime.now(),
                notas=f"{notas} | Saldo: {saldo_anterior} -> {stock_record.cantidad_actual}"
            )
            db.session.add(kardex)
            
            db.session.commit()
            flash(f'‚úÖ Movimiento registrado: {desc_mov}. Nuevo Saldo: {stock_record.cantidad_actual}', 'success')
            
        except Exception as e:
            db.session.rollback()
            flash(f'‚ùå Error t√©cnico: {str(e)}', 'danger')

    return render_template('inventory/movements.html', 
                           productos=productos, 
                           almacenes=almacenes,
                           ubicaciones=ubicaciones,
                           tipos_movimiento=tipos_movimiento,
                           now=datetime.now())

========================= FILE: .\app\blueprints\production.py =========================
import os
import uuid  # <--- CORRECCI√ìN CLAVE: Para generar c√≥digos √∫nicos y evitar el error de llave duplicada
from flask import Blueprint, render_template, redirect, url_for, flash, request, current_app
from flask_login import login_required, current_user
from datetime import datetime
from app.extensions import db
from sqlalchemy import func

# --- IMPORTACI√ìN DE MODELOS ---
from app.models.products import Producto 
from app.models.production import OrdenProduccion
from app.models.stock import InventarioProducto
from app.models.users import Usuario
from app.models.orders import OrdenVenta, OrdenVentaDetalle

production_bp = Blueprint('production', __name__, url_prefix='/produccion')

# --- 1. TABLERO DE NECESIDADES (DASHBOARD PRINCIPAL) ---
@production_bp.route('/tablero-necesidades')
@login_required
def tablero_necesidades():
    productos = Producto.query.order_by(Producto.descripcion).all()
    data_tablero = []
    
    # Contadores para el estado general del sistema
    conteo_criticos = 0
    conteo_recuperar = 0

    for p in productos:
        # A. Existencia F√≠sica (Lo que ya est√° guardado en ubicaciones)
        inventarios = InventarioProducto.query.filter_by(producto_id=p.id).all()
        cantidad_fisica = sum(i.cantidad_actual for i in inventarios)

        # B. En Proceso + En Tr√°nsito (Lo que viene en camino)
        # Sumamos: SOLICITADA (Espera), EN_PRODUCCION/BATIENDO (Cocina), POR_RECIBIR (Puerta Almac√©n)
        ordenes_activas = OrdenProduccion.query.filter(
            OrdenProduccion.producto_id == p.id,
            OrdenProduccion.estatus.in_(['SOLICITADA', 'EN_PRODUCCION', 'BATIENDO', 'POR_RECIBIR'])
        ).all()
        
        # Si ya se report√≥ producci√≥n real (POR_RECIBIR), usamos ese dato. Si no, usamos lo estimado.
        cantidad_en_camino = 0
        for o in ordenes_activas:
            if o.estatus == 'POR_RECIBIR' and o.cantidad_producida_real > 0:
                cantidad_en_camino += o.cantidad_producida_real
            else:
                cantidad_en_camino += o.cantidad

        # C. Ventas Comprometidas (Lo que ya se vendi√≥ pero no ha salido)
        ventas_pendientes = db.session.query(func.sum(OrdenVentaDetalle.cantidad_pedida))\
            .join(OrdenVenta)\
            .filter(OrdenVentaDetalle.producto_id == p.id)\
            .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_RUTA']))\
            .scalar() or 0

        # D. C√°lculo MRP (Disponible Real)
        stock_disponible_real = cantidad_fisica - ventas_pendientes
        
        meta = p.stock_ideal if p.stock_ideal else 0
        # F√≥rmula: Meta - (Lo que tengo libre + Lo que viene en camino)
        a_fabricar = meta - (stock_disponible_real + cantidad_en_camino)

        # E. Sem√°foros Visuales
        if a_fabricar <= 0:
            a_fabricar = 0 
            if stock_disponible_real >= meta:
                estado = "SURTIDO"
                clase_estado = "success" # Verde
            else:
                estado = "EN CAMINO" # Azul (Ya viene en camino suficiente)
                clase_estado = "info" 
        else:
            if stock_disponible_real <= 0:
                estado = "CR√çTICO" # Debes m√°s de lo que tienes
                clase_estado = "danger"
                conteo_criticos += 1
            else:
                estado = "RECUPERAR" # Hay stock, pero bajo
                clase_estado = "warning"
                conteo_recuperar += 1

        data_tablero.append({
            'id': p.id,
            'sku': p.sku,
            'descripcion': p.descripcion,
            'existencia': cantidad_fisica,
            'comprometido': ventas_pendientes,
            'disponible': stock_disponible_real,
            'en_proceso': cantidad_en_camino,
            'meta': meta,
            'a_fabricar': a_fabricar,
            'estado': estado,
            'clase_estado': clase_estado
        })

    # F. Datos para el Encabezado
    total_ordenes_activas = OrdenProduccion.query.filter(
        OrdenProduccion.estatus.in_(['SOLICITADA', 'EN_PRODUCCION', 'BATIENDO'])
    ).count()

    if conteo_criticos > 0:
        estado_sys = "ALERTA CR√çTICA"
        clase_sys = "danger"
        accion_sys = "Producir Urgente"
    elif conteo_recuperar > 0:
        estado_sys = "PRECAUCI√ìN"
        clase_sys = "warning"
        accion_sys = "Programar Lotes"
    else:
        estado_sys = "ESTABLE"
        clase_sys = "success"
        accion_sys = "Monitoreo"

    return render_template('production/dashboard.html', 
                           items=data_tablero, 
                           now=datetime.now(),
                           total_ordenes=total_ordenes_activas, 
                           estado_sys=estado_sys,
                           clase_sys=clase_sys,
                           accion_sys=accion_sys)

# --- 2. CREAR ORDEN (CON SOLUCI√ìN DE ERROR 'UNIQUEVIOLATION') ---
@production_bp.route('/crear-orden', methods=['POST'])
@login_required
def crear_orden():
    try:
        producto_id = int(request.form.get('producto_id'))
        cantidad = float(request.form.get('cantidad'))
        
        if cantidad <= 0:
            flash('Error: La cantidad debe ser mayor a 0.', 'danger')
            return redirect(url_for('production.tablero_necesidades'))

        # A. Blindaje Anti-Spam (Si ya hay una solicitada, no duplicar)
        orden_existente = OrdenProduccion.query.filter(
            OrdenProduccion.producto_id == producto_id,
            OrdenProduccion.estatus.in_(['SOLICITADA']) 
        ).first()

        if orden_existente:
            flash(f'‚ö†Ô∏è Ya existe una orden pendiente ({orden_existente.folio}).', 'warning')
            return redirect(url_for('production.tablero_necesidades'))

        # B. Generaci√≥n de Folio √önico (SOLUCI√ìN DEFINITIVA)
        # Usamos UUID para asegurar que NUNCA se repita, ni aunque borres la BD.
        # Formato: ORD-YYMMDD-IDPROD-XXXX (4 caracteres aleatorios)
        suffix = uuid.uuid4().hex[:4].upper()
        fecha_str = datetime.now().strftime('%y%m%d')
        folio_unico = f"ORD-{fecha_str}-{producto_id}-{suffix}"
        
        nueva_orden = OrdenProduccion(
            folio=folio_unico,
            producto_id=producto_id,
            cantidad=cantidad,
            usuario_solicita_id=current_user.id,
            fecha_solicitud=datetime.now(),
            estatus='SOLICITADA',
            prioridad='NORMAL'
        )

        db.session.add(nueva_orden)
        db.session.commit()
        
        flash(f'‚úÖ Orden {nueva_orden.folio} enviada correctamente.', 'success')

    except Exception as e:
        db.session.rollback()
        print(f"ERROR PRODUCCION: {str(e)}")
        flash(f'‚ùå Error al crear orden: {str(e)}', 'danger')

    return redirect(url_for('production.tablero_necesidades'))

# --- 3. VISTA DEL MAESTRO HELADERO ---
@production_bp.route('/ordenes-maestro')
@login_required
def ordenes_maestro():
    # Mostramos lo nuevo y lo que se est√° cocinando
    ordenes = OrdenProduccion.query.filter(
        OrdenProduccion.estatus.in_(['SOLICITADA', 'EN_PRODUCCION', 'BATIENDO'])
    ).order_by(OrdenProduccion.estatus.asc(), OrdenProduccion.fecha_solicitud.asc()).all()
    
    return render_template('production/orders_list.html', ordenes=ordenes)

# --- 4. CAMBIAR ESTATUS (SOLO INICIO) ---
@production_bp.route('/cambiar-estatus/<int:orden_id>/<string:nuevo_estatus>')
@login_required
def cambiar_estatus(orden_id, nuevo_estatus):
    orden = OrdenProduccion.query.get_or_404(orden_id)
    
    # Solo permitimos iniciar la producci√≥n aqu√≠. El cierre se hace por el modal.
    if nuevo_estatus == 'BATIENDO':
        orden.estatus = 'BATIENDO'
        orden.fecha_inicio = datetime.now()
        db.session.commit()
        flash(f'üî• Lote {orden.folio} iniciado. ¬°A cocinar!', 'info')
    
    return redirect(url_for('production.ordenes_maestro'))

# --- 5. REPORTAR PRODUCCI√ìN REAL (CIERRE DE LOTE) ---
@production_bp.route('/reportar-produccion', methods=['POST'])
@login_required
def reportar_produccion_real():
    try:
        orden_id = int(request.form.get('orden_id'))
        cantidad_real = float(request.form.get('cantidad_real'))
        notas = request.form.get('notas')

        orden = OrdenProduccion.query.get_or_404(orden_id)
        
        # Guardamos la realidad operativa
        orden.cantidad_producida_real = cantidad_real
        orden.notas_produccion = notas
        orden.fecha_termino = datetime.now()
        
        # CAMBIO IMPORTANTE:
        # No ponemos 'TERMINADA' todav√≠a. Ponemos 'POR_RECIBIR'.
        # Esto env√≠a la orden a la "puerta del almac√©n" para que el Almacenista la cuente.
        orden.estatus = 'POR_RECIBIR'
        
        db.session.commit()
        
        flash(f'‚úÖ Lote enviado a Almac√©n. Reportaste {cantidad_real} piezas. Pendiente de recepci√≥n.', 'success')

    except Exception as e:
        db.session.rollback()
        flash(f'‚ùå Error al reportar producci√≥n: {str(e)}', 'danger')

    return redirect(url_for('production.ordenes_maestro'))

========================= FILE: .\app\blueprints\reception.py =========================
from flask import Blueprint, render_template, redirect, url_for, flash, request
from flask_login import login_required, current_user
from datetime import datetime
from app.extensions import db

# Importaci√≥n de Modelos
from app.models.production import OrdenProduccion
from app.models.stock import InventarioProducto, HistorialMovimiento
from app.models.infrastructure import UbicacionAlmacen, Almacen 

reception_bp = Blueprint('reception', __name__, url_prefix='/recepcion')

# --- 1. TABLERO DE RECEPCI√ìN ---
@reception_bp.route('/')
@login_required
def index():
    # Filtramos las √≥rdenes activas (POR_RECIBIR)
    lotes_activos = OrdenProduccion.query.filter(
        OrdenProduccion.estatus.in_(['POR_RECIBIR'])
    ).all()
    
    # Traemos AMBOS cat√°logos para el filtro en cascada
    almacenes = Almacen.query.order_by(Almacen.descripcion).all()
    ubicaciones = UbicacionAlmacen.query.order_by(UbicacionAlmacen.codigo).all()
    
    # Renderizamos la vista con nombre √öNICO
    return render_template('reception/reception_dock.html', 
                           lotes=lotes_activos, 
                           almacenes=almacenes,
                           ubicaciones=ubicaciones)

# --- 2. PROCESAR EL INGRESO ---
@reception_bp.route('/confirmar', methods=['POST'])
@login_required
def confirmar():
    try:
        orden_id = int(request.form.get('orden_id'))
        # Recibimos el ID de la ubicaci√≥n exacta (dropdown hijo)
        ubicacion_id = int(request.form.get('ubicacion_id'))
        cantidad_ingresar = float(request.form.get('cantidad_ingresar'))
        forzar_cierre = request.form.get('forzar_cierre') == 'on'
        # Capturamos las notas del usuario
        notas_usuario = request.form.get('notas', '').strip()
        
        orden = OrdenProduccion.query.get_or_404(orden_id)
        
        # Validaciones
        if cantidad_ingresar < 0:
            flash('No puedes ingresar cantidades negativas.', 'warning')
            return redirect(url_for('reception.index'))

        # Solo permitimos 0 si se est√° cerrando la orden (Merma total del resto)
        if cantidad_ingresar == 0 and not forzar_cierre:
            flash('Si la cantidad es 0, debes marcar "Cerrar Orden" para indicar merma.', 'warning')
            return redirect(url_for('reception.index'))

        # A. ACTUALIZAR STOCK F√çSICO (Solo si hay cantidad > 0)
        if cantidad_ingresar > 0:
            inventario = InventarioProducto.query.filter_by(
                producto_id=orden.producto_id, 
                ubicacion_id=ubicacion_id
            ).first()

            if inventario:
                inventario.cantidad_actual += cantidad_ingresar
            else:
                nuevo_inv = InventarioProducto(
                    producto_id=orden.producto_id,
                    ubicacion_id=ubicacion_id,
                    cantidad_actual=cantidad_ingresar,
                    fecha_ingreso_almacen=datetime.now()
                )
                db.session.add(nuevo_inv)

        # B. ACTUALIZAR EL ACUMULADO DE LA ORDEN
        acumulado_previo = orden.cantidad_recibida_almacen or 0
        nuevo_acumulado = acumulado_previo + cantidad_ingresar
        orden.cantidad_recibida_almacen = nuevo_acumulado
        
        # C. GENERAR EVIDENCIA (K√ÅRDEX) CON NOTAS
        texto_historial = f"Ingreso ({cantidad_ingresar}). Acumulado: {nuevo_acumulado}/{orden.cantidad_producida_real}."
        if notas_usuario:
            texto_historial += f" | NOTA: {notas_usuario}"

        movimiento = HistorialMovimiento(
            producto_id=orden.producto_id,
            ubicacion_id=ubicacion_id,
            tipo_movimiento='ENTRADA_PRODUCCION',
            cantidad=cantidad_ingresar,
            usuario_id=current_user.id,
            fecha=datetime.now(),
            referencia=orden.folio,
            notas=texto_historial
        )
        db.session.add(movimiento)

        # D. L√ìGICA DE CIERRE (Super√°vit, Exacto o Merma)
        diferencia = orden.cantidad_producida_real - nuevo_acumulado
        
        # CASO 1: SUPER√ÅVIT (Sobrante positivo, diferencia negativa)
        if diferencia < -0.001:
            orden.estatus = 'TERMINADA'
            orden.fecha_termino = datetime.now()
            orden.notas_produccion = (orden.notas_produccion or "") + f" | SUPER√ÅVIT ALMAC√âN: {abs(diferencia)} pzas extra."
            flash(f"‚úÖ Lote completado con EXCEDENTE de {abs(diferencia)} pzas.", 'success')
            
        # CASO 2: EXACTO
        elif abs(diferencia) <= 0.001:
            orden.estatus = 'TERMINADA'
            orden.fecha_termino = datetime.now()
            flash(f"‚úÖ Lote {orden.folio} completado exacto.", 'success')
            
        # CASO 3: FALTANTE (MERMA) CON CIERRE FORZADO
        elif forzar_cierre:
            orden.estatus = 'TERMINADA'
            orden.fecha_termino = datetime.now()
            
            nota_cierre = f" | FALTANTE (MERMA): {diferencia}."
            if notas_usuario:
                nota_cierre += f" Causa: {notas_usuario}"
            
            orden.notas_produccion = (orden.notas_produccion or "") + nota_cierre
            flash(f"‚ö†Ô∏è Orden cerrada con faltante de {diferencia} pzas.", 'warning')
            
        # CASO 4: PARCIAL (Sigue abierta)
        else:
            flash(f"üì• Ingreso parcial guardado. Faltan {diferencia} pzas.", 'info')

        db.session.commit()

    except Exception as e:
        db.session.rollback()
        flash(f'‚ùå Error t√©cnico: {str(e)}', 'danger')

    return redirect(url_for('reception.index'))

========================= FILE: .\app\blueprints\sales.py =========================
from flask import Blueprint, render_template, request, jsonify
from flask_login import login_required, current_user
from app.extensions import db
from sqlalchemy import func

# Modelos
from app.models.clients import Cliente
from app.models.products import Producto
from app.models.orders import OrdenVenta, OrdenVentaDetalle
from datetime import datetime

sales_bp = Blueprint('sales', __name__, url_prefix='/ventas')

# --- 1. RUTA PARA CARGAR LA CONSOLA ---
@sales_bp.route('/preventa')
@login_required
def preventa():
    clientes = Cliente.query.all()
    productos_db = Producto.query.all()
    
    catalogo_js = []
    for p in productos_db:
        catalogo_js.append({
            "id": p.id,
            "sku": p.sku,
            "nombre": p.descripcion,
            "precio": float(p.precio_venta_general)
        })
        
    return render_template('sales/console.html', 
                           clientes=clientes, 
                           catalogo=catalogo_js,
                           date_now=datetime.now().strftime('%Y-%m-%d'))

# --- 2. API INTELIGENTE (CR√âDITO VIRTUAL) ---
@sales_bp.route('/api/cliente/<int:id>')
@login_required
def api_cliente(id):
    c = Cliente.query.get_or_404(id)
    
    # A. Deuda Contable
    deuda_contable = float(c.saldo_actual)

    # B. Deuda Virtual (Pedidos vivos)
    ventas_en_curso = db.session.query(func.sum(OrdenVenta.total_venta))\
        .filter(OrdenVenta.cliente_id == id)\
        .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_RUTA', 'EN_PRODUCCION', 'EMPACADO']))\
        .scalar() or 0.0
    
    ventas_en_curso = float(ventas_en_curso)

    # C. C√°lculo
    deuda_total_real = deuda_contable + ventas_en_curso
    limite = float(c.limite_credito)
    disponible_real = limite - deuda_total_real

    precios = {p.producto_id: float(p.valor_descuento) for p in c.precios_especiales}
    
    return jsonify({
        "limite_credito": limite,
        "saldo_actual": deuda_total_real,
        "disponible": disponible_real,
        "precios_especiales": precios
    })

# --- 3. CREAR PEDIDO (CON REGLA DE 15 CARACTERES) ---
@sales_bp.route('/crear-pedido', methods=['POST'])
@login_required
def crear_pedido():
    data = request.json
    
    if not data or not data.get('items'):
        return jsonify({"status": "error", "message": "El pedido est√° vac√≠o"}), 400

    try:
        # 1. VALIDACI√ìN DE NOTA OBLIGATORIA (CULTURA FINANCIERA)
        notas = data.get('notas', '').strip()
        if len(notas) < 15:
            return jsonify({
                "status": "error", 
                "message": "‚ö†Ô∏è Escribe una nota detallada (m√≠nimo 15 letras). Explica condiciones de pago o entrega."
            }), 400

        # 2. VALIDACI√ìN DE CR√âDITO
        if data['metodo_pago'] == 'Credito':
            cliente = Cliente.query.get(int(data['cliente_id']))
            total_pedido = float(data['total'])
            
            ventas_en_curso = db.session.query(func.sum(OrdenVenta.total_venta))\
                .filter(OrdenVenta.cliente_id == cliente.id)\
                .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_RUTA', 'EN_PRODUCCION', 'EMPACADO']))\
                .scalar() or 0.0
            
            deuda_total = float(cliente.saldo_actual) + float(ventas_en_curso)
            
            if (deuda_total + total_pedido) > float(cliente.limite_credito):
                return jsonify({
                    "status": "error", 
                    "message": f"‚õî CR√âDITO INSUFICIENTE. Disp: ${float(cliente.limite_credito) - deuda_total:.2f}"
                }), 400

        # --- GUARDAR VENTA ---
        folio_gen = f"PV-{datetime.now().strftime('%y%m%d%H%M%S')}"

        nueva_orden = OrdenVenta(
            folio = folio_gen,
            cliente_id = int(data['cliente_id']),
            vendedor_id = current_user.id,
            fecha_promesa_entrega = datetime.strptime(data['fecha_entrega'], '%Y-%m-%d'),
            metodo_pago_esperado = data['metodo_pago'],
            total_venta = 0, 
            estado = 'CONFIRMADA',
            notas_vendedor = notas # Ya validada
        )
        
        db.session.add(nueva_orden)
        db.session.flush() 

        total_calculado = 0
        
        for prod_id, info in data['items'].items():
            subtotal = float(info['cant']) * float(info['precio'])
            total_calculado += subtotal
            
            detalle = OrdenVentaDetalle(
                orden_id = nueva_orden.id,
                producto_id = int(prod_id),
                cantidad_pedida = float(info['cant']),
                precio_unitario = float(info['precio']),
                subtotal = subtotal
            )
            db.session.add(detalle)

        nueva_orden.total_venta = total_calculado
        db.session.commit()
        
        return jsonify({
            "status": "success", 
            "message": f"Pedido {folio_gen} guardado correctamente.", 
            "folio": folio_gen
        })

    except Exception as e:
        db.session.rollback()
        print(f"Error ventas: {e}")
        return jsonify({"status": "error", "message": str(e)}), 500

========================= FILE: .\app\models\catalogs.py =========================
# app/models/catalogs.py
from app.extensions import db

# --- CLASES BASE PARA REUTILIZAR C√ìDIGO ---
class CatalogoBase(db.Model):
    """Clase abstracta para cat√°logos simples (id, descripcion/nombre)"""
    __abstract__ = True
    id = db.Column(db.Integer, primary_key=True)
    activo = db.Column(db.Boolean, default=True)

# --- INFRAESTRUCTURA ---
class CatPlanta(CatalogoBase):
    __tablename__ = 'cat_plantas'
    descripcion = db.Column(db.String(100), nullable=False)
    notas = db.Column(db.String(255))

class CatArea(CatalogoBase):
    __tablename__ = 'cat_areas'
    descripcion = db.Column(db.String(100), nullable=False)
    notas = db.Column(db.String(255))

class CatUbicacion(CatalogoBase):
    __tablename__ = 'cat_ubicaciones'
    descripcion = db.Column(db.String(100), nullable=False) # Pasillo A, Nivel 1, etc.

class CatTipoAlmacen(CatalogoBase):
    __tablename__ = 'cat_tipos_almacen'
    nombre = db.Column(db.String(50), nullable=False)

class CatTipoMovimientoAlmacen(CatalogoBase):
    __tablename__ = 'cat_tipos_movimiento_almacen'
    descripcion = db.Column(db.String(50), nullable=False, unique=True)

# --- PRODUCTOS ---
class CatUnidadMedida(CatalogoBase):
    __tablename__ = 'cat_unidades_medida'
    nombre = db.Column(db.String(50), nullable=False)
    abreviatura = db.Column(db.String(10), nullable=False)

class CatCategoriaProducto(CatalogoBase):
    __tablename__ = 'cat_categorias_producto'
    nombre = db.Column(db.String(100), nullable=False)
    descripcion = db.Column(db.String(255))

class CatCategoriaMateriaPrima(CatalogoBase):
    __tablename__ = 'cat_categorias_materia_prima'
    nombre = db.Column(db.String(100), nullable=False)
    descripcion = db.Column(db.String(255))

# --- RH Y OPERACI√ìN ---
class CatPuesto(CatalogoBase):
    __tablename__ = 'cat_puestos'
    nombre = db.Column(db.String(50), nullable=False)
    nivel_acceso = db.Column(db.Integer, default=1) # 1-5

class CatTipoVehiculo(CatalogoBase):
    __tablename__ = 'cat_tipos_vehiculo'
    nombre = db.Column(db.String(50), nullable=False)

class CatModeloVehiculo(CatalogoBase):
    __tablename__ = 'cat_modelos_vehiculo'
    marca = db.Column(db.String(50), nullable=False)
    modelo = db.Column(db.String(50), nullable=False)
    anio = db.Column(db.Integer)

class CatModeloActivo(CatalogoBase):
    __tablename__ = 'cat_modelos_activo'
    marca = db.Column(db.String(50), nullable=False)
    modelo = db.Column(db.String(50), nullable=False)
    capacidad_litros = db.Column(db.Float)

class CatEstadoFisico(CatalogoBase):
    __tablename__ = 'cat_estados_fisicos'
    descripcion = db.Column(db.String(50), nullable=False)

class CatTipoIncidencia(CatalogoBase):
    __tablename__ = 'cat_tipos_incidencia'
    descripcion = db.Column(db.String(100), nullable=False)

# --- FINANZAS Y CONTROL ---
class CatBancoCaja(CatalogoBase):
    __tablename__ = 'cat_bancos_cajas'
    nombre = db.Column(db.String(100), nullable=False)

class CatConceptoFinanzas(CatalogoBase):
    __tablename__ = 'cat_conceptos_finanzas'
    tipo_flujo = db.Column(db.String(20), nullable=False) # INGRESO, EGRESO, DEUDA
    descripcion = db.Column(db.String(100), nullable=False)

class CatTipoDescuento(CatalogoBase):
    __tablename__ = 'cat_tipos_descuento'
    descripcion = db.Column(db.String(50), nullable=False) # PORCENTAJE, PRECIO_FINAL

class CatTipoPagoSolicitado(CatalogoBase):
    __tablename__ = 'cat_tipos_pago_solicitado'
    descripcion = db.Column(db.String(50), nullable=False) # CONTADO, CREDITO

class CatEstadoOrdenVenta(CatalogoBase):
    __tablename__ = 'cat_estados_orden_venta'
    descripcion = db.Column(db.String(50), nullable=False) # BORRADOR, CONFIRMADO...

class CatEstadoPlanProduccion(CatalogoBase):
    __tablename__ = 'cat_estados_plan_produccion'
    descripcion = db.Column(db.String(50), nullable=False) # PLANIFICADO, EN_PROCESO...

class CatEstadoOrdenEmpaque(CatalogoBase):
    __tablename__ = 'cat_estados_orden_empaque'
    descripcion = db.Column(db.String(50), nullable=False)

class CatTipoMovimientoFinanzas(CatalogoBase):
    __tablename__ = 'cat_tipos_movimiento_finanzas'
    descripcion = db.Column(db.String(50), nullable=False) # CARGO_VENTA...

class CatEstadoDeudaEmpresa(CatalogoBase):
    __tablename__ = 'cat_estados_deuda_empresa'
    descripcion = db.Column(db.String(50), nullable=False) # PENDIENTE...

class CatTipoFlujo(CatalogoBase):
    __tablename__ = 'cat_tipos_flujo'
    descripcion = db.Column(db.String(50), nullable=False) # ENTRADA, SALIDA

class CatOrigenFlujo(CatalogoBase):
    __tablename__ = 'cat_origenes_flujo'
    descripcion = db.Column(db.String(50), nullable=False) # CAPITAL, VENTAS...

class CatPeriodo(CatalogoBase):
    __tablename__ = 'cat_periodos'
    descripcion = db.Column(db.String(50), nullable=False) # MENSUAL, ANUAL

========================= FILE: .\app\models\clients.py =========================
# app/models/clients.py
from app.extensions import db

class Cliente(db.Model):
    __tablename__ = 'clientes'

    id = db.Column(db.Integer, primary_key=True)
    
    # --- NEGOCIO ---
    nombre_negocio = db.Column(db.String(150), nullable=False)
    rfc = db.Column(db.String(13)) # Fiscal
    tipo_negocio = db.Column(db.String(100)) # Abarrotes, Papeler√≠a...
    img_fachada = db.Column(db.String(255))
    calificacion = db.Column(db.Integer, default=5)

    # --- ENCARGADO ---
    nombres_encargado = db.Column(db.String(100))
    apellidos_encargado = db.Column(db.String(100))
    img_ine_frente = db.Column(db.String(255))
    img_ine_reverso = db.Column(db.String(255))

    # --- DOMICILIO NEGOCIO ---
    calle = db.Column(db.String(100))
    num_exterior = db.Column(db.String(20))
    num_interior = db.Column(db.String(20))
    colonia = db.Column(db.String(100))
    ciudad = db.Column(db.String(100))
    codigo_postal = db.Column(db.String(10))
    estado = db.Column(db.String(100))
    pais = db.Column(db.String(100), default="M√©xico")

    # --- FINANCIERO ---
    limite_credito = db.Column(db.Numeric(12, 2), default=0.00)
    saldo_actual = db.Column(db.Numeric(12, 2), default=0.00) # Se actualiza v√≠a Ledger
    
    # --- LOG√çSTICA ---
    ruta_id = db.Column(db.Integer, db.ForeignKey('rutas_reparto.id'))
    repartidor_habitual_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=True)
    vendedor_habitual_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=True)

    # Relaciones
    ruta = db.relationship('RutaReparto', backref='clientes')
    # Usamos string en foreign_keys para evitar import circular con Usuario si fuera necesario
    repartidor = db.relationship('Usuario', foreign_keys=[repartidor_habitual_id])
    vendedor = db.relationship('Usuario', foreign_keys=[vendedor_habitual_id])

class PrecioEspecialCliente(db.Model):
    __tablename__ = 'precios_especiales_cliente'

    id = db.Column(db.Integer, primary_key=True)
    
    cliente_id = db.Column(db.Integer, db.ForeignKey('clientes.id'))
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'))
    
    # FK a tu cat√°logo nuevo de tipos de descuento
    tipo_descuento_id = db.Column(db.Integer, db.ForeignKey('cat_tipos_descuento.id'))
    
    valor_descuento = db.Column(db.Numeric(10, 2), nullable=False) # 10%, $5.00, etc.

    cliente = db.relationship('Cliente', backref='precios_especiales')
    producto = db.relationship('Producto')
    tipo_descuento = db.relationship('CatTipoDescuento')

========================= FILE: .\app\models\infrastructure.py =========================
# app/models/infrastructure.py
from app.extensions import db
from datetime import datetime

class Almacen(db.Model):
    __tablename__ = 'almacenes'
    id = db.Column(db.Integer, primary_key=True)
    descripcion = db.Column(db.String(100), nullable=False)
    imagen_almacen = db.Column(db.String(255))
    tipo_id = db.Column(db.Integer, db.ForeignKey('cat_tipos_almacen.id'))
    planta_id = db.Column(db.Integer, db.ForeignKey('cat_plantas.id'))
    area_id = db.Column(db.Integer, db.ForeignKey('cat_areas.id'))
    
    tipo = db.relationship('CatTipoAlmacen')
    planta = db.relationship('CatPlanta')
    area = db.relationship('CatArea')

class UbicacionAlmacen(db.Model):
    __tablename__ = 'ubicaciones_almacen'
    id = db.Column(db.Integer, primary_key=True)
    codigo = db.Column(db.String(50), unique=True, nullable=False)
    notas = db.Column(db.String(255))
    almacen_id = db.Column(db.Integer, db.ForeignKey('almacenes.id'))
    cat_ubicacion_id = db.Column(db.Integer, db.ForeignKey('cat_ubicaciones.id'), nullable=True)
    
    almacen = db.relationship('Almacen', backref='ubicaciones')

class RutaReparto(db.Model):
    __tablename__ = 'rutas_reparto'
    id = db.Column(db.Integer, primary_key=True)
    descripcion = db.Column(db.String(100), nullable=False)
    img_mapa = db.Column(db.String(255))
    notas = db.Column(db.Text)

# --- CLASES FALTANTES AGREGADAS (CORRIGE EL ERROR CR√çTICO DEL AUDITOR) ---

class Vehiculo(db.Model):
    __tablename__ = 'vehiculos'
    id = db.Column(db.Integer, primary_key=True)
    placas = db.Column(db.String(20), unique=True)
    serie_vehiculo = db.Column(db.String(50))
    tipo_id = db.Column(db.Integer, db.ForeignKey('cat_tipos_vehiculo.id'))
    modelo_id = db.Column(db.Integer, db.ForeignKey('cat_modelos_vehiculo.id'))
    
    # Estado
    asignado = db.Column(db.Boolean, default=False)
    kilometraje_ultimo_servicio = db.Column(db.Float)
    
    # Relaciones
    tipo = db.relationship('CatTipoVehiculo')
    # modelo = db.relationship('CatModeloVehiculo') # Descomentar si el cat√°logo existe

class ActivoFrio(db.Model):
    __tablename__ = 'activos_frio'
    id = db.Column(db.Integer, primary_key=True)
    serie = db.Column(db.String(50), unique=True)
    descripcion = db.Column(db.String(100))
    modelo_id = db.Column(db.Integer, db.ForeignKey('cat_modelos_activo.id'))
    estado_id = db.Column(db.Integer, db.ForeignKey('cat_estados_fisicos.id'))
    asignado = db.Column(db.Boolean, default=False)

========================= FILE: .\app\models\orders.py =========================
# app/models/orders.py
from app.extensions import db
from datetime import datetime

class OrdenVenta(db.Model):
    __tablename__ = 'ordenes_venta'

    id = db.Column(db.Integer, primary_key=True)
    folio = db.Column(db.String(20), unique=True, nullable=False)
    
    # Actores
    cliente_id = db.Column(db.Integer, db.ForeignKey('clientes.id'), nullable=False)
    vendedor_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=False)
    
    # Fechas
    fecha_registro = db.Column(db.DateTime, default=datetime.utcnow)
    fecha_promesa_entrega = db.Column(db.Date, nullable=False)
    
    # Estados: BORRADOR, CONFIRMADA, EN_EMPAQUE, EN_RUTA, ENTREGADA, CANCELADA
    estado = db.Column(db.String(25), default='BORRADOR')
    
    # Condiciones
    metodo_pago_esperado = db.Column(db.String(20)) # CREDITO / CONTADO
    total_venta = db.Column(db.Float, default=0.0)
    notas_vendedor = db.Column(db.Text)

    # Relaciones
    items = db.relationship('OrdenVentaDetalle', backref='orden', cascade="all, delete-orphan")
    cliente = db.relationship('Cliente', backref='historial_pedidos')
    vendedor = db.relationship('Usuario', backref='preventas_realizadas')

class OrdenVentaDetalle(db.Model):
    __tablename__ = 'orden_venta_detalles'

    id = db.Column(db.Integer, primary_key=True)
    orden_id = db.Column(db.Integer, db.ForeignKey('ordenes_venta.id'), nullable=False)
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'), nullable=False)
    
    # Cantidades para trazabilidad total
    cantidad_pedida = db.Column(db.Float, nullable=False)
    cantidad_surtida = db.Column(db.Float, default=0.0)
    cantidad_entregada = db.Column(db.Float, default=0.0)
    
    # Costos en el momento de la venta
    precio_unitario = db.Column(db.Float, nullable=False)
    subtotal = db.Column(db.Float, nullable=False)
    
    producto = db.relationship('Producto')

========================= FILE: .\app\models\production.py =========================
from app.extensions import db
from datetime import datetime
from app.models.users import Usuario 

class OrdenProduccion(db.Model):
    __tablename__ = 'ordenes_produccion'

    id = db.Column(db.Integer, primary_key=True)
    folio = db.Column(db.String(50), unique=True, nullable=False)
    
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'), nullable=False)
    receta_id = db.Column(db.Integer, nullable=True)
    
    # LO QUE SE PIDE (Te√≥rico)
    cantidad = db.Column(db.Float, nullable=False)
    
    # LO QUE SALE (Realidad - Reportado por Maestro Heladero)
    cantidad_producida_real = db.Column(db.Float, default=0)
    notas_produccion = db.Column(db.Text, nullable=True)

    # --- NUEVO CAMPO PARA RECEPCI√ìN PARCIAL (ALMAC√âN) ---
    # Aqu√≠ se va sumando lo que el almacenista mete al refri poco a poco.
    cantidad_recibida_almacen = db.Column(db.Float, default=0)
    # ----------------------------------------------------

    usuario_solicita_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=False)
    
    fecha_solicitud = db.Column(db.DateTime, default=datetime.now)
    fecha_inicio = db.Column(db.DateTime, nullable=True)
    fecha_termino = db.Column(db.DateTime, nullable=True)
    
    # ESTATUS: 
    # 'SOLICITADA' -> 'BATIENDO' -> 'POR_RECIBIR' (En tr√°nsito/Parcial) -> 'TERMINADA' (Cerrada)
    estatus = db.Column(db.String(20), default='SOLICITADA')
    prioridad = db.Column(db.String(20), default='NORMAL')

    producto = db.relationship('Producto', backref='ordenes')
    usuario = db.relationship('Usuario', backref='ordenes_creadas')

========================= FILE: .\app\models\products.py =========================
# app/models/products.py
from app.extensions import db

class Producto(db.Model):
    __tablename__ = 'productos'

    id = db.Column(db.Integer, primary_key=True)
    sku = db.Column(db.String(50), unique=True, nullable=False)
    descripcion = db.Column(db.String(200), nullable=False)
    
    # Clasificaci√≥n
    categoria_id = db.Column(db.Integer, db.ForeignKey('cat_categorias_producto.id'))
    unidad_id = db.Column(db.Integer, db.ForeignKey('cat_unidades_medida.id'))

    # Dinero
    precio_costo_actual = db.Column(db.Numeric(10, 2), default=0.00)
    precio_venta_general = db.Column(db.Numeric(10, 2), default=0.00) # Base

    # F√≠sico
    peso_gramos = db.Column(db.Float, default=0.0)
    caducidad_dias = db.Column(db.Integer, default=0)
    imagen_producto = db.Column(db.String(255))

    # Sem√°foros de Inventario
    stock_minimo = db.Column(db.Float, default=0.0)
    stock_maximo = db.Column(db.Float, default=0.0)
    stock_ideal = db.Column(db.Float, default=0.0)

    # Relaciones
    categoria = db.relationship('CatCategoriaProducto')
    unidad = db.relationship('CatUnidadMedida')

class MateriaPrima(db.Model):
    __tablename__ = 'materia_prima'

    id = db.Column(db.Integer, primary_key=True)
    sku = db.Column(db.String(50), unique=True, nullable=False)
    descripcion = db.Column(db.String(200), nullable=False)
    
    categoria_id = db.Column(db.Integer, db.ForeignKey('cat_categorias_materia_prima.id'))
    unidad_id = db.Column(db.Integer, db.ForeignKey('cat_unidades_medida.id'))

    # Dinero
    precio_costo_promedio = db.Column(db.Numeric(10, 2), default=0.00)
    precio_venta_general = db.Column(db.Numeric(10, 2), default=0.00) # Requerimiento tuyo

    # F√≠sico
    peso_gramos = db.Column(db.Float, default=0.0)
    caducidad_dias = db.Column(db.Integer, default=0)
    imagen_materia = db.Column(db.String(255))
    
    # Inventario Ideal (Opcional, pero bueno tenerlo)
    stock_minimo = db.Column(db.Float, default=0.0)
    stock_maximo = db.Column(db.Float, default=0.0)
    stock_ideal = db.Column(db.Float, default=0.0)

    categoria = db.relationship('CatCategoriaMateriaPrima')
    unidad = db.relationship('CatUnidadMedida')

========================= FILE: .\app\models\stock.py =========================
# app/models/stock.py
from app.extensions import db
from datetime import datetime

class InventarioProducto(db.Model):
    __tablename__ = 'inventario_productos'

    id = db.Column(db.Integer, primary_key=True)
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'), nullable=True)
    materia_prima_id = db.Column(db.Integer, db.ForeignKey('materia_prima.id'), nullable=True)
    ubicacion_id = db.Column(db.Integer, db.ForeignKey('ubicaciones_almacen.id'), nullable=False)

    # --- CORRECCI√ìN CR√çTICA: Nombre alineado con Postgres ---
    cantidad_actual = db.Column(db.Float, default=0.0)  # ANTES: cantidad_fisica
    cantidad_reservada = db.Column(db.Float, default=0.0) 
    
    # Propiedad calculada para saber qu√© puede vender el preventista
    @property
    def cantidad_disponible(self):
        # AQU√ç TAMBI√âN HAB√çA QUE CORREGIR EL NOMBRE
        return self.cantidad_actual - self.cantidad_reservada

    # --- TRAZABILIDAD ---
    fecha_produccion = db.Column(db.Date, nullable=True) 
    fecha_ingreso_almacen = db.Column(db.DateTime, default=datetime.utcnow)

    # --- SEM√ÅFOROS POR UBICACI√ìN ---
    stock_minimo = db.Column(db.Float, default=0.0)
    stock_maximo = db.Column(db.Float, default=0.0)
    stock_ideal = db.Column(db.Float, default=0.0)

    # Relaciones
    producto = db.relationship('Producto', backref='existencias')
    ubicacion = db.relationship('UbicacionAlmacen', backref='productos_almacenados')

class MovimientoTemporal(db.Model):
    """Guarda las reservas mientras el almacenista est√° empacando"""
    __tablename__ = 'movimientos_temporales'
    
    id = db.Column(db.Integer, primary_key=True)
    orden_venta_id = db.Column(db.Integer, nullable=False) # Relaci√≥n a la orden
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'))
    ubicacion_origen_id = db.Column(db.Integer, db.ForeignKey('ubicaciones_almacen.id'))
    cantidad = db.Column(db.Float, nullable=False)
    estado = db.Column(db.String(20), default='RESERVADO') # RESERVADO, CONFIRMADO, MERMA

class HistorialMovimiento(db.Model):
    """K√°rdex Profesional para auditor√≠a de cada pieza"""
    __tablename__ = 'historial_movimientos'
    
    id = db.Column(db.Integer, primary_key=True)
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'))
    ubicacion_id = db.Column(db.Integer, db.ForeignKey('ubicaciones_almacen.id'))
    tipo_movimiento = db.Column(db.String(50)) # ENTRADA_PRODUCCION, MERMA, AJUSTE, SALIDA_VENTA
    cantidad = db.Column(db.Float, nullable=False)
    usuario_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'))
    fecha = db.Column(db.DateTime, default=datetime.utcnow)
    referencia = db.Column(db.String(100)) # ID de Orden o Lote
    notas = db.Column(db.Text)

========================= FILE: .\app\models\users.py =========================
# app/models/users.py
from app.extensions import db
from datetime import datetime
from flask_login import UserMixin # <--- 1. NUEVO IMPORT
from werkzeug.security import check_password_hash # <--- 2. NUEVO IMPORT

class Usuario(UserMixin, db.Model): # <--- 3. HERENCIA NUEVA
    __tablename__ = 'usuarios'

    id = db.Column(db.Integer, primary_key=True)
    
    # --- IDENTIDAD ---
    nombres = db.Column(db.String(100), nullable=False)
    apellido_paterno = db.Column(db.String(100), nullable=False)
    apellido_materno = db.Column(db.String(100))
    fecha_nacimiento = db.Column(db.Date)
    estado_civil = db.Column(db.String(50))
    profesion = db.Column(db.String(100))
    curp = db.Column(db.String(18))
    rfc = db.Column(db.String(13))

    # --- DOMICILIO ---
    calle = db.Column(db.String(100))
    num_exterior = db.Column(db.String(20))
    num_interior = db.Column(db.String(20))
    colonia = db.Column(db.String(100))
    ciudad = db.Column(db.String(100))
    codigo_postal = db.Column(db.String(10))
    estado = db.Column(db.String(100))
    pais = db.Column(db.String(100), default="M√©xico")

    # --- CONTACTO ---
    telefono_casa = db.Column(db.String(20))
    telefono_celular = db.Column(db.String(20))
    email_personal = db.Column(db.String(100))
    
    # Emergencia
    contacto_emergencia_nombre = db.Column(db.String(150))
    contacto_emergencia_telefono = db.Column(db.String(20))

    # --- LABORAL ---
    puesto_id = db.Column(db.Integer, db.ForeignKey('cat_puestos.id'))
    fecha_inicio_empresa = db.Column(db.Date, default=datetime.utcnow)
    calificacion_evaluacion = db.Column(db.Integer, default=5)
    notas_generales = db.Column(db.Text)

    # --- SEGURIDAD ---
    email_acceso = db.Column(db.String(100), unique=True, nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    pin_seguridad = db.Column(db.String(6))
    nivel_usuario = db.Column(db.Integer, default=1)
    activo = db.Column(db.Boolean, default=True)

    # --- DOCUMENTACI√ìN ---
    foto_perfil = db.Column(db.String(255))
    img_ine_frente = db.Column(db.String(255))
    img_ine_reverso = db.Column(db.String(255))
    img_licencia_frente = db.Column(db.String(255))
    img_licencia_reverso = db.Column(db.String(255))
    fecha_validez_licencia = db.Column(db.Date)

    # Relaciones
    puesto = db.relationship('CatPuesto', backref='usuarios')

    # --- M√âTODOS NUEVOS PARA LOGIN ---
    def check_password(self, password):
        """Verifica si la contrase√±a coincide con el hash"""
        return check_password_hash(self.password_hash, password)

    def __repr__(self):
        return f'<Usuario {self.nombres} {self.apellido_paterno}>'

========================= FILE: .\app\models\__init__.py =========================


========================= FILE: .\app\static\css\main.css =========================
/* app/static/css/main.css */

:root {
    --gelmex-primary: #0d47a1; /* Azul Industrial Fuerte */
    --gelmex-secondary: #1565c0; /* Azul Medio */
    --gelmex-accent: #ffca28; /* Amarillo Preventivo (Botones/Alertas) */
    --gelmex-dark: #263238; /* Gris Oscuro (Sidebar) */
    --gelmex-light: #f8f9fa; /* Fondo General */
    --sidebar-width: 250px;
}

body {
    background-color: var(--gelmex-light);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* --- SIDEBAR --- */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--gelmex-dark);
    color: white;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    padding-top: 1rem;
    transition: all 0.3s;
    z-index: 1000;
}

.sidebar-header {
    padding: 1rem;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 1rem;
}

.sidebar .nav-link {
    color: rgba(255,255,255,0.8);
    padding: 0.8rem 1.5rem;
    border-left: 4px solid transparent;
}

.sidebar .nav-link:hover, .sidebar .nav-link.active {
    color: white;
    background-color: rgba(255,255,255,0.05);
    border-left-color: var(--gelmex-accent);
}

.sidebar .nav-link i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
}

/* Submen√∫s en Sidebar (Para Producci√≥n) */
.nav-group-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: rgba(255,255,255,0.4);
    padding: 1rem 1.5rem 0.5rem;
    letter-spacing: 1px;
}

.sub-menu {
    padding-left: 2rem;
    background-color: rgba(0,0,0,0.1);
}

/* --- CONTENIDO PRINCIPAL --- */
.main-content {
    margin-left: var(--sidebar-width);
    padding: 20px;
    width: calc(100% - var(--sidebar-width));
    transition: all 0.3s;
}

/* --- NAVBAR SUPERIOR --- */
.top-navbar {
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    padding: 0.5rem 1rem;
    margin-bottom: 2rem;
    border-radius: 8px;
}

/* --- RESPONSIVO (M√≥vil) --- */
@media (max-width: 768px) {
    .sidebar {
        margin-left: calc(var(--sidebar-width) * -1);
    }
    .sidebar.active {
        margin-left: 0;
    }
    .main-content {
        margin-left: 0;
        width: 100%;
    }
}

/* --- CARDS & WIDGETS --- */
.card-erp {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}
.card-erp:hover {
    transform: translateY(-2px);
}

========================= FILE: .\app\templates\base.html =========================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GelMexSys 2.0 | {% block title %}Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        /* Estilos del Sidebar y Submen√∫s */
        .sidebar .nav-link {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ffc107; /* Amarillo industrial */
        }

        .submenu-dark {
            background: rgba(0, 0, 0, 0.2) !important;
            margin: 0 10px;
            border-radius: 8px;
            padding: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .submenu-dark .nav-link {
            font-size: 0.85rem !important;
            padding: 8px 20px !important;
            color: rgba(255, 255, 255, 0.7) !important;
            border-left: none !important;
        }

        .submenu-dark .nav-link:hover {
            color: #fff !important;
            background: transparent !important;
            padding-left: 25px !important;
        }

        .submenu-dark .nav-link.active-sub {
            color: #ffc107 !important;
            font-weight: bold;
        }

        .nav-link[data-bs-toggle="collapse"].collapsed i.fa-chevron-down {
            transform: rotate(-90deg);
        }
        .nav-link i.fa-chevron-down {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fa-solid fa-snowflake"></i> GelMexSys</h4>
            <small class="text-warning">v2.0 Enterprise</small>
        </div>

        <div class="nav flex-column mt-3">
            <a href="{{ url_for('home.dashboard') }}" class="nav-link py-3">
                <i class="fa-solid fa-gauge-high me-2"></i> Dashboard
            </a>

            <div class="nav-group-label mt-2">OPERACI√ìN</div>
            
            <a href="{{ url_for('sales.preventa') }}" class="nav-link py-3">
                <i class="fa-solid fa-cash-register me-2"></i> Ventas y Pedidos
            </a>
            
            <a class="nav-link py-3 d-flex justify-content-between align-items-center" 
               data-bs-toggle="collapse" href="#collapseInventario" role="button" aria-expanded="false">
                <span><i class="fa-solid fa-boxes-stacked me-2"></i> Inventario y Almac√©n</span>
                <i class="fa-solid fa-chevron-down small"></i>
            </a>
            <div class="collapse" id="collapseInventario">
                <div class="submenu-dark shadow-inner">
                    <a class="nav-link py-2" href="{{ url_for('inventory.index') }}">
                        <i class="fa-solid fa-list me-2"></i> Cat√°logo Productos
                    </a>
                    <a class="nav-link py-2" href="{{ url_for('inventory.movimientos') }}">
                        <i class="fa-solid fa-right-left me-2"></i> Movimientos / Ajustes
                    </a>
                    <a class="nav-link py-2 text-warning" href="{{ url_for('reception.index') }}">
                        <i class="fa-solid fa-dolly me-2"></i> Recepci√≥n Producci√≥n
                    </a>
                </div>
            </div>

            <a class="nav-link py-3 d-flex justify-content-between align-items-center" 
               data-bs-toggle="collapse" href="#collapseProduccion" role="button" aria-expanded="false">
                <span><i class="fa-solid fa-industry me-2"></i> Producci√≥n</span>
                <i class="fa-solid fa-chevron-down small"></i>
            </a>
            <div class="collapse" id="collapseProduccion">
                <div class="submenu-dark shadow-inner">
                    <a class="nav-link py-2" href="{{ url_for('production.tablero_necesidades') }}">
                        <i class="fa-solid fa-chart-line me-2"></i> Tablero de Demanda
                    </a>
                    <a class="nav-link py-2" href="{{ url_for('production.ordenes_maestro') }}">
                        <i class="fa-solid fa-fire-burner me-2"></i> √ìrdenes Maestro
                    </a>
                </div>
            </div>

            <a href="#" class="nav-link py-3"><i class="fa-solid fa-truck-fast me-2"></i> Log√≠stica y Rutas</a>

            <div class="nav-group-label mt-2">ADMINISTRACI√ìN</div>
            <a href="#" class="nav-link py-3"><i class="fa-solid fa-sack-dollar me-2"></i> Finanzas</a>
            <a href="#" class="nav-link py-3"><i class="fa-solid fa-users-gear me-2"></i> Configuraci√≥n</a>
        </div>
    </nav>

    <div class="main-content">
        <nav class="navbar top-navbar d-flex justify-content-between px-4 shadow-sm">
            <button class="btn btn-outline-secondary d-md-none" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>
            <h5 class="m-0 text-secondary fw-bold">{% block page_header %}Sistema de Control{% endblock %}</h5>
            
            <div class="d-flex align-items-center gap-3">
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark" data-bs-toggle="dropdown">
                        <img src="https://ui-avatars.com/api/?name={{ current_user.nombres }}&background=0d47a1&color=fff" class="rounded-circle me-2" width="32" alt="User">
                        <strong class="d-none d-md-block">{{ current_user.nombres }}</strong>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                        <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"><i class="fa-solid fa-right-from-bracket me-2"></i>Cerrar Sesi√≥n</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="px-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="p-4">
            {% block content %}{% endblock %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('sidebarToggle').onclick = () => document.querySelector('.sidebar').classList.toggle('active');
    </script>
</body>
</html>

========================= FILE: .\app\templates\auth\login.html =========================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GelMexSys 2.0 | Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .brand-logo {
            text-align: center;
            margin-bottom: 2rem;
            color: #0d47a1;
            font-weight: bold;
            font-size: 1.8rem;
        }
        .btn-login {
            background-color: #0d47a1;
            border: none;
            padding: 0.8rem;
            font-weight: 600;
        }
        .btn-login:hover {
            background-color: #002171;
        }
    </style>
</head>
<body>

    <div class="login-card">
        <div class="brand-logo">
            <i class="fa-solid fa-snowflake"></i> GelMexSys
        </div>
        
        <form method="POST">
            <div class="mb-3">
                <label for="email" class="form-label text-muted">Correo Institucional</label>
                <input type="email" class="form-control form-control-lg" id="email" name="email" placeholder="usuario@gelmex.com" required>
            </div>
            <div class="mb-4">
                <label for="password" class="form-label text-muted">Contrase√±a</label>
                <input type="password" class="form-control form-control-lg" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg btn-login">Iniciar Sesi√≥n</button>
            </div>
        </form>
        
        <div class="text-center mt-4">
            <small class="text-muted">¬øOlvidaste tu acceso? Contacta a TI.</small>
        </div>
    </div>

</body>
</html>

========================= FILE: .\app\templates\home\index.html =========================
{% extends 'base.html' %}

{% block title %}Inicio{% endblock %}

{% block page_header %}Resumen General{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-md-3">
        <div class="card card-erp p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Ventas del D√≠a</h6>
                    <h3>$0.00</h3>
                </div>
                <div class="fs-1 text-primary opacity-25">
                    <i class="fa-solid fa-money-bill-wave"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card card-erp p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Pedidos Activos</h6>
                    <h3>5</h3>
                </div>
                <div class="fs-1 text-warning opacity-25">
                    <i class="fa-solid fa-list-check"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\inventory\catalog_list.html =========================
{% extends 'base.html' %}

{% block title %}Cat√°logo | GelMexSys{% endblock %}
{% block page_header %}Cat√°logo de Productos{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lista Maestra de Productos</h5>
        <a href="{{ url_for('inventory.create') }}" class="btn btn-warning fw-bold text-dark">
            <i class="fa-solid fa-plus me-2"></i> Nuevo Producto
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>SKU</th>
                        <th>Producto</th>
                        <th>Categor√≠a</th>
                        <th>Costo</th>
                        <th>Precio Venta</th>
                        <th>Stock M√≠n.</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr>
                        <td class="fw-bold">{{ p.sku }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if p.imagen_producto %}
                                    <img src="{{ url_for('static', filename=p.imagen_producto) }}" class="rounded-circle me-2" width="40" height="40">
                                {% else %}
                                    <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width:40px; height:40px;">
                                        <i class="fa-solid fa-ice-cream"></i>
                                    </div>
                                {% endif %}
                                <span>{{ p.descripcion }}</span>
                            </div>
                        </td>
                        <td><span class="badge bg-info text-dark">{{ p.categoria.nombre if p.categoria else 'N/A' }}</span></td>
                        <td>${{ "{:.2f}".format(p.precio_costo_actual) }}</td>
                        <td class="fw-bold text-success">${{ "{:.2f}".format(p.precio_venta_general) }}</td>
                        <td>{{ p.stock_minimo }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-pen"></i></button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4">No hay productos registrados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\inventory\form.html =========================
{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}
{% block page_header %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card card-erp">
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}

                    <h5 class="mb-4 text-muted border-bottom pb-2">Datos Generales</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">SKU (C√≥digo)</label>
                            {{ form.sku(class="form-control", placeholder="Ej: PAL-LIM-AGU") }}
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Descripci√≥n</label>
                            {{ form.descripcion(class="form-control", placeholder="Ej: Paleta de Lim√≥n Base Agua") }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Categor√≠a</label>
                            {{ form.categoria_id(class="form-select") }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unidad de Medida</label>
                            {{ form.unidad_id(class="form-select") }}
                        </div>
                    </div>

                    <h5 class="mb-3 mt-4 text-muted border-bottom pb-2">Precios y Control</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-success fw-bold">Precio Venta ($)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.precio_venta(class="form-control") }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted">Costo Producci√≥n ($)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.precio_costo(class="form-control") }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-warning fw-bold">Stock M√≠nimo</label>
                            {{ form.stock_minimo(class="form-control") }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Imagen del Producto</label>
                        {{ form.imagen(class="form-control") }}
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary">Cancelar</a>
                        {{ form.submit(class="btn btn-primary px-4") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\inventory\movements.html =========================
{% extends 'base.html' %}

{% block title %}Movimientos | GelMexSys{% endblock %}
{% block page_header %}Operaci√≥n de Almac√©n{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card card-erp shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="m-0"><i class="fa-solid fa-dolly me-2"></i>Entradas y Ajustes</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST">
                        
                        <div class="mb-4">
                            <label class="form-label text-muted fw-bold small">ACCI√ìN A REALIZAR</label>
                            <select name="tipo_movimiento_id" class="form-select form-select-lg border-primary bg-light" required>
                                <option value="">-- Selecciona Operaci√≥n --</option>
                                {% for tipo in tipos_movimiento %}
                                    <option value="{{ tipo.id }}">üîπ {{ tipo.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted fw-bold small">PRODUCTO</label>
                            <select name="producto_id" class="form-select" required>
                                <option value="">-- Selecciona el producto --</option>
                                {% for p in productos %}
                                <option value="{{ p.id }}">{{ p.sku }} - {{ p.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small">1. ALMAC√âN</label>
                                <select id="selectAlmacen" name="almacen_id" class="form-select" required onchange="filtrarUbicaciones()">
                                    <option value="">-- Selecciona --</option>
                                    {% for a in almacenes %}
                                    <option value="{{ a.id }}">{{ a.descripcion }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small">2. UBICACI√ìN EXACTA</label>
                                <select id="selectUbicacion" name="ubicacion_id" class="form-select border-primary" required disabled>
                                    <option value="">-- Primero elije Almac√©n --</option>
                                    {% for u in ubicaciones %}
                                    <option value="{{ u.id }}" data-almacen="{{ u.almacen_id }}" class="opcion-ubicacion d-none">
                                        üìç {{ u.codigo }} {% if u.notas %}({{ u.notas }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-muted fw-bold small">CANTIDAD</label>
                            <input type="number" step="0.01" name="cantidad" class="form-control fw-bold text-center border-primary form-control-lg" required placeholder="0">
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-muted small">Notas / Referencia</label>
                            <textarea name="notas" class="form-control" rows="2" placeholder="Ej: Conteo f√≠sico arranque..."></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm">
                                <i class="fa-solid fa-check-circle me-2"></i> CONFIRMAR MOVIMIENTO
                            </button>
                            <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary">Cancelar</a>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="alert alert-info shadow-sm border-0">
                <h5><i class="fa-solid fa-circle-info me-2"></i>Control de Ubicaciones</h5>
                <hr>
                <p class="small">El sistema requiere ubicaci√≥n exacta para la trazabilidad.</p>
                <ul class="small mb-0">
                    <li>Selecciona primero el <strong>Almac√©n General</strong>.</li>
                    <li>Luego selecciona el <strong>Pasillo, Rack o Nivel</strong> espec√≠fico.</li>
                    <li>Si no aparecen ubicaciones, debes darlas de alta en Configuraci√≥n.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function filtrarUbicaciones() {
    const almacenSelect = document.getElementById('selectAlmacen');
    const ubicacionSelect = document.getElementById('selectUbicacion');
    const opciones = document.querySelectorAll('.opcion-ubicacion');
    const almacenId = almacenSelect.value;

    // Resetear selecci√≥n
    ubicacionSelect.value = "";
    
    if (almacenId) {
        ubicacionSelect.disabled = false;
        let count = 0;
        opciones.forEach(op => {
            if (op.dataset.almacen === almacenId) {
                op.classList.remove('d-none');
                count++;
            } else {
                op.classList.add('d-none');
            }
        });
        
        if(count === 0) {
            ubicacionSelect.innerHTML = '<option value="">‚ö†Ô∏è Sin ubicaciones en este almac√©n</option>';
            ubicacionSelect.disabled = true;
        } else {
            // Restaurar la opci√≥n por defecto si hay resultados
            const defaultOp = document.createElement('option');
            defaultOp.value = "";
            defaultOp.text = "-- Selecciona Ubicaci√≥n --";
            // Limpiamos y re-agregamos las visibles (forma sencilla de limpiar basura)
            // Ojo: el d-none funciona visualmente en navegadores modernos, 
            // pero para compatibilidad total a veces es mejor reconstruir el select.
            // Por simplicidad y rapidez usamos clases CSS aqu√≠.
        }
    } else {
        ubicacionSelect.disabled = true;
        opciones.forEach(op => op.classList.add('d-none'));
    }
}
</script>
{% endblock %}

========================= FILE: .\app\templates\production\dashboard.html =========================
{% extends 'base.html' %}

{% block title %}Tablero de Necesidades | GelMexSys{% endblock %}
{% block page_header %}Programaci√≥n de Producci√≥n{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-bold"><i class="fa-solid fa-chart-line me-2"></i>ANALIZADOR DE DEMANDA (JIT)</h5>
            <span class="badge bg-secondary">Actualizado: {{ now.strftime('%H:%M') }}</span>
        </div>
        
        <div class="card-body bg-light border-bottom">
            <div class="row text-center">
                <div class="col-md-4">
                    <small class="text-uppercase text-muted fw-bold">Salud del Inventario</small>
                    <div class="h4 mt-1 fw-bold text-{{ clase_sys }}">
                        {% if clase_sys == 'success' %}<i class="fa-solid fa-check-circle me-1"></i>{% endif %}
                        {% if clase_sys == 'danger' %}<i class="fa-solid fa-triangle-exclamation me-1"></i>{% endif %}
                        {{ estado_sys }}
                    </div>
                </div>
                <div class="col-md-4 border-start border-end">
                    <small class="text-uppercase text-muted fw-bold">√ìrdenes en F√°brica</small>
                    <div class="h4 mt-1 fw-bold text-primary">
                        {{ total_ordenes }} Activas
                    </div>
                </div>
                <div class="col-md-4">
                    <small class="text-uppercase text-muted fw-bold">Acci√≥n Sugerida</small>
                    <div class="h4 mt-1 fw-bold text-dark">{{ accion_sys }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-erp shadow-lg border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light small text-uppercase text-secondary text-center">
                    <tr>
                        <th class="text-start ps-4">Producto</th>
                        <th>Existencia<br>F√≠sica</th>
                        <th class="text-danger bg-danger bg-opacity-10">Ventas<br>Pendientes</th>
                        <th class="text-primary bg-primary bg-opacity-10">Disponible<br>Real</th>
                        <th>En<br>F√°brica</th>
                        <th class="d-none d-lg-table-cell">Meta</th>
                        <th class="bg-warning bg-opacity-25 text-dark" style="width: 150px;">A Fabricar</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr class="text-center">
                        <td class="text-start ps-4">
                            <strong class="d-block text-dark">{{ item.descripcion }}</strong>
                            <small class="text-muted">{{ item.sku }}</small>
                        </td>

                        <td><span class="fw-bold">{{ item.existencia | int }}</span></td>
                        
                        <td class="bg-danger bg-opacity-10 text-danger fw-bold">
                            {% if item.comprometido > 0 %}
                                -{{ item.comprometido | int }}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td class="bg-primary bg-opacity-10 text-primary fw-bold fs-5">
                            {{ item.disponible | int }}
                        </td>

                        <td>
                            {% if item.en_proceso > 0 %}
                                <span class="badge bg-info text-dark border border-info">
                                    <i class="fa-solid fa-spinner fa-spin me-1"></i> {{ item.en_proceso | int }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>

                        <td class="d-none d-lg-table-cell text-muted">{{ item.meta | int }}</td>
                        
                        <td class="bg-warning bg-opacity-25 py-3">
                            <form action="{{ url_for('production.crear_orden') }}" method="POST">
                                <input type="hidden" name="producto_id" value="{{ item.id }}">
                                
                                {% if item.estado == 'SURTIDO' or item.estado == 'EN CAMINO' %}
                                    <span class="badge rounded-pill bg-{{ item.clase_estado }} px-3 py-2 shadow-sm">
                                        {{ item.estado }}
                                    </span>
                                {% else %}
                                    <div class="input-group input-group-sm justify-content-center">
                                        <input type="number" name="cantidad" class="form-control text-center fw-bold border-warning" 
                                               value="{{ item.a_fabricar | int }}" min="1" style="max-width: 70px;">
                                        <button type="submit" class="btn btn-warning fw-bold shadow-sm" title="Enviar a Producci√≥n">
                                            <i class="fa-solid fa-paper-plane"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </form>
                        </td>
                        
                        <td>
                            {% if item.disponible <= 0 %}
                                <i class="fa-solid fa-circle-exclamation text-danger fs-5" title="Sin stock libre"></i>
                            {% elif item.a_fabricar > 0 %}
                                <i class="fa-solid fa-triangle-exclamation text-warning fs-5" title="Bajo stock"></i>
                            {% else %}
                                <i class="fa-solid fa-circle-check text-success fs-5" title="OK"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\production\orders_list.html =========================
{% extends 'base.html' %}

{% block title %}Cocina | GelMexSys{% endblock %}
{% block page_header %}Consola del Maestro Heladero{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if ordenes %}
    <div class="row">
        {% for orden in ordenes %}
        <div class="col-12 col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm border-0 {% if orden.estatus == 'BATIENDO' %}border-start border-5 border-warning{% endif %}">
                
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <span class="badge bg-light text-dark border">{{ orden.folio }}</span>
                    <small class="text-muted"><i class="fa-regular fa-clock me-1"></i> {{ orden.fecha_solicitud.strftime('%H:%M') }}</small>
                </div>

                <div class="card-body text-center">
                    <h5 class="card-title fw-bold text-dark mb-1">{{ orden.producto.descripcion }}</h5>
                    <p class="text-muted small mb-3">{{ orden.producto.sku }}</p>
                    
                    <div class="row mb-3">
                        <div class="col-6 border-end">
                            <small class="text-muted d-block text-uppercase">Solicitado</small>
                            <span class="h4 fw-bold text-primary">{{ orden.cantidad | int }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block text-uppercase">Real Producido</small>
                            {% if orden.cantidad_producida_real > 0 %}
                                <span class="h4 fw-bold text-success">{{ orden.cantidad_producida_real | int }}</span>
                            {% else %}
                                <span class="h4 text-muted">--</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if orden.estatus == 'SOLICITADA' %}
                        <div class="alert alert-secondary py-2 small">
                            <i class="fa-solid fa-hourglass-start me-1"></i> Esperando turno
                        </div>
                    {% elif orden.estatus == 'BATIENDO' %}
                        <div class="alert alert-warning py-2 small fw-bold text-dark">
                            <i class="fa-solid fa-fire-burner fa-fade me-1"></i> EN PRODUCCI√ìN
                        </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-white p-3">
                    <div class="d-grid gap-2">
                        {% if orden.estatus == 'SOLICITADA' %}
                            <a href="{{ url_for('production.cambiar_estatus', orden_id=orden.id, nuevo_estatus='BATIENDO') }}" 
                               class="btn btn-primary btn-lg shadow-sm">
                                <i class="fa-solid fa-fire-burner"></i> INICIAR LOTE
                            </a>
                        {% elif orden.estatus == 'BATIENDO' %}
                            <button type="button" class="btn btn-success btn-lg shadow fw-bold" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalCierre{{ orden.id }}">
                                <i class="fa-solid fa-truck-ramp-box"></i> ENVIAR A ALMAC√âN
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalCierre{{ orden.id }}" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Cierre de Lote: {{ orden.folio }}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form action="{{ url_for('production.reportar_produccion_real') }}" method="POST">
                            <div class="modal-body">
                                <input type="hidden" name="orden_id" value="{{ orden.id }}">
                                
                                <div class="mb-3 text-center">
                                    <label class="form-label text-muted">Cantidad Solicitada</label>
                                    <div class="h3">{{ orden.cantidad | int }}</div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold text-dark">¬øCu√°nto sali√≥ REALMENTE del lote?</label>
                                    <input type="number" name="cantidad_real" class="form-control form-control-lg text-center fw-bold border-success" 
                                           value="{{ orden.cantidad | int }}" min="1" required>
                                    <div class="form-text">Si sali√≥ m√°s o menos, aj√∫stalo aqu√≠. Esto es lo que recibir√° el almacenista.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Notas / Incidencias (Opcional)</label>
                                    <textarea name="notas" class="form-control" rows="2" placeholder="Ej: Se tir√≥ un poco de mezcla..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success fw-bold">Confirmar Entrega</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <h3 class="text-muted">Sin √ìrdenes Activas</h3>
        <p class="text-muted">Todo limpio por aqu√≠.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

========================= FILE: .\app\templates\reception\reception_dock.html =========================
{% extends 'base.html' %}

{% block title %}Recepci√≥n | GelMexSys{% endblock %}
{% block page_header %}Muelle de Recepci√≥n{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-dark text-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fa-solid fa-dolly me-2"></i>Lotes Pendientes</h5>
            <span class="badge bg-warning text-dark">{{ lotes|length }} Lotes</span>
        </div>
        
        <div class="card-body bg-light">
            {% if lotes %}
            <div class="row">
                {% for lote in lotes %}
                {% set recibido = lote.cantidad_recibida_almacen or 0 %}
                {% set total = lote.cantidad_producida_real %}
                {% set pendiente = total - recibido %}
                {% set porcentaje = (recibido / total * 100) | int %}
                {% if porcentaje > 100 %}{% set porcentaje = 100 %}{% endif %}
                
                <div class="col-12 col-xl-6 mb-3">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-primary">{{ lote.folio }}</span>
                                <small class="text-muted">{{ lote.fecha_termino.strftime('%d/%m %H:%M') if lote.fecha_termino else 'Hoy' }}</small>
                            </div>
                            <h5 class="fw-bold text-dark mb-0">{{ lote.producto.descripcion }}</h5>
                            
                            <div class="mt-3 p-3 bg-white rounded border">
                                <div class="d-flex justify-content-between small fw-bold">
                                    <span>Progreso: {{ recibido|int }} / {{ total|int }}</span>
                                    {% if pendiente < 0 %}
                                        <span class="text-success fw-bold">¬°Excedente: {{ pendiente|abs|int }}!</span>
                                    {% else %}
                                        <span class="text-danger">Faltan: {{ pendiente|int }}</span>
                                    {% endif %}
                                </div>
                                <div class="progress mt-2" style="height: 10px;">
                                    <div class="progress-bar {% if porcentaje < 100 %}bg-warning{% else %}bg-success{% endif %}" style="width: {{ porcentaje }}%"></div>
                                </div>
                            </div>

                            <button class="btn btn-primary w-100 fw-bold mt-3" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modal{{ lote.id }}">
                                <i class="fa-solid fa-dolly-flatbed me-2"></i> ACOMODAR
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="modal{{ lote.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Acomodar Lote</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <form action="{{ url_for('reception.confirmar') }}" method="POST">
                                <div class="modal-body">
                                    <input type="hidden" name="orden_id" value="{{ lote.id }}">
                                    
                                    <div class="alert alert-info text-center py-2">
                                        Pendientes Te√≥ricos: <strong>{{ pendiente|int }}</strong>
                                    </div>

                                    <div class="mb-3">
                                        <label class="fw-bold">Cantidad a ingresar (STOCK BUENO):</label>
                                        <input type="number" name="cantidad_ingresar" class="form-control text-center fw-bold border-success text-dark" 
                                               style="font-size: 1.5rem;"
                                               value="{{ pendiente if pendiente > 0 else 0 }}" min="0" step="0.01" required>
                                        <div class="form-text text-muted small">
                                            Escribe la cantidad f√≠sica real. Si hay de m√°s, ponlo. Si es merma, pon 0 y marca cierre forzado.
                                        </div>
                                    </div>

                                    <div class="mb-3 bg-light p-3 rounded border">
                                        <label class="fw-bold text-primary mb-2">PASO 1: Selecciona Almac√©n</label>
                                        <select class="form-select select-almacen text-dark" data-target="ubicacion{{ lote.id }}" required>
                                            <option value="" selected disabled>-- Elegir Almac√©n --</option>
                                            {% for a in almacenes %}
                                                <option value="{{ a.id }}">{{ a.descripcion }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="mb-3 bg-light p-3 rounded border">
                                        <label class="fw-bold text-primary mb-2">PASO 2: Ubicaci√≥n Exacta</label>
                                        <select name="ubicacion_id" id="ubicacion{{ lote.id }}" class="form-select text-dark" disabled required>
                                            <option value="" selected disabled>-- Esperando Almac√©n --</option>
                                            {% for u in ubicaciones %}
                                                <option value="{{ u.id }}" data-almacen="{{ u.almacen_id }}">
                                                    {{ u.codigo }} {% if u.notas %}({{ u.notas }}){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="fw-bold">Notas / Observaciones</label>
                                        <textarea name="notas" class="form-control text-dark" rows="2" placeholder="Ej: Sobrante de producci√≥n / Merma por ca√≠da..."></textarea>
                                    </div>

                                    <div class="alert alert-danger mt-4 d-flex align-items-start">
                                        <div class="form-check me-2">
                                            <input class="form-check-input border-danger" type="checkbox" name="forzar_cierre" id="check{{ lote.id }}" style="transform: scale(1.3);">
                                        </div>
                                        <div>
                                            <label class="form-check-label fw-bold text-danger" for="check{{ lote.id }}">
                                                üõë YA NO VA A LLEGAR M√ÅS (Cerrar Orden)
                                            </label>
                                            <div class="small text-danger mt-1">
                                                Marca esto si terminaste de acomodar y sobr√≥ o falt√≥ producto.
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-success fw-bold">GUARDAR</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5 text-muted"><h4>No hay lotes por recibir</h4></div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const selectsAlmacen = document.querySelectorAll('.select-almacen');
    
    selectsAlmacen.forEach(select => {
        select.addEventListener('change', function() {
            const almacenId = this.value;
            const targetId = this.getAttribute('data-target');
            const selectUbicacion = document.getElementById(targetId);
            
            selectUbicacion.value = "";
            selectUbicacion.disabled = false;
            
            const opciones = selectUbicacion.querySelectorAll('option');
            let contador = 0;
            
            opciones.forEach(opt => {
                if (opt.value === "") return; 
                if (String(opt.getAttribute('data-almacen')) === String(almacenId)) {
                    opt.style.display = "block";
                    contador++;
                } else {
                    opt.style.display = "none";
                }
            });
            
            if (contador === 0) {
                selectUbicacion.options[0].text = "‚ö†Ô∏è No hay ubicaciones aqu√≠";
                selectUbicacion.disabled = true;
            } else {
                selectUbicacion.options[0].text = "-- Selecciona Ubicaci√≥n --";
            }
        });
    });
});
</script>
{% endblock %}

========================= FILE: .\app\templates\sales\console.html =========================
{% extends 'base.html' %}

{% block title %}Venta en Campo | GelMexSys{% endblock %}

{% block content %}
<style>
    /* 1. RESET Y CAPAS */
    .card, .card-body, .row, [class^="col-"] {
        overflow: visible !important;
        position: relative;
    }

    /* 2. BUSCADORES FLOTANTES */
    .lista-sugerencias {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 100000 !important;
        background: #ffffff;
        border: 2px solid #0d47a1;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        border-radius: 0 0 12px 12px;
        margin-top: 2px;
    }

    .item-sugerencia {
        padding: 14px 18px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white !important;
        color: #333 !important;
    }

    .item-sugerencia:hover {
        background-color: #e3f2fd !important;
    }

    /* 3. DISE√ëO DE TOTALES Y ALINEACI√ìN */
    .total-display { 
        font-size: 2.3rem; 
        font-weight: 900; 
        color: #0d47a1; 
    }
    
    .label-finanzas {
        font-size: 0.85rem;
        font-weight: bold;
    }

    .espaciador-footer { height: 130px; }
</style>

<div class="container-fluid pb-5">
    <div class="card card-erp mb-3 border-0 shadow-sm" style="z-index: 1001;">
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-12 col-md-5 position-relative" id="wrapperCliente">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">1. Buscar Cliente</label>
                    <input type="text" class="form-control form-control-lg border-primary shadow-sm" 
                           id="inputBusquedaCliente" placeholder="Nombre o negocio..." autocomplete="off">
                    <div id="listaSugerenciasCliente" class="lista-sugerencias"></div>
                    
                    <div id="resumenCliente" class="mt-2 d-none">
                        <div class="badge bg-primary d-block text-start p-2 mb-1">
                            Venta a: <span id="labelCliente"></span>
                        </div>
                        <div class="row g-1 text-center">
                            <div class="col-4 border-end">
                                <small class="text-muted d-block small-label">L√çMITE</small>
                                <span id="valLimite" class="fw-bold">$0.00</span>
                            </div>
                            <div class="col-4 border-end">
                                <small class="text-muted d-block small-label text-danger">DEBE</small>
                                <span id="valDebe" class="fw-bold text-danger">$0.00</span>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block small-label text-success">DISPONIBLE</small>
                                <span id="valDisponible" class="fw-bold text-success">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-md-4">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="small fw-bold text-muted mb-1 text-uppercase">2. M√©todo de Pago</label>
                            <select id="metodoPago" class="form-select form-select-lg border-primary fw-bold" onchange="renderCarrito()">
                                <option value="Credito" selected>CR√âDITO</option>
                                <option value="Contado">CONTADO (EFECTIVO)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                <input type="text" id="inputNotas" class="form-control" placeholder="Nota">
                                <label for="inputNotas" class="text-muted small"><i class="fa-solid fa-pen-nib me-1"></i>Motivo / Condiciones (M√≠n. 15 letras)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-3 text-end border-md-start d-flex flex-column justify-content-center">
                    <label class="small fw-bold text-muted d-block text-uppercase">Total de esta Nota</label>
                    <div class="total-display" id="granTotal">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-erp mb-4 shadow-sm" style="z-index: 1000;">
        <div class="card-body p-3">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-7 position-relative" id="wrapperProducto">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">3. Agregar Producto</label>
                    <input type="text" class="form-control form-control-lg border-primary shadow-sm" 
                           id="inputBusquedaProd" placeholder="Escribe nombre o SKU..." autocomplete="off">
                    <div id="listaSugerenciasProd" class="lista-sugerencias"></div>
                </div>
                <div class="col-6 col-md-2">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">Cant.</label>
                    <input type="number" id="inputCant" class="form-control form-control-lg text-center fw-bold" value="1" min="1">
                </div>
                <div class="col-6 col-md-3 d-grid">
                    <button onclick="agregarAlCarrito()" class="btn btn-primary btn-lg fw-bold shadow">
                        <i class="fa-solid fa-plus"></i> AGREGAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm" style="z-index: 1;">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="ps-3 py-3">Descripci√≥n</th>
                        <th class="text-center">Cant.</th>
                        <th class="text-end pe-3">Subtotal</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody id="tbodyCarrito"></tbody>
            </table>
        </div>
        <div id="emptyMsg" class="text-center py-5 text-muted">
            <i class="fa-solid fa-cart-shopping fa-3x mb-3 opacity-25"></i><br>
            <span class="fs-5">La nota de remisi√≥n est√° vac√≠a</span>
        </div>
    </div>
    <div class="espaciador-footer"></div>
</div>

<div class="fixed-bottom p-3 bg-white border-top shadow-lg d-grid">
    <button id="btnFinalizar" class="btn btn-success btn-lg fw-bold py-3 shadow" onclick="enviarPedido()" disabled>
        CONFIRMAR PREVENTA
    </button>
</div>

<script>
    let carrito = {};
    let totalGlobal = 0;
    let productoSeleccionado = null;
    let clienteId = null;
    let creditoDisponible = 0;

    const clientesArr = [
        {% for c in clientes %}
        { id: {{ c.id }}, nombre: "{{ c.nombre_negocio }}", encargado: "{{ c.nombres_encargado }}" },
        {% endfor %}
    ];
    
    const catalogoBase = {{ catalogo | tojson | safe }};
    let catalogoActual = JSON.parse(JSON.stringify(catalogoBase));

    // BUSCADOR CLIENTE
    const inCli = document.getElementById('inputBusquedaCliente');
    const sugCli = document.getElementById('listaSugerenciasCliente');

    inCli.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        sugCli.innerHTML = '';
        if(val.length < 1) { sugCli.style.display = 'none'; return; }

        const matches = clientesArr.filter(c => 
            c.nombre.toLowerCase().includes(val) || c.encargado.toLowerCase().includes(val)
        );

        matches.forEach(c => {
            const d = document.createElement('div');
            d.className = 'item-sugerencia';
            d.innerHTML = `<div><strong>${c.nombre}</strong><br><small>${c.encargado}</small></div>`;
            d.onclick = () => {
                inCli.value = c.nombre;
                document.getElementById('labelCliente').innerText = c.nombre;
                clienteId = c.id;
                sugCli.style.display = 'none';
                fetchInfoCliente(c.id);
            };
            sugCli.appendChild(d);
        });
        sugCli.style.display = matches.length > 0 ? 'block' : 'none';
    });

    // BUSCADOR PRODUCTO
    const inProd = document.getElementById('inputBusquedaProd');
    const sugProd = document.getElementById('listaSugerenciasProd');

    inProd.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        sugProd.innerHTML = '';
        if(val.length < 1) { sugProd.style.display = 'none'; return; }

        const matches = catalogoActual.filter(p => p.nombre.toLowerCase().includes(val));

        matches.forEach(p => {
            const d = document.createElement('div');
            d.className = 'item-sugerencia';
            const badge = p.esEspecial ? '<span class="badge bg-success ms-2">ESPECIAL</span>' : '';
            d.innerHTML = `<span>${p.nombre}${badge}</span><span class="fw-bold text-primary">$${p.precio.toFixed(2)}</span>`;
            d.onclick = () => {
                inProd.value = p.nombre;
                productoSeleccionado = p;
                sugProd.style.display = 'none';
                document.getElementById('inputCant').focus();
            };
            sugProd.appendChild(d);
        });
        sugProd.style.display = matches.length > 0 ? 'block' : 'none';
    });

    async function fetchInfoCliente(id) {
        try {
            const r = await fetch(`/ventas/api/cliente/${id}`);
            const d = await r.json();
            
            creditoDisponible = d.disponible;
            document.getElementById('resumenCliente').classList.remove('d-none');
            document.getElementById('valLimite').innerText = `$${d.limite_credito.toFixed(2)}`;
            document.getElementById('valDebe').innerText = `$${d.saldo_actual.toFixed(2)}`;
            document.getElementById('valDisponible').innerText = `$${d.disponible.toFixed(2)}`;
            
            catalogoActual = catalogoBase.map(p => {
                const esp = d.precios_especiales[p.id];
                return { ...p, precio: esp !== undefined ? esp : p.precio, esEspecial: esp !== undefined };
            });
            
            Object.keys(carrito).forEach(k => {
                const p = catalogoActual.find(x => x.id == k);
                if(p) carrito[k].precio = p.precio;
            });
            renderCarrito();
        } catch (e) { console.error(e); }
    }

    function agregarAlCarrito() {
        if(!clienteId) return alert("Selecciona un cliente");
        if(!productoSeleccionado) return;
        const c = parseFloat(document.getElementById('inputCant').value);
        if(c <= 0) return;

        if(carrito[productoSeleccionado.id]) carrito[productoSeleccionado.id].cant += c;
        else carrito[productoSeleccionado.id] = { nombre: productoSeleccionado.nombre, precio: productoSeleccionado.precio, cant: c };
        
        inProd.value = ''; productoSeleccionado = null; renderCarrito();
    }

    function renderCarrito() {
        const b = document.getElementById('tbodyCarrito');
        const metodo = document.getElementById('metodoPago').value;
        const btn = document.getElementById('btnFinalizar');
        const displayTotal = document.getElementById('granTotal');
        
        b.innerHTML = ''; totalGlobal = 0;
        
        Object.keys(carrito).forEach(id => {
            const i = carrito[id];
            const s = i.cant * i.precio;
            totalGlobal += s;
            b.innerHTML += `<tr>
                <td class="ps-3"><strong>${i.nombre}</strong><br><small>$${i.precio.toFixed(2)} u.</small></td>
                <td class="text-center fw-bold">${i.cant}</td>
                <td class="text-end pe-3">$${s.toFixed(2)}</td>
                <td class="text-center"><button class="btn btn-link text-danger" onclick="delItem(${id})"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        });
        
        displayTotal.innerText = '$' + totalGlobal.toFixed(2);
        document.getElementById('emptyMsg').style.display = Object.keys(carrito).length ? 'none' : 'block';
        
        const notaVacia = Object.keys(carrito).length === 0;
        const excedeCredito = (metodo === 'Credito' && totalGlobal > creditoDisponible);

        if (notaVacia) {
            btn.disabled = true;
            btn.classList.replace('btn-danger', 'btn-success');
            btn.innerText = "CONFIRMAR PREVENTA";
            displayTotal.classList.remove('text-danger');
        } else if (excedeCredito) {
            btn.disabled = true;
            btn.classList.replace('btn-success', 'btn-danger');
            btn.innerText = "L√çMITE DE CR√âDITO EXCEDIDO";
            displayTotal.classList.add('text-danger');
        } else {
            btn.disabled = false;
            btn.classList.replace('btn-danger', 'btn-success');
            btn.innerText = (metodo === 'Contado') ? "CONFIRMAR VENTA (CONTADO)" : "CONFIRMAR PREVENTA (CR√âDITO)";
            displayTotal.classList.remove('text-danger');
        }
    }

    function delItem(id) { delete carrito[id]; renderCarrito(); }

    async function enviarPedido() {
        const metodo = document.getElementById('metodoPago').value;
        const notas = document.getElementById('inputNotas').value.trim();

        // --- VALIDACI√ìN DE 15 CARACTERES (El Candado) ---
        if (notas.length < 15) {
            alert(`‚ö†Ô∏è ¬°Ey! Explica la venta.\n\nEscribe al menos 15 letras en el campo de Notas.\n(Actualmente tienes ${notas.length}).\n\nEjemplo: "Paga al recibir en tienda"`);
            document.getElementById('inputNotas').focus();
            return;
        }
        // ------------------------------------------------

        if(!confirm(`¬øConfirmar este pedido?`)) return;
        
        const payload = { 
            cliente_id: clienteId, 
            fecha_entrega: "{{ date_now }}", 
            metodo_pago: metodo, 
            total: totalGlobal, 
            notas: notas, 
            items: carrito 
        };

        try {
            const r = await fetch('/ventas/crear-pedido', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const d = await r.json();
            if(d.status === 'success') {
                alert("‚úÖ " + d.message);
                window.location.reload();
            } else { alert("‚ùå Error: " + d.message); }
        } catch (e) { alert("Error de conexi√≥n"); }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#wrapperCliente')) sugCli.style.display = 'none';
        if (!e.target.closest('#wrapperProducto')) sugProd.style.display = 'none';
    });
</script>
{% endblock %}

========================= FILE: .\db_seeds\data_catalogs.py =========================
# db_seeds/01_catalogs_data.py

CATALOGOS = {
    # --- INFRAESTRUCTURA ---
    "cat_plantas": [
        {"descripcion": "Planta Matriz Hgo", "notas": "Producci√≥n Principal"},        
    ],
    "cat_areas": [
        {"descripcion": "Producci√≥n", "notas": "Zona Congelacion"},        
        {"descripcion": "Log√≠stica y Carga", "notas": "Andenes"},
        {"descripcion": "Administraci√≥n", "notas": "Oficinas"}
    ],
    "cat_ubicaciones": [ # NUEVO: Faltaba este
        {"descripcion": "Pasillo A"},
        {"descripcion": "Pasillo B"},
        {"descripcion": "Nivel 1 (Piso)"},
        {"descripcion": "Nivel 2 (Rack)"},
        {"descripcion": "Zona de Carga"}
    ],

    # --- PRODUCTOS ---
    "cat_unidades_medida": [
        {"nombre": "Pieza", "abreviatura": "Pza"},
        {"nombre": "Litro", "abreviatura": "Lt"},
        {"nombre": "Kilogramo", "abreviatura": "Kg"},
        {"nombre": "Caja", "abreviatura": "Cja"},
        {"nombre": "Gramo", "abreviatura": "gr"}
    ],
    "cat_categorias_producto": [
        {"nombre": "Bolis Base Leche", "descripcion": "Base l√°ctea congelada"},
        {"nombre": "Bolis Base Agua", "descripcion": "Base Agua congelada"},
        {"nombre": "Paletas Base Crema", "descripcion": "Paleta Base l√°ctea"},
        {"nombre": "Paletas Base Agua", "descripcion": "Paleta Base Agua"},
        {"nombre": "Helado Base Leche", "descripcion": "Litros de helado Base leche"}, 
        {"nombre": "Helado Base Agua", "descripcion": "Litros de helado Base Agua"}
    ],
    "cat_categorias_materia_prima": [
        {"nombre": "L√°cteos", "descripcion": "Leche, Crema, Suero"},
        {"nombre": "Az√∫cares y Endulzantes", "descripcion": ""}, # OJO: Este es el nombre correcto
        {"nombre": "Saborizantes y Esencias", "descripcion": ""},
        {"nombre": "Empaque Primario", "descripcion": "Bolsitas, Palitos"},
        {"nombre": "Empaque Secundario", "descripcion": "Cajas cart√≥n, Cinta"}
    ],

    # --- ALMAC√âN ---
    "cat_tipos_almacen": [
        {"nombre": "C√°mara Fr√≠a (Congelaci√≥n)"},
        {"nombre": "Almac√©n Seco"},
        {"nombre": "C√°mara Refrigerada (Conservaci√≥n)"},
        {"nombre": "Almac√©n de Refacciones"}
    ],
    "cat_tipos_movimiento_almacen": [ # NUEVO: Requerido por K√°rdex
        {"descripcion": "ENTRADA_PRODUCCION"},
        {"descripcion": "REUBICACION_INTERNA"},
        {"descripcion": "SALIDA_EMPAQUE"},
        {"descripcion": "AJUSTE_INVENTARIO"},
        {"descripcion": "BAJA_MERMA"}
    ],

    # --- RH Y OPERACI√ìN ---
    "cat_puestos": [
        {"nombre": "Super Administrador", "nivel_acceso": 5},
        {"nombre": "Gerente de Planta", "nivel_acceso": 4},
        {"nombre": "Finanzas / Contador", "nivel_acceso": 4},
        {"nombre": "Programador Producci√≥n", "nivel_acceso": 3},
        {"nombre": "Almacenista", "nivel_acceso": 3},
        {"nombre": "Vendedor / Preventista", "nivel_acceso": 2},
        {"nombre": "Maestro Heladero", "nivel_acceso": 2},
        {"nombre": "Repartidor / Chofer", "nivel_acceso": 1}
    ],
    "cat_tipos_vehiculo": [
        {"nombre": "Unidad Refrigerada (Termo)"},
        {"nombre": "Motocicleta"},
        {"nombre": "Autom√≥vil Sed√°n"}
    ],
    "cat_estados_fisicos": [
        {"descripcion": "Nuevo"},
        {"descripcion": "Bueno / Operativo"},
        {"descripcion": "Regular / Requiere Atenci√≥n"},
        {"descripcion": "Malo / En Reparaci√≥n"},
        {"descripcion": "Baja Definitiva"}
    ],

    # --- FINANZAS Y CONTROL ---
    "cat_conceptos_finanzas": [
        {"tipo_flujo": "INGRESO", "descripcion": "Venta Contado Ruta"},
        {"tipo_flujo": "INGRESO", "descripcion": "Cobranza Cr√©dito (Abono)"},
        {"tipo_flujo": "INGRESO", "descripcion": "Aportaci√≥n de Capital"},
        {"tipo_flujo": "EGRESO", "descripcion": "Pago a Proveedor MP"},
        {"tipo_flujo": "EGRESO", "descripcion": "Pago N√≥mina"},
        {"tipo_flujo": "EGRESO", "descripcion": "Pago Servicios (Luz/Agua)"},
        {"tipo_flujo": "EGRESO", "descripcion": "Mantenimiento Vehicular"},
        {"tipo_flujo": "DEUDA", "descripcion": "Compra Cr√©dito MP"}
    ],
    "cat_tipos_incidencia": [
        {"descripcion": "Producto Derretido"},
        {"descripcion": "Producto Da√±ado/Aplastado"},
        {"descripcion": "Robo / Extrav√≠o"},
        {"descripcion": "Consumo Interno Autorizado"},
        {"descripcion": "Merma de Producci√≥n"},
        {"descripcion": "Error de Conteo"}
    ],
    "cat_bancos_cajas": [
        {"nombre": "Caja Chica Planta"},
        {"nombre": "Caja Fuerte Principal"},
        {"nombre": "Cuenta Fiscal BBVA"},
        {"nombre": "Cuenta N√≥mina Santander"}
    ],
    
    # --- NUEVOS AGREGADOS DE ARQUITECTURA MAESTRA ---
    "cat_tipos_descuento": [
        {"descripcion": "PORCENTAJE"},
        {"descripcion": "MONTO_FIJO"},
        {"descripcion": "PRECIO_FINAL"}
    ],
    "cat_tipos_pago_solicitado": [
        {"descripcion": "CONTADO"},
        {"descripcion": "CREDITO"}
    ],
    "cat_estados_orden_venta": [
        {"descripcion": "BORRADOR"},
        {"descripcion": "CONFIRMADO"},
        {"descripcion": "EN_PRODUCCION"},
        {"descripcion": "EMPACADO"},
        {"descripcion": "EN_RUTA"},
        {"descripcion": "ENTREGADO"},
        {"descripcion": "CANCELADO"}
    ],
    "cat_estados_plan_produccion": [
        {"descripcion": "PLANIFICADO"},
        {"descripcion": "EN_PROCESO"},
        {"descripcion": "CERRADO"}
    ],
    "cat_estados_orden_empaque": [
        {"descripcion": "EN_PROCESO"},
        {"descripcion": "LISTO_PARA_RUTA"}
    ],
    "cat_tipos_movimiento_finanzas": [
        {"descripcion": "CARGO_VENTA"},
        {"descripcion": "ABONO_EFECTIVO"},
        {"descripcion": "ABONO_TRANSFERENCIA"},
        {"descripcion": "NOTA_CREDITO"}
    ],
    "cat_estados_deuda_empresa": [
        {"descripcion": "PENDIENTE"},
        {"descripcion": "PAGADO"},
        {"descripcion": "VENCIDO"}
    ],
    "cat_tipos_flujo": [
        {"descripcion": "ENTRADA"},
        {"descripcion": "SALIDA"}
    ],
    "cat_origenes_flujo": [
        {"descripcion": "CAPITAL"},
        {"descripcion": "VENTAS"},
        {"descripcion": "PRESTAMO"}
    ],
    "cat_periodos": [
        {"descripcion": "MENSUAL"},
        {"descripcion": "ANUAL"}
    ]
}

========================= FILE: .\db_seeds\data_clients.py =========================
# db_seeds/data_clients.py

CLIENTES = [
    {
        # Datos Negocio
        "nombre_negocio": "Abarrotes Don Pepe",
        "rfc": "XAXX010101000",
        "tipo_negocio": "Tienda de Abarrotes",
        "calificacion": 5,
        "img_fachada": "uploads/clientes/donpepe_fachada.jpg",
        
        # Datos Encargado
        "nombres_encargado": "Jose",
        "apellidos_encargado": "Perez Lopez",
        
        # Direcci√≥n Negocio (AQU√ç TAMBI√âN CORREGIMOS)
        "calle": "Calle Morelos",
        "num_exterior": "45",
        "num_interior": "",
        "colonia": "San Isidro",
        "codigo_postal": "38600",  # <--- CORREGIDO (Antes dec√≠a 'cp')
        "ciudad": "Ac√°mbaro",
        "estado": "Guanajuato",
        "pais": "M√©xico", # Agregu√© pa√≠s por si acaso el modelo lo requiere, no estorba
        
        # Finanzas
        "limite_credito": 5000.00,
        "saldo_actual": 0.00,
        
        # Log√≠stica
        "ruta_asignada": "Ruta 1: Acambaro",
        
        # Precios Especiales
        "precios_especiales": [
            {
                "producto_sku": "BOL-LIM-STD",
                "tipo_descuento": "PRECIO_FINAL",
                "valor": 4.50
            },
            {
                "producto_sku": "PAL-FRE-CRM",
                "tipo_descuento": "PORCENTAJE",
                "valor": 10.00
            }
        ]
    }
]

========================= FILE: .\db_seeds\data_infrastructure.py =========================
# db_seeds/02_infrastructure_data.py

ALMACENES = [
    {
        "descripcion": "C√°mara Fr√≠a Principal (Producto Terminado)",
        "tipo": "C√°mara Fr√≠a (Congelaci√≥n)",
        "planta": "Planta Matriz Hgo",
        "area": "Log√≠stica y Carga",
        "ubicaciones": [
            # Generaremos c√≥digos autom√°ticos o manuales
            {"codigo": "CF1-PAS1-NV1", "notas": "Pasillo 1 Nivel 1"},
            {"codigo": "CF1-PAS1-NV2", "notas": "Pasillo 1 Nivel 2"},
            {"codigo": "CF1-PISO", "notas": "Almacenaje a piso"}
        ]
    },
    {
        "descripcion": "Almac√©n Materia Prima Seca",
        "tipo": "Almac√©n Seco",
        "planta": "Planta Matriz Hgo",
        "area": "Producci√≥n Helados",
        "ubicaciones": [
            {"codigo": "SEC-ANAQUEL-A", "notas": "Sacos Az√∫car"},
            {"codigo": "SEC-ANAQUEL-B", "notas": "Saborizantes"}
        ]
    }
]

RUTAS = [
    {"descripcion": "Ruta 1: Acambaro", "notas": "Lunes, Mi√©rcoles, Viernes"},
    {"descripcion": "Ruta 2: Queretaro", "notas": "Martes y Jueves"},
    {"descripcion": "Ruta 3: Zinapecuaro", "notas": "S√°bados"}
]


========================= FILE: .\db_seeds\data_products.py =========================
# db_seeds/data_products.py

PRODUCTOS = [
    {
        "sku": "BOL-LIM-STD",
        "descripcion": "Boli de Lim√≥n (Tama√±o Est√°ndar)",
        "categoria": "Bolis Base Agua",
        "unidad": "Pieza",
        # CORRECCI√ìN DE NOMBRES PARA COINCIDIR CON BD
        "precio_costo_actual": 2.50,      # Antes: precio_costo
        "precio_venta_general": 6.00,     # Antes: precio_venta
        "stock_minimo": 100,              # Antes: stock_min
        "stock_maximo": 2000,             # Antes: stock_max
        "stock_ideal": 1000,
        "peso_gramos": 150,               # Antes: peso_gr
        "caducidad_dias": 30,
        "imagen": "uploads/productos/bol_limon.jpg" # El runner maneja 'imagen' manualmente, este d√©jalo as√≠
    },
    {
        "sku": "PAL-FRE-CRM",
        "descripcion": "Paleta de Fresa con Crema",
        "categoria": "Paletas Base Crema",
        "unidad": "Pieza",
        "precio_costo_actual": 4.00,
        "precio_venta_general": 12.00,
        "stock_minimo": 50,
        "stock_maximo": 1000,
        "stock_ideal": 500,
        "peso_gramos": 120,
        "caducidad_dias": 45,
        "imagen": "uploads/productos/pal_fresa.jpg"
    }
]

MATERIAS_PRIMAS = [
    {
        "sku": "AZU-BUL-50",
        "descripcion": "Bulto de Az√∫car Est√°ndar 50kg",
        "categoria": "Az√∫cares y Endulzantes",
        "unidad": "Kilogramo", 
        # CORRECCI√ìN: Materia Prima usa 'precio_costo_promedio'
        "precio_costo_promedio": 22.50,   # Antes: precio_costo
        "precio_venta_general": 28.00,
        "stock_minimo": 100,
        "stock_maximo": 1000,
        "stock_ideal": 500,
        "peso_gramos": 1000,
        "caducidad_dias": 365,
        "imagen": "uploads/materias/azucar.jpg"
    }
]

========================= FILE: .\db_seeds\data_users.py =========================
# db_seeds/data_users.py

USUARIOS = [
    {
        # --- LOGIN ---
        "email": "admin@gelmex.com",
        "password_raw": "Admin2025",
        
        # --- SEGURIDAD ---
        "pin_seguridad": "123456",
        "nivel_usuario": 5,
        "activo": True,

        # --- IDENTIDAD ---
        "nombres": "Mario Eduardo",
        "apellido_paterno": "Martinez",
        "apellido_materno": "Juarez",
        "puesto": "Super Administrador",
        "rfc": "MAJU900101XXX",
        "curp": "MAJU900101HGT...",
        
        # --- LABORAL ---
        "fecha_inicio_empresa": "2024-01-01",
        "calificacion_evaluacion": 5,
        
        # --- CONTACTO ---
        "telefono_celular": "78610300599",
        "telefono_casa": "4171234567",
        
        # --- DIRECCI√ìN (AQU√ç ESTABA EL ERROR) ---
        "calle": "Av. Hidalgo",
        "num_exterior": "123",
        "num_interior": "A",
        "colonia": "Centro",
        "codigo_postal": "38600",   # <--- CORREGIDO (Antes dec√≠a 'cp')
        "ciudad": "Ac√°mbaro",
        "estado": "Guanajuato",
        "pais": "M√©xico",
        
        # --- EMERGENCIA ---
        "contacto_emergencia_nombre": "Maria Reyna Figueroa",
        "contacto_emergencia_telefono": "4179999999",
        
        # --- ARCHIVOS ---
        "foto_perfil": "uploads/usuarios/admin_profile.jpg"
    }
]

========================= FILE: .\_historial_parches\fix_catalog.py =========================
from app import create_app
from app.extensions import db
from app.models.catalogs import CatTipoMovimientoAlmacen

app = create_app()

with app.app_context():
    print("üîß Agregando opci√≥n 'INVENTARIO_INICIAL' al cat√°logo...")
    
    # Verificamos si ya existe para no duplicar
    existe = CatTipoMovimientoAlmacen.query.filter_by(descripcion="INVENTARIO_INICIAL").first()
    
    if not existe:
        nuevo = CatTipoMovimientoAlmacen(descripcion="INVENTARIO_INICIAL")
        db.session.add(nuevo)
        db.session.commit()
        print("‚úÖ ¬°LISTO! Opci√≥n creada. Ahora aparecer√° en el sistema.")
    else:
        print("‚ÑπÔ∏è La opci√≥n ya exist√≠a.")

========================= FILE: .\_historial_parches\fix_column.py =========================
from app import create_app
from app.extensions import db
from sqlalchemy import text

app = create_app()

with app.app_context():
    print("üîß Reparando tabla 'inventario_productos'...")
    try:
        # Comando SQL directo para agregar la columna que falta
        sql = text("ALTER TABLE inventario_productos ADD COLUMN cantidad_reservada FLOAT DEFAULT 0.0;")
        db.session.execute(sql)
        db.session.commit()
        print("‚úÖ ¬°√âXITO! Columna 'cantidad_reservada' agregada correctamente.")
    except Exception as e:
        print(f"‚ö†Ô∏è Aviso (puede que ya exista): {e}")

========================= FILE: .\_historial_parches\tests\test_inventory_flow.py =========================
import unittest
import sys
import os

# 1. PREPARACI√ìN DE ENTORNO (CR√çTICO: HACER ESTO ANTES DE IMPORTAR APP)
# Esto enga√±a a Flask para que ignore tu archivo .env real
os.environ['FLASK_ENV'] = 'testing'
# Forzamos una URI de SQLite en memoria. Si tu config.py usa os.getenv('DATABASE_URL'), esto lo intercepta.
os.environ['DATABASE_URL'] = 'sqlite:///:memory:'
os.environ['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'

# Ajuste de ruta para imports
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from app import create_app, db
from app.models.products import Producto
from app.models.stock import InventarioProducto
from app.models.infrastructure import Almacen, UbicacionAlmacen
from app.models.catalogs import CatTipoMovimientoAlmacen, CatCategoriaProducto, CatUnidadMedida

class TestFlujoInventario(unittest.TestCase):
    
    def setUp(self):
        """Se ejecuta ANTES de cada prueba. Configura el entorno aislado."""
        
        # Crear la app
        self.app = create_app()
        
        # --- DOBLE VERIFICACI√ìN DE SEGURIDAD (FAIL-SAFE) ---
        # Forzamos la configuraci√≥n en el objeto app directamente por si el entorno fall√≥
        self.app.config.update({
            "TESTING": True,
            "SQLALCHEMY_DATABASE_URI": "sqlite:///:memory:",
            "SQLALCHEMY_TRACK_MODIFICATIONS": False,
            "WTF_CSRF_ENABLED": False  # Desactivar tokens CSRF para facilitar test de formularios
        })

        self.app_context = self.app.app_context()
        self.app_context.push()

        # MATAR CUALQUIER CONEXI√ìN PREVIA (Por si acaso se col√≥ Postgres)
        db.session.remove()
        db.engine.dispose()

        # VERIFICACI√ìN FINAL: Si esto imprime algo que no sea memory, lanzamos excepci√≥n
        uri_actual = str(db.engine.url)
        print(f"   [DEBUG] Conectado a: {uri_actual}")
        
        if 'sqlite' not in uri_actual and ':memory:' not in uri_actual:
            raise RuntimeError(f"üö® PELIGRO: El test intent√≥ conectarse a {uri_actual}. ABORTANDO.")

        # Ahora s√≠, creamos las tablas en la RAM
        try:
            db.create_all()
        except Exception as e:
            print(f"Error creando DB virtual: {e}")
            raise

        # Cargar datos semilla falsos (Mocks)
        self.crear_datos_mock()

    def tearDown(self):
        """Se ejecuta DESPU√âS de cada prueba. Limpia la RAM."""
        db.session.remove()
        db.drop_all()
        self.app_context.pop()

    def crear_datos_mock(self):
        """Crea datos falsos exclusivos para la memoria RAM"""
        
        # 1. Cat√°logos (Sin duplicados porque la DB est√° vac√≠a en RAM)
        tipos = ['INVENTARIO_INICIAL', 'ENTRADA_COMPRA', 'SALIDA_VENTA', 'AJUSTE_MERMA']
        for t in tipos:
            db.session.add(CatTipoMovimientoAlmacen(descripcion=t))
        
        db.session.add(CatCategoriaProducto(nombre="Helados Test"))
        db.session.add(CatUnidadMedida(nombre="Pieza", abreviatura="PZ"))
        
        # 2. Infraestructura
        alm = Almacen(descripcion="Almac√©n RAM", tipo_id=1)
        db.session.add(alm)
        db.session.flush() # Para obtener el ID
        
        ubi = UbicacionAlmacen(codigo="RAM-A1", almacen_id=alm.id)
        db.session.add(ubi)
        db.session.flush()
        self.ubi_id = ubi.id

        # 3. Producto
        prod = Producto(sku="TEST-RAM", descripcion="Boli Virtual", categoria_id=1, unidad_id=1)
        db.session.add(prod)
        db.session.flush()
        self.prod_id = prod.id
        
        db.session.commit()

    # ==========================================
    # PRUEBAS UNITARIAS
    # ==========================================

    def test_flujo_completo_inventario(self):
        print("\nüß™ INICIANDO TEST DE INTEGRIDAD DE INVENTARIO...")

        # CASO 1: Ajuste Inicial (Reset)
        # Inyectamos un valor basura
        inv = InventarioProducto(producto_id=self.prod_id, ubicacion_id=self.ubi_id, cantidad_actual=-999)
        db.session.add(inv)
        db.session.commit()

        # Simulamos la l√≥gica de "INVENTARIO_INICIAL"
        target = InventarioProducto.query.filter_by(producto_id=self.prod_id, ubicacion_id=self.ubi_id).first()
        target.cantidad_actual = 500 # Borr√≥n y cuenta nueva
        db.session.commit()
        
        self.assertEqual(target.cantidad_actual, 500, "FALLO: El inventario inicial no resete√≥ el saldo negativo.")
        print("   ‚úÖ PASO 1: Correcci√≥n de negativos -> OK")

        # CASO 2: Entrada (Suma)
        target.cantidad_actual += 100
        db.session.commit()
        self.assertEqual(target.cantidad_actual, 600, "FALLO: La suma de entrada fall√≥.")
        print("   ‚úÖ PASO 2: Suma de inventario -> OK")

        # CASO 3: Salida (Resta)
        target.cantidad_actual -= 50
        db.session.commit()
        self.assertEqual(target.cantidad_actual, 550, "FALLO: La resta de salida fall√≥.")
        print("   ‚úÖ PASO 3: Resta de inventario -> OK")

        # CASO 4: Bloqueo de Stock Insuficiente
        # Intentamos sacar 1000 cuando hay 550
        saldo_antes = target.cantidad_actual
        if target.cantidad_actual >= 1000:
            target.cantidad_actual -= 1000
        else:
            # Esto es lo que esperamos que pase
            pass 
        
        self.assertEqual(target.cantidad_actual, saldo_antes, "FALLO: El sistema permiti√≥ sacar m√°s de lo que hab√≠a.")
        print("   ‚úÖ PASO 4: Bloqueo de saldo negativo -> OK")

if __name__ == '__main__':
    unittest.main()

========================= FILE: .\_historial_parches\tests\__init__.py =========================

