============================================================
 GELMEXSYS 2.0 - REPORTE DE CONTEXTO TÃ‰CNICO (PostgreSQL)
 FECHA: 2025-12-30 15:16:27
============================================================

------------------------------
ESTRUCTURA DE DIRECTORIOS:
[./]
    ARQUITECTURA_DATOS.md
    audit_system.py
    check_columns.py
    config.py
    HOJA_DE_METODO_INICIAL.md
    init_production_table.py
    intrucciones git.txt
    requirements.txt
    run.py
    seed_runner.py
    setup_db.py
    setup_structure.py
    update_db_real.py
    [app/]
        extensions.py
        forms.py
        __init__.py
        [blueprints/]
            api_test.py
            auth.py
            clients.py
            finance.py
            home.py
            inventory.py
            logistics.py
            production.py
            reception.py
            sales.py
            shipping.py
        [models/]
            catalogs.py
            clients.py
            finance.py
            infrastructure.py
            orders.py
            payments.py
            production.py
            products.py
            shipping.py
            stock.py
            users.py
            __init__.py
        [static/]
            [css/]
                main.css
            [js/]
        [templates/]
            base.html
            [auth/]
                login.html
            [clients/]
                form.html
                index.html
            [finance/]
                audit.html
                dashboard.html
                expenses.html
                income.html
                ticket_movement.html
            [home/]
                index.html
            [inventory/]
                catalog_list.html
                form.html
                movements.html
            [logistics/]
                collection_client.html
                collection_search.html
                delivery_handover.html
                route_dashboard.html
                ticket.html
            [production/]
                dashboard.html
                orders_list.html
            [reception/]
                reception_dock.html
            [sales/]
                console.html
            [shipping/]
                dashboard.html
                labels.html
                picking.html
    [db_seeds/]
        data_catalogs.py
        data_clients.py
        data_infrastructure.py
        data_products.py
        data_users.py
    [_historial_parches/]
        fix_catalog.py
        fix_column.py
        [tests/]
            test_inventory_flow.py
            __init__.py
------------------------------


========================= FILE: .\ARQUITECTURA_DATOS.md =========================
# ARQUITECTURA DE BASE DE DATOS - GELMEXSYS 2.0 (PostgreSQL)

**Motor:** PostgreSQL 15+
**ORM:** SQLAlchemy
**Estrategia:** Relacional Normalizada (3NF)

---

## 1. DICCIONARIO DE DATOS Y RELACIONES

### A. MÃ“DULO DE CATÃLOGOS SATÃ‰LITE (DinÃ¡micos)
*El cliente exigiÃ³ "No Hardcoding". Estas tablas permiten al admin crear nuevos tipos sin llamar al programador.*

1.  **`cat_plantas`**
    * `id` (PK), `descripcion`, `notas`.
2.  **`cat_areas`**
    * `id` (PK), `descripcion`, `notas`.
3.  **`cat_unidades_medida`**
    * `id` (PK), `nombre` (Litro, Pieza), `abreviatura` (Lt, Pza).
4.  **`cat_categorias_producto`**
    * `id` (PK), `nombre` (Bolis Leche, Paletas Agua), `descripcion`.
5.  **`cat_categorias_materia_prima`**
    * `id` (PK), `nombre` (LÃ¡cteos, Saborizantes), `descripcion`.
6.  **`cat_tipos_almacen`**
    * `id` (PK), `nombre` (CÃ¡mara FrÃ­a, Seco, Conservador).
7.  **`cat_puestos`**
    * `id` (PK), `nombre` (Vendedor, Heladero, Repartidor), `nivel_acceso` (1-5).
8.  **`cat_tipos_vehiculo`**
    * `id` (PK), `nombre` (Sedan, Pickup, Refrigerada).
9.  **`cat_modelos_vehiculo`**
    * `id` (PK), `marca`, `modelo`, `anio`.
10. **`cat_modelos_activo`** (Para refrigeradores/congeladores)
    * `id` (PK), `marca`, `modelo`, `capacidad_litros`.
11. **`cat_estados_fisicos`**
    * `id` (PK), `descripcion` (Bueno, Malo, Ã“ptimo, Nuevo, En Taller).

---

### B. MÃ“DULO DE RECURSOS HUMANOS (Usuarios)

**Tabla: `usuarios`**
*Contiene la ficha completa del empleado.*
* `id` (PK)
* **Datos Personales:**
    * `nombres`, `apellido_paterno`, `apellido_materno`.
    * `fecha_nacimiento`, `estado_civil`, `profesion`.
    * `domicilio_calle`, `domicilio_num_ext`, `domicilio_num_int`, `domicilio_colonia`, `domicilio_cp`, `domicilio_ciudad`, `domicilio_estado`, `domicilio_pais`.
    * `telefono_casa`, `telefono_celular`.
* **Datos Laborales:**
    * `puesto_id` (FK -> `cat_puestos`).
    * `fecha_inicio_empresa`.
    * `calificacion_evaluacion` (1-5 Estrellas).
    * `notas_generales`.
* **Seguridad y Acceso:**
    * `email` (Login), `password_hash`, `pin_seguridad` (6 dÃ­gitos).
    * `nivel_usuario` (Heredado de puesto o sobreescrito).
* **Emergencia:**
    * `contacto_emergencia_nombre`, `contacto_emergencia_telefono`.
* **DocumentaciÃ³n (Rutas de Archivos en `uploads/usuarios/`):**
    * `foto_perfil` (Uso interno).
    * `img_ine_frente`, `img_ine_reverso`.
    * `img_licencia_frente`, `img_licencia_reverso`, `fecha_validez_licencia`.

---

### C. MÃ“DULO DE PRODUCTOS Y MATERIA PRIMA

**Tabla: `productos`**
* `id` (PK), `sku` (Ãšnico).
* `descripcion`.
* `categoria_id` (FK -> `cat_categorias_producto`).
* `unidad_id` (FK -> `cat_unidades_medida`).
* **Costos y Precios:**
    * `precio_costo_actual`.
    * `precio_venta_general` (Base).
* **FÃ­sico:**
    * `peso_gramos`, `caducidad_dias`.
    * `imagen_producto` (300x300 jpg, path).

**Tabla: `materia_prima`**
* `id` (PK), `sku`, `descripcion`.
* `categoria_id` (FK -> `cat_categorias_materia_prima`).
* `unidad_id` (FK -> `cat_unidades_medida`).
* `precio_costo_promedio`.
* `precio_venta_general` (Base).
* `peso_gramos`, `caducidad_dias`.
* `imagen_materia` (300x300 jpg, path).

---

### D. MÃ“DULO DE INFRAESTRUCTURA E INVENTARIOS

**Tabla: `almacenes`**
* `id` (PK), `descripcion`.
* `tipo_id` (FK -> `cat_tipos_almacen`).
* `planta_id` (FK -> `cat_plantas`).
* `area_id` (FK -> `cat_areas`).
* `imagen_almacen` (300x300 jpg).

**Tabla: `ubicaciones_almacen`**
* `id` (PK), `codigo` (Ej: CFPA001B004).
* `almacen_id` (FK -> `almacenes`).
* `notas`.

**Tabla: `inventario_lotes` (El corazÃ³n del stock)**
* `id` (PK).
* **QuÃ© es:**
    * `producto_id` (FK, Nullable).
    * `materia_prima_id` (FK, Nullable).
* **DÃ³nde estÃ¡:**
    * `ubicacion_id` (FK -> `ubicaciones_almacen`).
* **CuÃ¡nto hay:**
    * `cantidad_actual`.
    * `fecha_produccion` (Lote).
    * `fecha_ingreso_almacen`.
    * `stock_minimo`.
    * `stock_maximo`.
    * `stock_ideal`.
* **SemÃ¡foros (Definidos por producto, pero guardados aquÃ­ para snapshot o referenciados):**
    * (LÃ³gica: Se compara `cantidad_actual` vs `Producto.stock_minimo` o `cantidad_actual` vs `Producto.stock_maximo`).

---

### E. MÃ“DULO DE LOGÃSTICA Y ACTIVOS

**Tabla: `vehiculos`**
* `id` (PK), `placas`.
* `serie_vehiculo`.
* `tipo_id` (FK -> `cat_tipos_vehiculo`).
* `modelo_id` (FK -> `cat_modelos_vehiculo`).
* `estado_llantas_id` (FK -> `cat_estados_fisicos`).
* `estado_general_id` (FK -> `cat_estados_fisicos`).
* `kilometraje_ultimo_servicio`.
* `asignado` (Boolean).
* **Fechas CrÃ­ticas:**
    * `fecha_ultimo_servicio`, `fecha_proximo_servicio`.
    * `fecha_vencimiento_seguro`, `fecha_vencimiento_verificacion`.
* **Evidencia (600x400 jpg):**
    * `img_vehiculo`, `img_motor`, `img_odometro`.

**Tabla: `activos_frio` (Congeladores)**
* `id` (PK), `serie`, `descripcion`.
* `modelo_id` (FK -> `cat_modelos_activo`).
* `estado_id` (FK -> `cat_estados_fisicos`).
* `asignado` (Boolean).
* `img_activo` (300x300 jpg).
* `fecha_ultimo_mtto`, `fecha_proximo_mtto`.

**Tabla: `rutas_reparto`**
* `id` (PK), `descripcion`.
* `img_mapa` (600x400 jpg).
* `notas`.

---

### F. MÃ“DULO DE VENTAS Y CLIENTES (Complejidad Alta)

**Tabla: `clientes`**
* `id` (PK).
* **Negocio:**
    * `nombre_negocio`, `tipo_negocio`.
    * `img_fachada` (300x300 jpg).
    * `calificacion` (1-5).
* **Encargado:**
    * `nombres_encargado`, `apellido_p_encargado`, `apellido_m_encargado`.
    * `img_ine_frente`, `img_ine_reverso`.
    * `domicilio_completo` (Desglosado igual que usuarios).
* **Financiero:**
    * `Vendedor_habitual_id` (FK -> `usuarios`, Nullable).
    * `limite_credito` (CuÃ¡nto le fÃ­a GelMex).
    * `saldo_actual` (Deuda actual).
* **LogÃ­stica:**
    * `ruta_id` (FK -> `rutas_reparto`).
    * `repartidor_habitual_id` (FK -> `usuarios`, Nullable).

**Tabla: `asignacion_activos_cliente`**
* `cliente_id` (FK).
* `activo_frio_id` (FK).
* `fecha_asignacion`.

**Tabla: `precios_especiales_cliente` (Regla de Negocio CrÃ­tica)**
* *Esta tabla permite que cada cliente tenga un precio diferente.*
* `id` (PK).
* `cliente_id` (FK).
* `producto_id` (FK).
* `tipo_descuento`: ('PORCENTAJE', 'MONTO_FIJO', 'PRECIO_FINAL').
* `valor_descuento`: (Ej. 10, 5.00, 15.50).
* *LÃ³gica:* Al vender, el sistema busca aquÃ­ primero. Si no encuentra, usa `Producto.precio_venta_general`.

---

## 2. LÃ“GICA DE PROCEDIMIENTOS Y VISTAS

### A. Vistas (Views) para Reportes RÃ¡pidos
Estas vistas se crearÃ¡n en la BD para facilitar el trabajo de los Dashboards.

1.  **`view_inventario_global`**:
    * Suma el stock de todas las ubicaciones agrupado por SKU.
    * Muestra: SKU, DescripciÃ³n, Total Plantas, Total Rutas, Total General.

2.  **`view_estado_credito`**:
    * Lista clientes con `saldo_actual > 0`.
    * Calcula `credito_disponible` = `limite_credito` - `saldo_actual`.
    * Alerta si `saldo_actual` >= `limite_credito`.

### B. LÃ³gica de Transacciones (Procedimientos "LÃ³gicos")
No usaremos Stored Procedures de SQL (PL/pgSQL) para la lÃ³gica de negocio, usaremos **Servicios en Python** (capa intermedia) para mantener el control de versiones, pero la lÃ³gica serÃ¡ transaccional (Atomicity).

1.  **Procedimiento `CrearPedido`:**
    * Input: Cliente, Lista de Items.
    * ValidaciÃ³n 1: Â¿El cliente tiene crÃ©dito suficiente? (Si es venta a crÃ©dito).
    * CÃ¡lculo: Iterar items -> Buscar si existe `precios_especiales_cliente` -> Calcular Subtotal.
    * Output: Orden en estado "BORRADOR" o "CONFIRMADO".

2.  **Procedimiento `ConfirmarProduccion` (Maestro Heladero):**
    * Input: Orden de ProducciÃ³n, Cantidad Real Producida.
    * AcciÃ³n:
        * Restar Materia Prima (segÃºn receta - *Futuro*).
        * Sumar Stock a "UbicaciÃ³n Temporal ProducciÃ³n".
        * Crear registro en `inventario_lotes`.

3.  **Procedimiento `CierreRuta` (Finanzas):**
    * Input: ID Ruta, Efectivo Entregado, Notas de CrÃ©dito Firmadas.
    * AcciÃ³n:
        * Actualizar `saldo_actual` de cada cliente (Resta abonos, suma nuevos pedidos a crÃ©dito).
        * Conciliar Stock del camiÃ³n (Lo que saliÃ³ vs lo que volviÃ³ vs lo vendido).

---

## 3. ESTRATEGIA DE SEMILLAS (DB SEEDS)

Para el archivo `db_seeds.py`, seguiremos este orden estricto de llenado para evitar errores de Llaves ForÃ¡neas (FK):

1.  **Nivel 0 (CatÃ¡logos Duros):** Unidades de medida, Tipos de AlmacÃ©n, Estados FÃ­sicos.
2.  **Nivel 1 (Infraestructura):** Plantas, Ãreas, Rutas base.
3.  **Nivel 2 (CategorÃ­as):** CategorÃ­as de Productos y Materia Prima, Puestos.
4.  **Nivel 3 (Recursos):** Productos Base, Almacenes fÃ­sicos, VehÃ­culos demo.
5.  **Nivel 4 (Usuarios):** Crear al "Super Admin" (Dios) y un Vendedor demo.

========================= FILE: .\audit_system.py =========================
from app import create_app
from app.extensions import db
from sqlalchemy import inspect

app = create_app()

def audit_schema():
    with app.app_context():
        inspector = inspect(db.engine)
        print("=== AUDITORÃA DE ESTRUCTURA ACTUAL ===\n")

        # 1. REVISAR ORDENES DE VENTA
        print("--- TABLA: ordenes_venta ---")
        columns = inspector.get_columns('ordenes_venta')
        for col in columns:
            print(f"- {col['name']} ({col['type']})")
        
        # 2. REVISAR DETALLES (Vital para ver si tenemos cantidad_entregada)
        print("\n--- TABLA: orden_venta_detalles ---")
        columns = inspector.get_columns('orden_venta_detalles')
        for col in columns:
            print(f"- {col['name']} ({col['type']})")

        # 3. REVISAR CLIENTES (Vital para saldos y crÃ©ditos)
        print("\n--- TABLA: clientes ---")
        columns = inspector.get_columns('clientes')
        for col in columns:
            print(f"- {col['name']} ({col['type']})")

        # 4. CHECAR SI YA EXISTE PAGOS (Para no duplicar)
        if inspector.has_table('pagos'):
            print("\n--- TABLA: pagos (YA EXISTE) ---")
            columns = inspector.get_columns('pagos')
            for col in columns:
                print(f"- {col['name']} ({col['type']})")
        else:
            print("\n--- TABLA: pagos (NO EXISTE AÃšN) ---")

if __name__ == '__main__':
    audit_schema()

========================= FILE: .\check_columns.py =========================
from app import create_app
from app.models.infrastructure import UbicacionAlmacen

app = create_app()

with app.app_context():
    print("-" * 30)
    print(f"TABLA REAL: {UbicacionAlmacen.__tablename__}")
    print("-" * 30)
    print("COLUMNAS EN EL MODELO:")
    # Esto nos dirÃ¡ exactamente quÃ© atributos tiene la clase Python
    for column in UbicacionAlmacen.__table__.columns:
        print(f" >> {column.name}")
    print("-" * 30)

========================= FILE: .\config.py =========================
import os

class Config:
    # Llave de seguridad (luego la cambiamos por una real en producciÃ³n)
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'clave-super-secreta-desarrollo'
    SQLALCHEMY_TRACK_MODIFICATIONS = False

class DevelopmentConfig(Config):
    DEBUG = True
    # ConexiÃ³n a PostgreSQL Local
    # Formato: postgresql://usuario:password@localhost:puerto/nombre_db
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'postgresql://postgres:admin12345@localhost:5432/gelmex_db'

class ProductionConfig(Config):
    DEBUG = False
    # AquÃ­ irÃ­a la conexiÃ³n a PostgreSQL real
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')

# Diccionario para elegir fÃ¡cil
config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}

========================= FILE: .\HOJA_DE_METODO_INICIAL.md =========================
# HOJA DE MÃ‰TODO: DESPLIEGUE DE ENTORNO (GMX-OP-01)

| **PROYECTO** | **ID OPERACIÃ“N** | **REVISIÃ“N** | **RESPONSABLE** |
| :---              | :---              | :---         | :---                   |
| GelMexSys 2.0 ERP | OP-001-SETUP      | 1.1 (Fix)    | Ing. Mario E. MartÃ­nez |

## 1. OBJETIVO DE LA OPERACIÃ“N
Estandarizar el procedimiento de "Rearme Inicial" y configuraciÃ³n del entorno de desarrollo, asegurando la vinculaciÃ³n explÃ­cita a la versiÃ³n correcta de Python (3.12) y la gestiÃ³n de dependencias sin conflictos.

## 2. ESPECIFICACIONES DE ENTRADA (SNAPSHOT)
El sistema ha sido validado bajo los siguientes parÃ¡metros crÃ­ticos. **No proceder si no se cumplen.**

| ParÃ¡metro     | Valor Especificado    | Criterio de AceptaciÃ³n      |
| :-------------| :-------------------- | :-------------------------- |
| **S.O.** | Windows 10/11 (x64)   | Sistema Host Operativo      |
| **Git Core** | **v2.52.0.windows.1** | Hash de versiÃ³n coincidente |
| **Python** | **C:\Python312** | Ruta Absoluta del Binario   |
| **Framework** | Flask (Modular)       | InstalaciÃ³n limpia          |


## 3. SECUENCIA DE OPERACIONES
### OP 10: InstalaciÃ³n de Herramientas Base
**DescripciÃ³n:** PreparaciÃ³n del entorno host.
1. Descargar instalador certificado desde [git-scm.com](https://git-scm.com/).
2. Ejecutar instalaciÃ³n estÃ¡ndar (Default Settings).
3. **Punto de Control (InspecciÃ³n):** Ejecutar comando de validaciÃ³n.
   powershell
   git --version
   # SALIDA ESPERADA: git version 2.52.0.windows.1

### OP 20: ConfiguraciÃ³n de Identidad (Gafete Digital)
**DescripciÃ³n:** AsignaciÃ³n de trazabilidad al usuario.
1. Ejecutar en terminal:
powershell
git config --global user.name "edwared"
git config --global user.email "elektrion@gmail.com"

### OP 30: InicializaciÃ³n del Repositorio

**DescripciÃ³n:** ActivaciÃ³n del control de cambios en el directorio de trabajo.

1. Iniciar rastreo:
powershell
git init


2. **Seguridad:** Crear archivo de bloqueo `.gitignore` con los siguientes filtros:
```text
venv/
__pycache__/
*.pyc
instance/
.env
*.db
app/static/uploads/

3. **LÃ­nea Base:** Generar el primer punto de restauraciÃ³n.
```powershell
git add .
git commit -m "Inicio: Estructura base y entorno virtual segÃºn HOJA DE METODO OP-001"

### OP 40: Aprovisionamiento y VinculaciÃ³n de Entorno

**DescripciÃ³n:** CreaciÃ³n del contenedor aislado (VENV) forzando la ruta del ejecutable para evitar ambigÃ¼edad en Windows y carga de materiales.

1. **CreaciÃ³n con Ruta Absoluta:**
Usar el operador de llamada `&` de PowerShell para invocar el ejecutable especÃ­fico y evitar errores de sintaxis.
powershell
& "C:\Python312\python.exe" -m venv venv

2. **ActivaciÃ³n (Punto CrÃ­tico):**
powershell
.\venv\Scripts\activate

*VerificaciÃ³n Visual: Debe aparecer `(venv)` en verde al inicio de la terminal.*
3. **ValidaciÃ³n de Origen (Quality Gate):**
Asegurar que el sistema no estÃ¡ usando el Python de C:.
powershell
Get-Command python
# CRITERIO DE ACEPTACIÃ“N: Source debe ser ".../GelMexSys2.0/venv/Scripts/python.exe"

4. **DefiniciÃ³n de Lista de Materiales (BOM):**
Editar archivo `requirements.txt` con el siguiente contenido exacto para evitar conflictos de versiones:

Flask==3.0.0
python-dotenv==1.0.0
SQLAlchemy>=2.0.16
Flask-SQLAlchemy>=3.1.1


5. **InyecciÃ³n de Dependencias:**
powershell
pip install -r requirements.txt




## 4. DIAGRAMA DE ARQUITECTURA RESULTANTE

Al finalizar la operaciÃ³n y ejecutar el script de estructura, el directorio debe coincidir con este patrÃ³n:

GelMexSys2.0/
â”œâ”€â”€ HOJA_DE_METODO_INICIAL.md  <-- Documento Maestro Actualizado
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ blueprints/            # LÃ³gica (Controladores)
â”‚   â”œâ”€â”€ models/                # Datos (ORM)
â”‚   â”œâ”€â”€ static/                # Assets
â”‚   â”œâ”€â”€ templates/             # Vistas
â”‚   â””â”€â”€ __init__.py            # App Factory
â”œâ”€â”€ instance/                  # BD Local
â”œâ”€â”€ run.py                     # Entry Point
â””â”€â”€ requirements.txt           # BOM Certificado


# GUÃA TÃ‰CNICA: DESPLIEGUE DE MOTOR DE BASE DE DATOS (GMX-DB-01)

### PASO 1: Descarga e InstalaciÃ³n

1. Ve al sitio oficial: [https://www.postgresql.org/download/windows/](https://www.postgresql.org/download/windows/)
2. Dale clic en **"Download the installer"**.
3. Elige la versiÃ³n **16.x** (es la mÃ¡s estable ahorita) para Windows x86-64.
4. Ejecuta el instalador.

**Durante la instalaciÃ³n (OJO AQUÃ):**

* **Componentes:** AsegÃºrate de que estÃ©n marcados:
* [x] PostgreSQL Server
* [x] pgAdmin 4 (Este es el panel visual para administrar, indispensable).
* [x] Command Line Tools


* **Directorio:** DÃ©jalo por defecto.
* **ContraseÃ±a (CRÃTICO):** Te va a pedir una contraseÃ±a para el "Superusuario (postgres)".
* âš ï¸ **EscrÃ­bela:** Ponle `admin` o `123456` por ahora para desarrollo local. **No la olvides**, porque sin ella no podemos conectar Python.


* **Puerto:** DÃ©jalo en `5432` (EstÃ¡ndar).
* **Locale:** DÃ©jalo por defecto (Default locale).

Dale "Siguiente" a todo hasta que termine.

---

### PASO 2: Crear la Base de Datos "gelmex_db"

Ya instalado, no vamos a usar consola negra, vamos a usar lo visual.

1. Presiona la tecla `Windows` y busca **pgAdmin 4**. Ãbrelo (es el icono del elefante).
2. Te va a pedir la contraseÃ±a que acabas de crear. PÃ³nsela.
3. A la izquierda verÃ¡s `Servers` -> `PostgreSQL 16`. Dale doble clic para conectar.
4. Dale **clic derecho** sobre "Databases" -> **Create** -> **Database...**
5. En el nombre ponle: **`gelmex_db`** (Todo minÃºsculas).
6. Dale **Save**.

Â¡Listo! Ya tienes el contenedor vacÃ­o esperando los datos.

---

### PASO 3: Conectar Flask a PostgreSQL

Ahora hay que decirle a tu cÃ³digo: "Oye, deja de usar SQLite y conÃ©ctate al Postgres que acabamos de instalar".

1. Abre tu archivo **`config.py`** en VS Code.
2. Busca la clase `DevelopmentConfig`.
3. Modifica la lÃ­nea `SQLALCHEMY_DATABASE_URI`.

Debe quedar asÃ­ (cambia `TU_CONTRASEÃ‘A` por la que pusiste en el instalador):

```python
class DevelopmentConfig(Config):
    DEBUG = True
    # ConexiÃ³n a PostgreSQL Local
    # Formato: postgresql://usuario:password@localhost:puerto/nombre_db
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'postgresql://postgres:TU_CONTRASEÃ‘A@localhost:5432/gelmex_db'

```

*Nota: Si tu contraseÃ±a es `admin`, la lÃ­nea queda: `'postgresql://postgres:admin@localhost:5432/gelmex_db'*`

---

### PASO 4: Instalar el Driver

Para que Python hable con Postgres, necesita un traductor. Ejecuta esto en tu terminal (con el `(venv)` activo):

```powershell
pip install psycopg2-binary

```

---

### PASO 5: Generar las Tablas (La Prueba de Fuego)

Ahora sÃ­, ya con el motor instalado, la base creada y el cÃ³digo conectado, vamos a crear las tablas.

Ejecuta tu archivo de arranque:

```powershell
python run.py

```

1. Si dice `Running on http://127.0.0.1:5000`, **EXITAZO**.
2. Para confirmar, ve a **pgAdmin 4**, ve a `gelmex_db` -> `Schemas` -> `public` -> `Tables`. Dale clic derecho y "Refresh".
3. DeberÃ­as ver ahÃ­ toda la lista: `almacenes`, `clientes`, `productos`, `usuarios`... Â¡Todas las tablas vacÃ­as creadas por SQLAlchemy!


Â¡Excelente iniciativa! Es el momento exacto para hacer un **Checkpoint (Commit)**. Acabamos de pasar de una "App Hola Mundo" a un **Sistema ERP con Arquitectura de Datos Enterprise conectada a PostgreSQL**.

Si algo se rompe maÃ±ana, necesitamos poder volver a este punto exacto donde todo funciona (Tablas creadas + ConexiÃ³n Exitosa).

AquÃ­ tienes el procedimiento para ejecutar la **OP-50 (Control de Cambios)** siguiendo tu estÃ¡ndar.

---

### OP 50: Aseguramiento de VersiÃ³n (Git Commit)

**DescripciÃ³n:** ConsolidaciÃ³n de la Arquitectura de Datos, Modelos ORM y conexiÃ³n a motor de base de datos.

**1. Verificar el Estado (Reconocimiento)**
Primero, vamos a ver todo lo que Git detectÃ³ que cambiamos (Modelos, Config, Seeds, etc.). Ejecuta en tu terminal:

```powershell
git status

```

*DeberÃ­as ver en rojo (o verde si ya agregaste algo) archivos como `app/models/`, `db_seeds/`, `config.py`, `setup_db.py`, etc.*

**2. Preparar el Paquete (Staging)**
Vamos a subir todo al Ã¡rea de preparaciÃ³n.

```powershell
git add .

```

**3. Ejecutar el Commit (Guardado)**
Este es el comando clave. Copia y pega este mensaje para que quede profesional y descriptivo en el historial:

```powershell
git commit -m "Feat: Implementacion Arquitectura de Datos PostgreSQL y Modelos ORM

- Configuracion de conexion a PostgreSQL en config.py (GMX-DB-01).
- Creacion de Modelos Maestros: Catalogos, Usuarios, Productos, Clientes, Infraestructura.
- Integracion de script de sembrado de datos (seed_runner.py) y diccionarios de datos.
- Instalacion de driver psycopg2-binary.
- Validacion de creacion de tablas en pgAdmin 4."

```

---

### ActualizaciÃ³n de tu DocumentaciÃ³n

Para mantener tu **HOJA DE MÃ‰TODO (GMX-OP-01)** actualizada con lo que acabamos de hacer, aquÃ­ tienes el bloque que debes agregar al final de tu documento de texto para cerrar el ciclo de la "RevisiÃ³n 1.1":

#### OP 60: IntegraciÃ³n de Motor de Datos (Post-Deployment)

**DescripciÃ³n:** VinculaciÃ³n del entorno de aplicaciÃ³n con el servidor de datos persistente.

1. **InstalaciÃ³n de Driver:**
```powershell
pip install psycopg2-binary

```


2. **ConfiguraciÃ³n de Enlace:**
Editar `config.py` para apuntar a `postgresql://postgres:***@localhost:5432/gelmex_db`.
3. **Despliegue de Esquema:**
Ejecutar script de diagnÃ³stico y construcciÃ³n:
```powershell
python setup_db.py

```


*Criterio de AceptaciÃ³n: Mensaje "âœ… Â¡Ã‰XITO! TABLAS CREADAS CORRECTAMENTE." y visualizaciÃ³n de 34 tablas en pgAdmin.*

---



========================= FILE: .\init_production_table.py =========================
from app import create_app, db
# Importamos el modelo para que SQLAlchemy sepa que existe
from app.models.production import OrdenProduccion 

app = create_app()

with app.app_context():
    print("ðŸ”§ Verificando tablas faltantes...")
    # Esto crea SOLO las tablas que no existen (ordenes_produccion)
    db.create_all()
    print("âœ… Tabla 'ordenes_produccion' creada exitosamente en PostgreSQL.")

========================= FILE: .\intrucciones git.txt =========================
1. Revisa quÃ© vas a meter al horno
powershell
git status
*DeberÃ­as ver en rojo (o verde si ya le diste add) archivos como `HOJA_DE_METODO_INICIAL.md`, `generate_context.py` y `requirements.txt`.*

2. Prepara todo el paquete
powershell
git add .

3. Sella el compromiso (Commit)
Este mensaje describe que arreglamos el relajo del entorno y las herramientas:
powershell
git commit -m "Fix: CorrecciÃ³n de entorno venv y actualizaciÃ³n de herramientas de contexto"

Y listo, wey. Con eso ya quedÃ³ guardado este avance.

========================= FILE: .\requirements.txt =========================
Flask==3.0.0
python-dotenv==1.0.0
SQLAlchemy>=2.0.16
Flask-SQLAlchemy>=3.1.1

========================= FILE: .\run.py =========================
# run.py
import os
from app import create_app

config_name = os.getenv('FLASK_CONFIG') or 'default'
app = create_app(config_name)

if __name__ == '__main__':
    print(f"--> Arrancando GelMexSys en modo: {config_name}")
    print("--> ACCESO EXTERNO HABILITADO: Usa tu IP para entrar desde el cel.")
    
    # AGREGAMOS host='0.0.0.0'
    app.run(host='0.0.0.0', port=5000)

========================= FILE: .\seed_runner.py =========================
# seed_runner.py
from app import create_app
from app.extensions import db
from werkzeug.security import generate_password_hash

# --- IMPORTAR MODELOS ---
from app.models.catalogs import *
from app.models.users import Usuario
from app.models.infrastructure import Almacen, UbicacionAlmacen, RutaReparto
from app.models.products import Producto, MateriaPrima
from app.models.clients import Cliente, PrecioEspecialCliente

# --- IMPORTAR DATOS (Nombres Corregidos) ---
from db_seeds.data_catalogs import CATALOGOS
from db_seeds.data_infrastructure import ALMACENES, RUTAS
from db_seeds.data_products import PRODUCTOS, MATERIAS_PRIMAS
from db_seeds.data_users import USUARIOS
from db_seeds.data_clients import CLIENTES

app = create_app()

def run_seeds():
    with app.app_context():
        print("ðŸŒ± INICIANDO SEMBRADO DE DATOS GELMEXSYS 2.0...")
        
        # 1. CATÃLOGOS
        print("--> Sembrando CatÃ¡logos...")
        mapa_catalogos = {
            "cat_plantas": CatPlanta, "cat_areas": CatArea, "cat_ubicaciones": CatUbicacion,
            "cat_unidades_medida": CatUnidadMedida, "cat_categorias_producto": CatCategoriaProducto,
            "cat_categorias_materia_prima": CatCategoriaMateriaPrima, "cat_tipos_almacen": CatTipoAlmacen,
            "cat_tipos_movimiento_almacen": CatTipoMovimientoAlmacen, "cat_puestos": CatPuesto,
            "cat_tipos_vehiculo": CatTipoVehiculo, "cat_estados_fisicos": CatEstadoFisico,
            "cat_conceptos_finanzas": CatConceptoFinanzas, "cat_tipos_incidencia": CatTipoIncidencia,
            "cat_bancos_cajas": CatBancoCaja, "cat_tipos_descuento": CatTipoDescuento,
            "cat_tipos_pago_solicitado": CatTipoPagoSolicitado, "cat_estados_orden_venta": CatEstadoOrdenVenta,
            "cat_estados_plan_produccion": CatEstadoPlanProduccion, "cat_estados_orden_empaque": CatEstadoOrdenEmpaque,
            "cat_tipos_movimiento_finanzas": CatTipoMovimientoFinanzas, "cat_estados_deuda_empresa": CatEstadoDeudaEmpresa,
            "cat_tipos_flujo": CatTipoFlujo, "cat_origenes_flujo": CatOrigenFlujo, "cat_periodos": CatPeriodo
        }

        for tabla_key, modelo in mapa_catalogos.items():
            datos = CATALOGOS.get(tabla_key, [])
            for item in datos:
                # BÃºsqueda flexible (por descripciÃ³n o nombre)
                criterio = {}
                if hasattr(modelo, 'descripcion'): criterio['descripcion'] = item['descripcion']
                elif hasattr(modelo, 'nombre'): criterio['nombre'] = item['nombre']
                
                if not modelo.query.filter_by(**criterio).first():
                    db.session.add(modelo(**item))
        db.session.commit()

        # 2. INFRAESTRUCTURA
        print("--> Sembrando Infraestructura...")
        for r in RUTAS:
            if not RutaReparto.query.filter_by(descripcion=r['descripcion']).first():
                db.session.add(RutaReparto(**r))
        db.session.commit()

        for alm in ALMACENES:
            if not Almacen.query.filter_by(descripcion=alm['descripcion']).first():
                tipo = CatTipoAlmacen.query.filter_by(nombre=alm['tipo']).first()
                planta = CatPlanta.query.filter_by(descripcion=alm['planta']).first()
                # BÃºsqueda parcial para Ãrea
                area = CatArea.query.filter(CatArea.descripcion.ilike(f"%{alm['area']}%")).first()
                
                if tipo and planta and area:
                    nuevo = Almacen(descripcion=alm['descripcion'], tipo_id=tipo.id, planta_id=planta.id, area_id=area.id)
                    db.session.add(nuevo)
                    db.session.commit()
                    for ubi in alm['ubicaciones']:
                        db.session.add(UbicacionAlmacen(codigo=ubi['codigo'], notas=ubi['notas'], almacen_id=nuevo.id))
        db.session.commit()

        # 3. PRODUCTOS
        print("--> Sembrando Inventario Maestro...")
        for p in PRODUCTOS:
            if not Producto.query.filter_by(sku=p['sku']).first():
                cat = CatCategoriaProducto.query.filter_by(nombre=p['categoria']).first()
                uni = CatUnidadMedida.query.filter_by(nombre=p['unidad']).first()
                if cat and uni:
                    # Quitamos campos que no son columnas directas
                    data = {k: v for k, v in p.items() if k not in ['categoria', 'unidad', 'imagen']}
                    prod = Producto(**data)
                    prod.categoria_id, prod.unidad_id = cat.id, uni.id
                    prod.imagen_producto = p.get('imagen')
                    db.session.add(prod)
        
        for mp in MATERIAS_PRIMAS:
            if not MateriaPrima.query.filter_by(sku=mp['sku']).first():
                cat = CatCategoriaMateriaPrima.query.filter_by(nombre=mp['categoria']).first()
                uni = CatUnidadMedida.query.filter_by(nombre=mp['unidad']).first()
                if cat and uni:
                    data = {k: v for k, v in mp.items() if k not in ['categoria', 'unidad', 'imagen']}
                    mat = MateriaPrima(**data)
                    mat.categoria_id, mat.unidad_id = cat.id, uni.id
                    mat.imagen_materia = mp.get('imagen')
                    db.session.add(mat)
        db.session.commit()

        # 4. USUARIOS
        print("--> Sembrando Usuarios...")
        for u in USUARIOS:
            if not Usuario.query.filter_by(email_acceso=u['email']).first():
                puesto = CatPuesto.query.filter_by(nombre=u['puesto']).first()
                data = u.copy()
                del data['password_raw'], data['puesto'], data['email']
                
                user = Usuario(**data)
                user.email_acceso = u['email']
                user.password_hash = generate_password_hash(u['password_raw'])
                if puesto: user.puesto_id = puesto.id
                db.session.add(user)
        db.session.commit()

        # 5. CLIENTES
        print("--> Sembrando Clientes...")
        for c in CLIENTES:
            if not Cliente.query.filter_by(nombre_negocio=c['nombre_negocio']).first():
                ruta = RutaReparto.query.filter_by(descripcion=c['ruta_asignada']).first()
                data = c.copy()
                precios = data.pop('precios_especiales', [])
                del data['ruta_asignada']
                
                cte = Cliente(**data)
                if ruta: cte.ruta_id = ruta.id
                db.session.add(cte)
                db.session.commit()

                for pe in precios:
                    prod = Producto.query.filter_by(sku=pe['producto_sku']).first()
                    td = CatTipoDescuento.query.filter_by(descripcion=pe['tipo_descuento']).first()
                    if prod and td:
                        db.session.add(PrecioEspecialCliente(cliente_id=cte.id, producto_id=prod.id, tipo_descuento_id=td.id, valor_descuento=pe['valor']))
        db.session.commit()
        
        print("\nâœ… Â¡SEMBRADO COMPLETADO! La base de datos tiene vida.")

if __name__ == "__main__":
    try:
        run_seeds()
    except Exception as e:
        print(f"âŒ ERROR: {e}")

========================= FILE: .\setup_db.py =========================
# setup_db.py
import sys
import os

# Agregamos el directorio actual al path para evitar errores de mÃ³dulos
sys.path.append(os.getcwd())

from app import create_app
from app.extensions import db

def init_database():
    print("--> Inicializando aplicaciÃ³n Flask...")
    # 1. Instanciamos la app AQUÃ ADENTRO para evitar el error de variable
    app = create_app()

    with app.app_context():
        print("ðŸ”§ INICIANDO CONSTRUCCIÃ“N DE BASE DE DATOS...")
        print(f"--> Destino: {app.config['SQLALCHEMY_DATABASE_URI']}")
        
        try:
            # 2. Importar Modelos (Esto fuerza a SQLAlchemy a reconocer las tablas)
            print("--> Leyendo planos (Modelos)...")
            # Importamos dentro del contexto para asegurar que db estÃ© listo
            from app.models import catalogs
            from app.models import users
            from app.models import infrastructure
            from app.models import products
            from app.models import clients
            print("    [OK] Modelos cargados en memoria.")

            # 3. Crear Tablas
            print("--> Ejecutando CREATE TABLE en PostgreSQL...")
            db.create_all()
            
            print("-" * 40)
            print("âœ… Â¡Ã‰XITO! TABLAS CREADAS CORRECTAMENTE.")
            print("-" * 40)
            print("Instrucciones:")
            print("1. Ve a pgAdmin 4.")
            print("2. Dale clic derecho a 'Tables' -> Refresh.")
            print("3. Si ves la lista de tablas, ejecuta 'python seed_runner.py' para llenar los datos.")
            
        except Exception as e:
            print("\nâŒ ERROR CRÃTICO AL CONECTAR CON LA BD:")
            print(f"{e}")
            print("\nPOSIBLES CAUSAS:")
            print("1. La contraseÃ±a en config.py estÃ¡ mal.")
            print("2. El servidor de PostgreSQL no estÃ¡ corriendo.")
            print("3. La base de datos 'gelmex_db' no existe (CrÃ©ala en pgAdmin).")

if __name__ == "__main__":
    init_database()

========================= FILE: .\setup_structure.py =========================
import os
import pathlib

# --- CONFIGURACIÃ“N DEL BLUEPRINT (ESPECIFICACIÃ“N DE ARQUITECTURA) ---
# Definimos la estructura exacta aprobada en la Hoja de MÃ©todo
PROJECT_STRUCTURE = {
    "directories": [
        "app",
        "app/blueprints",   # Controladores
        "app/models",       # Base de Datos
        "app/static",       # Assets PÃºblicos
        "app/static/css",
        "app/static/js",
        "app/static/img",
        "app/templates",    # Vistas HTML
        "instance"          # DB Local (Protegida)
    ],
    "files": [
        "app/__init__.py",              # Inicializador del Core
        "app/blueprints/__init__.py",   # Inicializador de Paquete
        "app/models/__init__.py",       # Inicializador de Paquete
        "run.py",                       # Entry Point
        "config.py",                    # Variables de Entorno
        "requirements.txt"              # Lista de materiales (BOM)
    ]
}

def create_structure():
    print(f"[ INFO ] Iniciando despliegue de arquitectura GelMexSys 2.0...")
    
    # 1. Crear Directorios
    for directory in PROJECT_STRUCTURE["directories"]:
        path = pathlib.Path(directory)
        if not path.exists():
            os.makedirs(path)
            print(f"[ OK ] Directorio creado: {directory}/")
        else:
            print(f"[ SKIP ] El directorio ya existe: {directory}/")

    # 2. Crear Archivos VacÃ­os (Touch)
    for file in PROJECT_STRUCTURE["files"]:
        path = pathlib.Path(file)
        if not path.exists():
            # Crear archivo vacÃ­o
            with open(path, 'w') as f:
                pass 
            print(f"[ OK ] Archivo base generado: {file}")
        else:
            print(f"[ SKIP ] El archivo ya existe: {file}")

    print("-" * 40)
    print(f"[ FIN ] Despliegue de estructura completado con Ã©xito.")

if __name__ == "__main__":
    create_structure()

========================= FILE: .\update_db_real.py =========================
from app import create_app, db
from sqlalchemy import text

app = create_app()

with app.app_context():
    print("ðŸ”§ Actualizando tabla de Ã“rdenes de ProducciÃ³n...")
    try:
        # 1. Columna para lo que REALMENTE saliÃ³ de la mÃ¡quina
        db.session.execute(text("ALTER TABLE ordenes_produccion ADD COLUMN cantidad_producida_real FLOAT DEFAULT 0;"))
        print("âœ… Columna 'cantidad_producida_real' agregada.")
    except Exception as e:
        print(f"â„¹ï¸ Aviso: {e}")

    try:
        # 2. Columna para notas del Maestro (Excusas de por quÃ© saliÃ³ menos)
        db.session.execute(text("ALTER TABLE ordenes_produccion ADD COLUMN notas_produccion TEXT;"))
        print("âœ… Columna 'notas_produccion' agregada.")
    except Exception as e:
        print(f"â„¹ï¸ Aviso: {e}")
        
    db.session.commit()
    print("ðŸš€ Base de datos lista para la Realidad Operativa.")

========================= FILE: .\app\extensions.py =========================
# app/extensions.py
from flask_sqlalchemy import SQLAlchemy

# Inicializamos el objeto db sin la app todavÃ­a (Lazy Loading)
db = SQLAlchemy()

========================= FILE: .\app\forms.py =========================
# app/forms.py
from flask_wtf import FlaskForm
from wtforms import StringField, DecimalField, SelectField, FileField, SubmitField, IntegerField
from wtforms.validators import DataRequired, NumberRange, Length, Optional, Email
from flask_wtf.file import FileAllowed

class ProductoForm(FlaskForm):
    sku = StringField('SKU / CÃ³digo', validators=[DataRequired(), Length(max=50)])
    descripcion = StringField('Nombre del Producto', validators=[DataRequired(), Length(max=200)])
    categoria_id = SelectField('CategorÃ­a', coerce=int, validators=[DataRequired()])
    unidad_id = SelectField('Unidad de Medida', coerce=int, validators=[DataRequired()])
    precio_costo = DecimalField('Costo ProducciÃ³n ($)', places=2, validators=[NumberRange(min=0)])
    precio_venta = DecimalField('Precio Venta ($)', places=2, validators=[DataRequired(), NumberRange(min=0)])
    stock_minimo = IntegerField('Stock MÃ­nimo (Alerta)', validators=[NumberRange(min=0)], default=10)
    imagen = FileField('Foto del Producto', validators=[FileAllowed(['jpg', 'png', 'jpeg'], 'Solo imÃ¡genes JPG o PNG')])
    submit = SubmitField('Guardar Producto')

# --- NUEVO FORMULARIO DE CLIENTES ---
class ClienteForm(FlaskForm):
    # PestaÃ±a 1: Identidad y Contacto
    nombre_negocio = StringField('Nombre del Negocio', validators=[DataRequired(), Length(max=150)])
    rfc = StringField('RFC', validators=[Optional(), Length(max=13)])
    tipo_negocio = StringField('Giro / Tipo', validators=[Optional()])
    
    nombres_encargado = StringField('Nombre Encargado', validators=[DataRequired()])
    apellidos_encargado = StringField('Apellidos Encargado', validators=[Optional()])
    
    telefono = StringField('TelÃ©fono Fijo', validators=[Optional()])
    celular = StringField('Celular (WhatsApp)', validators=[Optional()])
    email = StringField('Correo ElectrÃ³nico', validators=[Optional(), Email(message="Email invÃ¡lido")])

    # PestaÃ±a 2: DirecciÃ³n
    calle = StringField('Calle', validators=[DataRequired()])
    num_exterior = StringField('NÃºmero Ext.', validators=[DataRequired()])
    colonia = StringField('Colonia', validators=[DataRequired()])
    codigo_postal = StringField('C.P.', validators=[Optional()])
    ciudad = StringField('Ciudad', validators=[DataRequired()])
    estado = StringField('Estado', default='Guanajuato')

    # PestaÃ±a 3: OperaciÃ³n
    ruta_id = SelectField('Ruta de Reparto', coerce=int, validators=[DataRequired()])
    vendedor_id = SelectField('Vendedor Asignado', coerce=int, validators=[Optional()])
    repartidor_id = SelectField('Repartidor Habitual', coerce=int, validators=[Optional()])

    # PestaÃ±a 4: Finanzas
    limite_credito = DecimalField('LÃ­mite de CrÃ©dito ($)', places=2, default=0.00)
    
    # PestaÃ±a 5: Documentos
    img_fachada = FileField('Fachada Negocio', validators=[FileAllowed(['jpg', 'png', 'jpeg'])])
    img_ine_frente = FileField('INE Frente', validators=[FileAllowed(['jpg', 'png', 'jpeg'])])
    img_ine_reverso = FileField('INE Reverso', validators=[FileAllowed(['jpg', 'png', 'jpeg'])])

    submit = SubmitField('Guardar Cliente')

========================= FILE: .\app\__init__.py =========================
from flask import Flask
from config import config
from app.extensions import db
from flask_login import LoginManager 

def create_app(config_name='default'):
    app = Flask(__name__)
    app.config.from_object(config[config_name])

    db.init_app(app)

    # --- CONFIGURACIÃ“N DE LOGIN ---
    login_manager = LoginManager()
    login_manager.login_view = 'auth.login'
    login_manager.login_message = "Debes iniciar sesiÃ³n para acceder a este sistema."
    login_manager.login_message_category = "warning"
    login_manager.init_app(app)

    # FunciÃ³n para cargar usuario desde la Cookie
    from app.models.users import Usuario
    @login_manager.user_loader
    def load_user(user_id):
        return Usuario.query.get(int(user_id))
    # --------------------------------------

    with app.app_context():
        # IMPORTANTE: Agregamos 'finance' para que detecte los modelos financieros
        from app.models import catalogs, users, infrastructure, products, clients, stock, orders, payments, finance
        db.create_all()

    # --- REGISTRO DE BLUEPRINTS ---
    from app.blueprints.api_test import api_bp
    app.register_blueprint(api_bp)

    from app.blueprints.home import home_bp
    app.register_blueprint(home_bp)

    from app.blueprints.auth import auth_bp
    app.register_blueprint(auth_bp)

    from app.blueprints.inventory import inventory_bp
    app.register_blueprint(inventory_bp)

    from app.blueprints.reception import reception_bp
    app.register_blueprint(reception_bp)

    from app.blueprints.sales import sales_bp
    app.register_blueprint(sales_bp)

    from app.blueprints.production import production_bp
    app.register_blueprint(production_bp)

    from app.blueprints.shipping import shipping_bp
    app.register_blueprint(shipping_bp)
    
    from app.blueprints.logistics import logistics_bp
    app.register_blueprint(logistics_bp)

    # NUEVO: MÃ³dulo de Finanzas
    from app.blueprints.finance import finance_bp
    app.register_blueprint(finance_bp)

    from app.blueprints.clients import clients_bp
    app.register_blueprint(clients_bp)

    return app

========================= FILE: .\app\blueprints\api_test.py =========================
# app/blueprints/api_test.py
from flask import Blueprint, jsonify
from app.models.users import Usuario
from app.models.products import Producto
from app.models.clients import Cliente

# Definimos el "Mapa" de rutas para pruebas
api_bp = Blueprint('api_test', __name__, url_prefix='/api/v1')

@api_bp.route('/status', methods=['GET'])
def check_status():
    return jsonify({"status": "OK", "message": "GelMexSys 2.0 Backend Operativo", "db": "PostgreSQL"})

@api_bp.route('/usuarios', methods=['GET'])
def get_usuarios():
    # Consulta real a la Base de Datos
    users = Usuario.query.all()
    # Convertimos los objetos de Python a lista de diccionarios (JSON)
    data = [{
        "id": u.id, 
        "nombre": f"{u.nombres} {u.apellido_paterno}", 
        "email": u.email_acceso,
        "puesto": u.puesto.nombre if u.puesto else "Sin Asignar"
    } for u in users]
    return jsonify(data)

@api_bp.route('/productos', methods=['GET'])
def get_productos():
    prods = Producto.query.all()
    data = [{
        "sku": p.sku,
        "descripcion": p.descripcion,
        "precio_venta": float(p.precio_venta_general),
        "stock_actual": 0 # Ahorita estÃ¡ en 0 porque no hemos hecho entradas de almacÃ©n
    } for p in prods]
    return jsonify(data)

@api_bp.route('/clientes', methods=['GET'])
def get_clientes():
    clients = Cliente.query.all()
    data = []
    for c in clients:
        # Sacamos sus precios especiales
        precios = []
        for p_esp in c.precios_especiales:
            precios.append({
                "producto": p_esp.producto.descripcion,
                "descuento_tipo": p_esp.tipo_descuento.descripcion,
                "valor": float(p_esp.valor_descuento)
            })
            
        data.append({
            "negocio": c.nombre_negocio,
            "encargado": c.nombres_encargado,
            "precios_especiales": precios
        })
    return jsonify(data)

========================= FILE: .\app\blueprints\auth.py =========================
# app/blueprints/auth.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required, current_user
from app.models.users import Usuario

auth_bp = Blueprint('auth', __name__, url_prefix='/auth')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    # Si ya estÃ¡ logueado, lo mandamos directo al dashboard
    if current_user.is_authenticated:
        return redirect(url_for('home.dashboard'))

    if request.method == 'POST':
        email_form = request.form.get('email')
        password_form = request.form.get('password')
        
        # 1. Buscar usuario en DB
        usuario = Usuario.query.filter_by(email_acceso=email_form).first()
        
        # 2. Validar que exista y que la contraseÃ±a sea correcta
        if usuario and usuario.check_password(password_form):
            login_user(usuario) # Crear la sesiÃ³n (Cookie)
            flash(f'Â¡Bienvenido de nuevo, {usuario.nombres}!', 'success')
            
            # Redirigir a donde querÃ­a ir o al dashboard
            next_page = request.args.get('next')
            return redirect(next_page or url_for('home.dashboard'))
        else:
            flash('Correo o contraseÃ±a incorrectos. Intenta de nuevo.', 'danger')
        
    return render_template('auth/login.html')

@auth_bp.route('/logout')
@login_required # Solo si estÃ¡s logueado puedes salir
def logout():
    logout_user()
    flash('Has cerrado sesiÃ³n correctamente.', 'info')
    return redirect(url_for('auth.login'))

========================= FILE: .\app\blueprints\clients.py =========================
import os
from flask import Blueprint, render_template, redirect, url_for, flash, request, current_app
from flask_login import login_required, current_user
from werkzeug.utils import secure_filename
from app.extensions import db
from sqlalchemy import func

# Modelos
from app.models.clients import Cliente, PrecioEspecialCliente
from app.models.products import Producto
from app.models.infrastructure import RutaReparto, ActivoFrio
from app.models.users import Usuario
from app.models.catalogs import CatPuesto, CatTipoDescuento
from app.models.orders import OrdenVenta
from app.forms import ClienteForm

clients_bp = Blueprint('clients', __name__, url_prefix='/clientes')

# --- UTILIDAD: GUARDAR IMÃGENES ---
def guardar_imagen(file, prefix):
    if not file or not file.filename: return None
    filename = secure_filename(f"{prefix}_{file.filename}")
    db_path = f"uploads/clientes/{filename}"
    save_path = os.path.join(current_app.root_path, 'static', 'uploads', 'clientes')
    os.makedirs(save_path, exist_ok=True)
    file.save(os.path.join(save_path, filename))
    return db_path

# --- LISTADO ---
@clients_bp.route('/')
@login_required
def index():
    clientes = Cliente.query.filter_by(activo=True).order_by(Cliente.nombre_negocio).all()
    return render_template('clients/index.html', clientes=clientes)

# --- CREAR ---
@clients_bp.route('/nuevo', methods=['GET', 'POST'])
@login_required
def create():
    form = ClienteForm()
    cargar_selectores_inteligentes(form)

    if form.validate_on_submit():
        # En CREAR no usamos populate_obj para tener control total desde cero
        nuevo_cliente = Cliente(
            nombre_negocio=form.nombre_negocio.data,
            rfc=form.rfc.data,
            tipo_negocio=form.tipo_negocio.data,
            nombres_encargado=form.nombres_encargado.data,
            apellidos_encargado=form.apellidos_encargado.data,
            telefono=form.telefono.data,
            celular=form.celular.data,
            email=form.email.data,
            calle=form.calle.data,
            num_exterior=form.num_exterior.data,
            colonia=form.colonia.data,
            codigo_postal=form.codigo_postal.data,
            ciudad=form.ciudad.data,
            estado=form.estado.data,
            ruta_id=form.ruta_id.data,
            vendedor_habitual_id=form.vendedor_id.data if form.vendedor_id.data > 0 else None,
            repartidor_habitual_id=form.repartidor_id.data if form.repartidor_id.data > 0 else None,
            limite_credito=form.limite_credito.data,
            saldo_actual=0.0,
            activo=True
        )

        # Guardado de imÃ¡genes inicial
        if form.img_fachada.data: 
            nuevo_cliente.img_fachada = guardar_imagen(form.img_fachada.data, 'fac')
        if form.img_ine_frente.data:
            nuevo_cliente.img_ine_frente = guardar_imagen(form.img_ine_frente.data, 'inef')
        if form.img_ine_reverso.data:
            nuevo_cliente.img_ine_reverso = guardar_imagen(form.img_ine_reverso.data, 'iner')

        db.session.add(nuevo_cliente)
        db.session.commit()
        
        flash('âœ… Cliente registrado. Ahora configura sus precios especiales.', 'success')
        return redirect(url_for('clients.edit', id=nuevo_cliente.id))

    return render_template('clients/form.html', form=form, titulo="Nuevo Cliente", cliente=None)

# --- EDITAR (AQUI ESTABA EL ERROR) ---
@clients_bp.route('/editar/<int:id>', methods=['GET', 'POST'])
@login_required
def edit(id):
    cliente = Cliente.query.get_or_404(id)
    form = ClienteForm(obj=cliente)
    cargar_selectores_inteligentes(form)
    
    if request.method == 'GET':
        form.vendedor_id.data = cliente.vendedor_habitual_id or 0
        form.repartidor_id.data = cliente.repartidor_habitual_id or 0

    if form.validate_on_submit():
        # 1. Rescatamos las rutas actuales ANTES de que populate_obj las borre
        ruta_fachada_actual = cliente.img_fachada
        ruta_ine_f_actual = cliente.img_ine_frente
        ruta_ine_r_actual = cliente.img_ine_reverso

        # 2. Actualizamos los campos de texto
        form.populate_obj(cliente) 
        
        # 3. LÃ³gica de Rescate de ImÃ¡genes:
        # Si el usuario subiÃ³ archivo nuevo (data y filename existen) -> Guardamos nueva ruta
        # Si NO subiÃ³ archivo (FileStorage vacÃ­o) -> Restauramos la ruta vieja

        # Fachada
        if form.img_fachada.data and form.img_fachada.data.filename:
            cliente.img_fachada = guardar_imagen(form.img_fachada.data, f'fac_{id}')
        else:
            cliente.img_fachada = ruta_fachada_actual

        # INE Frente
        if form.img_ine_frente.data and form.img_ine_frente.data.filename:
            cliente.img_ine_frente = guardar_imagen(form.img_ine_frente.data, f'inef_{id}')
        else:
            cliente.img_ine_frente = ruta_ine_f_actual

        # INE Reverso
        if form.img_ine_reverso.data and form.img_ine_reverso.data.filename:
            cliente.img_ine_reverso = guardar_imagen(form.img_ine_reverso.data, f'iner_{id}')
        else:
            cliente.img_ine_reverso = ruta_ine_r_actual

        # 4. Ajuste de IDs manuales
        cliente.vendedor_habitual_id = form.vendedor_id.data if form.vendedor_id.data > 0 else None
        cliente.repartidor_habitual_id = form.repartidor_id.data if form.repartidor_id.data > 0 else None

        db.session.commit()
        flash('âœ… Datos actualizados.', 'success')
        return redirect(url_for('clients.edit', id=id))

    # CÃ¡lculo de Deuda Real
    ventas_en_curso = db.session.query(func.sum(OrdenVenta.total_venta))\
        .filter(OrdenVenta.cliente_id == id)\
        .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_PRODUCCION', 'EMPACADO', 'EN_RUTA']))\
        .scalar() or 0.0
    
    riesgo_total = float(cliente.saldo_actual) + float(ventas_en_curso)

    productos = Producto.query.filter_by(activo=True).order_by(Producto.descripcion).all()
    tipos_descuento = CatTipoDescuento.query.all()

    return render_template('clients/form.html', 
                           form=form, 
                           titulo="Editar Cliente", 
                           cliente=cliente,
                           productos=productos,
                           tipos_descuento=tipos_descuento,
                           riesgo_total=riesgo_total)

# --- BAJA LÃ“GICA ---
@clients_bp.route('/eliminar/<int:id>')
@login_required
def delete(id):
    cliente = Cliente.query.get_or_404(id)
    if cliente.saldo_actual > 1:
        flash(f'âš ï¸ No se puede dar de baja. Tiene deuda de ${cliente.saldo_actual}.', 'warning')
        return redirect(url_for('clients.index'))

    cliente.activo = False
    db.session.commit()
    flash(f'ðŸ—‘ï¸ Cliente "{cliente.nombre_negocio}" dado de baja.', 'info')
    return redirect(url_for('clients.index'))

# --- PRECIOS ESPECIALES ---
@clients_bp.route('/add-precio', methods=['POST'])
@login_required
def add_precio():
    try:
        nuevo = PrecioEspecialCliente(
            cliente_id=int(request.form.get('cliente_id')),
            producto_id=int(request.form.get('producto_id')),
            tipo_descuento_id=int(request.form.get('tipo_descuento_id')),
            valor_descuento=float(request.form.get('valor'))
        )
        db.session.add(nuevo)
        db.session.commit()
        flash('âœ… Precio especial agregado.', 'success')
    except Exception as e:
        flash(f'Error: {str(e)}', 'danger')
    return redirect(url_for('clients.edit', id=request.form.get('cliente_id')))

@clients_bp.route('/del-precio/<int:id>')
@login_required
def del_precio(id):
    precio = PrecioEspecialCliente.query.get_or_404(id)
    cid = precio.cliente_id
    db.session.delete(precio)
    db.session.commit()
    flash('Precio eliminado.', 'info')
    return redirect(url_for('clients.edit', id=cid))

# --- HELPERS ---
def cargar_selectores_inteligentes(form):
    form.ruta_id.choices = [(r.id, r.descripcion) for r in RutaReparto.query.all()]
    
    puestos_vend = CatPuesto.query.filter(CatPuesto.nombre.ilike('%Vendedor%')).all()
    ids_vend = [p.id for p in puestos_vend]
    if ids_vend:
        vendedores = Usuario.query.filter(Usuario.puesto_id.in_(ids_vend), Usuario.activo==True).all()
    else:
        vendedores = []
    form.vendedor_id.choices = [(0, '-- Sin Asignar --')] + [(u.id, f"{u.nombres} {u.apellido_paterno}") for u in vendedores]

    puestos_rep = CatPuesto.query.filter(CatPuesto.nombre.ilike('%Repartidor%')).all()
    ids_rep = [p.id for p in puestos_rep]
    if ids_rep:
        repartidores = Usuario.query.filter(Usuario.puesto_id.in_(ids_rep), Usuario.activo==True).all()
    else:
        repartidores = []
    form.repartidor_id.choices = [(0, '-- Sin Asignar --')] + [(u.id, f"{u.nombres} {u.apellido_paterno}") for u in repartidores]

========================= FILE: .\app\blueprints\finance.py =========================
import random
import string
from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify
from flask_login import login_required, current_user
from datetime import datetime
from sqlalchemy import func, desc
from sqlalchemy.exc import IntegrityError
from app.extensions import db

# Modelos
from app.models.finance import CajaEmpresa, TransaccionFinanciera, GastoOperativo
from app.models.payments import Pago
from app.models.orders import OrdenVenta
from app.models.catalogs import CatConceptoFinanzas

finance_bp = Blueprint('finance', __name__, url_prefix='/finanzas')

# --- UTILIDAD: GENERADOR DE FOLIOS ---
def generar_folio_tesoreria(tipo):
    prefijo = "ING" if tipo == 'INGRESO' else "EGR"
    fecha = datetime.now().strftime('%y%m%d')
    sufijo = ''.join(random.choices(string.ascii_uppercase + string.digits, k=4))
    return f"TES-{prefijo}-{fecha}-{sufijo}"

@finance_bp.route('/')
@login_required
def dashboard():
    caja = CajaEmpresa.query.get(1)
    if not caja:
        caja = CajaEmpresa(id=1, saldo_actual=0)
        db.session.add(caja)
        db.session.commit()

    dinero_en_calle = db.session.query(func.sum(Pago.monto_pago))\
        .filter(Pago.estado == 'POR_AUDITAR').scalar() or 0.0

    mes_actual = datetime.now().month
    gastos_mes = db.session.query(func.sum(GastoOperativo.monto))\
        .filter(func.extract('month', GastoOperativo.fecha_registro) == mes_actual).scalar() or 0.0

    # Historial General
    ultimos_movimientos = TransaccionFinanciera.query\
        .order_by(desc(TransaccionFinanciera.fecha))\
        .limit(30).all()

    return render_template('finance/dashboard.html', 
                           caja=caja, 
                           en_calle=dinero_en_calle,
                           gastos=gastos_mes,
                           movimientos=ultimos_movimientos)

# --- SECCIÃ“N INGRESOS ---
@finance_bp.route('/ingresos')
@login_required
def ingresos():
    conceptos_ingreso = CatConceptoFinanzas.query.filter_by(tipo_flujo='INGRESO', activo=True).all()
    
    # Historial de INGRESOS (Transacciones)
    ultimos_ingresos = TransaccionFinanciera.query\
        .filter_by(tipo='INGRESO')\
        .order_by(desc(TransaccionFinanciera.fecha))\
        .limit(20).all()

    return render_template('finance/income.html', 
                           conceptos=conceptos_ingreso, 
                           ultimos_ingresos=ultimos_ingresos)

@finance_bp.route('/registrar-ingreso-extra', methods=['POST'])
@login_required
def registrar_ingreso_extra():
    try:
        monto = float(request.form.get('monto'))
        concepto_id = int(request.form.get('concepto_id'))
        detalle_texto = request.form.get('detalle')
        notas = request.form.get('notas')
    except (ValueError, TypeError):
        flash('âŒ Error: Datos numÃ©ricos invÃ¡lidos.', 'danger')
        return redirect(url_for('finance.ingresos'))

    cat_concepto = CatConceptoFinanzas.query.get(concepto_id)
    descripcion_base = cat_concepto.descripcion if cat_concepto else "Ingreso General"
    concepto_final = f"{descripcion_base} - {detalle_texto}" if detalle_texto else descripcion_base

    caja = CajaEmpresa.query.get(1)
    if not caja:
        caja = CajaEmpresa(id=1, saldo_actual=0)
        db.session.add(caja)

    caja.saldo_actual = float(caja.saldo_actual) + monto

    folio = generar_folio_tesoreria('INGRESO')

    transaccion = TransaccionFinanciera(
        folio=folio,
        tipo='INGRESO',
        monto=monto,
        concepto=concepto_final,
        notas=notas,
        usuario_id=current_user.id
    )
    db.session.add(transaccion)
    db.session.commit()

    flash(f"ðŸ’° Ingreso registrado correctamente. Folio: {folio}", 'success')
    return redirect(url_for('finance.ingresos'))

# --- AUDITORÃA ---
@finance_bp.route('/auditoria')
@login_required
def auditoria():
    pagos_pendientes = Pago.query.filter_by(estado='POR_AUDITAR')\
        .order_by(Pago.fecha_registro.desc()).all()
    return render_template('finance/audit.html', pagos=pagos_pendientes)

@finance_bp.route('/confirmar-ingreso', methods=['POST'])
@login_required
def confirmar_ingreso():
    pago_id = request.form.get('pago_id')
    accion = request.form.get('accion') 

    pago = Pago.query.get_or_404(pago_id)
    caja = CajaEmpresa.query.get(1)

    if accion == 'AUDITAR':
        pago.estado = 'AUDITADO'
        pago.auditado_por_id = current_user.id
        pago.fecha_auditoria = datetime.now()

        caja.saldo_actual = float(caja.saldo_actual) + float(pago.monto_pago)

        folio_tesoreria = generar_folio_tesoreria('INGRESO')

        transaccion = TransaccionFinanciera(
            folio=folio_tesoreria,
            tipo='INGRESO',
            monto=pago.monto_pago,
            concepto=f"Corte Caja - Pago Chofer {pago.folio_recibo}",
            notas=f"Orden: {pago.orden.folio}. Cliente: {pago.cliente.nombre_negocio}",
            usuario_id=current_user.id,
            pago_origen_id=pago.id
        )
        db.session.add(transaccion)

        orden = OrdenVenta.query.get(pago.orden_id)
        if orden.estado == 'SINAUDITARPAGO':
            orden.estado = 'PAGADO'

        msg = f"âœ… Auditado correctamente. Generado Ticket: {folio_tesoreria}"

    elif accion == 'RECHAZAR':
        pago.estado = 'RECHAZADO'
        pago.notas = (pago.notas or '') + " | RECHAZADO POR FINANZAS."
        msg = "âš ï¸ Pago rechazado."

    db.session.commit()
    flash(msg, 'success' if accion == 'AUDITAR' else 'warning')
    return redirect(url_for('finance.auditoria'))

# --- SECCIÃ“N GASTOS ---
@finance_bp.route('/gastos')
@login_required
def gastos():
    conceptos_egreso = CatConceptoFinanzas.query.filter_by(tipo_flujo='EGRESO', activo=True).all()
    
    # CORRECCIÃ“N AQUÃ: Consultamos TransaccionFinanciera (que tiene folio) filtrando por EGRESO
    # en lugar de GastoOperativo.
    ultimos_gastos = TransaccionFinanciera.query\
        .filter_by(tipo='EGRESO')\
        .order_by(desc(TransaccionFinanciera.fecha))\
        .limit(20).all()
    
    return render_template('finance/expenses.html', 
                           gastos=ultimos_gastos,
                           conceptos=conceptos_egreso)

@finance_bp.route('/registrar-gasto', methods=['POST'])
@login_required
def registrar_gasto():
    try:
        monto = float(request.form.get('monto'))
        concepto_id = int(request.form.get('concepto_id'))
        detalle_texto = request.form.get('detalle')
        notas = request.form.get('notas')
    except (ValueError, TypeError):
        flash('âŒ Error: Datos invÃ¡lidos.', 'danger')
        return redirect(url_for('finance.gastos'))

    caja = CajaEmpresa.query.get(1)
    if not caja:
        caja = CajaEmpresa(id=1, saldo_actual=0)
        db.session.add(caja)
        
    saldo_actual = float(caja.saldo_actual)

    if saldo_actual < monto:
        flash(f'âŒ Fondos insuficientes. Tienes ${saldo_actual:,.2f}', 'danger')
        return redirect(url_for('finance.gastos'))

    cat_concepto = CatConceptoFinanzas.query.get_or_404(concepto_id)
    nombre_categoria = cat_concepto.descripcion

    caja.saldo_actual = saldo_actual - monto

    # Guardamos el detalle en GastoOperativo
    nuevo_gasto = GastoOperativo(
        categoria=nombre_categoria,
        descripcion=detalle_texto,
        monto=monto,
        notas=notas,
        registrado_por_id=current_user.id
    )
    db.session.add(nuevo_gasto)
    db.session.flush()

    folio_tesoreria = generar_folio_tesoreria('EGRESO')

    # Guardamos la transacciÃ³n maestra
    transaccion = TransaccionFinanciera(
        folio=folio_tesoreria,
        tipo='EGRESO',
        monto=monto,
        concepto=f"{nombre_categoria} - {detalle_texto}", 
        notas=notas,
        usuario_id=current_user.id,
        gasto_id=nuevo_gasto.id
    )
    db.session.add(transaccion)

    db.session.commit()
    flash(f"ðŸ’¸ Gasto registrado: {folio_tesoreria}", 'success')
    return redirect(url_for('finance.gastos'))

@finance_bp.route('/ticket/<string:folio>')
@login_required
def ver_ticket(folio):
    movimiento = TransaccionFinanciera.query.filter_by(folio=folio).first_or_404()
    return render_template('finance/ticket_movement.html', mov=movimiento)

========================= FILE: .\app\blueprints\home.py =========================
# app/blueprints/home.py
from flask import Blueprint, render_template
from flask_login import login_required, current_user # <--- 1. IMPORTAR ESTO

home_bp = Blueprint('home', __name__)

@home_bp.route('/')
@home_bp.route('/dashboard')
@login_required # <--- 2. ESTE ES EL CANDADO (Si no hay login, no pasa)
def dashboard():
    # Pasamos el usuario actual a la plantilla (aunque Flask-Login ya lo hace globalmente)
    return render_template('home/index.html', user=current_user)

========================= FILE: .\app\blueprints\inventory.py =========================
import os
from flask import Blueprint, render_template, redirect, url_for, flash, current_app, request
from flask_login import login_required, current_user
from werkzeug.utils import secure_filename
from app.extensions import db
from datetime import datetime

# ImportaciÃ³n de Modelos
from app.models.products import Producto
from app.models.catalogs import CatCategoriaProducto, CatUnidadMedida, CatTipoMovimientoAlmacen
from app.models.stock import InventarioProducto, HistorialMovimiento
from app.models.infrastructure import Almacen, UbicacionAlmacen
from app.forms import ProductoForm 

inventory_bp = Blueprint('inventory', __name__, url_prefix='/inventario')

# --- RUTAS DE CATÃLOGO (Index y Nuevo Producto) ---
@inventory_bp.route('/')
@inventory_bp.route('/lista')
@login_required
def index():
    productos = Producto.query.all()
    # CAMBIO AQUÃ: De 'list.html' a 'catalog_list.html'
    return render_template('inventory/catalog_list.html', productos=productos)

@inventory_bp.route('/nuevo', methods=['GET', 'POST'])
@login_required
def create():
    form = ProductoForm()
    form.categoria_id.choices = [(c.id, c.nombre) for c in CatCategoriaProducto.query.all()]
    form.unidad_id.choices = [(u.id, u.nombre) for u in CatUnidadMedida.query.all()]

    if form.validate_on_submit():
        sku = form.sku.data.upper()
        if Producto.query.filter_by(sku=sku).first():
            flash(f'Error: El SKU {sku} ya existe.', 'danger')
            return render_template('inventory/form.html', form=form, title="Nuevo Producto")

        filename = None
        if form.imagen.data:
            file = form.imagen.data
            filename = secure_filename(sku + "_" + file.filename)
            upload_path = os.path.join(current_app.root_path, 'static/uploads/productos')
            os.makedirs(upload_path, exist_ok=True)
            file.save(os.path.join(upload_path, filename))
            filename = f"uploads/productos/{filename}"

        nuevo_prod = Producto(
            sku=sku,
            descripcion=form.descripcion.data,
            categoria_id=form.categoria_id.data,
            unidad_id=form.unidad_id.data,
            precio_costo_actual=form.precio_costo.data,
            precio_venta_general=form.precio_venta.data,
            stock_minimo=form.stock_minimo.data,
            imagen_producto=filename
        )
        db.session.add(nuevo_prod)
        db.session.commit()
        flash(f'Producto "{nuevo_prod.descripcion}" creado.', 'success')
        return redirect(url_for('inventory.index'))

    return render_template('inventory/form.html', form=form, title="Nuevo Producto")

# --- CONSOLA DE MOVIMIENTOS (ALMACENISTA) ---
@inventory_bp.route('/movimientos', methods=['GET', 'POST'])
@login_required
def movimientos():
    # Cargas para los selectores
    productos = Producto.query.order_by(Producto.descripcion).all()
    almacenes = Almacen.query.all()
    ubicaciones = UbicacionAlmacen.query.all() # Necesario para el filtro de JS
    tipos_movimiento = CatTipoMovimientoAlmacen.query.all()
    
    if request.method == 'POST':
        try:
            # 1. Datos del Formulario
            producto_id = int(request.form.get('producto_id'))
            
            # ValidaciÃ³n de UbicaciÃ³n (Vital)
            ubicacion_id_raw = request.form.get('ubicacion_id')
            if not ubicacion_id_raw:
                flash('Error: Debes seleccionar una ubicaciÃ³n exacta (Pasillo/Rack).', 'danger')
                return redirect(url_for('inventory.movimientos'))
            ubicacion_id = int(ubicacion_id_raw)

            cantidad = float(request.form.get('cantidad'))
            tipo_mov_id = int(request.form.get('tipo_movimiento_id'))
            notas = request.form.get('notas')

            # Obtenemos el objeto del catÃ¡logo para saber quÃ© hacer
            tipo_obj = CatTipoMovimientoAlmacen.query.get(tipo_mov_id)
            desc_mov = tipo_obj.descripcion.upper()

            # 2. Buscar Inventario
            stock_record = InventarioProducto.query.filter_by(
                producto_id=producto_id,
                ubicacion_id=ubicacion_id
            ).first()

            saldo_anterior = stock_record.cantidad_actual if stock_record else 0
            
            # Si no existe registro, lo creamos en 0 para operar sobre Ã©l
            if not stock_record:
                stock_record = InventarioProducto(
                    producto_id=producto_id,
                    ubicacion_id=ubicacion_id,
                    cantidad_actual=0,
                    fecha_ingreso_almacen=datetime.now()
                )
                db.session.add(stock_record)

            # 3. LÃ³gica de Negocio BLINDADA
            if "INICIAL" in desc_mov: 
                # MODO RESET: Ignora lo que habÃ­a, pone lo que dices.
                # ESTO CORRIGE TU SALDO NEGATIVO AUTOMÃTICAMENTE
                stock_record.cantidad_actual = cantidad 
                
            elif "ENTRADA" in desc_mov or "DEVOLUCION" in desc_mov or "PRODUCCION" in desc_mov:
                # MODO SUMA
                stock_record.cantidad_actual += cantidad
                
            elif "SALIDA" in desc_mov or "MERMA" in desc_mov or "AJUSTE" in desc_mov:
                # MODO RESTA (Con validaciÃ³n)
                if stock_record.cantidad_actual < cantidad:
                    db.session.rollback()
                    flash(f'â›” ERROR: No tienes suficiente stock. Tienes {stock_record.cantidad_actual} y quieres sacar {cantidad}.', 'danger')
                    return redirect(url_for('inventory.movimientos'))
                
                stock_record.cantidad_actual -= cantidad

            # 4. Evidencia en KÃ¡rdex
            kardex = HistorialMovimiento(
                producto_id=producto_id,
                ubicacion_id=ubicacion_id,
                tipo_movimiento=desc_mov,
                cantidad=cantidad,
                usuario_id=current_user.id,
                fecha=datetime.now(),
                notas=f"{notas} | Saldo: {saldo_anterior} -> {stock_record.cantidad_actual}"
            )
            db.session.add(kardex)
            
            db.session.commit()
            flash(f'âœ… Movimiento registrado: {desc_mov}. Nuevo Saldo: {stock_record.cantidad_actual}', 'success')
            
        except Exception as e:
            db.session.rollback()
            flash(f'âŒ Error tÃ©cnico: {str(e)}', 'danger')

    return render_template('inventory/movements.html', 
                           productos=productos, 
                           almacenes=almacenes,
                           ubicaciones=ubicaciones,
                           tipos_movimiento=tipos_movimiento,
                           now=datetime.now())

========================= FILE: .\app\blueprints\logistics.py =========================
import random
import string
from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify
from flask_login import login_required, current_user
from datetime import datetime
from sqlalchemy import func, or_, desc
from sqlalchemy.exc import IntegrityError
from app.extensions import db

# --- IMPORTACIÃ“N DE MODELOS ---
from app.models.orders import OrdenVenta, OrdenVentaDetalle
from app.models.payments import Pago
from app.models.clients import Cliente
from app.models.catalogs import CatTipoMovimientoFinanzas 

logistics_bp = Blueprint('logistics', __name__, url_prefix='/logistica')

# ==========================================
#  SECCIÃ“N 1: OPERATIVA DE REPARTO
# ==========================================

@logistics_bp.route('/')
@login_required
def index():
    pendientes = OrdenVenta.query.filter(
        OrdenVenta.estado.in_(['LISTO_RUTA', 'EN_RUTA'])
    ).order_by(OrdenVenta.fecha_promesa_entrega.asc()).all()

    terminadas = OrdenVenta.query.filter(
        OrdenVenta.estado.in_(['ENTREGADA', 'PAGADO', 'SINAUDITARPAGO'])
    ).order_by(OrdenVenta.id.desc()).limit(10).all()

    return render_template('logistics/route_dashboard.html', 
                           ordenes=pendientes, 
                           terminadas=terminadas)

@logistics_bp.route('/cargar/<int:orden_id>')
@login_required
def cargar_orden(orden_id):
    orden = OrdenVenta.query.get_or_404(orden_id)
    if orden.estado == 'LISTO_RUTA':
        orden.estado = 'EN_RUTA'
        db.session.commit()
        flash(f'ðŸ“¦ Orden {orden.folio} cargada.', 'success')
    return redirect(url_for('logistics.index'))

@logistics_bp.route('/entrega/<int:orden_id>')
@login_required
def entrega_cliente(orden_id):
    orden = OrdenVenta.query.get_or_404(orden_id)
    metodos_pago = CatTipoMovimientoFinanzas.query.filter_by(activo=True).all()
    
    deuda_historica = float(orden.cliente.saldo_actual or 0)
    ventas_en_curso = db.session.query(func.sum(OrdenVenta.total_venta))\
        .filter(OrdenVenta.cliente_id == orden.cliente_id)\
        .filter(OrdenVenta.id != orden.id)\
        .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_RUTA', 'EN_PRODUCCION', 'EMPACADO', 'ENTREGADA', 'SINAUDITARPAGO']))\
        .scalar() or 0.0
    saldo_global_previo = deuda_historica + float(ventas_en_curso)

    items_data = []
    total_piezas_bajar = 0
    for item in orden.items:
        cant_sugerida = item.cantidad_surtida if item.cantidad_surtida > 0 else item.cantidad_pedida
        total_piezas_bajar += cant_sugerida
        items_data.append({
            'detalle_id': item.id,
            'producto': item.producto.descripcion,
            'sku': item.producto.sku,
            'pedida': item.cantidad_pedida,
            'surtida': item.cantidad_surtida,
            'precio': float(item.precio_unitario),
            'sugerida': cant_sugerida
        })
        
    return render_template('logistics/delivery_handover.html', 
                           orden=orden, 
                           items=items_data,
                           total_piezas=total_piezas_bajar, 
                           saldo_global_previo=saldo_global_previo,
                           metodos_pago=metodos_pago)

@logistics_bp.route('/confirmar-entrega', methods=['POST'])
@login_required
def confirmar_entrega():
    # --- BLOQUE DE SEGURIDAD CONTRA COLISIONES ---
    intentos = 0
    max_intentos = 5
    
    while intentos < max_intentos:
        try:
            data = request.json
            orden_id = data.get('orden_id')
            items_ajuste = data.get('items') 
            info_pago = data.get('pago')     
            notas = data.get('notas')

            orden = OrdenVenta.query.get_or_404(orden_id)
            
            # 1. Ajuste de inventario
            nuevo_total_venta = 0
            for item_data in items_ajuste:
                detalle = OrdenVentaDetalle.query.get(int(item_data['detalle_id']))
                if item_data.get('cant_real'):
                    cant_real = float(item_data['cant_real'])
                    detalle.cantidad_entregada = cant_real
                    detalle.subtotal = cant_real * detalle.precio_unitario
                    nuevo_total_venta += detalle.subtotal
                
            if nuevo_total_venta > 0:
                orden.total_venta = nuevo_total_venta
                if orden.estado not in ['ENTREGADA', 'PAGADO', 'SINAUDITARPAGO']:
                    orden.saldo_pendiente = nuevo_total_venta 
            
            # 2. Registrar Pago
            monto_abono = float(info_pago.get('monto', 0))
            pago_id = None
            
            if monto_abono > 0:
                # --- GENERADOR DE FOLIO ROBUSTO ---
                fecha_server = datetime.now().strftime('%y%m%d')
                sufijo_random = ''.join(random.choices(string.ascii_uppercase + string.digits, k=4))
                folio_pago = f"PAG-{fecha_server}-{sufijo_random}"
                
                nuevo_pago = Pago(
                    folio_recibo=folio_pago,
                    cliente_id=orden.cliente_id,
                    orden_id=orden.id,
                    tipo_movimiento_id=int(info_pago.get('tipo_id')), 
                    cobrado_por_id=current_user.id,
                    monto_pago=monto_abono,
                    dinero_recibido=float(info_pago.get('recibido', 0)),
                    cambio_devuelto=float(info_pago.get('cambio', 0)),
                    estado='POR_AUDITAR', 
                    notas=notas
                )
                db.session.add(nuevo_pago)
                db.session.flush() # AquÃ­ validamos unicidad
                pago_id = nuevo_pago.id
                
                # Descuento de saldo (safe float)
                saldo_actual_safe = float(orden.saldo_pendiente or 0)
                orden.saldo_pendiente = saldo_actual_safe - monto_abono

            # 3. Saldos Globales
            deuda_previa = float(orden.cliente.saldo_actual or 0)
            if nuevo_total_venta > 0 and orden.estado not in ['ENTREGADA', 'PAGADO', 'SINAUDITARPAGO']:
                orden.cliente.saldo_actual = deuda_previa + nuevo_total_venta - monto_abono
            else:
                orden.cliente.saldo_actual = deuda_previa - monto_abono

            # 4. Estados
            if float(orden.saldo_pendiente) <= 0.5:
                orden.saldo_pendiente = 0 
                orden.estado = 'SINAUDITARPAGO' 
            else:
                orden.estado = 'ENTREGADA' 

            db.session.commit()
            return jsonify({'status': 'success', 'message': 'OperaciÃ³n procesada.', 'orden_id': orden.id, 'pago_id': pago_id})

        except IntegrityError:
            db.session.rollback()
            intentos += 1
            print(f"âš ï¸ ColisiÃ³n de Folio detectada. Reintentando ({intentos}/5)...")
            continue
            
        except Exception as e:
            db.session.rollback()
            print(f"Error Logistica: {e}")
            return jsonify({'status': 'error', 'message': str(e)}), 500
    
    return jsonify({'status': 'error', 'message': 'El sistema estÃ¡ saturado, intenta de nuevo.'}), 500

@logistics_bp.route('/ticket/<int:orden_id>')
@login_required
def ver_ticket(orden_id):
    orden = OrdenVenta.query.get_or_404(orden_id)
    # Traemos TODOS los pagos para el historial en el ticket
    todos_los_pagos = Pago.query.filter_by(orden_id=orden.id).order_by(Pago.fecha_registro.asc()).all()
    return render_template('logistics/ticket.html', orden=orden, pagos=todos_los_pagos)


# ==========================================
#  SECCIÃ“N 2: COBRANZA
# ==========================================

@logistics_bp.route('/cobranza')
@login_required
def cobranza_buscar():
    deudores = Cliente.query.filter(
        Cliente.saldo_actual > 1.0
    ).order_by(desc(Cliente.saldo_actual)).limit(100).all()

    return render_template('logistics/collection_search.html', deudores=deudores)

@logistics_bp.route('/api/buscar-deudores')
@login_required
def api_buscar_deudores():
    q = request.args.get('q', '').strip()
    if not q or len(q) < 3: return jsonify([])

    resultados = Cliente.query.filter(
        or_(
            Cliente.nombre_negocio.ilike(f'%{q}%'),
            Cliente.nombres_encargado.ilike(f'%{q}%'),
            Cliente.apellidos_encargado.ilike(f'%{q}%'),
            Cliente.calle.ilike(f'%{q}%'),
            Cliente.colonia.ilike(f'%{q}%')
        )
    ).limit(20).all()

    data = []
    for c in resultados:
        nombre_completo = f"{c.nombres_encargado or ''} {c.apellidos_encargado or ''}".strip()
        direccion_full = f"{c.calle or ''} {c.num_exterior or ''}, {c.colonia or ''}".strip()
        if direccion_full.startswith(','): direccion_full = direccion_full[1:].strip()

        data.append({
            'id': c.id,
            'negocio': c.nombre_negocio,
            'contacto': nombre_completo if nombre_completo else '---',
            'direccion': direccion_full if direccion_full else '---',
            'saldo': float(c.saldo_actual or 0)
        })
    
    return jsonify(data)

@logistics_bp.route('/cobranza/cliente/<int:cliente_id>')
@login_required
def cobranza_cliente(cliente_id):
    cliente = Cliente.query.get_or_404(cliente_id)
    
    candidatos = OrdenVenta.query.filter(
        OrdenVenta.cliente_id == cliente.id,
        OrdenVenta.estado.in_(['ENTREGADA', 'PAGADO', 'SINAUDITARPAGO']), 
        OrdenVenta.estado != 'CANCELADA'
    ).order_by(OrdenVenta.fecha_registro.asc()).all()

    ordenes_reales = []

    for orden in candidatos:
        pagos_registrados = db.session.query(func.sum(Pago.monto_pago))\
            .filter(Pago.orden_id == orden.id)\
            .scalar() or 0.0
        
        deuda_operativa = float(orden.total_venta) - float(pagos_registrados)

        if deuda_operativa > 0.5:
            orden.saldo_pendiente = deuda_operativa 
            ordenes_reales.append(orden)

    return render_template('logistics/collection_client.html', 
                           cliente=cliente, 
                           ordenes=ordenes_reales)

# NUEVA API PARA EL HISTORIAL DE PAGOS DEL CLIENTE
@logistics_bp.route('/api/historial-pagos/<int:cliente_id>')
@login_required
def api_historial_pagos(cliente_id):
    # Ãšltimos 20 pagos
    pagos = Pago.query.filter_by(cliente_id=cliente_id)\
        .order_by(Pago.fecha_registro.desc())\
        .limit(20).all()
    
    data = []
    for p in pagos:
        data.append({
            'folio': p.folio_recibo,
            'fecha': p.fecha_registro.strftime('%d/%m/%Y %H:%M'),
            'monto': float(p.monto_pago),
            'orden': p.orden.folio,
            'orden_id': p.orden_id
        })
    return jsonify(data)

========================= FILE: .\app\blueprints\production.py =========================
import os
import uuid  # <--- CORRECCIÃ“N CLAVE: Para generar cÃ³digos Ãºnicos y evitar el error de llave duplicada
from flask import Blueprint, render_template, redirect, url_for, flash, request, current_app
from flask_login import login_required, current_user
from datetime import datetime
from app.extensions import db
from sqlalchemy import func

# --- IMPORTACIÃ“N DE MODELOS ---
from app.models.products import Producto 
from app.models.production import OrdenProduccion
from app.models.stock import InventarioProducto
from app.models.users import Usuario
from app.models.orders import OrdenVenta, OrdenVentaDetalle

production_bp = Blueprint('production', __name__, url_prefix='/produccion')

# --- 1. TABLERO DE NECESIDADES (DASHBOARD PRINCIPAL) ---
@production_bp.route('/tablero-necesidades')
@login_required
def tablero_necesidades():
    productos = Producto.query.order_by(Producto.descripcion).all()
    data_tablero = []
    
    # Contadores para el estado general del sistema
    conteo_criticos = 0
    conteo_recuperar = 0

    for p in productos:
        # A. Existencia FÃ­sica (Lo que ya estÃ¡ guardado en ubicaciones)
        inventarios = InventarioProducto.query.filter_by(producto_id=p.id).all()
        cantidad_fisica = sum(i.cantidad_actual for i in inventarios)

        # B. En Proceso + En TrÃ¡nsito (Lo que viene en camino)
        # Sumamos: SOLICITADA (Espera), EN_PRODUCCION/BATIENDO (Cocina), POR_RECIBIR (Puerta AlmacÃ©n)
        ordenes_activas = OrdenProduccion.query.filter(
            OrdenProduccion.producto_id == p.id,
            OrdenProduccion.estatus.in_(['SOLICITADA', 'EN_PRODUCCION', 'BATIENDO', 'POR_RECIBIR'])
        ).all()
        
        # Si ya se reportÃ³ producciÃ³n real (POR_RECIBIR), usamos ese dato. Si no, usamos lo estimado.
        cantidad_en_camino = 0
        for o in ordenes_activas:
            if o.estatus == 'POR_RECIBIR' and o.cantidad_producida_real > 0:
                cantidad_en_camino += o.cantidad_producida_real
            else:
                cantidad_en_camino += o.cantidad

        # C. Ventas Comprometidas (Lo que ya se vendiÃ³ pero no ha salido)
        ventas_pendientes = db.session.query(func.sum(OrdenVentaDetalle.cantidad_pedida))\
            .join(OrdenVenta)\
            .filter(OrdenVentaDetalle.producto_id == p.id)\
            .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_RUTA']))\
            .scalar() or 0

        # D. CÃ¡lculo MRP (Disponible Real)
        stock_disponible_real = cantidad_fisica - ventas_pendientes
        
        meta = p.stock_ideal if p.stock_ideal else 0
        # FÃ³rmula: Meta - (Lo que tengo libre + Lo que viene en camino)
        a_fabricar = meta - (stock_disponible_real + cantidad_en_camino)

        # E. SemÃ¡foros Visuales
        if a_fabricar <= 0:
            a_fabricar = 0 
            if stock_disponible_real >= meta:
                estado = "SURTIDO"
                clase_estado = "success" # Verde
            else:
                estado = "EN CAMINO" # Azul (Ya viene en camino suficiente)
                clase_estado = "info" 
        else:
            if stock_disponible_real <= 0:
                estado = "CRÃTICO" # Debes mÃ¡s de lo que tienes
                clase_estado = "danger"
                conteo_criticos += 1
            else:
                estado = "RECUPERAR" # Hay stock, pero bajo
                clase_estado = "warning"
                conteo_recuperar += 1

        data_tablero.append({
            'id': p.id,
            'sku': p.sku,
            'descripcion': p.descripcion,
            'existencia': cantidad_fisica,
            'comprometido': ventas_pendientes,
            'disponible': stock_disponible_real,
            'en_proceso': cantidad_en_camino,
            'meta': meta,
            'a_fabricar': a_fabricar,
            'estado': estado,
            'clase_estado': clase_estado
        })

    # F. Datos para el Encabezado
    total_ordenes_activas = OrdenProduccion.query.filter(
        OrdenProduccion.estatus.in_(['SOLICITADA', 'EN_PRODUCCION', 'BATIENDO'])
    ).count()

    if conteo_criticos > 0:
        estado_sys = "ALERTA CRÃTICA"
        clase_sys = "danger"
        accion_sys = "Producir Urgente"
    elif conteo_recuperar > 0:
        estado_sys = "PRECAUCIÃ“N"
        clase_sys = "warning"
        accion_sys = "Programar Lotes"
    else:
        estado_sys = "ESTABLE"
        clase_sys = "success"
        accion_sys = "Monitoreo"

    return render_template('production/dashboard.html', 
                           items=data_tablero, 
                           now=datetime.now(),
                           total_ordenes=total_ordenes_activas, 
                           estado_sys=estado_sys,
                           clase_sys=clase_sys,
                           accion_sys=accion_sys)

# --- 2. CREAR ORDEN (CON SOLUCIÃ“N DE ERROR 'UNIQUEVIOLATION') ---
@production_bp.route('/crear-orden', methods=['POST'])
@login_required
def crear_orden():
    try:
        producto_id = int(request.form.get('producto_id'))
        cantidad = float(request.form.get('cantidad'))
        
        if cantidad <= 0:
            flash('Error: La cantidad debe ser mayor a 0.', 'danger')
            return redirect(url_for('production.tablero_necesidades'))

        # A. Blindaje Anti-Spam (Si ya hay una solicitada, no duplicar)
        orden_existente = OrdenProduccion.query.filter(
            OrdenProduccion.producto_id == producto_id,
            OrdenProduccion.estatus.in_(['SOLICITADA']) 
        ).first()

        if orden_existente:
            flash(f'âš ï¸ Ya existe una orden pendiente ({orden_existente.folio}).', 'warning')
            return redirect(url_for('production.tablero_necesidades'))

        # B. GeneraciÃ³n de Folio Ãšnico (SOLUCIÃ“N DEFINITIVA)
        # Usamos UUID para asegurar que NUNCA se repita, ni aunque borres la BD.
        # Formato: ORD-YYMMDD-IDPROD-XXXX (4 caracteres aleatorios)
        suffix = uuid.uuid4().hex[:4].upper()
        fecha_str = datetime.now().strftime('%y%m%d')
        folio_unico = f"ORD-{fecha_str}-{producto_id}-{suffix}"
        
        nueva_orden = OrdenProduccion(
            folio=folio_unico,
            producto_id=producto_id,
            cantidad=cantidad,
            usuario_solicita_id=current_user.id,
            fecha_solicitud=datetime.now(),
            estatus='SOLICITADA',
            prioridad='NORMAL'
        )

        db.session.add(nueva_orden)
        db.session.commit()
        
        flash(f'âœ… Orden {nueva_orden.folio} enviada correctamente.', 'success')

    except Exception as e:
        db.session.rollback()
        print(f"ERROR PRODUCCION: {str(e)}")
        flash(f'âŒ Error al crear orden: {str(e)}', 'danger')

    return redirect(url_for('production.tablero_necesidades'))

# --- 3. VISTA DEL MAESTRO HELADERO ---
@production_bp.route('/ordenes-maestro')
@login_required
def ordenes_maestro():
    # Mostramos lo nuevo y lo que se estÃ¡ cocinando
    ordenes = OrdenProduccion.query.filter(
        OrdenProduccion.estatus.in_(['SOLICITADA', 'EN_PRODUCCION', 'BATIENDO'])
    ).order_by(OrdenProduccion.estatus.asc(), OrdenProduccion.fecha_solicitud.asc()).all()
    
    return render_template('production/orders_list.html', ordenes=ordenes)

# --- 4. CAMBIAR ESTATUS (SOLO INICIO) ---
@production_bp.route('/cambiar-estatus/<int:orden_id>/<string:nuevo_estatus>')
@login_required
def cambiar_estatus(orden_id, nuevo_estatus):
    orden = OrdenProduccion.query.get_or_404(orden_id)
    
    # Solo permitimos iniciar la producciÃ³n aquÃ­. El cierre se hace por el modal.
    if nuevo_estatus == 'BATIENDO':
        orden.estatus = 'BATIENDO'
        orden.fecha_inicio = datetime.now()
        db.session.commit()
        flash(f'ðŸ”¥ Lote {orden.folio} iniciado. Â¡A cocinar!', 'info')
    
    return redirect(url_for('production.ordenes_maestro'))

# --- 5. REPORTAR PRODUCCIÃ“N REAL (CIERRE DE LOTE) ---
@production_bp.route('/reportar-produccion', methods=['POST'])
@login_required
def reportar_produccion_real():
    try:
        orden_id = int(request.form.get('orden_id'))
        cantidad_real = float(request.form.get('cantidad_real'))
        notas = request.form.get('notas')

        orden = OrdenProduccion.query.get_or_404(orden_id)
        
        # Guardamos la realidad operativa
        orden.cantidad_producida_real = cantidad_real
        orden.notas_produccion = notas
        orden.fecha_termino = datetime.now()
        
        # CAMBIO IMPORTANTE:
        # No ponemos 'TERMINADA' todavÃ­a. Ponemos 'POR_RECIBIR'.
        # Esto envÃ­a la orden a la "puerta del almacÃ©n" para que el Almacenista la cuente.
        orden.estatus = 'POR_RECIBIR'
        
        db.session.commit()
        
        flash(f'âœ… Lote enviado a AlmacÃ©n. Reportaste {cantidad_real} piezas. Pendiente de recepciÃ³n.', 'success')

    except Exception as e:
        db.session.rollback()
        flash(f'âŒ Error al reportar producciÃ³n: {str(e)}', 'danger')

    return redirect(url_for('production.ordenes_maestro'))

========================= FILE: .\app\blueprints\reception.py =========================
from flask import Blueprint, render_template, redirect, url_for, flash, request
from flask_login import login_required, current_user
from datetime import datetime
from app.extensions import db

# ImportaciÃ³n de Modelos
from app.models.production import OrdenProduccion
from app.models.stock import InventarioProducto, HistorialMovimiento
from app.models.infrastructure import UbicacionAlmacen, Almacen 

reception_bp = Blueprint('reception', __name__, url_prefix='/recepcion')

# --- 1. TABLERO DE RECEPCIÃ“N ---
@reception_bp.route('/')
@login_required
def index():
    # Filtramos las Ã³rdenes activas (POR_RECIBIR)
    lotes_activos = OrdenProduccion.query.filter(
        OrdenProduccion.estatus.in_(['POR_RECIBIR'])
    ).all()
    
    # Traemos AMBOS catÃ¡logos para el filtro en cascada
    almacenes = Almacen.query.order_by(Almacen.descripcion).all()
    ubicaciones = UbicacionAlmacen.query.order_by(UbicacionAlmacen.codigo).all()
    
    # Renderizamos la vista con nombre ÃšNICO
    return render_template('reception/reception_dock.html', 
                           lotes=lotes_activos, 
                           almacenes=almacenes,
                           ubicaciones=ubicaciones)

# --- 2. PROCESAR EL INGRESO ---
@reception_bp.route('/confirmar', methods=['POST'])
@login_required
def confirmar():
    try:
        orden_id = int(request.form.get('orden_id'))
        # Recibimos el ID de la ubicaciÃ³n exacta (dropdown hijo)
        ubicacion_id = int(request.form.get('ubicacion_id'))
        cantidad_ingresar = float(request.form.get('cantidad_ingresar'))
        forzar_cierre = request.form.get('forzar_cierre') == 'on'
        # Capturamos las notas del usuario
        notas_usuario = request.form.get('notas', '').strip()
        
        orden = OrdenProduccion.query.get_or_404(orden_id)
        
        # Validaciones
        if cantidad_ingresar < 0:
            flash('No puedes ingresar cantidades negativas.', 'warning')
            return redirect(url_for('reception.index'))

        # Solo permitimos 0 si se estÃ¡ cerrando la orden (Merma total del resto)
        if cantidad_ingresar == 0 and not forzar_cierre:
            flash('Si la cantidad es 0, debes marcar "Cerrar Orden" para indicar merma.', 'warning')
            return redirect(url_for('reception.index'))

        # A. ACTUALIZAR STOCK FÃSICO (Solo si hay cantidad > 0)
        if cantidad_ingresar > 0:
            inventario = InventarioProducto.query.filter_by(
                producto_id=orden.producto_id, 
                ubicacion_id=ubicacion_id
            ).first()

            if inventario:
                inventario.cantidad_actual += cantidad_ingresar
            else:
                nuevo_inv = InventarioProducto(
                    producto_id=orden.producto_id,
                    ubicacion_id=ubicacion_id,
                    cantidad_actual=cantidad_ingresar,
                    fecha_ingreso_almacen=datetime.now()
                )
                db.session.add(nuevo_inv)

        # B. ACTUALIZAR EL ACUMULADO DE LA ORDEN
        acumulado_previo = orden.cantidad_recibida_almacen or 0
        nuevo_acumulado = acumulado_previo + cantidad_ingresar
        orden.cantidad_recibida_almacen = nuevo_acumulado
        
        # C. GENERAR EVIDENCIA (KÃRDEX) CON NOTAS
        texto_historial = f"Ingreso ({cantidad_ingresar}). Acumulado: {nuevo_acumulado}/{orden.cantidad_producida_real}."
        if notas_usuario:
            texto_historial += f" | NOTA: {notas_usuario}"

        movimiento = HistorialMovimiento(
            producto_id=orden.producto_id,
            ubicacion_id=ubicacion_id,
            tipo_movimiento='ENTRADA_PRODUCCION',
            cantidad=cantidad_ingresar,
            usuario_id=current_user.id,
            fecha=datetime.now(),
            referencia=orden.folio,
            notas=texto_historial
        )
        db.session.add(movimiento)

        # D. LÃ“GICA DE CIERRE (SuperÃ¡vit, Exacto o Merma)
        diferencia = orden.cantidad_producida_real - nuevo_acumulado
        
        # CASO 1: SUPERÃVIT (Sobrante positivo, diferencia negativa)
        if diferencia < -0.001:
            orden.estatus = 'TERMINADA'
            orden.fecha_termino = datetime.now()
            orden.notas_produccion = (orden.notas_produccion or "") + f" | SUPERÃVIT ALMACÃ‰N: {abs(diferencia)} pzas extra."
            flash(f"âœ… Lote completado con EXCEDENTE de {abs(diferencia)} pzas.", 'success')
            
        # CASO 2: EXACTO
        elif abs(diferencia) <= 0.001:
            orden.estatus = 'TERMINADA'
            orden.fecha_termino = datetime.now()
            flash(f"âœ… Lote {orden.folio} completado exacto.", 'success')
            
        # CASO 3: FALTANTE (MERMA) CON CIERRE FORZADO
        elif forzar_cierre:
            orden.estatus = 'TERMINADA'
            orden.fecha_termino = datetime.now()
            
            nota_cierre = f" | FALTANTE (MERMA): {diferencia}."
            if notas_usuario:
                nota_cierre += f" Causa: {notas_usuario}"
            
            orden.notas_produccion = (orden.notas_produccion or "") + nota_cierre
            flash(f"âš ï¸ Orden cerrada con faltante de {diferencia} pzas.", 'warning')
            
        # CASO 4: PARCIAL (Sigue abierta)
        else:
            flash(f"ðŸ“¥ Ingreso parcial guardado. Faltan {diferencia} pzas.", 'info')

        db.session.commit()

    except Exception as e:
        db.session.rollback()
        flash(f'âŒ Error tÃ©cnico: {str(e)}', 'danger')

    return redirect(url_for('reception.index'))

========================= FILE: .\app\blueprints\sales.py =========================
from flask import Blueprint, render_template, request, jsonify
from flask_login import login_required, current_user
from app.extensions import db
from sqlalchemy import func

# Modelos
from app.models.clients import Cliente
from app.models.products import Producto
from app.models.orders import OrdenVenta, OrdenVentaDetalle
from datetime import datetime

sales_bp = Blueprint('sales', __name__, url_prefix='/ventas')

# --- 1. RUTA PARA CARGAR LA CONSOLA ---
@sales_bp.route('/preventa')
@login_required
def preventa():
    clientes = Cliente.query.all()
    productos_db = Producto.query.all()
    
    catalogo_js = []
    for p in productos_db:
        catalogo_js.append({
            "id": p.id,
            "sku": p.sku,
            "nombre": p.descripcion,
            "precio": float(p.precio_venta_general)
        })
        
    return render_template('sales/console.html', 
                           clientes=clientes, 
                           catalogo=catalogo_js,
                           date_now=datetime.now().strftime('%Y-%m-%d'))

# --- 2. API INTELIGENTE (CRÃ‰DITO VIRTUAL) ---
@sales_bp.route('/api/cliente/<int:id>')
@login_required
def api_cliente(id):
    c = Cliente.query.get_or_404(id)
    
    # A. Deuda Contable
    deuda_contable = float(c.saldo_actual)

    # B. Deuda Virtual (Pedidos vivos)
    ventas_en_curso = db.session.query(func.sum(OrdenVenta.total_venta))\
        .filter(OrdenVenta.cliente_id == id)\
        .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_RUTA', 'EN_PRODUCCION', 'EMPACADO']))\
        .scalar() or 0.0
    
    ventas_en_curso = float(ventas_en_curso)

    # C. CÃ¡lculo
    deuda_total_real = deuda_contable + ventas_en_curso
    limite = float(c.limite_credito)
    disponible_real = limite - deuda_total_real

    precios = {p.producto_id: float(p.valor_descuento) for p in c.precios_especiales}
    
    return jsonify({
        "limite_credito": limite,
        "saldo_actual": deuda_total_real,
        "disponible": disponible_real,
        "precios_especiales": precios
    })

# --- 3. CREAR PEDIDO (PARCHEADO) ---
@sales_bp.route('/crear-pedido', methods=['POST'])
@login_required
def crear_pedido():
    data = request.json
    
    if not data or not data.get('items'):
        return jsonify({"status": "error", "message": "El pedido estÃ¡ vacÃ­o"}), 400

    try:
        # 1. VALIDACIÃ“N DE NOTA
        notas = data.get('notas', '').strip()
        if len(notas) < 15:
            return jsonify({
                "status": "error", 
                "message": "âš ï¸ Escribe una nota detallada (mÃ­nimo 15 letras)."
            }), 400

        # 2. VALIDACIÃ“N DE CRÃ‰DITO
        if data['metodo_pago'] == 'Credito':
            cliente = Cliente.query.get(int(data['cliente_id']))
            total_pedido = float(data['total'])
            
            ventas_en_curso = db.session.query(func.sum(OrdenVenta.total_venta))\
                .filter(OrdenVenta.cliente_id == cliente.id)\
                .filter(OrdenVenta.estado.in_(['CONFIRMADA', 'EN_RUTA', 'EN_PRODUCCION', 'EMPACADO']))\
                .scalar() or 0.0
            
            deuda_total = float(cliente.saldo_actual) + float(ventas_en_curso)
            
            if (deuda_total + total_pedido) > float(cliente.limite_credito):
                return jsonify({
                    "status": "error", 
                    "message": f"â›” CRÃ‰DITO INSUFICIENTE. Disp: ${float(cliente.limite_credito) - deuda_total:.2f}"
                }), 400

        # --- GUARDAR VENTA ---
        folio_gen = f"PV-{datetime.now().strftime('%y%m%d%H%M%S')}"

        nueva_orden = OrdenVenta(
            folio = folio_gen,
            cliente_id = int(data['cliente_id']),
            vendedor_id = current_user.id,
            fecha_promesa_entrega = datetime.strptime(data['fecha_entrega'], '%Y-%m-%d'),
            metodo_pago_esperado = data['metodo_pago'],
            total_venta = 0, 
            estado = 'CONFIRMADA',
            notas_vendedor = notas
        )
        
        db.session.add(nueva_orden)
        db.session.flush() 

        total_calculado = 0
        
        for prod_id, info in data['items'].items():
            subtotal = float(info['cant']) * float(info['precio'])
            total_calculado += subtotal
            
            detalle = OrdenVentaDetalle(
                orden_id = nueva_orden.id,
                producto_id = int(prod_id),
                cantidad_pedida = float(info['cant']),
                precio_unitario = float(info['precio']),
                subtotal = subtotal
            )
            db.session.add(detalle)

        # PARCHE: Inicializar Deuda
        nueva_orden.total_venta = total_calculado
        nueva_orden.saldo_pendiente = total_calculado 
        
        db.session.commit()
        
        return jsonify({
            "status": "success", 
            "message": f"Pedido {folio_gen} guardado correctamente.", 
            "folio": folio_gen
        })

    except Exception as e:
        db.session.rollback()
        print(f"Error ventas: {e}")
        return jsonify({"status": "error", "message": str(e)}), 500

========================= FILE: .\app\blueprints\shipping.py =========================
from flask import Blueprint, render_template, redirect, url_for, flash, request
from flask_login import login_required, current_user
from datetime import datetime
from app.extensions import db
from sqlalchemy import desc

# Modelos
from app.models.orders import OrdenVenta, OrdenVentaDetalle
from app.models.stock import InventarioProducto, HistorialMovimiento
from app.models.infrastructure import UbicacionAlmacen, Almacen
from app.models.shipping import OrdenPaquete

shipping_bp = Blueprint('shipping', __name__, url_prefix='/envios')

# --- 1. DASHBOARD DE SURTIDO ---
@shipping_bp.route('/')
@login_required
def index():
    # 1. PEDIDOS ACTIVOS (Pendientes de trabajo)
    pendientes = OrdenVenta.query.filter(
        OrdenVenta.estado.in_(['CONFIRMADA', 'EN_PRODUCCION', 'EMPACADO'])
    ).order_by(OrdenVenta.fecha_promesa_entrega.asc()).all()
    
    # 2. PEDIDOS LISTOS (Historial reciente para referencia)
    terminados = OrdenVenta.query.filter(
        OrdenVenta.estado.in_(['LISTO_RUTA', 'EN_RUTA'])
    ).order_by(desc(OrdenVenta.fecha_promesa_entrega)).limit(10).all()
    
    return render_template('shipping/dashboard.html', pendientes=pendientes, terminados=terminados)

# --- 2. PANTALLA DE TRABAJO (PICKING) ---
@shipping_bp.route('/surtir/<int:orden_id>')
@login_required
def picking(orden_id):
    orden = OrdenVenta.query.get_or_404(orden_id)
    ids_productos = [item.producto_id for item in orden.items]
    
    # Consulta de Stock optimizada para evitar errores de ORM
    stock_data = db.session.query(InventarioProducto, UbicacionAlmacen, Almacen)\
        .select_from(InventarioProducto)\
        .join(UbicacionAlmacen, InventarioProducto.ubicacion_id == UbicacionAlmacen.id)\
        .join(Almacen, UbicacionAlmacen.almacen_id == Almacen.id)\
        .filter(InventarioProducto.producto_id.in_(ids_productos))\
        .filter(InventarioProducto.cantidad_actual > 0)\
        .order_by(Almacen.descripcion, UbicacionAlmacen.codigo)\
        .all()

    # Estructuramos datos para los Comboboxes (Selectores)
    stock_por_producto = {}
    for inv, ubi, alm in stock_data:
        if inv.producto_id not in stock_por_producto:
            stock_por_producto[inv.producto_id] = []
        stock_por_producto[inv.producto_id].append({
            'inv_id': inv.id,
            'almacen_id': alm.id,
            'almacen_nombre': alm.descripcion,
            'ubicacion_codigo': ubi.codigo,
            'cantidad': int(inv.cantidad_actual)
        })
    
    return render_template('shipping/picking.html', orden=orden, stock_por_producto=stock_por_producto)

# --- 3. CONFIRMAR PICKING (CON CANDADO DE SEGURIDAD) ---
@shipping_bp.route('/confirmar-picking', methods=['POST'])
@login_required
def confirmar_picking():
    try:
        detalle_id = int(request.form.get('detalle_id'))
        inventario_id = int(request.form.get('inventario_id')) 
        cantidad = float(request.form.get('cantidad'))
        
        detalle = OrdenVentaDetalle.query.get_or_404(detalle_id)
        
        # --- CANDADO DE SEGURIDAD ---
        # Si la orden ya estÃ¡ cerrada, impedimos cualquier movimiento
        if detalle.orden.estado in ['LISTO_RUTA', 'EN_RUTA', 'ENTREGADA', 'CANCELADA']:
            flash('â›” ACCIÃ“N DENEGADA: Esta orden ya fue finalizada. No se puede modificar el inventario.', 'danger')
            return redirect(url_for('shipping.picking', orden_id=detalle.orden_id))
        # ----------------------------

        inv = InventarioProducto.query.get(inventario_id)
        
        # Validaciones de Inventario
        if not inv:
            flash('âŒ Error: El registro de inventario ya no existe o cambiÃ³.', 'danger')
            return redirect(url_for('shipping.picking', orden_id=detalle.orden_id))
            
        if inv.cantidad_actual < cantidad:
            flash(f'âŒ Stock Insuficiente: Solo quedan {inv.cantidad_actual} pzas disponibles ahÃ­.', 'danger')
            return redirect(url_for('shipping.picking', orden_id=detalle.orden_id))
            
        # 1. Ejecutar Descuento (Salida de AlmacÃ©n)
        inv.cantidad_actual -= cantidad
        
        # 2. Actualizar Detalle Orden
        detalle.cantidad_surtida = (detalle.cantidad_surtida or 0) + cantidad
        
        # 3. Registrar en KÃ¡rdex
        mov = HistorialMovimiento(
            producto_id=detalle.producto_id,
            ubicacion_id=inv.ubicacion_id,
            tipo_movimiento='SALIDA_VENTA',
            cantidad=cantidad,
            usuario_id=current_user.id,
            fecha=datetime.now(),
            referencia=f"Pedido {detalle.orden.folio}",
            notas=f"Surtido para: {detalle.orden.cliente.nombre_negocio}"
        )
        db.session.add(mov)
        
        # Actualizar estado si es el primer movimiento
        if detalle.orden.estado == 'CONFIRMADA':
            detalle.orden.estado = 'EN_PRODUCCION'
            
        db.session.commit()
        flash(f'âœ… Tomadas {cantidad} pzas correctamente.', 'success')
        
    except Exception as e:
        db.session.rollback()
        flash(f'Error tÃ©cnico: {str(e)}', 'danger')
        
    return redirect(url_for('shipping.picking', orden_id=detalle.orden_id))

# --- 4. GENERAR ETIQUETAS MASIVAS (CON CANDADO) ---
@shipping_bp.route('/generar-etiquetas', methods=['POST'])
@login_required
def generar_etiquetas():
    try:
        orden_id = int(request.form.get('orden_id'))
        total_cajas = int(request.form.get('total_cajas'))
        contenido = request.form.get('contenido', '')
        
        orden = OrdenVenta.query.get_or_404(orden_id)
        
        # --- CANDADO DE SEGURIDAD ---
        if orden.estado in ['LISTO_RUTA', 'EN_RUTA', 'ENTREGADA', 'CANCELADA']:
            flash('â›” ERROR: La orden estÃ¡ cerrada. Solo puedes reimprimir etiquetas, no generar nuevas.', 'danger')
            return redirect(url_for('shipping.picking', orden_id=orden.id))
        # ----------------------------

        # Limpiar etiquetas previas para regenerar
        OrdenPaquete.query.filter_by(orden_id=orden.id).delete()
        
        ruta_str = orden.cliente.ruta.descripcion.split(':')[0] if orden.cliente.ruta else "SR"
        folio_clean = orden.folio.replace('PV-', '')
        
        for i in range(1, total_cajas + 1):
            # Formato QR: #FOLIO_RUTA_CajaX/Y
            codigo_qr = f"#{folio_clean}_{ruta_str}_C{i}/{total_cajas}"
            
            paq = OrdenPaquete(
                orden_id=orden.id,
                codigo_etiqueta=codigo_qr,
                numero_caja=i,
                total_cajas_orden=total_cajas,
                descripcion_contenido=contenido if contenido else f"Caja {i} de {total_cajas}",
                creado_por_id=current_user.id
            )
            db.session.add(paq)
        
        orden.estado = 'EMPACADO'
        db.session.commit()
        
        flash(f'âœ… {total_cajas} etiquetas de caja generadas.', 'success')
        return redirect(url_for('shipping.imprimir_etiquetas', orden_id=orden.id))

    except Exception as e:
        db.session.rollback()
        flash(f'Error generando etiquetas: {str(e)}', 'danger')
        return redirect(url_for('shipping.picking', orden_id=orden_id))

# --- 5. VISTA DE IMPRESIÃ“N (SIN CANDADO, SIEMPRE ACCESIBLE) ---
@shipping_bp.route('/imprimir/<int:orden_id>')
@login_required
def imprimir_etiquetas(orden_id):
    orden = OrdenVenta.query.get_or_404(orden_id)
    return render_template('shipping/labels.html', orden=orden)

# --- 6. GENERAR CAJA MANUAL (CON CANDADO) ---
@shipping_bp.route('/generar-caja', methods=['POST'])
@login_required
def generar_caja():
    try:
        orden_id = int(request.form.get('orden_id'))
        num_caja = int(request.form.get('num_caja'))
        total_cajas = int(request.form.get('total_cajas'))
        contenido = request.form.get('contenido')
        
        orden = OrdenVenta.query.get_or_404(orden_id)

        # --- CANDADO DE SEGURIDAD ---
        if orden.estado in ['LISTO_RUTA', 'EN_RUTA', 'ENTREGADA', 'CANCELADA']:
            flash('â›” ERROR: Orden cerrada.', 'danger')
            return redirect(url_for('shipping.picking', orden_id=orden.id))
        # ----------------------------

        codigo = f"PAQ-{orden.folio}-C{num_caja}"
        
        paq = OrdenPaquete(
            orden_id=orden.id,
            codigo_etiqueta=codigo,
            numero_caja=num_caja,
            total_cajas_orden=total_cajas,
            descripcion_contenido=contenido,
            creado_por_id=current_user.id
        )
        db.session.add(paq)
        
        if num_caja == total_cajas:
            orden.estado = 'EN_RUTA' # Opcional, o esperar a finalizar
        else:
            orden.estado = 'EMPACADO'
            
        db.session.commit()
        flash(f'ðŸ“¦ Caja {num_caja} registrada.', 'info')
        
    except Exception as e:
        db.session.rollback()
        flash(f'Error: {str(e)}', 'danger')
        
    return redirect(url_for('shipping.picking', orden_id=orden_id))

# --- 7. FINALIZAR ORDEN (CIERRE DEFINITIVO) ---
@shipping_bp.route('/finalizar/<int:orden_id>', methods=['POST'])
@login_required
def finalizar_orden(orden_id):
    try:
        orden = OrdenVenta.query.get_or_404(orden_id)
        
        # Si ya estaba cerrada, no hacemos nada (idempotencia)
        if orden.estado == 'LISTO_RUTA':
            flash('Esta orden ya estaba finalizada.', 'info')
            return redirect(url_for('shipping.index'))

        if not orden.paquetes:
            flash('âš ï¸ Advertencia: Finalizaste la orden sin generar etiquetas de caja.', 'warning')
            
        orden.estado = 'LISTO_RUTA'
        db.session.commit()
        
        flash(f'ðŸš€ Orden {orden.folio} finalizada correctamente y enviada a LogÃ­stica.', 'success')
        
    except Exception as e:
        db.session.rollback()
        flash(f'Error al finalizar: {str(e)}', 'danger')
        
    return redirect(url_for('shipping.index'))

========================= FILE: .\app\models\catalogs.py =========================
# app/models/catalogs.py
from app.extensions import db

# --- CLASES BASE PARA REUTILIZAR CÃ“DIGO ---
class CatalogoBase(db.Model):
    """Clase abstracta para catÃ¡logos simples (id, descripcion/nombre)"""
    __abstract__ = True
    id = db.Column(db.Integer, primary_key=True)
    activo = db.Column(db.Boolean, default=True)

# --- INFRAESTRUCTURA ---
class CatPlanta(CatalogoBase):
    __tablename__ = 'cat_plantas'
    descripcion = db.Column(db.String(100), nullable=False)
    notas = db.Column(db.String(255))

class CatArea(CatalogoBase):
    __tablename__ = 'cat_areas'
    descripcion = db.Column(db.String(100), nullable=False)
    notas = db.Column(db.String(255))

class CatUbicacion(CatalogoBase):
    __tablename__ = 'cat_ubicaciones'
    descripcion = db.Column(db.String(100), nullable=False) # Pasillo A, Nivel 1, etc.

class CatTipoAlmacen(CatalogoBase):
    __tablename__ = 'cat_tipos_almacen'
    nombre = db.Column(db.String(50), nullable=False)

class CatTipoMovimientoAlmacen(CatalogoBase):
    __tablename__ = 'cat_tipos_movimiento_almacen'
    descripcion = db.Column(db.String(50), nullable=False, unique=True)

# --- PRODUCTOS ---
class CatUnidadMedida(CatalogoBase):
    __tablename__ = 'cat_unidades_medida'
    nombre = db.Column(db.String(50), nullable=False)
    abreviatura = db.Column(db.String(10), nullable=False)

class CatCategoriaProducto(CatalogoBase):
    __tablename__ = 'cat_categorias_producto'
    nombre = db.Column(db.String(100), nullable=False)
    descripcion = db.Column(db.String(255))

class CatCategoriaMateriaPrima(CatalogoBase):
    __tablename__ = 'cat_categorias_materia_prima'
    nombre = db.Column(db.String(100), nullable=False)
    descripcion = db.Column(db.String(255))

# --- RH Y OPERACIÃ“N ---
class CatPuesto(CatalogoBase):
    __tablename__ = 'cat_puestos'
    nombre = db.Column(db.String(50), nullable=False)
    nivel_acceso = db.Column(db.Integer, default=1) # 1-5

class CatTipoVehiculo(CatalogoBase):
    __tablename__ = 'cat_tipos_vehiculo'
    nombre = db.Column(db.String(50), nullable=False)

class CatModeloVehiculo(CatalogoBase):
    __tablename__ = 'cat_modelos_vehiculo'
    marca = db.Column(db.String(50), nullable=False)
    modelo = db.Column(db.String(50), nullable=False)
    anio = db.Column(db.Integer)

class CatModeloActivo(CatalogoBase):
    __tablename__ = 'cat_modelos_activo'
    marca = db.Column(db.String(50), nullable=False)
    modelo = db.Column(db.String(50), nullable=False)
    capacidad_litros = db.Column(db.Float)

class CatEstadoFisico(CatalogoBase):
    __tablename__ = 'cat_estados_fisicos'
    descripcion = db.Column(db.String(50), nullable=False)

class CatTipoIncidencia(CatalogoBase):
    __tablename__ = 'cat_tipos_incidencia'
    descripcion = db.Column(db.String(100), nullable=False)

# --- FINANZAS Y CONTROL ---
class CatBancoCaja(CatalogoBase):
    __tablename__ = 'cat_bancos_cajas'
    nombre = db.Column(db.String(100), nullable=False)

class CatConceptoFinanzas(CatalogoBase):
    __tablename__ = 'cat_conceptos_finanzas'
    tipo_flujo = db.Column(db.String(20), nullable=False) # INGRESO, EGRESO, DEUDA
    descripcion = db.Column(db.String(100), nullable=False)

class CatTipoDescuento(CatalogoBase):
    __tablename__ = 'cat_tipos_descuento'
    descripcion = db.Column(db.String(50), nullable=False) # PORCENTAJE, PRECIO_FINAL

class CatTipoPagoSolicitado(CatalogoBase):
    __tablename__ = 'cat_tipos_pago_solicitado'
    descripcion = db.Column(db.String(50), nullable=False) # CONTADO, CREDITO

class CatEstadoOrdenVenta(CatalogoBase):
    __tablename__ = 'cat_estados_orden_venta'
    descripcion = db.Column(db.String(50), nullable=False) # BORRADOR, CONFIRMADO...

class CatEstadoPlanProduccion(CatalogoBase):
    __tablename__ = 'cat_estados_plan_produccion'
    descripcion = db.Column(db.String(50), nullable=False) # PLANIFICADO, EN_PROCESO...

class CatEstadoOrdenEmpaque(CatalogoBase):
    __tablename__ = 'cat_estados_orden_empaque'
    descripcion = db.Column(db.String(50), nullable=False)

class CatTipoMovimientoFinanzas(CatalogoBase):
    __tablename__ = 'cat_tipos_movimiento_finanzas'
    descripcion = db.Column(db.String(50), nullable=False) # CARGO_VENTA...

class CatEstadoDeudaEmpresa(CatalogoBase):
    __tablename__ = 'cat_estados_deuda_empresa'
    descripcion = db.Column(db.String(50), nullable=False) # PENDIENTE...

class CatTipoFlujo(CatalogoBase):
    __tablename__ = 'cat_tipos_flujo'
    descripcion = db.Column(db.String(50), nullable=False) # ENTRADA, SALIDA

class CatOrigenFlujo(CatalogoBase):
    __tablename__ = 'cat_origenes_flujo'
    descripcion = db.Column(db.String(50), nullable=False) # CAPITAL, VENTAS...

class CatPeriodo(CatalogoBase):
    __tablename__ = 'cat_periodos'
    descripcion = db.Column(db.String(50), nullable=False) # MENSUAL, ANUAL

========================= FILE: .\app\models\clients.py =========================
# app/models/clients.py
from app.extensions import db

class Cliente(db.Model):
    __tablename__ = 'clientes'

    id = db.Column(db.Integer, primary_key=True)
    
    # --- NEGOCIO ---
    nombre_negocio = db.Column(db.String(150), nullable=False)
    rfc = db.Column(db.String(13))
    tipo_negocio = db.Column(db.String(100))
    img_fachada = db.Column(db.String(255))
    calificacion = db.Column(db.Integer, default=5)

    # --- ENCARGADO ---
    nombres_encargado = db.Column(db.String(100))
    apellidos_encargado = db.Column(db.String(100))
    img_ine_frente = db.Column(db.String(255))
    img_ine_reverso = db.Column(db.String(255))
    
    # --- CONTACTO ---
    telefono = db.Column(db.String(20)) # Fijo
    celular = db.Column(db.String(20))  # WhatsApp / MÃ³vil
    email = db.Column(db.String(150))   # Notificaciones

    # --- DOMICILIO ---
    calle = db.Column(db.String(100))
    num_exterior = db.Column(db.String(20))
    num_interior = db.Column(db.String(20))
    colonia = db.Column(db.String(100))
    ciudad = db.Column(db.String(100))
    codigo_postal = db.Column(db.String(10))
    estado = db.Column(db.String(100))
    pais = db.Column(db.String(100), default="MÃ©xico")

    # --- FINANCIERO ---
    limite_credito = db.Column(db.Numeric(12, 2), default=0.00)
    saldo_actual = db.Column(db.Numeric(12, 2), default=0.00) 
    
    # --- LOGÃSTICA ---
    ruta_id = db.Column(db.Integer, db.ForeignKey('rutas_reparto.id'))
    
    # Relaciones con empleados operativos
    repartidor_habitual_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=True)
    vendedor_habitual_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=True)

    # --- CONTROL ---
    activo = db.Column(db.Boolean, default=True)

    # Relaciones ORM
    ruta = db.relationship('RutaReparto', backref='clientes')
    repartidor = db.relationship('Usuario', foreign_keys=[repartidor_habitual_id])
    vendedor = db.relationship('Usuario', foreign_keys=[vendedor_habitual_id])

class PrecioEspecialCliente(db.Model):
    __tablename__ = 'precios_especiales_cliente'

    id = db.Column(db.Integer, primary_key=True)
    
    cliente_id = db.Column(db.Integer, db.ForeignKey('clientes.id'))
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'))
    tipo_descuento_id = db.Column(db.Integer, db.ForeignKey('cat_tipos_descuento.id'))
    
    valor_descuento = db.Column(db.Numeric(10, 2), nullable=False)

    cliente = db.relationship('Cliente', backref='precios_especiales')
    producto = db.relationship('Producto')
    tipo_descuento = db.relationship('CatTipoDescuento')

========================= FILE: .\app\models\finance.py =========================
from app.extensions import db
from datetime import datetime

class CajaEmpresa(db.Model):
    __tablename__ = 'caja_empresa'
    
    id = db.Column(db.Integer, primary_key=True)
    saldo_actual = db.Column(db.Numeric(10, 2), default=0.00)
    ultima_actualizacion = db.Column(db.DateTime, default=datetime.now, onupdate=datetime.now)

    def __repr__(self):
        return f'<Caja ${self.saldo_actual}>'

class TransaccionFinanciera(db.Model):
    # ESTA ES LA TABLA MAESTRA DE TESORERÃA (EL HISTORIAL)
    __tablename__ = 'transacciones_financieras'

    id = db.Column(db.Integer, primary_key=True)
    
    # NUEVO: FOLIO ÃšNICO DE TESORERÃA (Ej: TES-ING-251230-ABCD)
    folio = db.Column(db.String(50), unique=True, nullable=False)
    
    tipo = db.Column(db.String(20))  # 'INGRESO' o 'EGRESO'
    monto = db.Column(db.Numeric(10, 2), nullable=False)
    concepto = db.Column(db.String(255)) 
    notas = db.Column(db.Text, nullable=True) # Para detalles extra
    fecha = db.Column(db.DateTime, default=datetime.now)
    
    # RelaciÃ³n con quien hizo el movimiento (Admin Finanzas)
    usuario_id = db.Column(db.Integer, db.ForeignKey('usuarios.id')) 
    usuario = db.relationship('Usuario', backref=db.backref('transacciones', lazy=True))
    
    # RASTREABILIDAD (De dÃ³nde vino esto)
    # Si viene de un pago de chofer:
    pago_origen_id = db.Column(db.Integer, db.ForeignKey('pagos.id'), nullable=True)
    pago_origen = db.relationship('Pago', backref='transaccion_tesoreria')
    
    # Si viene de un gasto operativo:
    gasto_id = db.Column(db.Integer, db.ForeignKey('gastos_operativos.id'), nullable=True)
    gasto = db.relationship('GastoOperativo', backref='transaccion_tesoreria')

class GastoOperativo(db.Model):
    __tablename__ = 'gastos_operativos'

    id = db.Column(db.Integer, primary_key=True)
    categoria = db.Column(db.String(50)) 
    descripcion = db.Column(db.String(255))
    monto = db.Column(db.Numeric(10, 2), nullable=False)
    notas = db.Column(db.Text, nullable=True)
    fecha_registro = db.Column(db.DateTime, default=datetime.now)
    
    registrado_por_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'))
    registrado_por = db.relationship('Usuario', backref='gastos_registrados')
    
    proveedor_id = db.Column(db.Integer, nullable=True)

========================= FILE: .\app\models\infrastructure.py =========================
# app/models/infrastructure.py
from app.extensions import db
from datetime import datetime

class Almacen(db.Model):
    __tablename__ = 'almacenes'
    id = db.Column(db.Integer, primary_key=True)
    descripcion = db.Column(db.String(100), nullable=False)
    imagen_almacen = db.Column(db.String(255))
    tipo_id = db.Column(db.Integer, db.ForeignKey('cat_tipos_almacen.id'))
    planta_id = db.Column(db.Integer, db.ForeignKey('cat_plantas.id'))
    area_id = db.Column(db.Integer, db.ForeignKey('cat_areas.id'))
    
    tipo = db.relationship('CatTipoAlmacen')
    planta = db.relationship('CatPlanta')
    area = db.relationship('CatArea')

class UbicacionAlmacen(db.Model):
    __tablename__ = 'ubicaciones_almacen'
    id = db.Column(db.Integer, primary_key=True)
    codigo = db.Column(db.String(50), unique=True, nullable=False)
    notas = db.Column(db.String(255))
    almacen_id = db.Column(db.Integer, db.ForeignKey('almacenes.id'))
    cat_ubicacion_id = db.Column(db.Integer, db.ForeignKey('cat_ubicaciones.id'), nullable=True)
    
    almacen = db.relationship('Almacen', backref='ubicaciones')

class RutaReparto(db.Model):
    __tablename__ = 'rutas_reparto'
    id = db.Column(db.Integer, primary_key=True)
    descripcion = db.Column(db.String(100), nullable=False)
    img_mapa = db.Column(db.String(255))
    notas = db.Column(db.Text)

# --- CLASES FALTANTES AGREGADAS (CORRIGE EL ERROR CRÃTICO DEL AUDITOR) ---

class Vehiculo(db.Model):
    __tablename__ = 'vehiculos'
    id = db.Column(db.Integer, primary_key=True)
    placas = db.Column(db.String(20), unique=True)
    serie_vehiculo = db.Column(db.String(50))
    tipo_id = db.Column(db.Integer, db.ForeignKey('cat_tipos_vehiculo.id'))
    modelo_id = db.Column(db.Integer, db.ForeignKey('cat_modelos_vehiculo.id'))
    
    # Estado
    asignado = db.Column(db.Boolean, default=False)
    kilometraje_ultimo_servicio = db.Column(db.Float)
    
    # Relaciones
    tipo = db.relationship('CatTipoVehiculo')
    # modelo = db.relationship('CatModeloVehiculo') # Descomentar si el catÃ¡logo existe

class ActivoFrio(db.Model):
    __tablename__ = 'activos_frio'
    id = db.Column(db.Integer, primary_key=True)
    serie = db.Column(db.String(50), unique=True)
    descripcion = db.Column(db.String(100))
    modelo_id = db.Column(db.Integer, db.ForeignKey('cat_modelos_activo.id'))
    estado_id = db.Column(db.Integer, db.ForeignKey('cat_estados_fisicos.id'))
    asignado = db.Column(db.Boolean, default=False)

========================= FILE: .\app\models\orders.py =========================
from app.extensions import db
from datetime import datetime

class OrdenVenta(db.Model):
    __tablename__ = 'ordenes_venta'

    id = db.Column(db.Integer, primary_key=True)
    folio = db.Column(db.String(20), unique=True, nullable=False)
    
    cliente_id = db.Column(db.Integer, db.ForeignKey('clientes.id'), nullable=False)
    vendedor_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=False)
    
    fecha_registro = db.Column(db.DateTime, default=datetime.now)
    fecha_promesa_entrega = db.Column(db.Date, nullable=False)
    
    # Estados: 'CONFIRMADA', 'PRODUCCION', 'LISTO_RUTA', 'EN_RUTA', 'ENTREGADA', 'PAGADO', 'CANCELADA'
    estado = db.Column(db.String(25), default='CONFIRMADA')
    
    metodo_pago_esperado = db.Column(db.String(20)) # 'Contado', 'Credito'
    
    # Dineros
    total_venta = db.Column(db.Float, default=0.0)    
    
    # Esta es la columna que faltaba y hacÃ­a tronar el ticket
    saldo_pendiente = db.Column(db.Numeric(12, 2), default=0.00) 
    # -----------------------------------

    notas_vendedor = db.Column(db.Text)

    # Relaciones
    cliente = db.relationship('Cliente', backref='ordenes')
    vendedor = db.relationship('Usuario', backref='ventas_realizadas')
    items = db.relationship('OrdenVentaDetalle', backref='orden', cascade="all, delete-orphan")
    
    # RelaciÃ³n con pagos (definida en el modelo Payment, pero accesible aquÃ­ por backref 'pagos_registrados')

class OrdenVentaDetalle(db.Model):
    __tablename__ = 'orden_venta_detalles'

    id = db.Column(db.Integer, primary_key=True)
    orden_id = db.Column(db.Integer, db.ForeignKey('ordenes_venta.id'), nullable=False)
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'), nullable=False)
    
    cantidad_pedida = db.Column(db.Float, nullable=False)
    cantidad_surtida = db.Column(db.Float, default=0)   # Lo que saliÃ³ de almacÃ©n
    cantidad_entregada = db.Column(db.Float, default=0) # Lo que recibiÃ³ el cliente
    
    precio_unitario = db.Column(db.Float, nullable=False)
    subtotal = db.Column(db.Float, nullable=False)

    producto = db.relationship('Producto')

========================= FILE: .\app\models\payments.py =========================
from app.extensions import db
from datetime import datetime

class Pago(db.Model):
    __tablename__ = 'pagos'

    id = db.Column(db.Integer, primary_key=True)
    folio_recibo = db.Column(db.String(50), unique=True, nullable=False)
    
    # FKs OBLIGATORIAS
    cliente_id = db.Column(db.Integer, db.ForeignKey('clientes.id'), nullable=False)
    orden_id = db.Column(db.Integer, db.ForeignKey('ordenes_venta.id'), nullable=False)
    tipo_movimiento_id = db.Column(db.Integer, db.ForeignKey('cat_tipos_movimiento_finanzas.id'), nullable=False)
    
    # RESPONSABLES
    cobrado_por_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=False)
    auditado_por_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=True) # Puede ser Null al inicio
    
    # DINERO
    monto_pago = db.Column(db.Numeric(12, 2), nullable=False)
    dinero_recibido = db.Column(db.Numeric(12, 2))
    cambio_devuelto = db.Column(db.Numeric(12, 2))
    
    referencia = db.Column(db.String(100))
    estado = db.Column(db.String(20), default='POR_AUDITAR')
    
    fecha_registro = db.Column(db.DateTime, default=datetime.now)
    fecha_auditoria = db.Column(db.DateTime)
    notas = db.Column(db.Text)

    # RELACIONES
    cliente = db.relationship('Cliente', backref='historial_pagos')
    orden = db.relationship('OrdenVenta', backref='pagos_registrados')
    
    # RelaciÃ³n al catÃ¡logo (para saber si fue Efectivo o Transferencia)
    # Asumimos que el modelo CatTipoMovimientoFinanzas ya existe en tus catÃ¡logos.
    # Si te da error de import, asegÃºrate de importarlo aquÃ­ o definirlo.
    
    # RELACIONES CON USUARIOS
    cobrador = db.relationship('Usuario', foreign_keys=[cobrado_por_id], backref='cobros_realizados')
    auditor = db.relationship('Usuario', foreign_keys=[auditado_por_id], backref='cobros_auditados')

========================= FILE: .\app\models\production.py =========================
from app.extensions import db
from datetime import datetime
from app.models.users import Usuario 

class OrdenProduccion(db.Model):
    __tablename__ = 'ordenes_produccion'

    id = db.Column(db.Integer, primary_key=True)
    folio = db.Column(db.String(50), unique=True, nullable=False)
    
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'), nullable=False)
    receta_id = db.Column(db.Integer, nullable=True)
    
    # LO QUE SE PIDE (TeÃ³rico)
    cantidad = db.Column(db.Float, nullable=False)
    
    # LO QUE SALE (Realidad - Reportado por Maestro Heladero)
    cantidad_producida_real = db.Column(db.Float, default=0)
    notas_produccion = db.Column(db.Text, nullable=True)

    # --- NUEVO CAMPO PARA RECEPCIÃ“N PARCIAL (ALMACÃ‰N) ---
    # AquÃ­ se va sumando lo que el almacenista mete al refri poco a poco.
    cantidad_recibida_almacen = db.Column(db.Float, default=0)
    # ----------------------------------------------------

    usuario_solicita_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), nullable=False)
    
    fecha_solicitud = db.Column(db.DateTime, default=datetime.now)
    fecha_inicio = db.Column(db.DateTime, nullable=True)
    fecha_termino = db.Column(db.DateTime, nullable=True)
    
    # ESTATUS: 
    # 'SOLICITADA' -> 'BATIENDO' -> 'POR_RECIBIR' (En trÃ¡nsito/Parcial) -> 'TERMINADA' (Cerrada)
    estatus = db.Column(db.String(20), default='SOLICITADA')
    prioridad = db.Column(db.String(20), default='NORMAL')

    producto = db.relationship('Producto', backref='ordenes')
    usuario = db.relationship('Usuario', backref='ordenes_creadas')

========================= FILE: .\app\models\products.py =========================
# app/models/products.py
from app.extensions import db

class Producto(db.Model):
    __tablename__ = 'productos'

    id = db.Column(db.Integer, primary_key=True)
    sku = db.Column(db.String(50), unique=True, nullable=False)
    descripcion = db.Column(db.String(200), nullable=False)
    
    # ClasificaciÃ³n
    categoria_id = db.Column(db.Integer, db.ForeignKey('cat_categorias_producto.id'))
    unidad_id = db.Column(db.Integer, db.ForeignKey('cat_unidades_medida.id'))

    # Dinero
    precio_costo_actual = db.Column(db.Numeric(10, 2), default=0.00)
    precio_venta_general = db.Column(db.Numeric(10, 2), default=0.00) # Base

    # FÃ­sico
    peso_gramos = db.Column(db.Float, default=0.0)
    caducidad_dias = db.Column(db.Integer, default=0)
    imagen_producto = db.Column(db.String(255))

    # SemÃ¡foros de Inventario
    stock_minimo = db.Column(db.Float, default=0.0)
    stock_maximo = db.Column(db.Float, default=0.0)
    stock_ideal = db.Column(db.Float, default=0.0)

    # --- CONTROL DE VIDA (SincronizaciÃ³n) ---
    # Esto le permite a Python ver la columna que YA EXISTE en tu BD
    activo = db.Column(db.Boolean, default=True)

    # Relaciones
    categoria = db.relationship('CatCategoriaProducto')
    unidad = db.relationship('CatUnidadMedida')

class MateriaPrima(db.Model):
    __tablename__ = 'materia_prima'

    id = db.Column(db.Integer, primary_key=True)
    sku = db.Column(db.String(50), unique=True, nullable=False)
    descripcion = db.Column(db.String(200), nullable=False)
    
    categoria_id = db.Column(db.Integer, db.ForeignKey('cat_categorias_materia_prima.id'))
    unidad_id = db.Column(db.Integer, db.ForeignKey('cat_unidades_medida.id'))

    # Dinero
    precio_costo_promedio = db.Column(db.Numeric(10, 2), default=0.00)
    precio_venta_general = db.Column(db.Numeric(10, 2), default=0.00) 

    # FÃ­sico
    peso_gramos = db.Column(db.Float, default=0.0)
    caducidad_dias = db.Column(db.Integer, default=0)
    imagen_materia = db.Column(db.String(255))
    
    # Inventario Ideal
    stock_minimo = db.Column(db.Float, default=0.0)
    stock_maximo = db.Column(db.Float, default=0.0)
    stock_ideal = db.Column(db.Float, default=0.0)

    # Agregado por seguridad para futuros filtros
    activo = db.Column(db.Boolean, default=True)

    categoria = db.relationship('CatCategoriaMateriaPrima')
    unidad = db.relationship('CatUnidadMedida')

========================= FILE: .\app\models\shipping.py =========================
from app.extensions import db
from datetime import datetime

class OrdenPaquete(db.Model):
    __tablename__ = 'orden_paquetes'

    id = db.Column(db.Integer, primary_key=True)
    orden_id = db.Column(db.Integer, db.ForeignKey('ordenes_venta.id'), nullable=False)
    
    codigo_etiqueta = db.Column(db.String(50), unique=True)
    numero_caja = db.Column(db.Integer)
    total_cajas_orden = db.Column(db.Integer)
    
    descripcion_contenido = db.Column(db.Text)
    peso_kg = db.Column(db.Float, default=0.0)
    
    creado_por_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'))
    fecha_creacion = db.Column(db.DateTime, default=datetime.now)

    # RelaciÃ³n inversa: orden.paquetes
    orden = db.relationship('OrdenVenta', backref='paquetes')
    usuario = db.relationship('Usuario')

========================= FILE: .\app\models\stock.py =========================
# app/models/stock.py
from app.extensions import db
from datetime import datetime

class InventarioProducto(db.Model):
    __tablename__ = 'inventario_productos'

    id = db.Column(db.Integer, primary_key=True)
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'), nullable=True)
    materia_prima_id = db.Column(db.Integer, db.ForeignKey('materia_prima.id'), nullable=True)
    ubicacion_id = db.Column(db.Integer, db.ForeignKey('ubicaciones_almacen.id'), nullable=False)

    # --- CORRECCIÃ“N CRÃTICA: Nombre alineado con Postgres ---
    cantidad_actual = db.Column(db.Float, default=0.0)  # ANTES: cantidad_fisica
    cantidad_reservada = db.Column(db.Float, default=0.0) 
    
    # Propiedad calculada para saber quÃ© puede vender el preventista
    @property
    def cantidad_disponible(self):
        # AQUÃ TAMBIÃ‰N HABÃA QUE CORREGIR EL NOMBRE
        return self.cantidad_actual - self.cantidad_reservada

    # --- TRAZABILIDAD ---
    fecha_produccion = db.Column(db.Date, nullable=True) 
    fecha_ingreso_almacen = db.Column(db.DateTime, default=datetime.utcnow)

    # --- SEMÃFOROS POR UBICACIÃ“N ---
    stock_minimo = db.Column(db.Float, default=0.0)
    stock_maximo = db.Column(db.Float, default=0.0)
    stock_ideal = db.Column(db.Float, default=0.0)

    # Relaciones
    producto = db.relationship('Producto', backref='existencias')
    ubicacion = db.relationship('UbicacionAlmacen', backref='productos_almacenados')

class MovimientoTemporal(db.Model):
    """Guarda las reservas mientras el almacenista estÃ¡ empacando"""
    __tablename__ = 'movimientos_temporales'
    
    id = db.Column(db.Integer, primary_key=True)
    orden_venta_id = db.Column(db.Integer, nullable=False) # RelaciÃ³n a la orden
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'))
    ubicacion_origen_id = db.Column(db.Integer, db.ForeignKey('ubicaciones_almacen.id'))
    cantidad = db.Column(db.Float, nullable=False)
    estado = db.Column(db.String(20), default='RESERVADO') # RESERVADO, CONFIRMADO, MERMA

class HistorialMovimiento(db.Model):
    """KÃ¡rdex Profesional para auditorÃ­a de cada pieza"""
    __tablename__ = 'historial_movimientos'
    
    id = db.Column(db.Integer, primary_key=True)
    producto_id = db.Column(db.Integer, db.ForeignKey('productos.id'))
    ubicacion_id = db.Column(db.Integer, db.ForeignKey('ubicaciones_almacen.id'))
    tipo_movimiento = db.Column(db.String(50)) # ENTRADA_PRODUCCION, MERMA, AJUSTE, SALIDA_VENTA
    cantidad = db.Column(db.Float, nullable=False)
    usuario_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'))
    fecha = db.Column(db.DateTime, default=datetime.utcnow)
    referencia = db.Column(db.String(100)) # ID de Orden o Lote
    notas = db.Column(db.Text)

========================= FILE: .\app\models\users.py =========================
# app/models/users.py
from app.extensions import db
from datetime import datetime
from flask_login import UserMixin # <--- 1. NUEVO IMPORT
from werkzeug.security import check_password_hash # <--- 2. NUEVO IMPORT

class Usuario(UserMixin, db.Model): # <--- 3. HERENCIA NUEVA
    __tablename__ = 'usuarios'

    id = db.Column(db.Integer, primary_key=True)
    
    # --- IDENTIDAD ---
    nombres = db.Column(db.String(100), nullable=False)
    apellido_paterno = db.Column(db.String(100), nullable=False)
    apellido_materno = db.Column(db.String(100))
    fecha_nacimiento = db.Column(db.Date)
    estado_civil = db.Column(db.String(50))
    profesion = db.Column(db.String(100))
    curp = db.Column(db.String(18))
    rfc = db.Column(db.String(13))

    # --- DOMICILIO ---
    calle = db.Column(db.String(100))
    num_exterior = db.Column(db.String(20))
    num_interior = db.Column(db.String(20))
    colonia = db.Column(db.String(100))
    ciudad = db.Column(db.String(100))
    codigo_postal = db.Column(db.String(10))
    estado = db.Column(db.String(100))
    pais = db.Column(db.String(100), default="MÃ©xico")

    # --- CONTACTO ---
    telefono_casa = db.Column(db.String(20))
    telefono_celular = db.Column(db.String(20))
    email_personal = db.Column(db.String(100))
    
    # Emergencia
    contacto_emergencia_nombre = db.Column(db.String(150))
    contacto_emergencia_telefono = db.Column(db.String(20))

    # --- LABORAL ---
    puesto_id = db.Column(db.Integer, db.ForeignKey('cat_puestos.id'))
    fecha_inicio_empresa = db.Column(db.Date, default=datetime.utcnow)
    calificacion_evaluacion = db.Column(db.Integer, default=5)
    notas_generales = db.Column(db.Text)

    # --- SEGURIDAD ---
    email_acceso = db.Column(db.String(100), unique=True, nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    pin_seguridad = db.Column(db.String(6))
    nivel_usuario = db.Column(db.Integer, default=1)
    activo = db.Column(db.Boolean, default=True)

    # --- DOCUMENTACIÃ“N ---
    foto_perfil = db.Column(db.String(255))
    img_ine_frente = db.Column(db.String(255))
    img_ine_reverso = db.Column(db.String(255))
    img_licencia_frente = db.Column(db.String(255))
    img_licencia_reverso = db.Column(db.String(255))
    fecha_validez_licencia = db.Column(db.Date)

    # Relaciones
    puesto = db.relationship('CatPuesto', backref='usuarios')

    # --- MÃ‰TODOS NUEVOS PARA LOGIN ---
    def check_password(self, password):
        """Verifica si la contraseÃ±a coincide con el hash"""
        return check_password_hash(self.password_hash, password)

    def __repr__(self):
        return f'<Usuario {self.nombres} {self.apellido_paterno}>'

========================= FILE: .\app\models\__init__.py =========================


========================= FILE: .\app\static\css\main.css =========================
/* app/static/css/main.css */

:root {
    --gelmex-primary: #0d47a1; /* Azul Industrial Fuerte */
    --gelmex-secondary: #1565c0; /* Azul Medio */
    --gelmex-accent: #ffca28; /* Amarillo Preventivo (Botones/Alertas) */
    --gelmex-dark: #263238; /* Gris Oscuro (Sidebar) */
    --gelmex-light: #f8f9fa; /* Fondo General */
    --sidebar-width: 250px;
}

body {
    background-color: var(--gelmex-light);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* --- SIDEBAR --- */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--gelmex-dark);
    color: white;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    padding-top: 1rem;
    transition: all 0.3s;
    z-index: 1000;
}

.sidebar-header {
    padding: 1rem;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 1rem;
}

.sidebar .nav-link {
    color: rgba(255,255,255,0.8);
    padding: 0.8rem 1.5rem;
    border-left: 4px solid transparent;
}

.sidebar .nav-link:hover, .sidebar .nav-link.active {
    color: white;
    background-color: rgba(255,255,255,0.05);
    border-left-color: var(--gelmex-accent);
}

.sidebar .nav-link i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
}

/* SubmenÃºs en Sidebar (Para ProducciÃ³n) */
.nav-group-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: rgba(255,255,255,0.4);
    padding: 1rem 1.5rem 0.5rem;
    letter-spacing: 1px;
}

.sub-menu {
    padding-left: 2rem;
    background-color: rgba(0,0,0,0.1);
}

/* --- CONTENIDO PRINCIPAL --- */
.main-content {
    margin-left: var(--sidebar-width);
    padding: 20px;
    width: calc(100% - var(--sidebar-width));
    transition: all 0.3s;
}

/* --- NAVBAR SUPERIOR --- */
.top-navbar {
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    padding: 0.5rem 1rem;
    margin-bottom: 2rem;
    border-radius: 8px;
}

/* --- RESPONSIVO (MÃ³vil) --- */
@media (max-width: 768px) {
    .sidebar {
        margin-left: calc(var(--sidebar-width) * -1);
    }
    .sidebar.active {
        margin-left: 0;
    }
    .main-content {
        margin-left: 0;
        width: 100%;
    }
}

/* --- CARDS & WIDGETS --- */
.card-erp {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}
.card-erp:hover {
    transform: translateY(-2px);
}

========================= FILE: .\app\templates\base.html =========================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GelMexSys 2.0 | {% block title %}Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        /* Estilos del Sidebar y SubmenÃºs */
        .sidebar .nav-link {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ffc107; /* Amarillo industrial */
        }

        .submenu-dark {
            background: rgba(0, 0, 0, 0.2) !important;
            margin: 0 10px;
            border-radius: 8px;
            padding: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .submenu-dark .nav-link {
            font-size: 0.85rem !important;
            padding: 8px 20px !important;
            color: rgba(255, 255, 255, 0.7) !important;
            border-left: none !important;
        }

        .submenu-dark .nav-link:hover {
            color: #fff !important;
            background: transparent !important;
            padding-left: 25px !important;
        }

        .submenu-dark .nav-link.active-sub {
            color: #ffc107 !important;
            font-weight: bold;
        }

        .nav-link[data-bs-toggle="collapse"].collapsed i.fa-chevron-down {
            transform: rotate(-90deg);
        }
        .nav-link i.fa-chevron-down {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fa-solid fa-snowflake"></i> GelMexSys</h4>
            <small class="text-warning">v2.0 Enterprise</small>
        </div>

        <div class="nav flex-column mt-3">
            <a href="{{ url_for('home.dashboard') }}" class="nav-link py-3">
                <i class="fa-solid fa-gauge-high me-2"></i> Dashboard
            </a>

            <div class="nav-group-label mt-2">OPERACIÃ“N</div>
            
            <a href="{{ url_for('sales.preventa') }}" class="nav-link py-3">
                <i class="fa-solid fa-cash-register me-2"></i> Ventas y Pedidos
            </a>
            
            <a class="nav-link py-3 d-flex justify-content-between align-items-center" 
               data-bs-toggle="collapse" href="#collapseInventario" role="button" aria-expanded="false">
                <span><i class="fa-solid fa-boxes-stacked me-2"></i> Inventario y AlmacÃ©n</span>
                <i class="fa-solid fa-chevron-down small"></i>
            </a>
            <div class="collapse" id="collapseInventario">
                <div class="submenu-dark shadow-inner">
                    <a class="nav-link py-2" href="{{ url_for('inventory.index') }}">
                        <i class="fa-solid fa-list me-2"></i> CatÃ¡logo Productos
                    </a>
                    <a class="nav-link py-2" href="{{ url_for('inventory.movimientos') }}">
                        <i class="fa-solid fa-right-left me-2"></i> Movimientos / Ajustes
                    </a>
                    <a class="nav-link py-2 text-warning" href="{{ url_for('reception.index') }}">
                        <i class="fa-solid fa-dolly me-2"></i> RecepciÃ³n ProducciÃ³n
                    </a>
                    <a class="nav-link py-2 text-info" href="{{ url_for('shipping.index') }}">
                        <i class="fa-solid fa-box-open me-2"></i> Surtido y Empaque
                    </a>
                </div>
            </div>

            <a class="nav-link py-3 d-flex justify-content-between align-items-center" 
               data-bs-toggle="collapse" href="#collapseProduccion" role="button" aria-expanded="false">
                <span><i class="fa-solid fa-industry me-2"></i> ProducciÃ³n</span>
                <i class="fa-solid fa-chevron-down small"></i>
            </a>
            <div class="collapse" id="collapseProduccion">
                <div class="submenu-dark shadow-inner">
                    <a class="nav-link py-2" href="{{ url_for('production.tablero_necesidades') }}">
                        <i class="fa-solid fa-chart-line me-2"></i> Tablero de Demanda
                    </a>
                    <a class="nav-link py-2" href="{{ url_for('production.ordenes_maestro') }}">
                        <i class="fa-solid fa-fire-burner me-2"></i> Ã“rdenes Maestro
                    </a>
                </div>
            </div>

            <a href="{{ url_for('logistics.index') }}" class="nav-link py-3">
                <i class="fa-solid fa-truck-fast me-2"></i> LogÃ­stica y Rutas
            </a>

            <div class="nav-group-label mt-2">ADMINISTRACIÃ“N</div>
            
            <a href="{{ url_for('clients.index') }}" class="nav-link py-3">
                <i class="fa-solid fa-users me-2"></i> Cartera de Clientes
            </a>
            
            <a class="nav-link py-3 d-flex justify-content-between align-items-center" 
               data-bs-toggle="collapse" href="#collapseFinanzas" role="button" aria-expanded="false">
                <span><i class="fa-solid fa-sack-dollar me-2"></i> Finanzas</span>
                <i class="fa-solid fa-chevron-down small"></i>
            </a>
            <div class="collapse" id="collapseFinanzas">
                <div class="submenu-dark shadow-inner">
                    <a class="nav-link py-2" href="{{ url_for('finance.dashboard') }}">
                        <i class="fa-solid fa-chart-pie me-2"></i> Tablero Financiero
                    </a>
                    
                    <a class="nav-link py-2 text-info" href="{{ url_for('finance.ingresos') }}">
                        <i class="fa-solid fa-wallet me-2"></i> Ingresos Extra / Capital
                    </a>
                    
                    <a class="nav-link py-2 text-success" href="{{ url_for('finance.auditoria') }}">
                        <i class="fa-solid fa-check-double me-2"></i> AuditorÃ­a de Pagos
                    </a>
                    <a class="nav-link py-2 text-danger" href="{{ url_for('finance.gastos') }}">
                        <i class="fa-solid fa-money-bill-transfer me-2"></i> Gastos y Salidas
                    </a>
                </div>
            </div>

            <a href="#" class="nav-link py-3"><i class="fa-solid fa-users-gear me-2"></i> ConfiguraciÃ³n</a>
        </div>
    </nav>

    <div class="main-content">
        <nav class="navbar top-navbar d-flex justify-content-between px-4 shadow-sm">
            <button class="btn btn-outline-secondary d-md-none" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>
            <h5 class="m-0 text-secondary fw-bold">{% block page_header %}Sistema de Control{% endblock %}</h5>
            
            <div class="d-flex align-items-center gap-3">
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark" data-bs-toggle="dropdown">
                        <img src="https://ui-avatars.com/api/?name={{ current_user.nombres }}&background=0d47a1&color=fff" class="rounded-circle me-2" width="32" alt="User">
                        <strong class="d-none d-md-block">{{ current_user.nombres }}</strong>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                        <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"><i class="fa-solid fa-right-from-bracket me-2"></i>Cerrar SesiÃ³n</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="px-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="p-4">
            {% block content %}{% endblock %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('sidebarToggle').onclick = () => document.querySelector('.sidebar').classList.toggle('active');
    </script>
</body>
</html>

========================= FILE: .\app\templates\auth\login.html =========================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GelMexSys 2.0 | Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .brand-logo {
            text-align: center;
            margin-bottom: 2rem;
            color: #0d47a1;
            font-weight: bold;
            font-size: 1.8rem;
        }
        .btn-login {
            background-color: #0d47a1;
            border: none;
            padding: 0.8rem;
            font-weight: 600;
        }
        .btn-login:hover {
            background-color: #002171;
        }
    </style>
</head>
<body>

    <div class="login-card">
        <div class="brand-logo">
            <i class="fa-solid fa-snowflake"></i> GelMexSys
        </div>
        
        <form method="POST">
            <div class="mb-3">
                <label for="email" class="form-label text-muted">Correo Institucional</label>
                <input type="email" class="form-control form-control-lg" id="email" name="email" placeholder="usuario@gelmex.com" required>
            </div>
            <div class="mb-4">
                <label for="password" class="form-label text-muted">ContraseÃ±a</label>
                <input type="password" class="form-control form-control-lg" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg btn-login">Iniciar SesiÃ³n</button>
            </div>
        </form>
        
        <div class="text-center mt-4">
            <small class="text-muted">Â¿Olvidaste tu acceso? Contacta a TI.</small>
        </div>
    </div>

</body>
</html>

========================= FILE: .\app\templates\clients\form.html =========================
{% extends 'base.html' %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold"><i class="fa-solid fa-store me-2"></i>{{ titulo }}</h4>
        <a href="{{ url_for('clients.index') }}" class="btn btn-outline-secondary">Cancelar</a>
    </div>

    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom-0 pt-3">
                <ul class="nav nav-tabs card-header-tabs" id="clientTabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#tab-identity" type="button">1. Identidad</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-logistics" type="button">2. LogÃ­stica</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-finance" type="button">3. Finanzas</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-docs" type="button">4. Documentos</button></li>
                    {% if cliente %}
                    <li class="nav-item"><button class="nav-link fw-bold text-success" data-bs-toggle="tab" data-bs-target="#tab-prices" type="button"><i class="fa-solid fa-tags me-1"></i> Precios VIP</button></li>
                    {% endif %}
                </ul>
            </div>

            <div class="card-body p-4">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-identity">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Nombre del Negocio *</label>
                                {{ form.nombre_negocio(class="form-control form-control-lg", placeholder="Ej: Abarrotes La Esperanza") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">RFC</label>
                                {{ form.rfc(class="form-control", placeholder="XAXX010101000") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Encargado *</label>
                                {{ form.nombres_encargado(class="form-control") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellidos</label>
                                {{ form.apellidos_encargado(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-success fw-bold"><i class="fa-brands fa-whatsapp"></i> Celular</label>
                                {{ form.celular(class="form-control border-success") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">TelÃ©fono Fijo</label>
                                {{ form.telefono(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                {{ form.email(class="form-control", placeholder="tienda@correo.com") }}
                            </div>
                            <div class="col-12">
                                <label class="form-label">Giro del Negocio</label>
                                {{ form.tipo_negocio(class="form-control") }}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-logistics">
                        <h6 class="text-muted border-bottom pb-2 mb-3">UbicaciÃ³n</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Calle y NÃºmero *</label>
                                <div class="input-group">
                                    {{ form.calle(class="form-control", placeholder="Calle") }}
                                    {{ form.num_exterior(class="form-control", placeholder="#") }}
                                </div>
                            </div>
                            <div class="col-md-6"><label class="form-label">Colonia *</label>{{ form.colonia(class="form-control") }}</div>
                            <div class="col-md-4"><label class="form-label">Ciudad *</label>{{ form.ciudad(class="form-control") }}</div>
                            <div class="col-md-4"><label class="form-label">Estado</label>{{ form.estado(class="form-control", readonly=true) }}</div>
                            <div class="col-md-4"><label class="form-label">C.P.</label>{{ form.codigo_postal(class="form-control") }}</div>
                        </div>
                        <h6 class="text-muted border-bottom pb-2 mb-3">AsignaciÃ³n Operativa</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-primary">Ruta *</label>
                                {{ form.ruta_id(class="form-select border-primary") }}
                            </div>
                            <div class="col-md-4"><label class="form-label">Vendedor</label>{{ form.vendedor_id(class="form-select") }}</div>
                            <div class="col-md-4"><label class="form-label">Repartidor</label>{{ form.repartidor_id(class="form-select") }}</div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-finance">
                        <div class="row g-4 align-items-center">
                            <div class="col-12">
                                <label class="form-label fw-bold">LÃ­mite de CrÃ©dito Autorizado ($)</label>
                                {{ form.limite_credito(class="form-control form-control-lg fw-bold border-dark w-50") }}
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card bg-light border p-3 text-center">
                                    <small class="text-muted text-uppercase fw-bold">Saldo Contable (Facturado)</small>
                                    <h3 class="fw-bold text-secondary my-2">
                                        ${{ "{:,.2f}".format(cliente.saldo_actual if cliente else 0) }}
                                    </h3>
                                    <small class="text-muted"><i class="fa-solid fa-lock me-1"></i> Solo lectura</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                {% if cliente %}
                                    {% set limite = cliente.limite_credito|float %}
                                    {% set riesgo = riesgo_total|float %}
                                    <div class="card p-3 text-center text-white {% if riesgo > limite %}bg-danger{% elif riesgo > 0 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                        <small class="text-uppercase fw-bold opacity-75">Riesgo Total (Deuda + En Curso)</small>
                                        <h3 class="fw-bold my-2">${{ "{:,.2f}".format(riesgo) }}</h3>
                                        <small class="opacity-75">
                                            {% if riesgo > limite %}
                                            <i class="fa-solid fa-circle-exclamation me-1"></i> Â¡LÃMITE EXCEDIDO!
                                            {% else %}
                                            <i class="fa-solid fa-check-circle me-1"></i> CrÃ©dito Disponible: ${{ "{:,.2f}".format(limite - riesgo) }}
                                            {% endif %}
                                        </small>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">Guarda primero para ver anÃ¡lisis de riesgo.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-docs">
                        <div class="row g-3">
                            <div class="col-md-4 text-center">
                                <label class="form-label fw-bold">Fachada</label>
                                {{ form.img_fachada(class="form-control mb-2") }}
                                {% if cliente and cliente.img_fachada %}<img src="{{ url_for('static', filename=cliente.img_fachada) }}" class="img-thumbnail" style="height:150px;">{% endif %}
                            </div>
                            <div class="col-md-4 text-center">
                                <label class="form-label fw-bold">INE Frente</label>
                                {{ form.img_ine_frente(class="form-control mb-2") }}
                                {% if cliente and cliente.img_ine_frente %}<img src="{{ url_for('static', filename=cliente.img_ine_frente) }}" class="img-thumbnail" style="height:150px;">{% endif %}
                            </div>
                            <div class="col-md-4 text-center">
                                <label class="form-label fw-bold">INE Reverso</label>
                                {{ form.img_ine_reverso(class="form-control mb-2") }}
                                {% if cliente and cliente.img_ine_reverso %}<img src="{{ url_for('static', filename=cliente.img_ine_reverso) }}" class="img-thumbnail" style="height:150px;">{% endif %}
                            </div>
                        </div>
                    </div>

                    {% if cliente %}
                    <div class="tab-pane fade" id="tab-prices">
                        <div class="card bg-light border mb-3">
                            <div class="card-body">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-primary">Selecciona Producto</label>
                                        <select id="new_prod" class="form-select">
                                            {% for p in productos %}
                                                <option value="{{ p.id }}">
                                                    {{ p.descripcion }} (${{ "{:,.2f}".format(p.precio_venta_general) }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small">Tipo Descuento</label>
                                        <select id="new_rule" class="form-select">{% for t in tipos_descuento %}<option value="{{ t.id }}">{{ t.descripcion }}</option>{% endfor %}</select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small">Valor</label>
                                        <input type="number" id="new_val" class="form-control" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success w-100 fw-bold" onclick="addPrice()">
                                            <i class="fa-solid fa-plus"></i> AGREGAR
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <table class="table table-hover align-middle text-center">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-start">Producto</th>
                                    <th>Precio Lista</th>
                                    <th>Regla Aplicada</th>
                                    <th>PRECIO FINAL</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pe in cliente.precios_especiales %}
                                <tr>
                                    <td class="text-start fw-bold">{{ pe.producto.descripcion }}</td>
                                    <td class="text-muted text-decoration-line-through">${{ "{:.2f}".format(pe.producto.precio_venta_general) }}</td>
                                    <td>
                                        {% if pe.tipo_descuento.descripcion == 'PORCENTAJE' %}
                                            <span class="badge bg-warning text-dark">-{{ pe.valor_descuento }}%</span>
                                        {% else %}
                                            <span class="badge bg-primary">FIJO</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold text-success fs-5">
                                        {% if pe.tipo_descuento.descripcion == 'PORCENTAJE' %}
                                            {% set descuento = (pe.producto.precio_venta_general * pe.valor_descuento) / 100 %}
                                            ${{ "{:.2f}".format(pe.producto.precio_venta_general - descuento) }}
                                        {% else %}
                                            ${{ "{:.2f}".format(pe.valor_descuento) }}
                                        {% endif %}
                                    </td>
                                    <td class="text-end"><a href="{{ url_for('clients.del_precio', id=pe.id) }}" class="text-danger"><i class="fa-solid fa-trash"></i></a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card-footer bg-white text-end py-3">
                {{ form.submit(class="btn btn-primary fw-bold px-5") }}
            </div>
        </div>
    </form>
</div>

{% if cliente %}
<form id="fPrice" action="{{ url_for('clients.add_precio') }}" method="POST">
    <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
    <input type="hidden" name="producto_id" id="h_p">
    <input type="hidden" name="tipo_descuento_id" id="h_t">
    <input type="hidden" name="valor" id="h_v">
</form>
<script>
function addPrice() {
    document.getElementById('h_p').value = document.getElementById('new_prod').value;
    document.getElementById('h_t').value = document.getElementById('new_rule').value;
    document.getElementById('h_v').value = document.getElementById('new_val').value;
    if(document.getElementById('h_v').value) document.getElementById('fPrice').submit();
}
</script>
{% endif %}
{% endblock %}

========================= FILE: .\app\templates\clients\index.html =========================
{% extends 'base.html' %}
{% block title %}Clientes | GelMexSys{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold text-primary"><i class="fa-solid fa-users me-2"></i>Cartera de Clientes</h4>
        <a href="{{ url_for('clients.create') }}" class="btn btn-primary fw-bold shadow-sm">
            <i class="fa-solid fa-user-plus me-2"></i> NUEVO CLIENTE
        </a>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Cliente</th>
                        <th>Contacto</th>
                        <th>Ruta</th>
                        <th class="text-end">Deuda</th>
                        <th class="text-center">Estado</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in clientes %}
                    <tr>
                        <td class="ps-3 fw-bold">{{ c.nombre_negocio }}</td>
                        <td>
                            <div>{{ c.nombres_encargado }}</div>
                            <small class="text-muted">{{ c.celular or c.telefono or c.email or '-' }}</small>
                        </td>
                        <td><span class="badge bg-light text-dark border">{{ c.ruta.descripcion }}</span></td>
                        <td class="text-end fw-bold {{ 'text-danger' if c.saldo_actual > c.limite_credito else 'text-success' }}">
                            ${{ "{:,.2f}".format(c.saldo_actual) }}
                        </td>
                        <td class="text-center">
                            {% if c.saldo_actual > c.limite_credito %}
                                <i class="fa-solid fa-circle text-danger" title="CrÃ©dito Excedido"></i>
                            {% else %}
                                <i class="fa-solid fa-circle text-success" title="OK"></i>
                            {% endif %}
                        </td>
                        <td class="text-end pe-3">
                            <a href="{{ url_for('clients.edit', id=c.id) }}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-pen"></i></a>
                            <a href="{{ url_for('clients.delete', id=c.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Â¿Baja lÃ³gica?')"><i class="fa-solid fa-trash"></i></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center py-4">Sin clientes activos.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\finance\audit.html =========================
{% extends 'base.html' %}
{% block title %}AuditorÃ­a de Pagos{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold"><i class="fa-solid fa-sack-dollar text-warning me-2"></i> RecepciÃ³n de Efectivo</h4>
        <a href="{{ url_for('finance.dashboard') }}" class="btn btn-outline-dark">Volver</a>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Folio Pago</th>
                        <th>Chofer / Vendedor</th>
                        <th>Origen</th>
                        <th class="text-end">Monto</th>
                        <th class="text-center">AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    {% if not pagos %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="fa-solid fa-check-double fs-1 mb-2"></i><br>
                            Todo al dÃ­a. No hay choferes con dinero pendiente de entrega.
                        </td>
                    </tr>
                    {% else %}
                    {% for p in pagos %}
                    <tr>
                        <td class="ps-3 fw-bold text-primary">{{ p.folio_recibo }}<br>
                            <small class="text-muted fw-normal">{{ p.fecha_registro.strftime('%d/%m %H:%M') }}</small>
                        </td>
                        <td>
                            <i class="fa-solid fa-user-tie text-secondary"></i> {{ p.cobrador.nombre or 'Chofer' }}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">Orden: {{ p.orden.folio }}</span><br>
                            <small>{{ p.cliente.nombre_negocio }}</small>
                        </td>
                        <td class="text-end fs-5 fw-bold text-success">
                            ${{ "{:,.2f}".format(p.monto_pago) }}
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('finance.confirmar_ingreso') }}" method="POST" class="d-inline">
                                <input type="hidden" name="pago_id" value="{{ p.id }}">
                                <button type="submit" name="accion" value="AUDITAR" class="btn btn-success btn-sm fw-bold shadow-sm">
                                    <i class="fa-solid fa-check"></i> CONFIRMAR
                                </button>
                                <button type="submit" name="accion" value="RECHAZAR" class="btn btn-outline-danger btn-sm" title="Rechazar (Faltante)">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\finance\dashboard.html =========================
{% extends 'base.html' %}
{% block title %}Finanzas Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark m-0">Centinela Financiero</h3>
            <small class="text-muted">BitÃ¡cora Maestra de TesorerÃ­a</small>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white shadow h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75">Dinero en BÃ³veda</h6>
                    <h1 class="display-4 fw-bold mb-2">${{ "{:,.2f}".format(caja.saldo_actual) }}</h1>
                    
                    <a href="{{ url_for('finance.ingresos') }}" class="btn btn-light text-success fw-bold btn-sm mt-2 w-75 mx-auto shadow-sm">
                        <i class="fa-solid fa-circle-plus me-1"></i> REGISTRAR INGRESO
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-warning text-dark shadow h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75">Por Auditar (En Calle)</h6>
                    <h1 class="display-4 fw-bold mb-2">${{ "{:,.2f}".format(en_calle) }}</h1>
                    <a href="{{ url_for('finance.auditoria') }}" class="btn btn-dark btn-sm mt-2 w-75 mx-auto">
                        Auditar Rutas <i class="fa-solid fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-danger text-white shadow h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75">Gastos del Mes</h6>
                    <h1 class="display-4 fw-bold mb-2">${{ "{:,.2f}".format(gastos) }}</h1>
                    <a href="{{ url_for('finance.gastos') }}" class="btn btn-light text-danger fw-bold btn-sm mt-2 w-75 mx-auto shadow-sm">
                        Registrar Salida <i class="fa-solid fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-white py-3">
            <h6 class="m-0 fw-bold text-primary"><i class="fa-solid fa-list-ul me-2"></i> Ãšltimos 30 Movimientos de BÃ³veda</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary text-uppercase small">
                        <tr>
                            <th class="ps-4">Fecha / Folio</th>
                            <th>Tipo</th>
                            <th>Concepto</th>
                            <th>Usuario</th>
                            <th class="text-end">Monto</th>
                            <th class="text-center">Ticket</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if not movimientos %}
                        <tr><td colspan="6" class="text-center py-5 text-muted">AÃºn no hay movimientos registrados.</td></tr>
                        {% else %}
                        {% for mov in movimientos %}
                        <tr>
                            <td class="ps-4">
                                <span class="d-block fw-bold text-dark">{{ mov.fecha.strftime('%d/%m/%Y %H:%M') }}</span>
                                <small class="text-muted font-monospace">{{ mov.folio }}</small>
                            </td>
                            <td>
                                {% if mov.tipo == 'INGRESO' %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success">ENTRADA</span>
                                {% else %}
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">SALIDA</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="fw-bold">{{ mov.concepto }}</span>
                                {% if mov.notas %}
                                <br><small class="text-muted fst-italic">{{ mov.notas[:50] }}...</small>
                                {% endif %}
                            </td>
                            <td>
                                <i class="fa-regular fa-user-circle me-1"></i> {{ mov.usuario.nombres }}
                            </td>
                            <td class="text-end fw-bold fs-6 {{ 'text-success' if mov.tipo == 'INGRESO' else 'text-danger' }}">
                                {{ '+' if mov.tipo == 'INGRESO' else '-' }} ${{ "{:,.2f}".format(mov.monto) }}
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('finance.ver_ticket', folio=mov.folio) }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Reimprimir Ticket">
                                    <i class="fa-solid fa-print"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\finance\expenses.html =========================
{% extends 'base.html' %}
{% block title %}Control de Gastos{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold text-danger"><i class="fa-solid fa-money-bill-transfer me-2"></i> Salidas de Efectivo</h4>
        <a href="{{ url_for('finance.dashboard') }}" class="btn btn-outline-dark">Volver</a>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6 class="fw-bold mb-3 text-danger">Registrar Nuevo Gasto</h6>
                    <form action="{{ url_for('finance.registrar_gasto') }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">CategorÃ­a:</label>
                            <select name="concepto_id" class="form-select border-danger" required>
                                <option value="" selected disabled>-- Selecciona --</option>
                                {% for c in conceptos %}
                                    <option value="{{ c.id }}">{{ c.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">DescripciÃ³n / Detalle:</label>
                            <input type="text" name="detalle" class="form-control" placeholder="Ej: Gasolina Camioneta 5" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Monto ($):</label>
                            <div class="input-group">
                                <span class="input-group-text text-danger fw-bold">$</span>
                                <input type="number" step="0.01" name="monto" class="form-control form-control-lg fw-bold text-danger" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Notas Adicionales:</label>
                            <textarea name="notas" class="form-control" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold shadow-sm">
                            <i class="fa-solid fa-floppy-disk me-2"></i> REGISTRAR SALIDA
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow border-0">
                <div class="card-header bg-white fw-bold text-danger">Ãšltimos Movimientos</div>
                <div class="card-body p-0">
                    <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr class="text-muted small text-uppercase">
                                <th class="ps-3">CategorÃ­a / Detalle</th>
                                <th>Fecha</th>
                                <th class="text-end">Monto</th>
                                <th class="text-center pe-3">Ticket</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in gastos %}
                            <tr>
                                <td class="ps-3">
                                    {% if mov.gasto %}
                                        <span class="badge bg-light text-dark border mb-1">{{ mov.gasto.categoria }}</span><br>
                                        <span class="fw-bold text-dark">{{ mov.gasto.descripcion }}</span>
                                    {% else %}
                                        <span class="fw-bold text-dark">{{ mov.concepto }}</span>
                                    {% endif %}
                                </td>
                                <td class="small text-muted">{{ mov.fecha.strftime('%d/%m %H:%M') }}</td>
                                <td class="text-end fw-bold text-danger">-${{ "{:,.2f}".format(mov.monto) }}</td>
                                <td class="text-center pe-3">
                                    <a href="{{ url_for('finance.ver_ticket', folio=mov.folio) }}" target="_blank" class="btn btn-sm btn-outline-danger" title="Reimprimir Vale">
                                        <i class="fa-solid fa-print"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">Sin gastos recientes.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\finance\income.html =========================
{% extends 'base.html' %}
{% block title %}Control de Ingresos{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold text-success"><i class="fa-solid fa-sack-dollar me-2"></i> Entradas de Efectivo</h4>
        <a href="{{ url_for('finance.dashboard') }}" class="btn btn-outline-dark">Volver</a>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6 class="fw-bold mb-3 text-success">Registrar Nuevo Ingreso</h6>
                    <form action="{{ url_for('finance.registrar_ingreso_extra') }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Tipo de Ingreso:</label>
                            <select name="concepto_id" class="form-select border-success" required>
                                <option value="" selected disabled>-- Selecciona --</option>
                                {% for c in conceptos %}
                                    <option value="{{ c.id }}">{{ c.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Detalle / Referencia:</label>
                            <input type="text" name="detalle" class="form-control" placeholder="Ej: AportaciÃ³n Socio 1..." required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Monto ($):</label>
                            <div class="input-group">
                                <span class="input-group-text text-success fw-bold">$</span>
                                <input type="number" step="0.01" name="monto" class="form-control form-control-lg fw-bold text-success" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Notas Adicionales:</label>
                            <textarea name="notas" class="form-control" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100 fw-bold shadow-sm">
                            <i class="fa-solid fa-circle-plus me-2"></i> REGISTRAR INGRESO
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow border-0">
                <div class="card-header bg-white fw-bold text-success">Ãšltimos Ingresos Registrados</div>
                <div class="card-body p-0">
                    <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr class="text-muted small text-uppercase">
                                <th class="ps-3">Concepto</th>
                                <th>Fecha</th>
                                <th class="text-end">Monto</th>
                                <th class="text-center pe-3">Ticket</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in ultimos_ingresos %}
                            <tr>
                                <td class="ps-3">
                                    <span class="fw-bold text-dark d-block">{{ mov.concepto }}</span>
                                    {% if mov.notas %}
                                    <small class="text-muted fst-italic">{{ mov.notas }}</small>
                                    {% endif %}
                                </td>
                                <td class="small text-muted">{{ mov.fecha.strftime('%d/%m %H:%M') }}</td>
                                <td class="text-end fw-bold text-success">+${{ "{:,.2f}".format(mov.monto) }}</td>
                                <td class="text-center pe-3">
                                    <a href="{{ url_for('finance.ver_ticket', folio=mov.folio) }}" target="_blank" class="btn btn-sm btn-outline-success" title="Imprimir Comprobante">
                                        <i class="fa-solid fa-print"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">Sin ingresos recientes.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\finance\ticket_movement.html =========================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket {{ mov.folio }}</title>
    <style>
        body { 
            font-family: 'Courier New', Courier, monospace; 
            font-size: 12px; 
            margin: 0; 
            padding: 15px; 
            max-width: 300px; 
            background: #fff; 
            color: #000;
        }
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .fw-bold { font-weight: bold; }
        .line { border-bottom: 1px dashed #000; margin: 8px 0; }
        .mega { font-size: 16px; font-weight: bold; }
        .box { border: 1px solid #000; padding: 5px; margin: 5px 0; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body onload="window.print()">
    <div class="text-center">
        <h3 style="margin:0;">GELMEX SYS</h3>
        <p style="margin:2px 0;">TESORERIA Y FINANZAS</p>
        <div class="line"></div>
        
        <p class="fw-bold mega" style="margin:5px 0;">
            {{ 'COMPROBANTE DE INGRESO' if mov.tipo == 'INGRESO' else 'VALE DE SALIDA (GASTO)' }}
        </p>
        
        <p style="margin:0;">FOLIO: <strong>{{ mov.folio }}</strong></p>
        <p style="margin:0;">{{ mov.fecha.strftime('%d/%m/%Y %H:%M:%S') }}</p>
    </div>

    <div class="line"></div>

    <div style="margin-bottom: 10px;">
        <span class="fw-bold">CONCEPTO:</span><br>
        <span>{{ mov.concepto }}</span>
    </div>

    {% if mov.notas %}
    <div style="margin-bottom: 10px;">
        <span class="fw-bold">DETALLES / NOTAS:</span><br>
        <span style="font-style: italic;">{{ mov.notas }}</span>
    </div>
    {% endif %}

    <div class="line"></div>

    <div class="text-center">
        <p style="margin:0;">MONTO DE LA OPERACIÃ“N</p>
        <h2 class="mega" style="margin: 5px 0;">${{ "{:,.2f}".format(mov.monto) }}</h2>
    </div>

    <div class="line"></div>

    <div>
        <small>Registrado por:</small><br>
        <strong>{{ mov.usuario.nombres }}</strong>
    </div>

    {% if mov.pago_origen %}
    <div style="margin-top:5px;">
        <small>Referencia Origen:</small><br>
        Recibo Chofer: {{ mov.pago_origen.folio_recibo }}
    </div>
    {% endif %}

    <div style="margin-top: 20px; text-align: center; border-top: 1px solid #000; padding-top: 5px;">
        Firma de Conformidad
    </div>

    <div class="text-center" style="margin-top: 20px;">
        <small>Este documento es un comprobante interno de control financiero.</small>
    </div>

    <button class="no-print" onclick="window.close()" style="width:100%; padding: 10px; margin-top: 20px; cursor: pointer;">CERRAR VENTANA</button>
</body>
</html>

========================= FILE: .\app\templates\home\index.html =========================
{% extends 'base.html' %}

{% block title %}Inicio{% endblock %}

{% block page_header %}Resumen General{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-md-3">
        <div class="card card-erp p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Ventas del DÃ­a</h6>
                    <h3>$0.00</h3>
                </div>
                <div class="fs-1 text-primary opacity-25">
                    <i class="fa-solid fa-money-bill-wave"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card card-erp p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Pedidos Activos</h6>
                    <h3>5</h3>
                </div>
                <div class="fs-1 text-warning opacity-25">
                    <i class="fa-solid fa-list-check"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\inventory\catalog_list.html =========================
{% extends 'base.html' %}

{% block title %}CatÃ¡logo | GelMexSys{% endblock %}
{% block page_header %}CatÃ¡logo de Productos{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lista Maestra de Productos</h5>
        <a href="{{ url_for('inventory.create') }}" class="btn btn-warning fw-bold text-dark">
            <i class="fa-solid fa-plus me-2"></i> Nuevo Producto
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>SKU</th>
                        <th>Producto</th>
                        <th>CategorÃ­a</th>
                        <th>Costo</th>
                        <th>Precio Venta</th>
                        <th>Stock MÃ­n.</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr>
                        <td class="fw-bold">{{ p.sku }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if p.imagen_producto %}
                                    <img src="{{ url_for('static', filename=p.imagen_producto) }}" class="rounded-circle me-2" width="40" height="40">
                                {% else %}
                                    <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width:40px; height:40px;">
                                        <i class="fa-solid fa-ice-cream"></i>
                                    </div>
                                {% endif %}
                                <span>{{ p.descripcion }}</span>
                            </div>
                        </td>
                        <td><span class="badge bg-info text-dark">{{ p.categoria.nombre if p.categoria else 'N/A' }}</span></td>
                        <td>${{ "{:.2f}".format(p.precio_costo_actual) }}</td>
                        <td class="fw-bold text-success">${{ "{:.2f}".format(p.precio_venta_general) }}</td>
                        <td>{{ p.stock_minimo }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-pen"></i></button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4">No hay productos registrados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\inventory\form.html =========================
{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}
{% block page_header %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card card-erp">
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}

                    <h5 class="mb-4 text-muted border-bottom pb-2">Datos Generales</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">SKU (CÃ³digo)</label>
                            {{ form.sku(class="form-control", placeholder="Ej: PAL-LIM-AGU") }}
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">DescripciÃ³n</label>
                            {{ form.descripcion(class="form-control", placeholder="Ej: Paleta de LimÃ³n Base Agua") }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">CategorÃ­a</label>
                            {{ form.categoria_id(class="form-select") }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unidad de Medida</label>
                            {{ form.unidad_id(class="form-select") }}
                        </div>
                    </div>

                    <h5 class="mb-3 mt-4 text-muted border-bottom pb-2">Precios y Control</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-success fw-bold">Precio Venta ($)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.precio_venta(class="form-control") }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted">Costo ProducciÃ³n ($)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.precio_costo(class="form-control") }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-warning fw-bold">Stock MÃ­nimo</label>
                            {{ form.stock_minimo(class="form-control") }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Imagen del Producto</label>
                        {{ form.imagen(class="form-control") }}
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary">Cancelar</a>
                        {{ form.submit(class="btn btn-primary px-4") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\inventory\movements.html =========================
{% extends 'base.html' %}

{% block title %}Movimientos | GelMexSys{% endblock %}
{% block page_header %}OperaciÃ³n de AlmacÃ©n{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card card-erp shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="m-0"><i class="fa-solid fa-dolly me-2"></i>Entradas y Ajustes</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST">
                        
                        <div class="mb-4">
                            <label class="form-label text-muted fw-bold small">ACCIÃ“N A REALIZAR</label>
                            <select name="tipo_movimiento_id" class="form-select form-select-lg border-primary bg-light" required>
                                <option value="">-- Selecciona OperaciÃ³n --</option>
                                {% for tipo in tipos_movimiento %}
                                    <option value="{{ tipo.id }}">ðŸ”¹ {{ tipo.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted fw-bold small">PRODUCTO</label>
                            <select name="producto_id" class="form-select" required>
                                <option value="">-- Selecciona el producto --</option>
                                {% for p in productos %}
                                <option value="{{ p.id }}">{{ p.sku }} - {{ p.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small">1. ALMACÃ‰N</label>
                                <select id="selectAlmacen" name="almacen_id" class="form-select" required onchange="filtrarUbicaciones()">
                                    <option value="">-- Selecciona --</option>
                                    {% for a in almacenes %}
                                    <option value="{{ a.id }}">{{ a.descripcion }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small">2. UBICACIÃ“N EXACTA</label>
                                <select id="selectUbicacion" name="ubicacion_id" class="form-select border-primary" required disabled>
                                    <option value="">-- Primero elije AlmacÃ©n --</option>
                                    {% for u in ubicaciones %}
                                    <option value="{{ u.id }}" data-almacen="{{ u.almacen_id }}" class="opcion-ubicacion d-none">
                                        ðŸ“ {{ u.codigo }} {% if u.notas %}({{ u.notas }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-muted fw-bold small">CANTIDAD</label>
                            <input type="number" step="0.01" name="cantidad" class="form-control fw-bold text-center border-primary form-control-lg" required placeholder="0">
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-muted small">Notas / Referencia</label>
                            <textarea name="notas" class="form-control" rows="2" placeholder="Ej: Conteo fÃ­sico arranque..."></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm">
                                <i class="fa-solid fa-check-circle me-2"></i> CONFIRMAR MOVIMIENTO
                            </button>
                            <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary">Cancelar</a>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="alert alert-info shadow-sm border-0">
                <h5><i class="fa-solid fa-circle-info me-2"></i>Control de Ubicaciones</h5>
                <hr>
                <p class="small">El sistema requiere ubicaciÃ³n exacta para la trazabilidad.</p>
                <ul class="small mb-0">
                    <li>Selecciona primero el <strong>AlmacÃ©n General</strong>.</li>
                    <li>Luego selecciona el <strong>Pasillo, Rack o Nivel</strong> especÃ­fico.</li>
                    <li>Si no aparecen ubicaciones, debes darlas de alta en ConfiguraciÃ³n.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function filtrarUbicaciones() {
    const almacenSelect = document.getElementById('selectAlmacen');
    const ubicacionSelect = document.getElementById('selectUbicacion');
    const opciones = document.querySelectorAll('.opcion-ubicacion');
    const almacenId = almacenSelect.value;

    // Resetear selecciÃ³n
    ubicacionSelect.value = "";
    
    if (almacenId) {
        ubicacionSelect.disabled = false;
        let count = 0;
        opciones.forEach(op => {
            if (op.dataset.almacen === almacenId) {
                op.classList.remove('d-none');
                count++;
            } else {
                op.classList.add('d-none');
            }
        });
        
        if(count === 0) {
            ubicacionSelect.innerHTML = '<option value="">âš ï¸ Sin ubicaciones en este almacÃ©n</option>';
            ubicacionSelect.disabled = true;
        } else {
            // Restaurar la opciÃ³n por defecto si hay resultados
            const defaultOp = document.createElement('option');
            defaultOp.value = "";
            defaultOp.text = "-- Selecciona UbicaciÃ³n --";
            // Limpiamos y re-agregamos las visibles (forma sencilla de limpiar basura)
            // Ojo: el d-none funciona visualmente en navegadores modernos, 
            // pero para compatibilidad total a veces es mejor reconstruir el select.
            // Por simplicidad y rapidez usamos clases CSS aquÃ­.
        }
    } else {
        ubicacionSelect.disabled = true;
        opciones.forEach(op => op.classList.add('d-none'));
    }
}
</script>
{% endblock %}

========================= FILE: .\app\templates\logistics\collection_client.html =========================
{% extends 'base.html' %}
{% block title %}Cobranza: {{ cliente.nombre_negocio }}{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('logistics.cobranza_buscar') }}" class="btn btn-outline-secondary"><i class="fa-solid fa-arrow-left"></i> AtrÃ¡s</a>
        <div class="text-end">
            <small class="text-muted d-block">DEUDA TOTAL</small>
            <h2 class="fw-bold text-danger m-0">${{ "{:,.2f}".format(cliente.saldo_actual) }}</h2>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body d-flex align-items-center">
            <div class="bg-white p-3 rounded-circle shadow-sm me-3 text-primary">
                <i class="fa-solid fa-store fs-3"></i>
            </div>
            <div>
                <h4 class="fw-bold m-0">{{ cliente.nombre_negocio }}</h4>
                <small class="text-muted">{{ cliente.direccion }} | {{ cliente.nombre_contacto or cliente.nombres_encargado }}</small>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-secondary m-0"><i class="fa-solid fa-file-invoice-dollar me-2"></i>Notas Pendientes</h5>
        <button class="btn btn-outline-primary btn-sm fw-bold" onclick="abrirHistorial()">
            <i class="fa-solid fa-clock-rotate-left me-1"></i> HISTORIAL PAGOS
        </button>
    </div>

    {% if not ordenes %}
    <div class="alert alert-success shadow-sm">
        <i class="fa-solid fa-check-circle me-2"></i> Este cliente estÃ¡ al corriente.
    </div>
    {% else %}
    
    <div class="row">
        {% for orden in ordenes %}
        <div class="col-12 col-md-6 mb-3">
            <div class="card shadow-sm border-0 border-top border-4 border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="fw-bold mb-1">{{ orden.folio }}</h5>
                            <small class="text-muted"><i class="fa-solid fa-calendar me-1"></i> {{ orden.fecha_registro.strftime('%d/%m/%Y') }}</small>
                        </div>
                        <div class="text-end">
                             <small class="text-muted d-block" style="font-size: 0.7rem;">SALDO PENDIENTE</small>
                             <span class="fs-4 fw-bold text-dark">${{ "{:,.2f}".format(orden.saldo_pendiente or 0) }}</span>
                        </div>
                    </div>

                    <hr class="my-2 border-secondary opacity-10">

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Total Nota: ${{ "{:,.2f}".format(orden.total_venta) }}</small>
                        
                        <button class="btn btn-success fw-bold btn-sm px-3" 
                                onclick="abrirModalAbono({{ orden.id }}, '{{ orden.folio }}', {{ orden.saldo_pendiente or 0 }})">
                            <i class="fa-solid fa-money-bill-wave me-1"></i> ABONAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="modal fade" id="modalAbono" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">Abonar a Nota</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h5 class="text-center fw-bold mb-1" id="lblFolio">---</h5>
                <p class="text-center text-muted mb-4">Saldo: <span id="lblSaldo" class="fw-bold text-dark">---</span></p>

                <div class="mb-3">
                    <label class="fw-bold small">Monto a Pagar:</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light">$</span>
                        <input type="number" id="inputMonto" class="form-control fw-bold text-success" placeholder="0.00">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="fw-bold small">MÃ©todo de Pago:</label>
                    <select id="selectMetodoCobranza" class="form-select">
                        <option value="2">EFECTIVO</option>
                        <option value="3">TRANSFERENCIA</option>
                        <option value="4">TARJETA</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold small">Notas:</label>
                    <textarea id="txtNotasCobranza" class="form-control" rows="2" placeholder="Opcional..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnRegistrarPago" class="btn btn-success fw-bold w-50" onclick="confirmarAbono()">REGISTRAR PAGO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistorial" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Ãšltimos Pagos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="listaHistorial" class="list-group list-group-flush">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentOrdenId = null;

    function abrirModalAbono(id, folio, saldo) {
        currentOrdenId = id;
        document.getElementById('lblFolio').innerText = folio;
        document.getElementById('lblSaldo').innerText = '$' + saldo.toFixed(2);
        
        document.getElementById('inputMonto').value = saldo.toFixed(2); 
        document.getElementById('txtNotasCobranza').value = '';
        
        const btn = document.getElementById('btnRegistrarPago');
        btn.disabled = false;
        btn.innerText = "REGISTRAR PAGO";
        
        const modal = new bootstrap.Modal(document.getElementById('modalAbono'));
        modal.show();
    }

    async function confirmarAbono() {
        const inputMonto = document.getElementById('inputMonto');
        const btn = document.getElementById('btnRegistrarPago');
        const monto = parseFloat(inputMonto.value);

        if (!monto || monto <= 0) {
            alert("Monto invÃ¡lido.");
            return;
        }

        // BLOQUEAR BOTÃ“N
        btn.disabled = true;
        btn.innerText = "Procesando...";

        const payload = {
            orden_id: currentOrdenId,
            items: [], 
            notas: "COBRANZA: " + document.getElementById('txtNotasCobranza').value,
            pago: {
                monto: monto,
                recibido: monto,
                cambio: 0,
                tipo_id: document.getElementById('selectMetodoCobranza').value
            }
        };

        try {
            const res = await fetch("{{ url_for('logistics.confirmar_entrega') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                const modalEl = document.getElementById('modalAbono');
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if(modalInstance) modalInstance.hide();

                // ABRIR TICKET NUEVA PESTAÃ‘A
                window.open("/logistica/ticket/" + currentOrdenId, '_blank');

                // RECARGAR PAGINA
                setTimeout(() => {
                    window.location.reload();
                }, 500);

            } else {
                alert("Error: " + data.message);
                btn.disabled = false;
                btn.innerText = "REGISTRAR PAGO";
            }
        } catch(e) {
            alert("Error de conexiÃ³n.");
            console.error(e);
            btn.disabled = false;
            btn.innerText = "REGISTRAR PAGO";
        }
    }

    async function abrirHistorial() {
        const modal = new bootstrap.Modal(document.getElementById('modalHistorial'));
        modal.show();
        
        const lista = document.getElementById('listaHistorial');
        lista.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div><p>Cargando...</p></div>';

        try {
            const res = await fetch("{{ url_for('logistics.api_historial_pagos', cliente_id=cliente.id) }}");
            const pagos = await res.json();

            if(pagos.length === 0) {
                lista.innerHTML = '<div class="p-4 text-center text-muted">No hay pagos recientes.</div>';
                return;
            }

            let html = '';
            pagos.forEach(p => {
                html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold text-dark">$${p.monto.toFixed(2)}</div>
                        <small class="text-muted">${p.fecha}</small><br>
                        <small class="text-primary" style="font-size:0.75em">${p.folio}</small>
                    </div>
                    <div class="text-end">
                        <small class="d-block text-muted mb-1">Nota: ${p.orden}</small>
                        <a href="/logistica/ticket/${p.orden_id}" target="_blank" class="btn btn-sm btn-light border shadow-sm">
                            <i class="fa-solid fa-print"></i>
                        </a>
                    </div>
                </div>
                `;
            });
            lista.innerHTML = html;

        } catch(e) {
            console.error(e);
            lista.innerHTML = '<div class="p-4 text-center text-danger">Error al cargar historial.</div>';
        }
    }
</script>
{% endblock %}

========================= FILE: .\app\templates\logistics\collection_search.html =========================
{% extends 'base.html' %}
{% block title %}Cartera de Cobranza{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
            <a href="{{ url_for('logistics.index') }}" class="btn btn-outline-dark me-3"><i class="fa-solid fa-arrow-left"></i></a>
            <div>
                <h4 class="fw-bold m-0 text-danger">Cartera Vencida</h4>
                <small class="text-muted">Lista de Deudores</small>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-3">
        <div class="card-body p-2">
            <div class="input-group">
                <span class="input-group-text bg-white border-0"><i class="fa-solid fa-filter text-secondary"></i></span>
                <input type="text" id="inputFiltro" class="form-control border-0 fw-bold" 
                       placeholder="Filtrar por nombre, calle o colonia..." 
                       onkeyup="filtrarTabla()">
            </div>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="tablaCobranza">
                    <thead class="bg-light text-secondary small text-uppercase">
                        <tr>
                            <th class="ps-3" style="cursor:pointer" onclick="ordenarTabla(0)">Negocio <i class="fa-solid fa-sort ms-1"></i></th>
                            <th class="d-none d-md-table-cell">DirecciÃ³n</th>
                            <th class="text-end" style="cursor:pointer" onclick="ordenarTabla(2)">Deuda <i class="fa-solid fa-sort ms-1"></i></th>
                            <th class="text-center">AcciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyDeudores">
                        {% if not deudores %}
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">
                                <i class="fa-solid fa-check-circle fs-1 mb-3 text-success"></i><br>
                                Â¡Excelente! No hay clientes con deuda pendiente mayor a $1.
                            </td>
                        </tr>
                        {% else %}
                        {% for c in deudores %}
                        <tr class="fila-deudor">
                            <td class="ps-3 py-3">
                                <div class="fw-bold text-dark">{{ c.nombre_negocio }}</div>
                                <small class="text-muted d-md-none">{{ c.calle or '' }} {{ c.num_exterior or '' }}</small>
                                <small class="text-primary d-block" style="font-size: 0.75rem;">
                                    <i class="fa-solid fa-user"></i> {{ c.nombres_encargado or '' }} {{ c.apellidos_encargado or '' }}
                                </small>
                            </td>
                            <td class="d-none d-md-table-cell text-muted small">
                                {{ c.calle or '' }} {{ c.num_exterior or '' }}, {{ c.colonia or '' }}
                            </td>
                            <td class="text-end fw-bold text-danger fs-5">
                                ${{ "{:,.2f}".format(c.saldo_actual) }}
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('logistics.cobranza_cliente', cliente_id=c.id) }}" 
                                   class="btn btn-sm btn-outline-danger fw-bold shadow-sm">
                                    <i class="fa-solid fa-hand-holding-dollar"></i> VER
                                </a>
                            </td>
                            <td style="display:none;">{{ c.colonia }} {{ c.calle }} {{ c.nombres_encargado }} {{ c.apellidos_encargado }}</td> 
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-3 text-muted small">
        Mostrando clientes con Saldo Pendiente.
    </div>
</div>

<script>
    // 1. FILTRADO EN VIVO (CLIENT SIDE)
    function filtrarTabla() {
        const input = document.getElementById("inputFiltro");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("tablaCobranza");
        const tr = table.getElementsByTagName("tr");

        // Empezamos en 1 para no ocultar el encabezado
        for (let i = 1; i < tr.length; i++) {
            const rowContent = tr[i].textContent || tr[i].innerText;
            if (rowContent.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }

    // 2. ORDENAMIENTO DE COLUMNAS
    function ordenarTabla(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("tablaCobranza");
        switching = true;
        dir = "asc"; 
        
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                
                let xVal = x.innerText.toLowerCase();
                let yVal = y.innerText.toLowerCase();
                
                // Si es la columna de dinero (Ã­ndice 2), limpiar sÃ­mbolos para ordenar numÃ©ricamente
                if(n === 2) {
                    xVal = parseFloat(xVal.replace(/[^0-9.-]+/g,""));
                    yVal = parseFloat(yVal.replace(/[^0-9.-]+/g,""));
                }

                if (dir == "asc") {
                    if (xVal > yVal) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xVal < yVal) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;      
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }
</script>
{% endblock %}

========================= FILE: .\app\templates\logistics\delivery_handover.html =========================
{% extends 'base.html' %}
{% block title %}Entrega {{ orden.folio }}{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    
    <div class="card bg-dark text-white shadow mb-3 border-0">
        <div class="card-body d-flex justify-content-between align-items-center py-2">
            <div>
                <small class="opacity-75 text-uppercase fw-bold">Total a Bajar</small>
                <div class="fs-3 fw-bold text-warning"><i class="fa-solid fa-dolly me-2"></i>{{ total_piezas|int }} Piezas</div>
            </div>
            <div class="text-end">
                <small class="opacity-75">Orden</small>
                <div class="fw-bold">{{ orden.folio }}</div>
            </div>
        </div>
    </div>

    {% if saldo_global_previo > 0 %}
    <div class="alert alert-danger shadow-sm d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="fw-bold"><i class="fa-solid fa-circle-exclamation me-2"></i>TIENE DEUDA VIEJA</span>
        </div>
        <div class="fw-bold fs-5">${{ "{:,.2f}".format(saldo_global_previo) }}</div>
    </div>
    {% endif %}

    <div class="card shadow-sm border-0 mb-3">
        <div class="card-body bg-light border-start border-primary border-5">
            <h5 class="fw-bold m-0 text-primary">{{ orden.cliente.nombre_negocio }}</h5>
            <div class="d-flex justify-content-between mt-2">
                <span class="badge bg-white text-dark border">{{ orden.metodo_pago_esperado }}</span>
                <span class="fs-4 fw-bold text-dark" id="displayTotal">${{ "{:,.2f}".format(orden.total_venta) }}</span>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white fw-bold">ðŸ“¦ Confirmar Productos</div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0 align-middle">
                <thead>
                    <tr class="small text-muted text-uppercase">
                        <th class="ps-3">Item</th>
                        <th class="text-center" width="90">Bajar</th>
                        <th class="text-center" width="50"><i class="fa-solid fa-check"></i></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr data-id="{{ item.detalle_id }}" data-precio="{{ item.precio }}">
                        <td class="ps-3">
                            <div class="fw-bold text-truncate" style="max-width: 180px;">{{ item.producto }}</div>
                            <small class="text-muted">Traes: <strong>{{ item.surtida|int }}</strong></small>
                        </td>
                        <td class="p-2">
                            <input type="number" 
                                   class="form-control text-center fw-bold input-qty"
                                   value="{{ item.sugerida|int }}" 
                                   min="0" max="{{ item.surtida|int }}"
                                   oninput="validarMaximo(this); calcularTotal();">
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input border-2 border-dark item-check" 
                                   style="width: 25px; height: 25px;"
                                   onchange="validarFormulario()">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white fw-bold">ðŸ’° Pago Contra-Entrega</div>
        <div class="card-body">
            
            <label class="small text-muted fw-bold mb-1">Monto a Cobrar:</label>
            <div class="input-group mb-3">
                <span class="input-group-text bg-light">$</span>
                <input type="number" id="inputAbono" class="form-control form-control-lg fw-bold text-success" 
                       value="{% if orden.metodo_pago_esperado == 'Contado' %}{{ orden.total_venta }}{% endif %}"
                       placeholder="0.00" oninput="calcularCambio()">
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small text-muted fw-bold mb-1">Recibido:</label>
                    <input type="number" id="inputRecibido" class="form-control" placeholder="$$$" oninput="calcularCambio()">
                </div>
                <div class="col-6">
                    <label class="small text-muted fw-bold mb-1">Cambio:</label>
                    <input type="text" id="displayCambio" class="form-control bg-light fw-bold text-secondary" readonly value="$0.00">
                </div>
            </div>

            <div class="mb-3">
                <label class="small text-muted fw-bold mb-1">MÃ©todo de Pago:</label>
                <select id="selectMetodo" class="form-select fw-bold text-dark">
                    {% for metodo in metodos_pago %}
                        <option value="{{ metodo.id }}">{{ metodo.descripcion|replace('_', ' ') }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-2">
                <label class="small text-muted fw-bold mb-1">Notas (Min 15 letras):</label>
                <textarea id="inputNotas" class="form-control" rows="2" 
                          placeholder="Ej: Entrega completa, pagado..." 
                          oninput="validarFormulario()"></textarea>
                <div class="text-end"><small id="charCount" class="text-danger fw-bold">0/15</small></div>
            </div>
        </div>
    </div>

    <div class="d-grid pb-5">
        <button id="btnFinalizar" onclick="enviarEntrega()" class="btn btn-secondary btn-lg py-3 fw-bold shadow" disabled>
            <i class="fa-solid fa-lock me-2"></i> COMPLETAR CHECKS Y NOTAS
        </button>
    </div>

</div>

<script>
    function validarMaximo(input) {
        if(parseInt(input.value) > parseInt(input.max)) input.value = input.max;
        if(parseInt(input.value) < 0) input.value = 0;
    }

    function calcularTotal() {
        let nuevoTotal = 0;
        document.querySelectorAll('.input-qty').forEach(input => {
            const row = input.closest('tr');
            nuevoTotal += (parseFloat(row.dataset.precio) * (parseFloat(input.value) || 0));
        });
        document.getElementById('displayTotal').innerText = '$' + nuevoTotal.toFixed(2);
    }

    function calcularCambio() {
        const abono = parseFloat(document.getElementById('inputAbono').value) || 0;
        const recibido = parseFloat(document.getElementById('inputRecibido').value) || 0;
        const cambio = recibido - abono;
        
        const elCambio = document.getElementById('displayCambio');
        if (cambio < 0) {
            elCambio.value = "FALTA: $" + Math.abs(cambio).toFixed(2);
            elCambio.classList.add('text-danger');
        } else {
            elCambio.value = '$' + cambio.toFixed(2);
            elCambio.classList.remove('text-danger');
        }
    }

    function validarFormulario() {
        const notas = document.getElementById('inputNotas').value.trim();
        const checks = document.querySelectorAll('.item-check');
        let checksOk = true;
        checks.forEach(c => { if(!c.checked) checksOk = false; });

        document.getElementById('charCount').innerText = notas.length + "/15";
        document.getElementById('charCount').className = notas.length >= 15 ? 'text-success fw-bold' : 'text-danger fw-bold';

        const btn = document.getElementById('btnFinalizar');
        if (checksOk && notas.length >= 15) {
            btn.disabled = false;
            btn.classList.replace('btn-secondary', 'btn-success');
            btn.innerHTML = '<i class="fa-solid fa-print me-2"></i> TERMINAR E IMPRIMIR';
        } else {
            btn.disabled = true;
            btn.classList.replace('btn-success', 'btn-secondary');
            btn.innerHTML = '<i class="fa-solid fa-lock me-2"></i> COMPLETAR CHECKS Y NOTAS';
        }
    }

    async function enviarEntrega() {
        if (!confirm("Â¿Cerrar entrega y generar ticket?")) return;

        const items = [];
        document.querySelectorAll('.input-qty').forEach(input => {
            items.push({
                detalle_id: input.closest('tr').dataset.id,
                cant_real: input.value
            });
        });

        const abono = document.getElementById('inputAbono').value;
        const recibido = document.getElementById('inputRecibido').value;
        const cambioVal = document.getElementById('displayCambio').value.replace('$','').replace('FALTA: ','-');

        const payload = {
            orden_id: {{ orden.id }},
            items: items,
            notas: document.getElementById('inputNotas').value,
            pago: {
                monto: abono || 0,
                recibido: recibido || 0,
                cambio: parseFloat(cambioVal) || 0,
                tipo_id: document.getElementById('selectMetodo').value
            }
        };

        try {
            const res = await fetch("{{ url_for('logistics.confirmar_entrega') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                window.location.href = "/logistica/ticket/" + data.orden_id;
            } else {
                alert("âŒ ERROR: " + data.message);
            }
        } catch (e) {
            alert("Error de conexiÃ³n");
        }
    }
</script>
{% endblock %}

========================= FILE: .\app\templates\logistics\route_dashboard.html =========================
{% extends 'base.html' %}
{% block title %}Mi Ruta | GelMexSys{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-primary m-0"><i class="fa-solid fa-truck-fast me-2"></i>Mi Ruta</h4>
            <small class="text-muted">{{ ordenes|length }} entregas pendientes</small>
        </div>
        
        <a href="{{ url_for('logistics.cobranza_buscar') }}" class="btn btn-dark shadow-sm fw-bold">
            <i class="fa-solid fa-hand-holding-dollar me-2"></i> COBRANZA
        </a>
    </div>

    {% if not ordenes %}
    <div class="alert alert-success shadow-sm mb-5 border-0 border-start border-5 border-success">
        <i class="fa-solid fa-check-circle me-2"></i> Â¡Excelente! No tienes entregas pendientes en tu ruta.
    </div>
    {% endif %}

    <div class="row mb-5">
        {% for orden in ordenes %}
        <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card shadow-sm border-0 h-100 {% if orden.estado == 'EN_RUTA' %}border-start border-primary border-5{% else %}border-start border-warning border-5{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="fw-bold m-0 text-truncate">{{ orden.cliente.nombre_negocio }}</h5>
                        <span class="badge {% if orden.estado == 'EN_RUTA' %}bg-primary{% else %}bg-warning text-dark{% endif %}">
                            {{ orden.estado }}
                        </span>
                    </div>
                    <p class="text-muted small mb-1"><i class="fa-solid fa-map-marker-alt me-1"></i> {{ orden.cliente.direccion or 'Sin direcciÃ³n' }}</p>
                    <p class="text-muted small mb-2"><i class="fa-solid fa-barcode me-1"></i> {{ orden.folio }}</p>
                    
                    <div class="d-flex justify-content-between bg-light rounded p-2 mb-3">
                        <div class="text-center px-2">
                            <small class="d-block text-muted" style="font-size: 0.7rem;">TOTAL</small>
                            <span class="fw-bold">${{ "{:,.2f}".format(orden.total_venta) }}</span>
                        </div>
                        <div class="text-center px-2 border-start">
                            <small class="d-block text-muted" style="font-size: 0.7rem;">PAGO</small>
                            <span class="fw-bold">{{ orden.metodo_pago_esperado }}</span>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        {% if orden.estado == 'LISTO_RUTA' %}
                        <a href="{{ url_for('logistics.cargar_orden', orden_id=orden.id) }}" class="btn btn-secondary fw-bold">
                            <i class="fa-solid fa-dolly me-2"></i> SUBIR AL CAMIÃ“N
                        </a>
                        {% else %}
                        <a href="{{ url_for('logistics.entrega_cliente', orden_id=orden.id) }}" class="btn btn-primary fw-bold py-2">
                            <i class="fa-solid fa-box-open me-2"></i> REALIZAR ENTREGA
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if terminadas %}
    <h5 class="fw-bold text-secondary mb-3 border-top pt-4"><i class="fa-solid fa-clock-rotate-left me-2"></i>Historial de Hoy (Reimprimir Tickets)</h5>
    <div class="row">
        {% for orden in terminadas %}
        <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card shadow-sm border-0 h-100 bg-light">
                <div class="card-body d-flex justify-content-between align-items-center p-3">
                    <div style="max-width: 60%;">
                        <h6 class="fw-bold m-0 text-dark text-truncate">{{ orden.cliente.nombre_negocio }}</h6>
                        <small class="text-muted">{{ orden.folio }}</small>
                    </div>
                    
                    <div class="text-end">
                        <div class="mb-1">
                            {% if orden.estado == 'PAGADO' %}
                                <span class="badge bg-success"><i class="fa-solid fa-check"></i> PAGADO</span>
                            {% else %}
                                <span class="badge bg-info text-dark"><i class="fa-solid fa-clock"></i> CRÃ‰DITO</span>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('logistics.ver_ticket', orden_id=orden.id) }}" class="btn btn-outline-dark btn-sm fw-bold">
                            <i class="fa-solid fa-print"></i> TICKET
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

</div>
{% endblock %}

========================= FILE: .\app\templates\logistics\ticket.html =========================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket #{{ orden.folio }}</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; font-size: 12px; margin: 0; padding: 10px; max-width: 300px; background: #fff; }
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .text-start { text-align: left; }
        .fw-bold { font-weight: bold; }
        .line { border-bottom: 1px dashed #000; margin: 5px 0; }
        .big { font-size: 14px; }
        .mega { font-size: 18px; font-weight: bold; }
        .table { width: 100%; border-collapse: collapse; }
        .table td { vertical-align: top; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body onload="window.print()">
    <div class="text-center">
        <h3 class="margin:0;">GELMEX SYS</h3>
        <p>Nota de RemisiÃ³n</p>
        <p class="fw-bold">{{ orden.folio }}</p>
        <p>{{ orden.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</p>
    </div>
    
    <div class="line"></div>
    
    <div>
        <strong>Cliente:</strong> {{ orden.cliente.nombre_negocio }}<br>
        <small>{{ orden.cliente.direccion }}</small>
    </div>

    <div class="line"></div>

    <table class="table">
        <thead>
            <tr>
                <th class="text-start">Cant</th>
                <th class="text-start">Prod</th>
                <th class="text-end">$$</th>
            </tr>
        </thead>
        <tbody>
            {% for item in orden.items %}
            {% if item.cantidad_entregada > 0 %}
            <tr>
                <td>{{ item.cantidad_entregada|int }}</td>
                <td>{{ item.producto.descripcion[:15] }}</td>
                <td class="text-end">${{ "{:,.0f}".format(item.subtotal) }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div class="line"></div>

    <table style="width: 100%;">
        <tr>
            <td class="text-end fw-bold big">TOTAL NOTA:</td>
            <td class="text-end fw-bold big">${{ "{:,.2f}".format(orden.total_venta) }}</td>
        </tr>
    </table>

    <div class="line"></div>

    <div class="text-start mb-2">
        <small class="fw-bold">HISTORIAL DE ABONOS:</small>
        <table class="table table-sm mt-1" style="font-size: 11px;">
            {% for p in pagos %}
            <tr>
                <td>{{ p.fecha_registro.strftime('%d/%m') }}</td>
                <td>{{ p.folio_recibo[-4:] }}</td> 
                <td class="text-end fw-bold">${{ "{:,.2f}".format(p.monto_pago) }}</td>
            </tr>
            {% endfor %}
            {% if not pagos %}
            <tr><td colspan="3" class="text-muted text-center">- Sin abonos -</td></tr>
            {% endif %}
        </table>
    </div>
    
    <div class="line"></div>

    <div class="text-center mt-2">
        {% if orden.estado == 'PAGADO' or orden.estado == 'SINAUDITARPAGO' %}
            <span class="mega">*** PAGADO ***</span>
            <p class="small">SALDO: $0.00</p>
        {% else %}
            <span class="mega">*** RESTAN ***</span>
            <p class="fw-bold big">SALDO PENDIENTE: ${{ "{:,.2f}".format(orden.saldo_pendiente or 0) }}</p>
        {% endif %}
    </div>

    <div class="line"></div>
    <div class="text-center">
        <p>Â¡Gracias por su compra!</p>
        <small>Este comprobante es informativo.</small>
    </div>

    <button class="no-print" onclick="window.close()" style="width:100%; padding: 10px; margin-top: 20px; font-size: 16px;">CERRAR</button>
</body>
</html>

========================= FILE: .\app\templates\production\dashboard.html =========================
{% extends 'base.html' %}

{% block title %}Tablero de Necesidades | GelMexSys{% endblock %}
{% block page_header %}ProgramaciÃ³n de ProducciÃ³n{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-bold"><i class="fa-solid fa-chart-line me-2"></i>ANALIZADOR DE DEMANDA (JIT)</h5>
            <span class="badge bg-secondary">Actualizado: {{ now.strftime('%H:%M') }}</span>
        </div>
        
        <div class="card-body bg-light border-bottom">
            <div class="row text-center">
                <div class="col-md-4">
                    <small class="text-uppercase text-muted fw-bold">Salud del Inventario</small>
                    <div class="h4 mt-1 fw-bold text-{{ clase_sys }}">
                        {% if clase_sys == 'success' %}<i class="fa-solid fa-check-circle me-1"></i>{% endif %}
                        {% if clase_sys == 'danger' %}<i class="fa-solid fa-triangle-exclamation me-1"></i>{% endif %}
                        {{ estado_sys }}
                    </div>
                </div>
                <div class="col-md-4 border-start border-end">
                    <small class="text-uppercase text-muted fw-bold">Ã“rdenes en FÃ¡brica</small>
                    <div class="h4 mt-1 fw-bold text-primary">
                        {{ total_ordenes }} Activas
                    </div>
                </div>
                <div class="col-md-4">
                    <small class="text-uppercase text-muted fw-bold">AcciÃ³n Sugerida</small>
                    <div class="h4 mt-1 fw-bold text-dark">{{ accion_sys }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-erp shadow-lg border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light small text-uppercase text-secondary text-center">
                    <tr>
                        <th class="text-start ps-4">Producto</th>
                        <th>Existencia<br>FÃ­sica</th>
                        <th class="text-danger bg-danger bg-opacity-10">Ventas<br>Pendientes</th>
                        <th class="text-primary bg-primary bg-opacity-10">Disponible<br>Real</th>
                        <th>En<br>FÃ¡brica</th>
                        <th class="d-none d-lg-table-cell">Meta</th>
                        <th class="bg-warning bg-opacity-25 text-dark" style="width: 150px;">A Fabricar</th>
                        <th>AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr class="text-center">
                        <td class="text-start ps-4">
                            <strong class="d-block text-dark">{{ item.descripcion }}</strong>
                            <small class="text-muted">{{ item.sku }}</small>
                        </td>

                        <td><span class="fw-bold">{{ item.existencia | int }}</span></td>
                        
                        <td class="bg-danger bg-opacity-10 text-danger fw-bold">
                            {% if item.comprometido > 0 %}
                                -{{ item.comprometido | int }}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td class="bg-primary bg-opacity-10 text-primary fw-bold fs-5">
                            {{ item.disponible | int }}
                        </td>

                        <td>
                            {% if item.en_proceso > 0 %}
                                <span class="badge bg-info text-dark border border-info">
                                    <i class="fa-solid fa-spinner fa-spin me-1"></i> {{ item.en_proceso | int }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>

                        <td class="d-none d-lg-table-cell text-muted">{{ item.meta | int }}</td>
                        
                        <td class="bg-warning bg-opacity-25 py-3">
                            <form action="{{ url_for('production.crear_orden') }}" method="POST">
                                <input type="hidden" name="producto_id" value="{{ item.id }}">
                                
                                {% if item.estado == 'SURTIDO' or item.estado == 'EN CAMINO' %}
                                    <span class="badge rounded-pill bg-{{ item.clase_estado }} px-3 py-2 shadow-sm">
                                        {{ item.estado }}
                                    </span>
                                {% else %}
                                    <div class="input-group input-group-sm justify-content-center">
                                        <input type="number" name="cantidad" class="form-control text-center fw-bold border-warning" 
                                               value="{{ item.a_fabricar | int }}" min="1" style="max-width: 70px;">
                                        <button type="submit" class="btn btn-warning fw-bold shadow-sm" title="Enviar a ProducciÃ³n">
                                            <i class="fa-solid fa-paper-plane"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </form>
                        </td>
                        
                        <td>
                            {% if item.disponible <= 0 %}
                                <i class="fa-solid fa-circle-exclamation text-danger fs-5" title="Sin stock libre"></i>
                            {% elif item.a_fabricar > 0 %}
                                <i class="fa-solid fa-triangle-exclamation text-warning fs-5" title="Bajo stock"></i>
                            {% else %}
                                <i class="fa-solid fa-circle-check text-success fs-5" title="OK"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

========================= FILE: .\app\templates\production\orders_list.html =========================
{% extends 'base.html' %}

{% block title %}Cocina | GelMexSys{% endblock %}
{% block page_header %}Consola del Maestro Heladero{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if ordenes %}
    <div class="row">
        {% for orden in ordenes %}
        <div class="col-12 col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm border-0 {% if orden.estatus == 'BATIENDO' %}border-start border-5 border-warning{% endif %}">
                
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <span class="badge bg-light text-dark border">{{ orden.folio }}</span>
                    <small class="text-muted"><i class="fa-regular fa-clock me-1"></i> {{ orden.fecha_solicitud.strftime('%H:%M') }}</small>
                </div>

                <div class="card-body text-center">
                    <h5 class="card-title fw-bold text-dark mb-1">{{ orden.producto.descripcion }}</h5>
                    <p class="text-muted small mb-3">{{ orden.producto.sku }}</p>
                    
                    <div class="row mb-3">
                        <div class="col-6 border-end">
                            <small class="text-muted d-block text-uppercase">Solicitado</small>
                            <span class="h4 fw-bold text-primary">{{ orden.cantidad | int }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block text-uppercase">Real Producido</small>
                            {% if orden.cantidad_producida_real > 0 %}
                                <span class="h4 fw-bold text-success">{{ orden.cantidad_producida_real | int }}</span>
                            {% else %}
                                <span class="h4 text-muted">--</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if orden.estatus == 'SOLICITADA' %}
                        <div class="alert alert-secondary py-2 small">
                            <i class="fa-solid fa-hourglass-start me-1"></i> Esperando turno
                        </div>
                    {% elif orden.estatus == 'BATIENDO' %}
                        <div class="alert alert-warning py-2 small fw-bold text-dark">
                            <i class="fa-solid fa-fire-burner fa-fade me-1"></i> EN PRODUCCIÃ“N
                        </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-white p-3">
                    <div class="d-grid gap-2">
                        {% if orden.estatus == 'SOLICITADA' %}
                            <a href="{{ url_for('production.cambiar_estatus', orden_id=orden.id, nuevo_estatus='BATIENDO') }}" 
                               class="btn btn-primary btn-lg shadow-sm">
                                <i class="fa-solid fa-fire-burner"></i> INICIAR LOTE
                            </a>
                        {% elif orden.estatus == 'BATIENDO' %}
                            <button type="button" class="btn btn-success btn-lg shadow fw-bold" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalCierre{{ orden.id }}">
                                <i class="fa-solid fa-truck-ramp-box"></i> ENVIAR A ALMACÃ‰N
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalCierre{{ orden.id }}" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Cierre de Lote: {{ orden.folio }}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form action="{{ url_for('production.reportar_produccion_real') }}" method="POST">
                            <div class="modal-body">
                                <input type="hidden" name="orden_id" value="{{ orden.id }}">
                                
                                <div class="mb-3 text-center">
                                    <label class="form-label text-muted">Cantidad Solicitada</label>
                                    <div class="h3">{{ orden.cantidad | int }}</div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold text-dark">Â¿CuÃ¡nto saliÃ³ REALMENTE del lote?</label>
                                    <input type="number" name="cantidad_real" class="form-control form-control-lg text-center fw-bold border-success" 
                                           value="{{ orden.cantidad | int }}" min="1" required>
                                    <div class="form-text">Si saliÃ³ mÃ¡s o menos, ajÃºstalo aquÃ­. Esto es lo que recibirÃ¡ el almacenista.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Notas / Incidencias (Opcional)</label>
                                    <textarea name="notas" class="form-control" rows="2" placeholder="Ej: Se tirÃ³ un poco de mezcla..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success fw-bold">Confirmar Entrega</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <h3 class="text-muted">Sin Ã“rdenes Activas</h3>
        <p class="text-muted">Todo limpio por aquÃ­.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

========================= FILE: .\app\templates\reception\reception_dock.html =========================
{% extends 'base.html' %}

{% block title %}RecepciÃ³n | GelMexSys{% endblock %}
{% block page_header %}Muelle de RecepciÃ³n{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-dark text-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fa-solid fa-dolly me-2"></i>Lotes Pendientes</h5>
            <span class="badge bg-warning text-dark">{{ lotes|length }} Lotes</span>
        </div>
        
        <div class="card-body bg-light">
            {% if lotes %}
            <div class="row">
                {% for lote in lotes %}
                {% set recibido = lote.cantidad_recibida_almacen or 0 %}
                {% set total = lote.cantidad_producida_real %}
                {% set pendiente = total - recibido %}
                {% set porcentaje = (recibido / total * 100) | int %}
                {% if porcentaje > 100 %}{% set porcentaje = 100 %}{% endif %}
                
                <div class="col-12 col-xl-6 mb-3">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-primary">{{ lote.folio }}</span>
                                <small class="text-muted">{{ lote.fecha_termino.strftime('%d/%m %H:%M') if lote.fecha_termino else 'Hoy' }}</small>
                            </div>
                            <h5 class="fw-bold text-dark mb-0">{{ lote.producto.descripcion }}</h5>
                            
                            <div class="mt-3 p-3 bg-white rounded border">
                                <div class="d-flex justify-content-between small fw-bold">
                                    <span>Progreso: {{ recibido|int }} / {{ total|int }}</span>
                                    {% if pendiente < 0 %}
                                        <span class="text-success fw-bold">Â¡Excedente: {{ pendiente|abs|int }}!</span>
                                    {% else %}
                                        <span class="text-danger">Faltan: {{ pendiente|int }}</span>
                                    {% endif %}
                                </div>
                                <div class="progress mt-2" style="height: 10px;">
                                    <div class="progress-bar {% if porcentaje < 100 %}bg-warning{% else %}bg-success{% endif %}" style="width: {{ porcentaje }}%"></div>
                                </div>
                            </div>

                            <button class="btn btn-primary w-100 fw-bold mt-3" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modal{{ lote.id }}">
                                <i class="fa-solid fa-dolly-flatbed me-2"></i> ACOMODAR
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="modal{{ lote.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Acomodar Lote</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <form action="{{ url_for('reception.confirmar') }}" method="POST">
                                <div class="modal-body">
                                    <input type="hidden" name="orden_id" value="{{ lote.id }}">
                                    
                                    <div class="alert alert-info text-center py-2">
                                        Pendientes TeÃ³ricos: <strong>{{ pendiente|int }}</strong>
                                    </div>

                                    <div class="mb-3">
                                        <label class="fw-bold">Cantidad a ingresar (STOCK BUENO):</label>
                                        <input type="number" name="cantidad_ingresar" class="form-control text-center fw-bold border-success text-dark" 
                                               style="font-size: 1.5rem;"
                                               value="{{ pendiente if pendiente > 0 else 0 }}" min="0" step="0.01" required>
                                        <div class="form-text text-muted small">
                                            Escribe la cantidad fÃ­sica real. Si hay de mÃ¡s, ponlo. Si es merma, pon 0 y marca cierre forzado.
                                        </div>
                                    </div>

                                    <div class="mb-3 bg-light p-3 rounded border">
                                        <label class="fw-bold text-primary mb-2">PASO 1: Selecciona AlmacÃ©n</label>
                                        <select class="form-select select-almacen text-dark" data-target="ubicacion{{ lote.id }}" required>
                                            <option value="" selected disabled>-- Elegir AlmacÃ©n --</option>
                                            {% for a in almacenes %}
                                                <option value="{{ a.id }}">{{ a.descripcion }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="mb-3 bg-light p-3 rounded border">
                                        <label class="fw-bold text-primary mb-2">PASO 2: UbicaciÃ³n Exacta</label>
                                        <select name="ubicacion_id" id="ubicacion{{ lote.id }}" class="form-select text-dark" disabled required>
                                            <option value="" selected disabled>-- Esperando AlmacÃ©n --</option>
                                            {% for u in ubicaciones %}
                                                <option value="{{ u.id }}" data-almacen="{{ u.almacen_id }}">
                                                    {{ u.codigo }} {% if u.notas %}({{ u.notas }}){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="fw-bold">Notas / Observaciones</label>
                                        <textarea name="notas" class="form-control text-dark" rows="2" placeholder="Ej: Sobrante de producciÃ³n / Merma por caÃ­da..."></textarea>
                                    </div>

                                    <div class="alert alert-danger mt-4 d-flex align-items-start">
                                        <div class="form-check me-2">
                                            <input class="form-check-input border-danger" type="checkbox" name="forzar_cierre" id="check{{ lote.id }}" style="transform: scale(1.3);">
                                        </div>
                                        <div>
                                            <label class="form-check-label fw-bold text-danger" for="check{{ lote.id }}">
                                                ðŸ›‘ YA NO VA A LLEGAR MÃS (Cerrar Orden)
                                            </label>
                                            <div class="small text-danger mt-1">
                                                Marca esto si terminaste de acomodar y sobrÃ³ o faltÃ³ producto.
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-success fw-bold">GUARDAR</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5 text-muted"><h4>No hay lotes por recibir</h4></div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const selectsAlmacen = document.querySelectorAll('.select-almacen');
    
    selectsAlmacen.forEach(select => {
        select.addEventListener('change', function() {
            const almacenId = this.value;
            const targetId = this.getAttribute('data-target');
            const selectUbicacion = document.getElementById(targetId);
            
            selectUbicacion.value = "";
            selectUbicacion.disabled = false;
            
            const opciones = selectUbicacion.querySelectorAll('option');
            let contador = 0;
            
            opciones.forEach(opt => {
                if (opt.value === "") return; 
                if (String(opt.getAttribute('data-almacen')) === String(almacenId)) {
                    opt.style.display = "block";
                    contador++;
                } else {
                    opt.style.display = "none";
                }
            });
            
            if (contador === 0) {
                selectUbicacion.options[0].text = "âš ï¸ No hay ubicaciones aquÃ­";
                selectUbicacion.disabled = true;
            } else {
                selectUbicacion.options[0].text = "-- Selecciona UbicaciÃ³n --";
            }
        });
    });
});
</script>
{% endblock %}

========================= FILE: .\app\templates\sales\console.html =========================
{% extends 'base.html' %}

{% block title %}Venta en Campo | GelMexSys{% endblock %}

{% block content %}
<style>
    /* 1. RESET Y CAPAS */
    .card, .card-body, .row, [class^="col-"] {
        overflow: visible !important;
        position: relative;
    }

    /* 2. BUSCADORES FLOTANTES */
    .lista-sugerencias {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 100000 !important;
        background: #ffffff;
        border: 2px solid #0d47a1;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        border-radius: 0 0 12px 12px;
        margin-top: 2px;
    }

    .item-sugerencia {
        padding: 14px 18px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white !important;
        color: #333 !important;
    }

    .item-sugerencia:hover {
        background-color: #e3f2fd !important;
    }

    /* 3. DISEÃ‘O DE TOTALES Y ALINEACIÃ“N */
    .total-display { 
        font-size: 2.3rem; 
        font-weight: 900; 
        color: #0d47a1; 
    }
    
    .label-finanzas {
        font-size: 0.85rem;
        font-weight: bold;
    }

    .espaciador-footer { height: 130px; }
</style>

<div class="container-fluid pb-5">
    <div class="card card-erp mb-3 border-0 shadow-sm" style="z-index: 1001;">
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-12 col-md-5 position-relative" id="wrapperCliente">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">1. Buscar Cliente</label>
                    <input type="text" class="form-control form-control-lg border-primary shadow-sm" 
                           id="inputBusquedaCliente" placeholder="Nombre o negocio..." autocomplete="off">
                    <div id="listaSugerenciasCliente" class="lista-sugerencias"></div>
                    
                    <div id="resumenCliente" class="mt-2 d-none">
                        <div class="badge bg-primary d-block text-start p-2 mb-1">
                            Venta a: <span id="labelCliente"></span>
                        </div>
                        <div class="row g-1 text-center">
                            <div class="col-4 border-end">
                                <small class="text-muted d-block small-label">LÃMITE</small>
                                <span id="valLimite" class="fw-bold">$0.00</span>
                            </div>
                            <div class="col-4 border-end">
                                <small class="text-muted d-block small-label text-danger">DEBE</small>
                                <span id="valDebe" class="fw-bold text-danger">$0.00</span>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block small-label text-success">DISPONIBLE</small>
                                <span id="valDisponible" class="fw-bold text-success">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-md-4">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="small fw-bold text-muted mb-1 text-uppercase">2. MÃ©todo de Pago</label>
                            <select id="metodoPago" class="form-select form-select-lg border-primary fw-bold" onchange="renderCarrito()">
                                <option value="Credito" selected>CRÃ‰DITO</option>
                                <option value="Contado">CONTADO (EFECTIVO)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                <input type="text" id="inputNotas" class="form-control" placeholder="Nota">
                                <label for="inputNotas" class="text-muted small"><i class="fa-solid fa-pen-nib me-1"></i>Motivo / Condiciones (MÃ­n. 15 letras)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-3 text-end border-md-start d-flex flex-column justify-content-center">
                    <label class="small fw-bold text-muted d-block text-uppercase">Total de esta Nota</label>
                    <div class="total-display" id="granTotal">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-erp mb-4 shadow-sm" style="z-index: 1000;">
        <div class="card-body p-3">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-7 position-relative" id="wrapperProducto">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">3. Agregar Producto</label>
                    <input type="text" class="form-control form-control-lg border-primary shadow-sm" 
                           id="inputBusquedaProd" placeholder="Escribe nombre o SKU..." autocomplete="off">
                    <div id="listaSugerenciasProd" class="lista-sugerencias"></div>
                </div>
                <div class="col-6 col-md-2">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">Cant.</label>
                    <input type="number" id="inputCant" class="form-control form-control-lg text-center fw-bold" value="1" min="1">
                </div>
                <div class="col-6 col-md-3 d-grid">
                    <button onclick="agregarAlCarrito()" class="btn btn-primary btn-lg fw-bold shadow">
                        <i class="fa-solid fa-plus"></i> AGREGAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm" style="z-index: 1;">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="ps-3 py-3">DescripciÃ³n</th>
                        <th class="text-center">Cant.</th>
                        <th class="text-end pe-3">Subtotal</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody id="tbodyCarrito"></tbody>
            </table>
        </div>
        <div id="emptyMsg" class="text-center py-5 text-muted">
            <i class="fa-solid fa-cart-shopping fa-3x mb-3 opacity-25"></i><br>
            <span class="fs-5">La nota de remisiÃ³n estÃ¡ vacÃ­a</span>
        </div>
    </div>
    <div class="espaciador-footer"></div>
</div>

<div class="fixed-bottom p-3 bg-white border-top shadow-lg d-grid">
    <button id="btnFinalizar" class="btn btn-success btn-lg fw-bold py-3 shadow" onclick="enviarPedido()" disabled>
        CONFIRMAR PREVENTA
    </button>
</div>

<script>
    let carrito = {};
    let totalGlobal = 0;
    let productoSeleccionado = null;
    let clienteId = null;
    let creditoDisponible = 0;

    const clientesArr = [
        {% for c in clientes %}
        { id: {{ c.id }}, nombre: "{{ c.nombre_negocio }}", encargado: "{{ c.nombres_encargado }}" },
        {% endfor %}
    ];
    
    const catalogoBase = {{ catalogo | tojson | safe }};
    let catalogoActual = JSON.parse(JSON.stringify(catalogoBase));

    // BUSCADOR CLIENTE
    const inCli = document.getElementById('inputBusquedaCliente');
    const sugCli = document.getElementById('listaSugerenciasCliente');

    inCli.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        sugCli.innerHTML = '';
        if(val.length < 1) { sugCli.style.display = 'none'; return; }

        const matches = clientesArr.filter(c => 
            c.nombre.toLowerCase().includes(val) || c.encargado.toLowerCase().includes(val)
        );

        matches.forEach(c => {
            const d = document.createElement('div');
            d.className = 'item-sugerencia';
            d.innerHTML = `<div><strong>${c.nombre}</strong><br><small>${c.encargado}</small></div>`;
            d.onclick = () => {
                inCli.value = c.nombre;
                document.getElementById('labelCliente').innerText = c.nombre;
                clienteId = c.id;
                sugCli.style.display = 'none';
                fetchInfoCliente(c.id);
            };
            sugCli.appendChild(d);
        });
        sugCli.style.display = matches.length > 0 ? 'block' : 'none';
    });

    // BUSCADOR PRODUCTO
    const inProd = document.getElementById('inputBusquedaProd');
    const sugProd = document.getElementById('listaSugerenciasProd');

    inProd.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        sugProd.innerHTML = '';
        if(val.length < 1) { sugProd.style.display = 'none'; return; }

        const matches = catalogoActual.filter(p => p.nombre.toLowerCase().includes(val));

        matches.forEach(p => {
            const d = document.createElement('div');
            d.className = 'item-sugerencia';
            const badge = p.esEspecial ? '<span class="badge bg-success ms-2">ESPECIAL</span>' : '';
            d.innerHTML = `<span>${p.nombre}${badge}</span><span class="fw-bold text-primary">$${p.precio.toFixed(2)}</span>`;
            d.onclick = () => {
                inProd.value = p.nombre;
                productoSeleccionado = p;
                sugProd.style.display = 'none';
                document.getElementById('inputCant').focus();
            };
            sugProd.appendChild(d);
        });
        sugProd.style.display = matches.length > 0 ? 'block' : 'none';
    });

    async function fetchInfoCliente(id) {
        try {
            const r = await fetch(`/ventas/api/cliente/${id}`);
            const d = await r.json();
            
            creditoDisponible = d.disponible;
            document.getElementById('resumenCliente').classList.remove('d-none');
            document.getElementById('valLimite').innerText = `$${d.limite_credito.toFixed(2)}`;
            document.getElementById('valDebe').innerText = `$${d.saldo_actual.toFixed(2)}`;
            document.getElementById('valDisponible').innerText = `$${d.disponible.toFixed(2)}`;
            
            catalogoActual = catalogoBase.map(p => {
                const esp = d.precios_especiales[p.id];
                return { ...p, precio: esp !== undefined ? esp : p.precio, esEspecial: esp !== undefined };
            });
            
            Object.keys(carrito).forEach(k => {
                const p = catalogoActual.find(x => x.id == k);
                if(p) carrito[k].precio = p.precio;
            });
            renderCarrito();
        } catch (e) { console.error(e); }
    }

    function agregarAlCarrito() {
        if(!clienteId) return alert("Selecciona un cliente");
        if(!productoSeleccionado) return;
        const c = parseFloat(document.getElementById('inputCant').value);
        if(c <= 0) return;

        if(carrito[productoSeleccionado.id]) carrito[productoSeleccionado.id].cant += c;
        else carrito[productoSeleccionado.id] = { nombre: productoSeleccionado.nombre, precio: productoSeleccionado.precio, cant: c };
        
        inProd.value = ''; productoSeleccionado = null; renderCarrito();
    }

    function renderCarrito() {
        const b = document.getElementById('tbodyCarrito');
        const metodo = document.getElementById('metodoPago').value;
        const btn = document.getElementById('btnFinalizar');
        const displayTotal = document.getElementById('granTotal');
        
        b.innerHTML = ''; totalGlobal = 0;
        
        Object.keys(carrito).forEach(id => {
            const i = carrito[id];
            const s = i.cant * i.precio;
            totalGlobal += s;
            b.innerHTML += `<tr>
                <td class="ps-3"><strong>${i.nombre}</strong><br><small>$${i.precio.toFixed(2)} u.</small></td>
                <td class="text-center fw-bold">${i.cant}</td>
                <td class="text-end pe-3">$${s.toFixed(2)}</td>
                <td class="text-center"><button class="btn btn-link text-danger" onclick="delItem(${id})"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        });
        
        displayTotal.innerText = '$' + totalGlobal.toFixed(2);
        document.getElementById('emptyMsg').style.display = Object.keys(carrito).length ? 'none' : 'block';
        
        const notaVacia = Object.keys(carrito).length === 0;
        const excedeCredito = (metodo === 'Credito' && totalGlobal > creditoDisponible);

        if (notaVacia) {
            btn.disabled = true;
            btn.classList.replace('btn-danger', 'btn-success');
            btn.innerText = "CONFIRMAR PREVENTA";
            displayTotal.classList.remove('text-danger');
        } else if (excedeCredito) {
            btn.disabled = true;
            btn.classList.replace('btn-success', 'btn-danger');
            btn.innerText = "LÃMITE DE CRÃ‰DITO EXCEDIDO";
            displayTotal.classList.add('text-danger');
        } else {
            btn.disabled = false;
            btn.classList.replace('btn-danger', 'btn-success');
            btn.innerText = (metodo === 'Contado') ? "CONFIRMAR VENTA (CONTADO)" : "CONFIRMAR PREVENTA (CRÃ‰DITO)";
            displayTotal.classList.remove('text-danger');
        }
    }

    function delItem(id) { delete carrito[id]; renderCarrito(); }

    async function enviarPedido() {
        const metodo = document.getElementById('metodoPago').value;
        const notas = document.getElementById('inputNotas').value.trim();

        // --- VALIDACIÃ“N DE 15 CARACTERES (El Candado) ---
        if (notas.length < 15) {
            alert(`âš ï¸ Â¡Ey! Explica la venta.\n\nEscribe al menos 15 letras en el campo de Notas.\n(Actualmente tienes ${notas.length}).\n\nEjemplo: "Paga al recibir en tienda"`);
            document.getElementById('inputNotas').focus();
            return;
        }
        // ------------------------------------------------

        if(!confirm(`Â¿Confirmar este pedido?`)) return;
        
        const payload = { 
            cliente_id: clienteId, 
            fecha_entrega: "{{ date_now }}", 
            metodo_pago: metodo, 
            total: totalGlobal, 
            notas: notas, 
            items: carrito 
        };

        try {
            const r = await fetch('/ventas/crear-pedido', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const d = await r.json();
            if(d.status === 'success') {
                alert("âœ… " + d.message);
                window.location.reload();
            } else { alert("âŒ Error: " + d.message); }
        } catch (e) { alert("Error de conexiÃ³n"); }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#wrapperCliente')) sugCli.style.display = 'none';
        if (!e.target.closest('#wrapperProducto')) sugProd.style.display = 'none';
    });
</script>
{% endblock %}

========================= FILE: .\app\templates\shipping\dashboard.html =========================
{% extends 'base.html' %}
{% block title %}Despacho | GelMexSys{% endblock %}
{% block page_header %}Tablero de Surtido y Embarque{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-primary fw-bold"><i class="fa-solid fa-clipboard-list me-2"></i>Cola de Trabajo (Pendientes)</h5>
        <span class="badge bg-primary fs-6">{{ pendientes|length }} Ã“rdenes</span>
    </div>
    
    <div class="row">
        {% for orden in pendientes %}
        <div class="col-12 col-md-6 col-xl-4 mb-4">
            <div class="card h-100 shadow-sm border-0 border-start border-4 {% if orden.estado == 'EMPACADO' %}border-warning{% else %}border-primary{% endif %}">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0 d-flex justify-content-between">
                    <span class="badge bg-light text-dark border">{{ orden.folio }}</span>
                    {% if orden.estado == 'CONFIRMADA' %}
                        <span class="badge bg-secondary">POR INICIAR</span>
                    {% elif orden.estado == 'EN_PRODUCCION' %}
                        <span class="badge bg-info text-dark">SURTIENDO</span>
                    {% elif orden.estado == 'EMPACADO' %}
                        <span class="badge bg-warning text-dark">EMPACANDO</span>
                    {% endif %}
                </div>
                
                <div class="card-body">
                    <h5 class="card-title fw-bold text-dark mb-1">{{ orden.cliente.nombre_negocio }}</h5>
                    <p class="text-muted small mb-3">
                        <i class="fa-solid fa-route me-1"></i> 
                        {{ orden.cliente.ruta.descripcion if orden.cliente.ruta else 'Sin Ruta' }}
                    </p>
                    
                    <div class="d-flex align-items-center justify-content-between bg-light rounded p-2 mb-2">
                        <div class="text-center px-2">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">ÃTEMS</small>
                            <strong>{{ orden.items|length }}</strong>
                        </div>
                        <div class="text-center px-2 border-start border-end">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">ENTREGA</small>
                            <strong>{{ orden.fecha_promesa_entrega.strftime('%d/%m') }}</strong>
                        </div>
                        <div class="text-center px-2">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">VENDEDOR</small>
                            <strong>{{ orden.vendedor.nombres.split()[0] }}</strong>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-white border-top-0 pb-3 pt-0">
                    <a href="{{ url_for('shipping.picking', orden_id=orden.id) }}" class="btn btn-primary w-100 fw-bold shadow-sm">
                        {% if orden.estado == 'CONFIRMADA' %}
                            INICIAR <i class="fa-solid fa-play ms-2"></i>
                        {% else %}
                            CONTINUAR <i class="fa-solid fa-arrow-right ms-2"></i>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-4 bg-light rounded mb-4">
            <h4 class="text-muted m-0">ðŸŽ‰ No hay pedidos pendientes por ahora.</h4>
        </div>
        {% endfor %}
    </div>

    <hr class="my-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-success fw-bold"><i class="fa-solid fa-truck-ramp-box me-2"></i>Listos para Ruta (Ãšltimos Empacados)</h5>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle bg-white shadow-sm rounded">
            <thead class="table-light">
                <tr>
                    <th>Folio</th>
                    <th>Cliente</th>
                    <th>Ruta</th>
                    <th>Cajas</th>
                    <th>Fecha Entrega</th>
                    <th>Estatus</th>
                    <th>AcciÃ³n</th>
                </tr>
            </thead>
            <tbody>
                {% for orden in terminados %}
                <tr>
                    <td class="fw-bold">{{ orden.folio }}</td>
                    <td>{{ orden.cliente.nombre_negocio }}</td>
                    <td>{{ orden.cliente.ruta.descripcion if orden.cliente.ruta else 'S/R' }}</td>
                    <td><span class="badge bg-dark">{{ orden.paquetes|length }} Cajas</span></td>
                    <td>{{ orden.fecha_promesa_entrega.strftime('%d/%m/%Y') }}</td>
                    <td><span class="badge bg-success">LISTO PARA RUTA</span></td>
                    <td>
                        <a href="{{ url_for('shipping.picking', orden_id=orden.id) }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fa-solid fa-eye"></i> Ver / Reimprimir
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-3">No has terminado ninguna orden recientemente.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}

========================= FILE: .\app\templates\shipping\labels.html =========================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Etiquetas - {{ orden.folio }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background: #525659; }
        .page-break { page-break-after: always; }
        .label-container {
            background: white;
            width: 100mm;
            height: 150mm;
            margin: 20px auto;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        @media print {
            body { background: white; margin: 0; }
            .label-container {
                box-shadow: none;
                margin: 0;
                width: 100%;
                height: 100vh;
                border: none;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="container-fluid py-3 no-print bg-dark text-white shadow fixed-top">
        <div class="d-flex justify-content-between align-items-center px-4">
            <div class="d-flex align-items-center">
                <h5 class="m-0 me-3"><i class="fa-solid fa-print me-2"></i>Vista de ImpresiÃ³n</h5>
                <span class="badge bg-secondary">{{ orden.paquetes|length }} Etiquetas</span>
            </div>
            <div class="d-flex gap-2">
                <button onclick="window.print()" class="btn btn-warning fw-bold">
                    <i class="fa-solid fa-print me-2"></i> IMPRIMIR
                </button>
                <a href="{{ url_for('shipping.picking', orden_id=orden.id) }}" class="btn btn-danger fw-bold">
                    <i class="fa-solid fa-xmark me-2"></i> CERRAR
                </a>
            </div>
        </div>
    </div>
    <div style="height: 80px;" class="no-print"></div>

    {% for p in orden.paquetes %}
    <div class="label-container page-break">
        
        <div class="text-center border-bottom pb-2 mb-2">
            <h2 class="fw-bold mb-0 text-uppercase">GelMex</h2>
            <small class="text-muted fw-bold letter-spacing-1">LOGÃSTICA Y DISTRIBUCIÃ“N</small>
        </div>

        <div class="row mt-2">
            <div class="col-12 mb-3">
                <label class="small text-muted fw-bold text-uppercase">Cliente / Destino:</label>
                <div class="fs-4 fw-bold lh-1">{{ orden.cliente.nombre_negocio }}</div>
                <div class="small text-muted mt-1">
                    <i class="fa-solid fa-location-dot me-1"></i>
                    {{ orden.cliente.ciudad }}, {{ orden.cliente.estado }}
                </div>
            </div>
            
            <div class="col-6">
                <label class="small text-muted fw-bold text-uppercase">Ruta:</label>
                <div class="fs-1 fw-bold text-center border border-3 border-dark rounded">
                    {{ orden.cliente.ruta.descripcion.split(':')[0] if orden.cliente.ruta else 'S/R' }}
                </div>
            </div>
            <div class="col-6 text-end">
                <label class="small text-muted fw-bold text-uppercase">CAJA:</label>
                <div class="fs-1 fw-bold">{{ p.numero_caja }} <span class="fs-4 text-muted">/ {{ p.total_cajas_orden }}</span></div>
            </div>
        </div>

        <div class="mt-3 border-top border-bottom py-2 bg-light px-2 rounded">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="d-block small fw-bold text-muted">FOLIO ORDEN</span>
                    <span class="fs-5 fw-bold">{{ orden.folio }}</span>
                </div>
                <div class="text-end">
                    <span class="d-block small fw-bold text-muted">VALOR</span>
                    <span class="fs-5 fw-bold">${{ "{:,.2f}".format(orden.total_venta) }}</span>
                </div>
            </div>
            <div class="mt-2 small text-muted fst-italic border-top pt-1">
                <strong>Contenido:</strong> {{ p.descripcion_contenido }}
            </div>
        </div>

        <div class="text-center mt-auto flex-grow-1 d-flex flex-column align-items-center justify-content-center pt-4">
            <div id="qrcode-{{ p.id }}" class="p-2 bg-white border"></div>
            <div class="mt-2 font-monospace small fw-bold text-break">{{ p.codigo_etiqueta }}</div>
        </div>

        <div class="text-center small text-muted mt-3 border-top pt-2">
            Salida: <strong>{{ orden.fecha_promesa_entrega.strftime('%d/%m/%Y') }}</strong> | 
            EmpacÃ³: {{ p.usuario.nombres if p.usuario else 'Sistema' }}
        </div>
    </div>

    <script>
        try {
            new QRCode(document.getElementById("qrcode-{{ p.id }}"), {
                text: "{{ p.codigo_etiqueta }}",
                width: 150,
                height: 150,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        } catch (e) { console.error(e); }
    </script>
    {% endfor %}
</body>
</html>

========================= FILE: .\app\templates\shipping\picking.html =========================
{% extends 'base.html' %}
{% block title %}Surtido {{ orden.folio }}{% endblock %}
{% block page_header %}Mesa de Surtido{% endblock %}

{% block content %}

{# --- LÃ“GICA DE MODO LECTURA --- #}
{% set orden_cerrada = orden.estado in ['LISTO_RUTA', 'EN_RUTA', 'ENTREGADA', 'CANCELADA'] %}

<div class="container-fluid">
    <div class="card shadow-sm mb-4 border-primary">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h4 class="fw-bold m-0 text-primary">{{ orden.folio }}</h4>
                <span class="text-muted fs-5">{{ orden.cliente.nombre_negocio }}</span>
                <div class="text-muted small mt-1">
                    <i class="fa-solid fa-truck me-1"></i> {{ orden.cliente.ruta.descripcion if orden.cliente.ruta else 'Sin Ruta' }}
                </div>
            </div>
            <div class="text-end">
                <span class="badge bg-warning text-dark fs-5 shadow-sm">{{ orden.estado }}</span>
                <br>
                <small class="text-muted">Entrega: {{ orden.fecha_promesa_entrega.strftime('%d/%m') }}</small>
            </div>
        </div>
        
        {% if orden_cerrada %}
        <div class="card-footer bg-secondary text-white fw-bold text-center">
            <i class="fa-solid fa-lock me-2"></i> MODO HISTÃ“RICO: ORDEN FINALIZADA Y CERRADA
        </div>
        {% elif orden.notas_vendedor %}
        <div class="card-footer bg-warning bg-opacity-25 border-top-0">
            <i class="fa-solid fa-triangle-exclamation me-2"></i><strong>Nota:</strong> {{ orden.notas_vendedor }}
        </div>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <h5 class="m-0"><i class="fa-solid fa-list-check me-2"></i>Lista de Productos</h5>
                    <span class="badge bg-light text-dark">{{ orden.items|length }} Ãtems</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light text-secondary text-uppercase small">
                            <tr>
                                <th style="width: 40%;">Producto</th>
                                <th class="text-center">Progreso</th>
                                <th class="text-center">Falta</th>
                                <th class="text-end">AcciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in orden.items %}
                            {% set pedido = item.cantidad_pedida | int %}
                            {% set surtido = item.cantidad_surtida | int %}
                            {% set faltante = pedido - surtido %}
                            {% set porcentaje = (surtido / pedido * 100) | int %}
                            
                            <tr class="{% if faltante <= 0 %}table-success bg-opacity-25{% endif %}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            {% if faltante <= 0 %}
                                                <i class="fa-solid fa-circle-check text-success fa-2x"></i>
                                            {% else %}
                                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-muted border" style="width:40px; height:40px;">
                                                    <i class="fa-solid fa-box"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <strong>{{ item.producto.descripcion }}</strong>
                                            <br>
                                            <span class="badge bg-secondary">{{ item.producto.sku }}</span>
                                        </div>
                                    </div>
                                </td>
                                
                                <td class="align-middle">
                                    <div class="d-flex justify-content-between small mb-1 fw-bold">
                                        <span>{{ surtido }} / {{ pedido }}</span>
                                        <span>{{ porcentaje }}%</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar {% if faltante <= 0 %}bg-success{% else %}bg-primary progress-bar-striped{% endif %}" 
                                             role="progressbar" style="width: {{ porcentaje }}%"></div>
                                    </div>
                                </td>

                                <td class="text-center fw-bold fs-5">
                                    {% if faltante > 0 %}
                                        <span class="text-danger">{{ faltante }}</span>
                                    {% else %}
                                        <span class="text-success">OK</span>
                                    {% endif %}
                                </td>

                                <td class="text-end">
                                    {% if orden_cerrada %}
                                        <span class="text-muted"><i class="fa-solid fa-lock"></i></span>
                                    {% else %}
                                        {% if faltante > 0 %}
                                        <button class="btn btn-primary fw-bold shadow-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#modalPick{{ item.id }}">
                                            <i class="fa-solid fa-hand-holding-box"></i> TOMAR
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-success disabled border-0">
                                            <i class="fa-solid fa-check"></i> LISTO
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>

                            {% if not orden_cerrada %}
                            <div class="modal fade" id="modalPick{{ item.id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content border-0">
                                        <div class="modal-header bg-primary text-white">
                                            <div>
                                                <h5 class="modal-title fw-bold">Surtir: {{ item.producto.descripcion }}</h5>
                                                <small>Te faltan: <span class="badge bg-warning text-dark fs-6">{{ faltante }} pzas</span></small>
                                            </div>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        
                                        <form action="{{ url_for('shipping.confirmar_picking') }}" method="POST">
                                            <div class="modal-body bg-light">
                                                <input type="hidden" name="detalle_id" value="{{ item.id }}">
                                                
                                                {% set stock_info = stock_por_producto.get(item.producto_id, []) %}
                                                
                                                {% if stock_info %}
                                                    <div class="mb-3 bg-white p-3 rounded border">
                                                        <label class="fw-bold mb-2 text-primary small text-uppercase">1. Selecciona AlmacÃ©n</label>
                                                        <select id="selectAlmacen{{ item.id }}" class="form-select form-select-lg" 
                                                                onchange="filtrarUbicaciones('{{ item.id }}')">
                                                            <option value="">-- Elige un AlmacÃ©n --</option>
                                                            {% set almacenes_vistos = [] %}
                                                            {% for s in stock_info %}
                                                                {% if s.almacen_id not in almacenes_vistos %}
                                                                    <option value="{{ s.almacen_id }}">{{ s.almacen_nombre }}</option>
                                                                    {% set _ = almacenes_vistos.append(s.almacen_id) %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div class="mb-3 bg-white p-3 rounded border">
                                                        <label class="fw-bold mb-2 text-primary small text-uppercase">2. UbicaciÃ³n Exacta</label>
                                                        <select id="selectUbicacion{{ item.id }}" name="inventario_id" 
                                                                class="form-select form-select-lg" 
                                                                disabled required 
                                                                onchange="actualizarInputCantidad('{{ item.id }}', {{ faltante }})">
                                                            <option value="">-- Esperando AlmacÃ©n --</option>
                                                            {% for s in stock_info %}
                                                                <option value="{{ s.inv_id }}" 
                                                                        data-almacen="{{ s.almacen_id }}" 
                                                                        data-stock="{{ s.cantidad }}"
                                                                        style="display:none;">
                                                                    {{ s.ubicacion_codigo }} (Disponible: {{ s.cantidad }})
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div class="row g-3 align-items-center bg-white p-3 rounded border">
                                                        <div class="col-6 text-end">
                                                            <label class="fw-bold fs-5">Cantidad a Tomar:</label>
                                                        </div>
                                                        <div class="col-6">
                                                            <input type="number" 
                                                                   id="inputCant{{ item.id }}"
                                                                   name="cantidad" 
                                                                   class="form-control form-control-lg text-center fw-bold border-success" 
                                                                   value="{{ faltante }}" 
                                                                   min="0.1" 
                                                                   step="0.01"
                                                                   required
                                                                   disabled
                                                                   oninput="validarBoton('{{ item.id }}')">
                                                        </div>
                                                        <div class="col-12 text-end">
                                                            <span class="form-text text-muted" id="msgStock{{ item.id }}">Selecciona ubicaciÃ³n primero...</span>
                                                        </div>
                                                    </div>

                                                {% else %}
                                                    <div class="alert alert-danger m-0">
                                                        <i class="fa-solid fa-triangle-exclamation"></i> <strong>SIN STOCK:</strong> No se encontrÃ³ inventario disponible.
                                                    </div>
                                                {% endif %}

                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                <button type="submit" 
                                                        id="btnSubmit{{ item.id }}"
                                                        class="btn btn-primary fw-bold px-4" 
                                                        disabled>
                                                    <i class="fa-solid fa-check me-2"></i> CONFIRMAR RETIRO
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="sticky-top" style="top: 20px; z-index: 100;">
                
                {% if not orden_cerrada %}
                <div class="card shadow-sm border-0 bg-warning bg-opacity-10 mb-3">
                    <div class="card-header bg-warning text-dark border-0">
                        <h5 class="m-0"><i class="fa-solid fa-print me-2"></i>Generar GuÃ­as</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('shipping.generar_etiquetas') }}" method="POST">
                            <input type="hidden" name="orden_id" value="{{ orden.id }}">
                            <div class="text-center mb-3">
                                <i class="fa-solid fa-boxes-stacked fa-3x text-muted opacity-50"></i>
                            </div>
                            <label class="fw-bold mb-2">Â¿Total de Cajas?</label>
                            <div class="input-group input-group-lg mb-3">
                                <span class="input-group-text bg-white"><i class="fa-solid fa-hashtag"></i></span>
                                <input type="number" name="total_cajas" class="form-control fw-bold text-center" 
                                       value="{{ orden.paquetes|length if orden.paquetes else 1 }}" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">Contenido (Opcional):</label>
                                <textarea name="contenido" class="form-control" rows="2" placeholder="Ej: Solo congelado..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-dark w-100 fw-bold py-3 shadow-sm">
                                <i class="fa-solid fa-barcode me-2"></i> GENERAR Y IMPRIMIR
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}

                {% if orden.paquetes %}
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-white border-bottom fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="fa-solid fa-tags me-2"></i>Etiquetas</span>
                        <a href="{{ url_for('shipping.imprimir_etiquetas', orden_id=orden.id) }}" target="_blank" class="btn btn-sm btn-outline-dark fw-bold">
                            <i class="fa-solid fa-print"></i> REIMPRIMIR
                        </a>
                    </div>
                    <ul class="list-group list-group-flush small">
                        {% for p in orden.paquetes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="badge bg-dark font-monospace">{{ p.codigo_etiqueta }}</span>
                            <small class="text-muted">Caja {{ p.numero_caja }}</small>
                            <i class="fa-solid fa-check-circle text-success"></i>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if not orden_cerrada %}
                <div class="card shadow-lg border-0 bg-success text-white">
                    <div class="card-body text-center p-4">
                        <h5 class="fw-bold mb-3">Â¿Terminaste Todo?</h5>
                        <p class="small text-white-50 mb-3">Si ya surtiste y pegaste las etiquetas, manda la orden a reparto.</p>
                        
                        <form action="{{ url_for('shipping.finalizar_orden', orden_id=orden.id) }}" method="POST">
                            <button type="submit" class="btn btn-light text-success w-100 fw-bold py-3 fs-5 shadow-sm" 
                                    onclick="return confirm('Â¿Seguro que quieres finalizar esta orden?')">
                                <i class="fa-solid fa-check-double me-2"></i> FINALIZAR ORDEN
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
                
            </div>
        </div>
    </div>
</div>

<script>
// 1. FILTRAR UBICACIONES (Reset total al cambiar almacÃ©n)
function filtrarUbicaciones(itemId) {
    const almacenSelect = document.getElementById('selectAlmacen' + itemId);
    const ubicacionSelect = document.getElementById('selectUbicacion' + itemId);
    const inputCant = document.getElementById('inputCant' + itemId);
    const btnSubmit = document.getElementById('btnSubmit' + itemId); // BotÃ³n
    const idAlmacenSeleccionado = almacenSelect.value;
    
    // Reseteo Total
    ubicacionSelect.value = "";
    ubicacionSelect.disabled = true;
    inputCant.disabled = true; // Deshabilitar input
    btnSubmit.disabled = true; // Deshabilitar botÃ³n
    
    const opciones = ubicacionSelect.querySelectorAll('option');
    let hayOpciones = false;
    
    opciones.forEach(op => {
        if (op.value === "") return;
        const perteneceAlmacen = op.getAttribute('data-almacen') === idAlmacenSeleccionado;
        if (perteneceAlmacen) {
            op.style.display = 'block';
            hayOpciones = true;
        } else {
            op.style.display = 'none';
        }
    });
    
    if (hayOpciones) {
        ubicacionSelect.disabled = false;
        ubicacionSelect.options[0].text = "-- Selecciona UbicaciÃ³n --";
    } else if (idAlmacenSeleccionado) {
        ubicacionSelect.options[0].text = "âš ï¸ No hay ubicaciones con stock aquÃ­";
    }
}

// 2. ACTUALIZAR CANTIDAD (Habilita input y llama a validar)
function actualizarInputCantidad(itemId, faltanteGlobal) {
    const ubicacionSelect = document.getElementById('selectUbicacion' + itemId);
    const inputCant = document.getElementById('inputCant' + itemId);
    const msg = document.getElementById('msgStock' + itemId);
    
    const opcion = ubicacionSelect.options[ubicacionSelect.selectedIndex];
    
    if (opcion.value === "") {
        inputCant.disabled = true;
        validarBoton(itemId); // Revalidar para apagar el botÃ³n
        return;
    }
    
    const stockDisponible = parseInt(opcion.getAttribute('data-stock'));
    const maximoPermitido = Math.min(stockDisponible, faltanteGlobal);
    
    // Configurar input
    inputCant.disabled = false;
    inputCant.value = maximoPermitido;
    inputCant.max = stockDisponible;
    
    // Mensaje visual
    if (stockDisponible < faltanteGlobal) {
        msg.innerHTML = `<span class="text-danger fw-bold">âš ï¸ Stock parcial: ${stockDisponible}. FaltarÃ¡n ${faltanteGlobal - stockDisponible}.</span>`;
    } else {
        msg.innerHTML = `<span class="text-success fw-bold">âœ… Stock suficiente.</span>`;
    }
    
    // Activar validaciÃ³n del botÃ³n
    validarBoton(itemId);
}

// 3. VALIDAR ESTADO DEL BOTÃ“N (La Joya de la Corona)
function validarBoton(itemId) {
    const ubicacionSelect = document.getElementById('selectUbicacion' + itemId);
    const inputCant = document.getElementById('inputCant' + itemId);
    const btnSubmit = document.getElementById('btnSubmit' + itemId);
    
    const ubicacionValida = ubicacionSelect.value !== "";
    const cantidad = parseFloat(inputCant.value);
    const maxStock = parseFloat(inputCant.max);
    
    // LÃ³gica: UbicaciÃ³n llena AND Cantidad > 0 AND Cantidad <= Stock real
    if (ubicacionValida && cantidad > 0 && cantidad <= maxStock) {
        btnSubmit.disabled = false; // PRENDER
        btnSubmit.classList.remove('btn-secondary');
        btnSubmit.classList.add('btn-primary');
    } else {
        btnSubmit.disabled = true; // APAGAR
        btnSubmit.classList.remove('btn-primary');
        btnSubmit.classList.add('btn-secondary');
    }
}
</script>
{% endblock %}

========================= FILE: .\db_seeds\data_catalogs.py =========================
# db_seeds/01_catalogs_data.py

CATALOGOS = {
    # --- INFRAESTRUCTURA ---
    "cat_plantas": [
        {"descripcion": "Planta Matriz Hgo", "notas": "ProducciÃ³n Principal"},        
    ],
    "cat_areas": [
        {"descripcion": "ProducciÃ³n", "notas": "Zona Congelacion"},        
        {"descripcion": "LogÃ­stica y Carga", "notas": "Andenes"},
        {"descripcion": "AdministraciÃ³n", "notas": "Oficinas"}
    ],
    "cat_ubicaciones": [ # NUEVO: Faltaba este
        {"descripcion": "Pasillo A"},
        {"descripcion": "Pasillo B"},
        {"descripcion": "Nivel 1 (Piso)"},
        {"descripcion": "Nivel 2 (Rack)"},
        {"descripcion": "Zona de Carga"}
    ],

    # --- PRODUCTOS ---
    "cat_unidades_medida": [
        {"nombre": "Pieza", "abreviatura": "Pza"},
        {"nombre": "Litro", "abreviatura": "Lt"},
        {"nombre": "Kilogramo", "abreviatura": "Kg"},
        {"nombre": "Caja", "abreviatura": "Cja"},
        {"nombre": "Gramo", "abreviatura": "gr"}
    ],
    "cat_categorias_producto": [
        {"nombre": "Bolis Base Leche", "descripcion": "Base lÃ¡ctea congelada"},
        {"nombre": "Bolis Base Agua", "descripcion": "Base Agua congelada"},
        {"nombre": "Paletas Base Crema", "descripcion": "Paleta Base lÃ¡ctea"},
        {"nombre": "Paletas Base Agua", "descripcion": "Paleta Base Agua"},
        {"nombre": "Helado Base Leche", "descripcion": "Litros de helado Base leche"}, 
        {"nombre": "Helado Base Agua", "descripcion": "Litros de helado Base Agua"}
    ],
    "cat_categorias_materia_prima": [
        {"nombre": "LÃ¡cteos", "descripcion": "Leche, Crema, Suero"},
        {"nombre": "AzÃºcares y Endulzantes", "descripcion": ""}, # OJO: Este es el nombre correcto
        {"nombre": "Saborizantes y Esencias", "descripcion": ""},
        {"nombre": "Empaque Primario", "descripcion": "Bolsitas, Palitos"},
        {"nombre": "Empaque Secundario", "descripcion": "Cajas cartÃ³n, Cinta"}
    ],

    # --- ALMACÃ‰N ---
    "cat_tipos_almacen": [
        {"nombre": "CÃ¡mara FrÃ­a (CongelaciÃ³n)"},
        {"nombre": "AlmacÃ©n Seco"},
        {"nombre": "CÃ¡mara Refrigerada (ConservaciÃ³n)"},
        {"nombre": "AlmacÃ©n de Refacciones"}
    ],
    "cat_tipos_movimiento_almacen": [ # NUEVO: Requerido por KÃ¡rdex
        {"descripcion": "ENTRADA_PRODUCCION"},
        {"descripcion": "REUBICACION_INTERNA"},
        {"descripcion": "SALIDA_EMPAQUE"},
        {"descripcion": "AJUSTE_INVENTARIO"},
        {"descripcion": "BAJA_MERMA"}
    ],

    # --- RH Y OPERACIÃ“N ---
    "cat_puestos": [
        {"nombre": "Super Administrador", "nivel_acceso": 5},
        {"nombre": "Gerente de Planta", "nivel_acceso": 4},
        {"nombre": "Finanzas / Contador", "nivel_acceso": 4},
        {"nombre": "Programador ProducciÃ³n", "nivel_acceso": 3},
        {"nombre": "Almacenista", "nivel_acceso": 3},
        {"nombre": "Vendedor / Preventista", "nivel_acceso": 2},
        {"nombre": "Maestro Heladero", "nivel_acceso": 2},
        {"nombre": "Repartidor / Chofer", "nivel_acceso": 1}
    ],
    "cat_tipos_vehiculo": [
        {"nombre": "Unidad Refrigerada (Termo)"},
        {"nombre": "Motocicleta"},
        {"nombre": "AutomÃ³vil SedÃ¡n"}
    ],
    "cat_estados_fisicos": [
        {"descripcion": "Nuevo"},
        {"descripcion": "Bueno / Operativo"},
        {"descripcion": "Regular / Requiere AtenciÃ³n"},
        {"descripcion": "Malo / En ReparaciÃ³n"},
        {"descripcion": "Baja Definitiva"}
    ],

    # --- FINANZAS Y CONTROL ---
    "cat_conceptos_finanzas": [
        {"tipo_flujo": "INGRESO", "descripcion": "Venta Contado Ruta"},
        {"tipo_flujo": "INGRESO", "descripcion": "Cobranza CrÃ©dito (Abono)"},
        {"tipo_flujo": "INGRESO", "descripcion": "AportaciÃ³n de Capital"},
        {"tipo_flujo": "EGRESO", "descripcion": "Pago a Proveedor MP"},
        {"tipo_flujo": "EGRESO", "descripcion": "Pago NÃ³mina"},
        {"tipo_flujo": "EGRESO", "descripcion": "Pago Servicios (Luz/Agua)"},
        {"tipo_flujo": "EGRESO", "descripcion": "Mantenimiento Vehicular"},
        {"tipo_flujo": "DEUDA", "descripcion": "Compra CrÃ©dito MP"}
    ],
    "cat_tipos_incidencia": [
        {"descripcion": "Producto Derretido"},
        {"descripcion": "Producto DaÃ±ado/Aplastado"},
        {"descripcion": "Robo / ExtravÃ­o"},
        {"descripcion": "Consumo Interno Autorizado"},
        {"descripcion": "Merma de ProducciÃ³n"},
        {"descripcion": "Error de Conteo"}
    ],
    "cat_bancos_cajas": [
        {"nombre": "Caja Chica Planta"},
        {"nombre": "Caja Fuerte Principal"},
        {"nombre": "Cuenta Fiscal BBVA"},
        {"nombre": "Cuenta NÃ³mina Santander"}
    ],
    
    # --- NUEVOS AGREGADOS DE ARQUITECTURA MAESTRA ---
    "cat_tipos_descuento": [
        {"descripcion": "PORCENTAJE"},
        {"descripcion": "MONTO_FIJO"},
        {"descripcion": "PRECIO_FINAL"}
    ],
    "cat_tipos_pago_solicitado": [
        {"descripcion": "CONTADO"},
        {"descripcion": "CREDITO"}
    ],
    "cat_estados_orden_venta": [
        {"descripcion": "BORRADOR"},
        {"descripcion": "CONFIRMADO"},
        {"descripcion": "EN_PRODUCCION"},
        {"descripcion": "EMPACADO"},
        {"descripcion": "EN_RUTA"},
        {"descripcion": "ENTREGADO"},
        {"descripcion": "CANCELADO"}
    ],
    "cat_estados_plan_produccion": [
        {"descripcion": "PLANIFICADO"},
        {"descripcion": "EN_PROCESO"},
        {"descripcion": "CERRADO"}
    ],
    "cat_estados_orden_empaque": [
        {"descripcion": "EN_PROCESO"},
        {"descripcion": "LISTO_PARA_RUTA"}
    ],
    "cat_tipos_movimiento_finanzas": [
        {"descripcion": "CARGO_VENTA"},
        {"descripcion": "ABONO_EFECTIVO"},
        {"descripcion": "ABONO_TRANSFERENCIA"},
        {"descripcion": "NOTA_CREDITO"}
    ],
    "cat_estados_deuda_empresa": [
        {"descripcion": "PENDIENTE"},
        {"descripcion": "PAGADO"},
        {"descripcion": "VENCIDO"}
    ],
    "cat_tipos_flujo": [
        {"descripcion": "ENTRADA"},
        {"descripcion": "SALIDA"}
    ],
    "cat_origenes_flujo": [
        {"descripcion": "CAPITAL"},
        {"descripcion": "VENTAS"},
        {"descripcion": "PRESTAMO"}
    ],
    "cat_periodos": [
        {"descripcion": "MENSUAL"},
        {"descripcion": "ANUAL"}
    ]
}

========================= FILE: .\db_seeds\data_clients.py =========================
# db_seeds/data_clients.py

CLIENTES = [
    {
        # Datos Negocio
        "nombre_negocio": "Abarrotes Don Pepe",
        "rfc": "XAXX010101000",
        "tipo_negocio": "Tienda de Abarrotes",
        "calificacion": 5,
        "img_fachada": "uploads/clientes/donpepe_fachada.jpg",
        
        # Datos Encargado
        "nombres_encargado": "Jose",
        "apellidos_encargado": "Perez Lopez",
        
        # DirecciÃ³n Negocio (AQUÃ TAMBIÃ‰N CORREGIMOS)
        "calle": "Calle Morelos",
        "num_exterior": "45",
        "num_interior": "",
        "colonia": "San Isidro",
        "codigo_postal": "38600",  # <--- CORREGIDO (Antes decÃ­a 'cp')
        "ciudad": "AcÃ¡mbaro",
        "estado": "Guanajuato",
        "pais": "MÃ©xico", # AgreguÃ© paÃ­s por si acaso el modelo lo requiere, no estorba
        
        # Finanzas
        "limite_credito": 5000.00,
        "saldo_actual": 0.00,
        
        # LogÃ­stica
        "ruta_asignada": "Ruta 1: Acambaro",
        
        # Precios Especiales
        "precios_especiales": [
            {
                "producto_sku": "BOL-LIM-STD",
                "tipo_descuento": "PRECIO_FINAL",
                "valor": 4.50
            },
            {
                "producto_sku": "PAL-FRE-CRM",
                "tipo_descuento": "PORCENTAJE",
                "valor": 10.00
            }
        ]
    }
]

========================= FILE: .\db_seeds\data_infrastructure.py =========================
# db_seeds/02_infrastructure_data.py

ALMACENES = [
    {
        "descripcion": "CÃ¡mara FrÃ­a Principal (Producto Terminado)",
        "tipo": "CÃ¡mara FrÃ­a (CongelaciÃ³n)",
        "planta": "Planta Matriz Hgo",
        "area": "LogÃ­stica y Carga",
        "ubicaciones": [
            # Generaremos cÃ³digos automÃ¡ticos o manuales
            {"codigo": "CF1-PAS1-NV1", "notas": "Pasillo 1 Nivel 1"},
            {"codigo": "CF1-PAS1-NV2", "notas": "Pasillo 1 Nivel 2"},
            {"codigo": "CF1-PISO", "notas": "Almacenaje a piso"}
        ]
    },
    {
        "descripcion": "AlmacÃ©n Materia Prima Seca",
        "tipo": "AlmacÃ©n Seco",
        "planta": "Planta Matriz Hgo",
        "area": "ProducciÃ³n Helados",
        "ubicaciones": [
            {"codigo": "SEC-ANAQUEL-A", "notas": "Sacos AzÃºcar"},
            {"codigo": "SEC-ANAQUEL-B", "notas": "Saborizantes"}
        ]
    }
]

RUTAS = [
    {"descripcion": "Ruta 1: Acambaro", "notas": "Lunes, MiÃ©rcoles, Viernes"},
    {"descripcion": "Ruta 2: Queretaro", "notas": "Martes y Jueves"},
    {"descripcion": "Ruta 3: Zinapecuaro", "notas": "SÃ¡bados"}
]


========================= FILE: .\db_seeds\data_products.py =========================
# db_seeds/data_products.py

PRODUCTOS = [
    {
        "sku": "BOL-LIM-STD",
        "descripcion": "Boli de LimÃ³n (TamaÃ±o EstÃ¡ndar)",
        "categoria": "Bolis Base Agua",
        "unidad": "Pieza",
        # CORRECCIÃ“N DE NOMBRES PARA COINCIDIR CON BD
        "precio_costo_actual": 2.50,      # Antes: precio_costo
        "precio_venta_general": 6.00,     # Antes: precio_venta
        "stock_minimo": 100,              # Antes: stock_min
        "stock_maximo": 2000,             # Antes: stock_max
        "stock_ideal": 1000,
        "peso_gramos": 150,               # Antes: peso_gr
        "caducidad_dias": 30,
        "imagen": "uploads/productos/bol_limon.jpg" # El runner maneja 'imagen' manualmente, este dÃ©jalo asÃ­
    },
    {
        "sku": "PAL-FRE-CRM",
        "descripcion": "Paleta de Fresa con Crema",
        "categoria": "Paletas Base Crema",
        "unidad": "Pieza",
        "precio_costo_actual": 4.00,
        "precio_venta_general": 12.00,
        "stock_minimo": 50,
        "stock_maximo": 1000,
        "stock_ideal": 500,
        "peso_gramos": 120,
        "caducidad_dias": 45,
        "imagen": "uploads/productos/pal_fresa.jpg"
    }
]

MATERIAS_PRIMAS = [
    {
        "sku": "AZU-BUL-50",
        "descripcion": "Bulto de AzÃºcar EstÃ¡ndar 50kg",
        "categoria": "AzÃºcares y Endulzantes",
        "unidad": "Kilogramo", 
        # CORRECCIÃ“N: Materia Prima usa 'precio_costo_promedio'
        "precio_costo_promedio": 22.50,   # Antes: precio_costo
        "precio_venta_general": 28.00,
        "stock_minimo": 100,
        "stock_maximo": 1000,
        "stock_ideal": 500,
        "peso_gramos": 1000,
        "caducidad_dias": 365,
        "imagen": "uploads/materias/azucar.jpg"
    }
]

========================= FILE: .\db_seeds\data_users.py =========================
# db_seeds/data_users.py

USUARIOS = [
    {
        # --- LOGIN ---
        "email": "admin@gelmex.com",
        "password_raw": "Admin2025",
        
        # --- SEGURIDAD ---
        "pin_seguridad": "123456",
        "nivel_usuario": 5,
        "activo": True,

        # --- IDENTIDAD ---
        "nombres": "Mario Eduardo",
        "apellido_paterno": "Martinez",
        "apellido_materno": "Juarez",
        "puesto": "Super Administrador",
        "rfc": "MAJU900101XXX",
        "curp": "MAJU900101HGT...",
        
        # --- LABORAL ---
        "fecha_inicio_empresa": "2024-01-01",
        "calificacion_evaluacion": 5,
        
        # --- CONTACTO ---
        "telefono_celular": "78610300599",
        "telefono_casa": "4171234567",
        
        # --- DIRECCIÃ“N (AQUÃ ESTABA EL ERROR) ---
        "calle": "Av. Hidalgo",
        "num_exterior": "123",
        "num_interior": "A",
        "colonia": "Centro",
        "codigo_postal": "38600",   # <--- CORREGIDO (Antes decÃ­a 'cp')
        "ciudad": "AcÃ¡mbaro",
        "estado": "Guanajuato",
        "pais": "MÃ©xico",
        
        # --- EMERGENCIA ---
        "contacto_emergencia_nombre": "Maria Reyna Figueroa",
        "contacto_emergencia_telefono": "4179999999",
        
        # --- ARCHIVOS ---
        "foto_perfil": "uploads/usuarios/admin_profile.jpg"
    }
]

========================= FILE: .\_historial_parches\fix_catalog.py =========================
from app import create_app
from app.extensions import db
from app.models.catalogs import CatTipoMovimientoAlmacen

app = create_app()

with app.app_context():
    print("ðŸ”§ Agregando opciÃ³n 'INVENTARIO_INICIAL' al catÃ¡logo...")
    
    # Verificamos si ya existe para no duplicar
    existe = CatTipoMovimientoAlmacen.query.filter_by(descripcion="INVENTARIO_INICIAL").first()
    
    if not existe:
        nuevo = CatTipoMovimientoAlmacen(descripcion="INVENTARIO_INICIAL")
        db.session.add(nuevo)
        db.session.commit()
        print("âœ… Â¡LISTO! OpciÃ³n creada. Ahora aparecerÃ¡ en el sistema.")
    else:
        print("â„¹ï¸ La opciÃ³n ya existÃ­a.")

========================= FILE: .\_historial_parches\fix_column.py =========================
from app import create_app
from app.extensions import db
from sqlalchemy import text

app = create_app()

with app.app_context():
    print("ðŸ”§ Reparando tabla 'inventario_productos'...")
    try:
        # Comando SQL directo para agregar la columna que falta
        sql = text("ALTER TABLE inventario_productos ADD COLUMN cantidad_reservada FLOAT DEFAULT 0.0;")
        db.session.execute(sql)
        db.session.commit()
        print("âœ… Â¡Ã‰XITO! Columna 'cantidad_reservada' agregada correctamente.")
    except Exception as e:
        print(f"âš ï¸ Aviso (puede que ya exista): {e}")

========================= FILE: .\_historial_parches\tests\test_inventory_flow.py =========================
import unittest
import sys
import os

# 1. PREPARACIÃ“N DE ENTORNO (CRÃTICO: HACER ESTO ANTES DE IMPORTAR APP)
# Esto engaÃ±a a Flask para que ignore tu archivo .env real
os.environ['FLASK_ENV'] = 'testing'
# Forzamos una URI de SQLite en memoria. Si tu config.py usa os.getenv('DATABASE_URL'), esto lo intercepta.
os.environ['DATABASE_URL'] = 'sqlite:///:memory:'
os.environ['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'

# Ajuste de ruta para imports
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from app import create_app, db
from app.models.products import Producto
from app.models.stock import InventarioProducto
from app.models.infrastructure import Almacen, UbicacionAlmacen
from app.models.catalogs import CatTipoMovimientoAlmacen, CatCategoriaProducto, CatUnidadMedida

class TestFlujoInventario(unittest.TestCase):
    
    def setUp(self):
        """Se ejecuta ANTES de cada prueba. Configura el entorno aislado."""
        
        # Crear la app
        self.app = create_app()
        
        # --- DOBLE VERIFICACIÃ“N DE SEGURIDAD (FAIL-SAFE) ---
        # Forzamos la configuraciÃ³n en el objeto app directamente por si el entorno fallÃ³
        self.app.config.update({
            "TESTING": True,
            "SQLALCHEMY_DATABASE_URI": "sqlite:///:memory:",
            "SQLALCHEMY_TRACK_MODIFICATIONS": False,
            "WTF_CSRF_ENABLED": False  # Desactivar tokens CSRF para facilitar test de formularios
        })

        self.app_context = self.app.app_context()
        self.app_context.push()

        # MATAR CUALQUIER CONEXIÃ“N PREVIA (Por si acaso se colÃ³ Postgres)
        db.session.remove()
        db.engine.dispose()

        # VERIFICACIÃ“N FINAL: Si esto imprime algo que no sea memory, lanzamos excepciÃ³n
        uri_actual = str(db.engine.url)
        print(f"   [DEBUG] Conectado a: {uri_actual}")
        
        if 'sqlite' not in uri_actual and ':memory:' not in uri_actual:
            raise RuntimeError(f"ðŸš¨ PELIGRO: El test intentÃ³ conectarse a {uri_actual}. ABORTANDO.")

        # Ahora sÃ­, creamos las tablas en la RAM
        try:
            db.create_all()
        except Exception as e:
            print(f"Error creando DB virtual: {e}")
            raise

        # Cargar datos semilla falsos (Mocks)
        self.crear_datos_mock()

    def tearDown(self):
        """Se ejecuta DESPUÃ‰S de cada prueba. Limpia la RAM."""
        db.session.remove()
        db.drop_all()
        self.app_context.pop()

    def crear_datos_mock(self):
        """Crea datos falsos exclusivos para la memoria RAM"""
        
        # 1. CatÃ¡logos (Sin duplicados porque la DB estÃ¡ vacÃ­a en RAM)
        tipos = ['INVENTARIO_INICIAL', 'ENTRADA_COMPRA', 'SALIDA_VENTA', 'AJUSTE_MERMA']
        for t in tipos:
            db.session.add(CatTipoMovimientoAlmacen(descripcion=t))
        
        db.session.add(CatCategoriaProducto(nombre="Helados Test"))
        db.session.add(CatUnidadMedida(nombre="Pieza", abreviatura="PZ"))
        
        # 2. Infraestructura
        alm = Almacen(descripcion="AlmacÃ©n RAM", tipo_id=1)
        db.session.add(alm)
        db.session.flush() # Para obtener el ID
        
        ubi = UbicacionAlmacen(codigo="RAM-A1", almacen_id=alm.id)
        db.session.add(ubi)
        db.session.flush()
        self.ubi_id = ubi.id

        # 3. Producto
        prod = Producto(sku="TEST-RAM", descripcion="Boli Virtual", categoria_id=1, unidad_id=1)
        db.session.add(prod)
        db.session.flush()
        self.prod_id = prod.id
        
        db.session.commit()

    # ==========================================
    # PRUEBAS UNITARIAS
    # ==========================================

    def test_flujo_completo_inventario(self):
        print("\nðŸ§ª INICIANDO TEST DE INTEGRIDAD DE INVENTARIO...")

        # CASO 1: Ajuste Inicial (Reset)
        # Inyectamos un valor basura
        inv = InventarioProducto(producto_id=self.prod_id, ubicacion_id=self.ubi_id, cantidad_actual=-999)
        db.session.add(inv)
        db.session.commit()

        # Simulamos la lÃ³gica de "INVENTARIO_INICIAL"
        target = InventarioProducto.query.filter_by(producto_id=self.prod_id, ubicacion_id=self.ubi_id).first()
        target.cantidad_actual = 500 # BorrÃ³n y cuenta nueva
        db.session.commit()
        
        self.assertEqual(target.cantidad_actual, 500, "FALLO: El inventario inicial no reseteÃ³ el saldo negativo.")
        print("   âœ… PASO 1: CorrecciÃ³n de negativos -> OK")

        # CASO 2: Entrada (Suma)
        target.cantidad_actual += 100
        db.session.commit()
        self.assertEqual(target.cantidad_actual, 600, "FALLO: La suma de entrada fallÃ³.")
        print("   âœ… PASO 2: Suma de inventario -> OK")

        # CASO 3: Salida (Resta)
        target.cantidad_actual -= 50
        db.session.commit()
        self.assertEqual(target.cantidad_actual, 550, "FALLO: La resta de salida fallÃ³.")
        print("   âœ… PASO 3: Resta de inventario -> OK")

        # CASO 4: Bloqueo de Stock Insuficiente
        # Intentamos sacar 1000 cuando hay 550
        saldo_antes = target.cantidad_actual
        if target.cantidad_actual >= 1000:
            target.cantidad_actual -= 1000
        else:
            # Esto es lo que esperamos que pase
            pass 
        
        self.assertEqual(target.cantidad_actual, saldo_antes, "FALLO: El sistema permitiÃ³ sacar mÃ¡s de lo que habÃ­a.")
        print("   âœ… PASO 4: Bloqueo de saldo negativo -> OK")

if __name__ == '__main__':
    unittest.main()

========================= FILE: .\_historial_parches\tests\__init__.py =========================

