{% extends 'base.html' %}
{% block title %}Finanzas Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark m-0">Centinela Financiero</h3>
            <small class="text-muted">Bitácora Maestra de Tesorería</small>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white shadow h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75">Dinero en Bóveda</h6>
                    <h1 class="display-4 fw-bold mb-2">${{ "{:,.2f}".format(caja.saldo_actual) }}</h1>
                    
                    <a href="{{ url_for('finance.ingresos') }}" class="btn btn-light text-success fw-bold btn-sm mt-2 w-75 mx-auto shadow-sm">
                        <i class="fa-solid fa-circle-plus me-1"></i> REGISTRAR INGRESO
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-warning text-dark shadow h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75">Por Auditar (En Calle)</h6>
                    <h1 class="display-4 fw-bold mb-2">${{ "{:,.2f}".format(en_calle) }}</h1>
                    <a href="{{ url_for('finance.auditoria') }}" class="btn btn-dark btn-sm mt-2 w-75 mx-auto">
                        Auditar Rutas <i class="fa-solid fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-danger text-white shadow h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75">Gastos del Mes</h6>
                    <h1 class="display-4 fw-bold mb-2">${{ "{:,.2f}".format(gastos) }}</h1>
                    <a href="{{ url_for('finance.gastos') }}" class="btn btn-light text-danger fw-bold btn-sm mt-2 w-75 mx-auto shadow-sm">
                        Registrar Salida <i class="fa-solid fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-white py-3">
            <h6 class="m-0 fw-bold text-primary"><i class="fa-solid fa-list-ul me-2"></i> Últimos 30 Movimientos de Bóveda</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary text-uppercase small">
                        <tr>
                            <th class="ps-4">Fecha / Folio</th>
                            <th>Tipo</th>
                            <th>Concepto</th>
                            <th>Usuario</th>
                            <th class="text-end">Monto</th>
                            <th class="text-center">Ticket</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if not movimientos %}
                        <tr><td colspan="6" class="text-center py-5 text-muted">Aún no hay movimientos registrados.</td></tr>
                        {% else %}
                        {% for mov in movimientos %}
                        <tr>
                            <td class="ps-4">
                                <span class="d-block fw-bold text-dark">{{ mov.fecha.strftime('%d/%m/%Y %H:%M') }}</span>
                                <small class="text-muted font-monospace">{{ mov.folio }}</small>
                            </td>
                            <td>
                                {% if mov.tipo == 'INGRESO' %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success">ENTRADA</span>
                                {% else %}
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">SALIDA</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="fw-bold">{{ mov.concepto }}</span>
                                {% if mov.notas %}
                                <br><small class="text-muted fst-italic">{{ mov.notas[:50] }}...</small>
                                {% endif %}
                            </td>
                            <td>
                                <i class="fa-regular fa-user-circle me-1"></i> {{ mov.usuario.nombres }}
                            </td>
                            <td class="text-end fw-bold fs-6 {{ 'text-success' if mov.tipo == 'INGRESO' else 'text-danger' }}">
                                {{ '+' if mov.tipo == 'INGRESO' else '-' }} ${{ "{:,.2f}".format(mov.monto) }}
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('finance.ver_ticket', folio=mov.folio) }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Reimprimir Ticket">
                                    <i class="fa-solid fa-print"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}