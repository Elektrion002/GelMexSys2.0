{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold"><i class="fa-solid fa-id-card me-2"></i>{{ title }}</h4>
        <a href="{{ url_for('users.index') }}" class="btn btn-outline-secondary">Cancelar</a>
    </div>

    {# --- ALERTA DE ERRORES --- #}
    {% if form.errors %}
    <div class="alert alert-danger">
        <i class="fa-solid fa-triangle-exclamation me-2"></i> <strong>Corrige los siguientes errores:</strong>
        <ul class="mb-0 mt-2 small">
            {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                    <li>{{ getattr(form, field).label.text }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom-0 pt-3">
                <ul class="nav nav-tabs card-header-tabs" id="userTabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#tab-general" type="button">1. General</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-address" type="button">2. Domicilio</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-laboral" type="button">3. Laboral y Emergencia</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-access" type="button">4. Acceso</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-files" type="button">5. Expediente</button></li>
                </ul>
            </div>

            <div class="card-body p-4">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-general">
                        <h6 class="text-muted border-bottom pb-2 mb-3">Datos de Identidad</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Nombre(s) *</label>
                                {{ form.nombres(class="form-control " + ("is-invalid" if form.nombres.errors else "")) }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Apellido Paterno *</label>
                                {{ form.apellido_paterno(class="form-control " + ("is-invalid" if form.apellido_paterno.errors else "")) }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Apellido Materno</label>
                                {{ form.apellido_materno(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha Nacimiento</label>
                                {{ form.fecha_nacimiento(class="form-control", type="date") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado Civil</label>
                                {{ form.estado_civil(class="form-select") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Profesión / Oficio</label>
                                {{ form.profesion(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">CURP</label>
                                {{ form.curp(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">RFC (Personal)</label>
                                {{ form.rfc(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Celular Personal *</label>
                                {{ form.telefono_celular(class="form-control " + ("is-invalid" if form.telefono_celular.errors else "")) }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Email Personal</label>
                                {{ form.email_personal(class="form-control", placeholder="ejemplo@gmail.com") }}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-address">
                        <h6 class="text-muted border-bottom pb-2 mb-3">Dirección Particular</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Calle</label>
                                {{ form.calle(class="form-control") }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">No. Exterior</label>
                                {{ form.num_exterior(class="form-control") }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">No. Interior</label>
                                {{ form.num_interior(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Colonia</label>
                                {{ form.colonia(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Código Postal</label>
                                {{ form.codigo_postal(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Teléfono Casa</label>
                                {{ form.telefono_casa(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ciudad</label>
                                {{ form.ciudad(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado</label>
                                {{ form.estado(class="form-control") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">País</label>
                                {{ form.pais(class="form-control") }}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-laboral">
                        <h6 class="text-muted border-bottom pb-2 mb-3">Información de la Empresa</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-primary">Puesto / Rol *</label>
                                {{ form.puesto_id(class="form-select") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha Ingreso</label>
                                {{ form.fecha_inicio_empresa(class="form-control", type="date") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Evaluación Desempeño</label>
                                {{ form.calificacion_evaluacion(class="form-select") }}
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notas Generales / Observaciones</label>
                                {{ form.notas_generales(class="form-control", rows="2") }}
                            </div>
                        </div>

                        <h6 class="text-muted border-bottom pb-2 mb-3 text-danger">En Caso de Emergencia</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre Contacto</label>
                                {{ form.contacto_emergencia_nombre(class="form-control") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono Contacto</label>
                                {{ form.contacto_emergencia_telefono(class="form-control") }}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-access">
                        <h6 class="text-muted border-bottom pb-2 mb-3">Credenciales del Sistema</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Correo Institucional (Login) *</label>
                                {{ form.email_acceso(class="form-control " + ("is-invalid" if form.email_acceso.errors else "")) }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Contraseña</label>
                                {{ form.password(class="form-control", placeholder="Dejar vacío para mantener la actual") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nivel de Permisos *</label>
                                {{ form.nivel_usuario(class="form-select") }}
                                <div class="form-text">Define qué módulos puede ver.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">PIN Seguridad (App Móvil)</label>
                                {{ form.pin_seguridad(class="form-control", placeholder="Ej: 1234") }}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-files">
                        <div class="row g-4 text-center">
                            <div class="col-md-3">
                                <div class="border p-2 rounded mb-2 bg-light">
                                    {% if usuario and usuario.foto_perfil %}
                                        <img src="{{ url_for('static', filename=usuario.foto_perfil) }}" class="img-fluid rounded-circle" style="width:100px; height:100px; object-fit:cover;">
                                    {% else %}
                                        <i class="fa-solid fa-user fa-3x text-muted my-3"></i><br>Sin Foto
                                    {% endif %}
                                </div>
                                <label class="form-label small fw-bold">Foto Perfil</label>
                                {{ form.foto_perfil(class="form-control form-control-sm") }}
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">INE Frente</label>
                                {{ form.img_ine_frente(class="form-control form-control-sm") }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">INE Reverso</label>
                                {{ form.img_ine_reverso(class="form-control form-control-sm") }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Licencia Frente</label>
                                {{ form.img_licencia_frente(class="form-control form-control-sm") }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Licencia Reverso</label>
                                {{ form.img_licencia_reverso(class="form-control form-control-sm") }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Vigencia Licencia</label>
                                {{ form.fecha_validez_licencia(class="form-control form-control-sm", type="date") }}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="card-footer bg-white text-end py-3">
                {{ form.submit(class="btn btn-primary fw-bold px-5") }}
            </div>
        </div>
    </form>
</div>
{% endblock %}