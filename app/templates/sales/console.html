{% extends 'base.html' %}

{% block title %}Venta en Campo | GelMexSys{% endblock %}

{% block content %}
<style>
    /* 1. RESET Y CAPAS */
    .card, .card-body, .row, [class^="col-"] {
        overflow: visible !important;
        position: relative;
    }

    /* 2. BUSCADORES FLOTANTES */
    .lista-sugerencias {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 100000 !important;
        background: #ffffff;
        border: 2px solid #0d47a1;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        border-radius: 0 0 12px 12px;
        margin-top: 2px;
    }

    .item-sugerencia {
        padding: 14px 18px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white !important;
        color: #333 !important;
    }

    .item-sugerencia:hover {
        background-color: #e3f2fd !important;
    }

    /* 3. DISEÑO DE TOTALES Y ALINEACIÓN */
    .total-display { 
        font-size: 2.3rem; 
        font-weight: 900; 
        color: #0d47a1; 
    }
    
    .label-finanzas {
        font-size: 0.85rem;
        font-weight: bold;
    }

    .espaciador-footer { height: 130px; }
</style>

<div class="container-fluid pb-5">
    <div class="card card-erp mb-3 border-0 shadow-sm" style="z-index: 1001;">
        <div class="card-body p-4">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-5 position-relative" id="wrapperCliente">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">1. Buscar Cliente</label>
                    <input type="text" class="form-control form-control-lg border-primary shadow-sm" 
                           id="inputBusquedaCliente" placeholder="Nombre o negocio..." autocomplete="off">
                    <div id="listaSugerenciasCliente" class="lista-sugerencias"></div>
                    
                    <div id="resumenCliente" class="mt-2 d-none">
                        <div class="badge bg-primary d-block text-start p-2 mb-1">
                            Venta a: <span id="labelCliente"></span>
                        </div>
                        <div class="row g-1 text-center">
                            <div class="col-4 border-end">
                                <small class="text-muted d-block small-label">LÍMITE</small>
                                <span id="valLimite" class="fw-bold">$0.00</span>
                            </div>
                            <div class="col-4 border-end">
                                <small class="text-muted d-block small-label text-danger">DEBE</small>
                                <span id="valDebe" class="fw-bold text-danger">$0.00</span>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block small-label text-success">DISPONIBLE</small>
                                <span id="valDisponible" class="fw-bold text-success">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-md-3">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">2. Método de Pago</label>
                    <select id="metodoPago" class="form-select form-select-lg border-primary fw-bold" onchange="renderCarrito()">
                        <option value="Credito" selected>CRÉDITO</option>
                        <option value="Contado">CONTADO (EFECTIVO)</option>
                    </select>
                </div>

                <div class="col-12 col-md-4 text-end border-md-start">
                    <label class="small fw-bold text-muted d-block text-uppercase">Total de esta Nota</label>
                    <div class="total-display" id="granTotal">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-erp mb-4 shadow-sm" style="z-index: 1000;">
        <div class="card-body p-3">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-7 position-relative" id="wrapperProducto">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">3. Agregar Producto</label>
                    <input type="text" class="form-control form-control-lg border-primary shadow-sm" 
                           id="inputBusquedaProd" placeholder="Escribe nombre o SKU..." autocomplete="off">
                    <div id="listaSugerenciasProd" class="lista-sugerencias"></div>
                </div>
                <div class="col-6 col-md-2">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">Cant.</label>
                    <input type="number" id="inputCant" class="form-control form-control-lg text-center fw-bold" value="1" min="1">
                </div>
                <div class="col-6 col-md-3 d-grid">
                    <button onclick="agregarAlCarrito()" class="btn btn-primary btn-lg fw-bold shadow">
                        <i class="fa-solid fa-plus"></i> AGREGAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm" style="z-index: 1;">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="ps-3 py-3">Descripción</th>
                        <th class="text-center">Cant.</th>
                        <th class="text-end pe-3">Subtotal</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody id="tbodyCarrito"></tbody>
            </table>
        </div>
        <div id="emptyMsg" class="text-center py-5 text-muted">
            <i class="fa-solid fa-cart-shopping fa-3x mb-3 opacity-25"></i><br>
            <span class="fs-5">La nota de remisión está vacía</span>
        </div>
    </div>
    <div class="espaciador-footer"></div>
</div>

<div class="fixed-bottom p-3 bg-white border-top shadow-lg d-grid">
    <button id="btnFinalizar" class="btn btn-success btn-lg fw-bold py-3 shadow" onclick="enviarPedido()" disabled>
        CONFIRMAR PREVENTA
    </button>
</div>

<script>
    let carrito = {};
    let totalGlobal = 0;
    let productoSeleccionado = null;
    let clienteId = null;
    let creditoDisponible = 0;

    const clientesArr = [
        {% for c in clientes %}
        { id: {{ c.id }}, nombre: "{{ c.nombre_negocio }}", encargado: "{{ c.nombres_encargado }}" },
        {% endfor %}
    ];
    
    const catalogoBase = {{ catalogo | tojson | safe }};
    let catalogoActual = JSON.parse(JSON.stringify(catalogoBase));

    // BUSCADOR CLIENTE
    const inCli = document.getElementById('inputBusquedaCliente');
    const sugCli = document.getElementById('listaSugerenciasCliente');

    inCli.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        sugCli.innerHTML = '';
        if(val.length < 1) { sugCli.style.display = 'none'; return; }

        const matches = clientesArr.filter(c => 
            c.nombre.toLowerCase().includes(val) || c.encargado.toLowerCase().includes(val)
        );

        matches.forEach(c => {
            const d = document.createElement('div');
            d.className = 'item-sugerencia';
            d.innerHTML = `<div><strong>${c.nombre}</strong><br><small>${c.encargado}</small></div>`;
            d.onclick = () => {
                inCli.value = c.nombre;
                document.getElementById('labelCliente').innerText = c.nombre;
                clienteId = c.id;
                sugCli.style.display = 'none';
                fetchInfoCliente(c.id);
            };
            sugCli.appendChild(d);
        });
        sugCli.style.display = matches.length > 0 ? 'block' : 'none';
    });

    // BUSCADOR PRODUCTO
    const inProd = document.getElementById('inputBusquedaProd');
    const sugProd = document.getElementById('listaSugerenciasProd');

    inProd.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        sugProd.innerHTML = '';
        if(val.length < 1) { sugProd.style.display = 'none'; return; }

        const matches = catalogoActual.filter(p => p.nombre.toLowerCase().includes(val));

        matches.forEach(p => {
            const d = document.createElement('div');
            d.className = 'item-sugerencia';
            const badge = p.esEspecial ? '<span class="badge bg-success ms-2">ESPECIAL</span>' : '';
            d.innerHTML = `<span>${p.nombre}${badge}</span><span class="fw-bold text-primary">$${p.precio.toFixed(2)}</span>`;
            d.onclick = () => {
                inProd.value = p.nombre;
                productoSeleccionado = p;
                sugProd.style.display = 'none';
                document.getElementById('inputCant').focus();
            };
            sugProd.appendChild(d);
        });
        sugProd.style.display = matches.length > 0 ? 'block' : 'none';
    });

    async function fetchInfoCliente(id) {
        try {
            const r = await fetch(`/ventas/api/cliente/${id}`);
            const d = await r.json();
            
            // Lógica de Finanzas: Mostramos todo el desglose
            creditoDisponible = d.disponible;
            document.getElementById('resumenCliente').classList.remove('d-none');
            document.getElementById('valLimite').innerText = `$${d.limite_credito.toFixed(2)}`;
            document.getElementById('valDebe').innerText = `$${d.saldo_actual.toFixed(2)}`;
            document.getElementById('valDisponible').innerText = `$${d.disponible.toFixed(2)}`;
            
            catalogoActual = catalogoBase.map(p => {
                const esp = d.precios_especiales[p.id];
                return { ...p, precio: esp !== undefined ? esp : p.precio, esEspecial: esp !== undefined };
            });
            
            Object.keys(carrito).forEach(k => {
                const p = catalogoActual.find(x => x.id == k);
                if(p) carrito[k].precio = p.precio;
            });
            renderCarrito();
        } catch (e) { console.error(e); }
    }

    function agregarAlCarrito() {
        if(!clienteId) return alert("Selecciona un cliente");
        if(!productoSeleccionado) return;
        const c = parseFloat(document.getElementById('inputCant').value);
        if(c <= 0) return;

        if(carrito[productoSeleccionado.id]) carrito[productoSeleccionado.id].cant += c;
        else carrito[productoSeleccionado.id] = { nombre: productoSeleccionado.nombre, precio: productoSeleccionado.precio, cant: c };
        
        inProd.value = ''; productoSeleccionado = null; renderCarrito();
    }

    function renderCarrito() {
        const b = document.getElementById('tbodyCarrito');
        const metodo = document.getElementById('metodoPago').value;
        const btn = document.getElementById('btnFinalizar');
        const displayTotal = document.getElementById('granTotal');
        
        b.innerHTML = ''; totalGlobal = 0;
        
        Object.keys(carrito).forEach(id => {
            const i = carrito[id];
            const s = i.cant * i.precio;
            totalGlobal += s;
            b.innerHTML += `<tr>
                <td class="ps-3"><strong>${i.nombre}</strong><br><small>$${i.precio.toFixed(2)} u.</small></td>
                <td class="text-center fw-bold">${i.cant}</td>
                <td class="text-end pe-3">$${s.toFixed(2)}</td>
                <td class="text-center"><button class="btn btn-link text-danger" onclick="delItem(${id})"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        });
        
        displayTotal.innerText = '$' + totalGlobal.toFixed(2);
        document.getElementById('emptyMsg').style.display = Object.keys(carrito).length ? 'none' : 'block';
        
        const notaVacia = Object.keys(carrito).length === 0;
        const excedeCredito = (metodo === 'Credito' && totalGlobal > creditoDisponible);

        if (notaVacia) {
            btn.disabled = true;
            btn.classList.replace('btn-danger', 'btn-success');
            btn.innerText = "CONFIRMAR PREVENTA";
            displayTotal.classList.remove('text-danger');
        } else if (excedeCredito) {
            btn.disabled = true;
            btn.classList.replace('btn-success', 'btn-danger');
            btn.innerText = "LÍMITE DE CRÉDITO EXCEDIDO";
            displayTotal.classList.add('text-danger');
        } else {
            btn.disabled = false;
            btn.classList.replace('btn-danger', 'btn-success');
            btn.innerText = (metodo === 'Contado') ? "CONFIRMAR VENTA (CONTADO)" : "CONFIRMAR PREVENTA (CRÉDITO)";
            displayTotal.classList.remove('text-danger');
        }
    }

    function delItem(id) { delete carrito[id]; renderCarrito(); }

    async function enviarPedido() {
        const metodo = document.getElementById('metodoPago').value;
        if(!confirm(`¿Enviar pedido a PRODUCCIÓN?`)) return;
        
        const payload = { cliente_id: clienteId, fecha_entrega: "{{ date_now }}", metodo_pago: metodo, total: totalGlobal, items: carrito };

        try {
            const r = await fetch('/ventas/crear-pedido', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const d = await r.json();
            if(d.status === 'success') {
                alert("Éxito: " + d.message);
                window.location.reload();
            } else { alert("Error: " + d.message); }
        } catch (e) { alert("Error de conexión"); }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#wrapperCliente')) sugCli.style.display = 'none';
        if (!e.target.closest('#wrapperProducto')) sugProd.style.display = 'none';
    });
</script>
{% endblock %}