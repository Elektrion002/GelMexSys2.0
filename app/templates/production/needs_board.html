{% extends 'base.html' %}

{% block title %}Tablero de Necesidades | GelMexSys{% endblock %}
{% block page_header %}Programación de Producción{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-bold"><i class="fa-solid fa-microchip me-2"></i>ANALIZADOR DE DEMANDA VS ÓPTIMOS</h5>
            <span class="badge bg-secondary">Corte: {{ now }}</span>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tablaProduccion">
                <thead class="table-light small text-uppercase text-secondary">
                    <tr>
                        <th class="ps-3">Producto</th>
                        <th class="text-center">Vendido (Hoy)</th>
                        <th class="text-center">Existencia / En Proceso</th>
                        <th class="text-center d-none d-lg-table-cell">Meta Óptima</th>
                        <th class="text-center bg-warning text-dark" style="width: 160px;">A FABRICAR</th>
                        <th class="text-center">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in analisis %}
                    <tr data-id="{{ item.id }}" data-sku="{{ item.sku }}">
                        <td class="ps-3">
                            <strong class="d-block text-dark">{{ item.descripcion }}</strong>
                            <small class="text-muted">{{ item.sku }}</small>
                        </td>
                        <td class="text-center fw-bold text-primary">{{ item.demanda }}</td>
                        
                        <td class="text-center">
                            <div class="fw-bold fs-5">{{ item.stock_actual }}</div>
                            {% if item.en_proceso > 0 %}
                                <div class="badge bg-info-subtle text-info border border-info-subtle">
                                    <i class="fa-solid fa-fire-burner me-1"></i> {{ item.en_proceso }} batiendo
                                </div>
                            {% endif %}
                        </td>

                        <td class="text-center text-muted d-none d-lg-table-cell">{{ item.stock_ideal }}</td>
                        
                        <td class="text-center bg-light">
                            <input type="number" 
                                   class="form-control fw-bold text-center border-warning input-producir" 
                                   value="{{ item.producir }}" 
                                   step="1" min="0"
                                   id="input-{{ item.id }}">
                        </td>

                        <td class="text-center">
                            <span class="badge rounded-pill bg-{{ item.semaforo }} py-2 px-3 shadow-sm">
                                {% if item.semaforo == 'danger' %} 
                                    <i class="fa-solid fa-circle-exclamation me-1"></i> CRÍTICO
                                {% elif item.semaforo == 'warning' %} 
                                    <i class="fa-solid fa-clock-rotate-left me-1"></i> RECUPERAR
                                {% else %} 
                                    <i class="fa-solid fa-circle-check me-1"></i> SURTIDO
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-footer p-4 bg-white border-top text-end">
            <button class="btn btn-warning btn-lg fw-bold shadow-lg py-3 px-5" id="btnEnviarOrden" onclick="enviarAlMaestro()">
                <i class="fa-solid fa-hat-chef me-2"></i> ENVIAR ORDEN AL MAESTRO HELADERO
            </button>
        </div>
    </div>
</div>

<style>
    .input-producir:focus {
        background-color: #fffde7;
        border-color: #fbc02d;
        box-shadow: 0 0 8px rgba(251, 192, 45, 0.4);
    }
    .bg-info-subtle { background-color: #e0f7fa !important; }
    .text-info { color: #00838f !important; }
</style>

<script>
async function enviarAlMaestro() {
    const btn = document.getElementById('btnEnviarOrden');
    const filas = document.querySelectorAll('#tablaProduccion tbody tr');
    let itemsProduccion = [];

    filas.forEach(fila => {
        const id = fila.dataset.id;
        const cantidad = fila.querySelector('input').value;
        const descripcion = fila.querySelector('strong').innerText;

        if (parseFloat(cantidad) > 0) {
            itemsProduccion.push({
                producto_id: id,
                descripcion: descripcion,
                cantidad: parseFloat(cantidad)
            });
        }
    });

    if (itemsProduccion.length === 0) {
        alert("⚠️ Carnal, no pusiste nada para fabricar. El almacén sigue igual.");
        return;
    }

    if(!confirm(`¿Confirmas enviar esta carga al Maestro Heladero? Se congelará la demanda actual.`)) {
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-gear fa-spin me-2"></i>NOTIFICANDO FÁBRICA...';

    try {
        const response = await fetch("{{ url_for('production.guardar_orden') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: itemsProduccion })
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert("✅ ¡A toda madre! " + result.message);
            window.location.reload(); // Aquí el tablero ya saldrá restado
        } else {
            alert("❌ Chale, algo falló: " + result.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-hat-chef me-2"></i> ENVIAR ORDEN AL MAESTRO HELADERO';
        }
    } catch (error) {
        console.error("Error:", error);
        alert("❌ Error de red. Checa si el servidor sigue vivo.");
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-hat-chef me-2"></i> ENVIAR ORDEN AL MAESTRO HELADERO';
    }
}
</script>
{% endblock %}